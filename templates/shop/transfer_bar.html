{% extends "shop/base_shop.html" %}
{% block title %}انتقال مالکیت - طلاملا{% endblock %}

{% block shop_content %}
<nav class="mb-3">
    <ol class="breadcrumb small">
        <li class="breadcrumb-item"><a href="/" class="text-decoration-none">فروشگاه</a></li>
        <li class="breadcrumb-item"><a href="/my-bars" class="text-decoration-none">شمش‌های من</a></li>
        <li class="breadcrumb-item active">انتقال مالکیت</li>
    </ol>
</nav>

<div class="row justify-content-center">
    <div class="col-md-6">
        <!-- Bar Info -->
        <div class="card-tm no-hover mb-3 tm-animate-fade-in-up tm-delay-1">
            <div class="d-flex justify-content-between align-items-center">
                <div>
                    <h6 class="fw-bold mb-0">{{ bar.product.name if bar.product else 'نامشخص' }}</h6>
                    <small class="font-monospace text-muted" dir="ltr">{{ bar.serial_code }}</small>
                </div>
                <span class="badge-tm badge-tm-success">{{ bar.status_label }}</span>
            </div>
        </div>

        <div class="card-tm no-hover tm-animate-fade-in-up tm-delay-2">
            <h5 class="fw-bold mb-3 text-center tm-animate-fade-in">
                <i class="bi bi-arrow-left-right text-tm-primary me-1"></i>
                انتقال مالکیت
            </h5>

            {% if error %}
            <div class="alert alert-tm-danger py-2 mb-3">
                <i class="bi bi-exclamation-triangle me-1"></i>{{ error }}
            </div>
            {% endif %}

            {% if step == 'mobile' %}
            <!-- Step 1: Enter recipient mobile -->
            <p class="text-muted text-center small mb-4">
                شماره موبایل فردی که می‌خواهید شمش را به او انتقال دهید وارد کنید.
                برای تأیید، یک کد به <strong>موبایل خودتان</strong> ارسال می‌شود.
            </p>

            <form method="POST" action="/my-bars/{{ bar.id }}/transfer">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

                <div class="mb-4">
                    <label class="form-label-tm fw-bold">موبایل گیرنده</label>
                    <input type="tel" name="to_mobile" class="form-control form-control-tm text-center"
                           dir="ltr" required placeholder="09xxxxxxxxx"
                           pattern="09[0-9]{9}" maxlength="11" style="font-size:1.1rem; letter-spacing:1px;">
                </div>

                <button type="submit" class="btn btn-lg btn-tm-primary w-100">
                    <i class="bi bi-send me-1"></i> ارسال کد تأیید
                </button>
            </form>

            {% elif step == 'otp' %}
            <!-- Step 2: Enter OTP -->
            <p class="text-muted text-center small mb-2">
                کد تأیید به <strong>موبایل خودتان</strong> ارسال شد.
            </p>
            <p class="text-center small mb-4">
                گیرنده: <strong dir="ltr">{{ to_mobile }}</strong>
            </p>

            <form method="POST" action="/my-bars/{{ bar.id }}/transfer/confirm">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <input type="hidden" name="transfer_id" value="{{ transfer_id }}">

                <div class="mb-4">
                    <label class="form-label-tm fw-bold">کد تأیید</label>
                    <input type="text" name="otp_code" class="form-control form-control-tm text-center font-monospace"
                           dir="ltr" required maxlength="6" placeholder="------"
                           style="font-size:1.5rem; letter-spacing:8px;" autofocus>
                </div>

                <button type="submit" class="btn btn-lg btn-tm-primary w-100">
                    <i class="bi bi-check-circle me-1"></i> تأیید و انتقال
                </button>
            </form>
            {% endif %}
        </div>

        <div class="text-center mt-3">
            <a href="/my-bars" class="text-decoration-none small">
                <i class="bi bi-arrow-right me-1"></i> بازگشت به شمش‌های من
            </a>
        </div>
    </div>
</div>
{% endblock %}
