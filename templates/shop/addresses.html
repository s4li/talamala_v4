{% extends "shop/base_shop.html" %}
{% block title %}Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ù…Ù† - Ø·Ù„Ø§Ù…Ù„Ø§{% endblock %}

{% block shop_content %}
<div class="row justify-content-center">
    <div class="col-md-10 col-lg-9">
        <div class="d-flex justify-content-between align-items-center mb-4 tm-animate-fade-in">
            <h4 class="fw-bold mb-0"><i class="bi bi-geo-alt me-2"></i>Ø¢Ø¯Ø±Ø³â€ŒÙ‡Ø§ÛŒ Ù…Ù†</h4>
            <button class="btn btn-sm btn-tm-primary" data-bs-toggle="collapse" data-bs-target="#addAddressForm">
                <i class="bi bi-plus-lg me-1"></i>Ø¢Ø¯Ø±Ø³ Ø¬Ø¯ÛŒØ¯
            </button>
        </div>

        {% if msg %}
        <div class="alert-tm-success py-2 d-flex justify-content-between align-items-center flex-wrap gap-2">
            <span>{{ msg }}</span>
            <a href="/checkout" class="btn btn-sm btn-tm-primary"><i class="bi bi-cart-check me-1"></i>Ø§Ø¯Ø§Ù…Ù‡ Ø®Ø±ÛŒØ¯</a>
        </div>
        {% endif %}

        {% if next_url %}
        <div class="alert-tm-info py-2 small mb-3">
            <i class="bi bi-info-circle me-1"></i>
            Ø¢Ø¯Ø±Ø³ Ø¬Ø¯ÛŒØ¯ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯ ØªØ§ Ø¨Ù‡ ØµÙØ­Ù‡ ØªÚ©Ù…ÛŒÙ„ Ø³ÙØ§Ø±Ø´ Ø¨Ø§Ø²Ú¯Ø±Ø¯ÛŒØ¯.
        </div>
        {% endif %}

        <!-- Add Address Form (collapsed, auto-open when next_url) -->
        <div class="collapse mb-4 {{ 'show' if next_url else '' }}" id="addAddressForm">
            <div class="card-tm no-hover">
                    <h6 class="fw-bold mb-3">Ø§ÙØ²ÙˆØ¯Ù† Ø¢Ø¯Ø±Ø³ Ø¬Ø¯ÛŒØ¯</h6>
                    <form method="POST" action="/addresses">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        {% if next_url %}<input type="hidden" name="next_url" value="{{ next_url }}">{% endif %}
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label-tm small fw-bold">Ø¹Ù†ÙˆØ§Ù† <span class="text-danger">*</span></label>
                                <input type="text" name="title" class="form-control form-control-tm" placeholder="Ù…Ø«Ù„Ø§Ù‹: Ø®Ø§Ù†Ù‡ØŒ Ù…Ø­Ù„ Ú©Ø§Ø±" required>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-tm small fw-bold">Ø§Ø³ØªØ§Ù† <span class="text-danger">*</span></label>
                                <select name="province_id" id="addrProvince" class="form-select form-select-tm" required onchange="loadCities(this.value)">
                                    <option value="">Ø§Ù†ØªØ®Ø§Ø¨...</option>
                                    {% for p in provinces %}
                                    <option value="{{ p.id }}">{{ p.name }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-tm small fw-bold">Ø´Ù‡Ø± <span class="text-danger">*</span></label>
                                <select name="city_id" id="addrCity" class="form-select form-select-tm" required onchange="loadDistricts(this.value)" disabled>
                                    <option value="">Ø§Ø¨ØªØ¯Ø§ Ø§Ø³ØªØ§Ù†...</option>
                                </select>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-tm small fw-bold">Ù…Ø­Ù„Ù‡</label>
                                <select name="district_id" id="addrDistrict" class="form-select form-select-tm" disabled>
                                    <option value="">Ø§Ø¨ØªØ¯Ø§ Ø´Ù‡Ø±...</option>
                                </select>
                            </div>
                            <div class="col-md-8">
                                <label class="form-label-tm small fw-bold">Ø¢Ø¯Ø±Ø³ Ú©Ø§Ù…Ù„ <span class="text-danger">*</span></label>
                                <textarea name="address" class="form-control form-control-tm" rows="2" placeholder="Ø®ÛŒØ§Ø¨Ø§Ù†ØŒ Ú©ÙˆÚ†Ù‡ØŒ Ù¾Ù„Ø§Ú©ØŒ ÙˆØ§Ø­Ø¯" required></textarea>
                            </div>
                            <div class="col-md-3">
                                <label class="form-label-tm small fw-bold">Ú©Ø¯ Ù¾Ø³ØªÛŒ</label>
                                <input type="text" name="postal_code" class="form-control form-control-tm" dir="ltr" maxlength="10" placeholder="1234567890">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label-tm small fw-bold">Ù†Ø§Ù… Ú¯ÛŒØ±Ù†Ø¯Ù‡</label>
                                <input type="text" name="receiver_name" class="form-control form-control-tm" placeholder="(Ø®Ø§Ù„ÛŒ = Ø®ÙˆØ¯ØªØ§Ù†)">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label-tm small fw-bold">ØªÙ„ÙÙ† Ú¯ÛŒØ±Ù†Ø¯Ù‡</label>
                                <input type="text" name="receiver_phone" class="form-control form-control-tm" dir="ltr" placeholder="09...">
                            </div>
                            <div class="col-md-2 d-flex align-items-end">
                                <div class="form-check">
                                    <input type="checkbox" name="is_default" class="form-check-input" id="isDefaultCheck">
                                    <label class="form-check-label small" for="isDefaultCheck">Ù¾ÛŒØ´â€ŒÙØ±Ø¶</label>
                                </div>
                            </div>
                        </div>
                        <button class="btn btn-tm-primary mt-3"><i class="bi bi-check-lg me-1"></i>Ø°Ø®ÛŒØ±Ù‡ Ø¢Ø¯Ø±Ø³</button>
                    </form>
            </div>
        </div>

        <!-- Existing Addresses -->
        {% if addresses %}
        <div class="row g-3">
            {% for addr in addresses %}
            <div class="col-md-6 tm-animate-fade-in-up tm-delay-{{ loop.index if loop.index <= 12 else 12 }}">
                <div class="card-tm no-hover h-100 {% if addr.is_default %}border-start border-3 border-success{% endif %}">
                        <div class="d-flex justify-content-between align-items-start mb-2">
                            <h6 class="fw-bold mb-0">
                                {{ addr.title }}
                                {% if addr.is_default %}<span class="badge-tm badge-tm-success ms-1">Ù¾ÛŒØ´â€ŒÙØ±Ø¶</span>{% endif %}
                            </h6>
                            <div class="d-flex gap-1">
                                {% if not addr.is_default %}
                                <form method="POST" action="/addresses/{{ addr.id }}/default" class="d-inline">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                    <button class="btn btn-sm btn-tm-outline" title="Ù¾ÛŒØ´â€ŒÙØ±Ø¶"><i class="bi bi-star"></i></button>
                                </form>
                                {% endif %}
                                <form method="POST" action="/addresses/{{ addr.id }}/delete"
                                      onsubmit="return confirm('Ø­Ø°Ù Ø§ÛŒÙ† Ø¢Ø¯Ø±Ø³ØŸ')" class="d-inline">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                    <button class="btn btn-sm btn-tm-danger" title="Ø­Ø°Ù"><i class="bi bi-trash"></i></button>
                                </form>
                            </div>
                        </div>
                        <div class="small text-muted">
                            <div><i class="bi bi-geo me-1"></i>{{ addr.province.name if addr.province else '' }}ØŒ {{ addr.city.name if addr.city else '' }}{% if addr.district %}ØŒ {{ addr.district.name }}{% endif %}</div>
                            <div class="mt-1">{{ addr.address }}</div>
                            {% if addr.postal_code %}<div class="mt-1" dir="ltr">ğŸ“® {{ addr.postal_code }}</div>{% endif %}
                            {% if addr.receiver_name %}<div class="mt-1">ğŸ‘¤ {{ addr.receiver_name }}{% if addr.receiver_phone %} â€” {{ addr.receiver_phone }}{% endif %}</div>{% endif %}
                        </div>
                </div>
            </div>
            {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-5 text-muted">
            <i class="bi bi-geo-alt" style="font-size:3rem;"></i>
            <p class="mt-2">Ù‡Ù†ÙˆØ² Ø¢Ø¯Ø±Ø³ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.</p>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}

{% block shop_js %}
<script>
async function loadCities(provinceId) {
    const citySelect = document.getElementById('addrCity');
    const distSelect = document.getElementById('addrDistrict');
    citySelect.innerHTML = '<option value="">\u23F3 Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option>';
    distSelect.innerHTML = '<option value="">Ø§Ø¨ØªØ¯Ø§ Ø´Ù‡Ø±...</option>';
    distSelect.disabled = true;
    if (!provinceId) { citySelect.innerHTML = '<option value="">Ø§Ø¨ØªØ¯Ø§ Ø§Ø³ØªØ§Ù†...</option>'; citySelect.disabled = true; return; }
    try {
        const r = await fetch(`/api/geo/cities?province_id=${provinceId}`);
        const cities = await r.json();
        citySelect.innerHTML = '<option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ù‡Ø±...</option>';
        cities.forEach(c => { citySelect.innerHTML += `<option value="${c.id}">${c.name}</option>`; });
        citySelect.disabled = false;
    } catch(e) { citySelect.innerHTML = '<option value="">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</option>'; console.error(e); }
}
async function loadDistricts(cityId) {
    const distSelect = document.getElementById('addrDistrict');
    distSelect.innerHTML = '<option value="">\u23F3 Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</option>';
    if (!cityId) { distSelect.disabled = true; return; }
    try {
        const r = await fetch(`/api/geo/districts?city_id=${cityId}`);
        const districts = await r.json();
        distSelect.innerHTML = '<option value="">Ù‡Ù…Ù‡ Ù…Ø­Ù„Ù‡â€ŒÙ‡Ø§</option>';
        districts.forEach(d => { distSelect.innerHTML += `<option value="${d.id}">${d.name}</option>`; });
        distSelect.disabled = false;
    } catch(e) { distSelect.innerHTML = '<option value="">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ</option>'; console.error(e); }
}
</script>
{% endblock %}
