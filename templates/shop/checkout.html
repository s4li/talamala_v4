{% extends "shop/base_shop.html" %}
{% block title %}ØªÚ©Ù…ÛŒÙ„ Ø®Ø±ÛŒØ¯ - Ø·Ù„Ø§Ù…Ù„Ø§{% endblock %}

{% block shop_css %}
<style>
    .delivery-option {
        border: 2px solid #e0e0e0;
        border-radius: 12px;
        padding: 20px;
        cursor: pointer;
        transition: all var(--tm-duration-normal) var(--tm-ease-out);
    }
    .delivery-option:hover {
        border-color: var(--tm-gold);
        transform: translateY(-3px);
        box-shadow: var(--tm-shadow-md);
    }
    .delivery-option.active {
        border-color: var(--tm-gold);
        background: #fffdf5;
        box-shadow: 0 0 0 3px rgba(212,168,67,0.15);
    }
    .delivery-option .option-icon { font-size: 2.5rem; }
    .location-card {
        border: 2px solid #e0e0e0;
        border-radius: 10px;
        padding: 12px;
        cursor: pointer;
        transition: all var(--tm-duration-fast) var(--tm-ease-out);
    }
    .location-card:hover {
        border-color: var(--tm-gold);
        transform: translateY(-2px);
        box-shadow: var(--tm-shadow-sm);
    }
    .location-card.selected {
        border-color: var(--tm-gold);
        background: #fffdf5;
    }
    .location-card.no-stock {
        opacity: 0.5;
        cursor: not-allowed;
    }
    .step-section { display: none; }
    .step-section.active { display: block; }
</style>
{% endblock %}

{% block shop_content %}
<!-- Breadcrumb -->
<nav class="mb-3">
    <ol class="breadcrumb small">
        <li class="breadcrumb-item"><a href="/" class="text-decoration-none">ÙØ±ÙˆØ´Ú¯Ø§Ù‡</a></li>
        <li class="breadcrumb-item"><a href="/cart" class="text-decoration-none">Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯</a></li>
        <li class="breadcrumb-item active">ØªÚ©Ù…ÛŒÙ„ Ø®Ø±ÛŒØ¯</li>
    </ol>
</nav>

{% if request.query_params.get('error') %}
<div class="alert-tm-danger py-2"><i class="bi bi-exclamation-triangle me-1"></i>{{ request.query_params.get('error') }}</div>
{% endif %}

<form method="POST" action="/cart/checkout" id="checkoutForm">
<input type="hidden" name="csrf_token" value="{{ csrf_token }}">
<input type="hidden" name="delivery_method" id="deliveryMethodInput" value="">
<input type="hidden" name="coupon_code" id="couponCodeInput" value="">
<input type="hidden" name="is_gift" id="isGiftInput" value="0">

<div class="row g-4">
    <!-- Main Content -->
    <div class="col-lg-8">
        <h4 class="fw-bold mb-4"><i class="bi bi-truck me-2"></i>Ù†Ø­ÙˆÙ‡ ØªØ­ÙˆÛŒÙ„</h4>

        <!-- Step 1: Choose delivery method -->
        <div class="row g-3 mb-4">
            <!-- Pickup Option -->
            <div class="col-md-6 tm-animate-fade-in-up tm-delay-1">
                <div class="delivery-option" id="optPickup" onclick="selectMethod('Pickup')">
                    <div class="text-center mb-2">
                        <div class="option-icon">ğŸª</div>
                    </div>
                    <h5 class="fw-bold text-center">ØªØ­ÙˆÛŒÙ„ Ø­Ø¶ÙˆØ±ÛŒ</h5>
                    <p class="text-muted text-center small mb-0">Ø³Ø±ÛŒØ¹ Ùˆ Ø§Ù…Ù† â€¢ Ø¨Ø¯ÙˆÙ† Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø±Ø³Ø§Ù„</p>
                </div>
            </div>

            <!-- Postal Option -->
            <div class="col-md-6 tm-animate-fade-in-up tm-delay-2">
                <div class="delivery-option {% if not postal_info.is_available %}opacity-50{% endif %}"
                     id="optPostal"
                     {% if postal_info.is_available and postal_stock > 0 %}onclick="selectMethod('Postal')"{% endif %}>
                    <div class="text-center mb-2">
                        <div class="option-icon">ğŸ“¦</div>
                    </div>
                    <h5 class="fw-bold text-center">Ø§Ø±Ø³Ø§Ù„ Ù¾Ø³ØªÛŒ</h5>
                    <p class="text-muted text-center small mb-0">Ø¨ÛŒÙ…Ù‡ Ø´Ø¯Ù‡ â€¢ Ø³Ø±Ø§Ø³Ø± Ø§ÛŒØ±Ø§Ù†</p>
                    {% if not postal_info.is_available %}
                    <div class="alert-tm-warning py-1 px-2 mt-2 small text-center mb-0">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        {{ postal_info.unavailable_reason }}
                    </div>
                    {% elif postal_stock == 0 %}
                    <div class="alert-tm-warning py-1 px-2 mt-2 small text-center mb-0">
                        <i class="bi bi-exclamation-triangle me-1"></i>
                        Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ø§Ù†Ø¨Ø§Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾Ø³ØªÛŒ ØªÙ…Ø§Ù… Ø´Ø¯Ù‡ Ø§Ø³Øª.
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>

        <!-- Step 2A: Pickup Details -->
        <div class="step-section" id="pickupSection">
            <div class="card-tm no-hover">
                <h5 class="fw-bold mb-3"><i class="bi bi-geo-alt me-1"></i>Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ</h5>

                <!-- Province -->
                <div class="row g-3 mb-3">
                    <div class="col-md-6">
                        <label class="form-label-tm">Ø§Ø³ØªØ§Ù†</label>
                        <select class="form-select form-select-tm" id="provinceSelect" onchange="onProvinceChange()">
                            <option value="">Ø§Ù†ØªØ®Ø§Ø¨ Ø§Ø³ØªØ§Ù†...</option>
                            {% for prov in provinces %}
                            <option value="{{ prov }}">{{ prov }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="col-md-6">
                        <label class="form-label-tm">Ø´Ù‡Ø±</label>
                        <select class="form-select form-select-tm" id="citySelect" onchange="onCityChange()" disabled>
                            <option value="">Ø§Ø¨ØªØ¯Ø§ Ø§Ø³ØªØ§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>
                        </select>
                    </div>
                </div>

                <!-- Locations -->
                <div id="locationsContainer">
                    <div id="locationsLoading" class="text-center py-3 d-none">
                        <div class="spinner-border spinner-border-sm text-warning"></div>
                        <span class="ms-2 text-muted">Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ...</span>
                    </div>
                    <div id="locationsList" class="row g-2"></div>
                    <div id="noLocations" class="text-center py-3 d-none">
                        <i class="bi bi-info-circle text-warning me-1"></i>
                        <span class="text-muted">Ø¯Ø± Ø§ÛŒÙ† Ø´Ù‡Ø± Ù…ÙˆØ¬ÙˆØ¯ÛŒ Ù†Ø¯Ø§Ø±ÛŒÙ…. Ù„Ø·ÙØ§Ù‹ Ø§Ø±Ø³Ø§Ù„ Ù¾Ø³ØªÛŒ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ ÛŒØ§ Ø´Ù‡Ø± Ø¯ÛŒÚ¯Ø±ÛŒ Ø±Ø§ Ø§Ù…ØªØ­Ø§Ù† Ú©Ù†ÛŒØ¯.</span>
                    </div>
                </div>

                <input type="hidden" name="pickup_dealer_id" id="pickupLocationInput" value="">

                <!-- Commitment -->
                <div class="form-check mt-3 p-3 bg-light rounded">
                    <input type="checkbox" class="form-check-input" name="commitment" value="yes" id="commitmentCheck">
                    <label class="form-check-label" for="commitmentCheck">
                        <strong>Ù…ØªØ¹Ù‡Ø¯ Ù…ÛŒâ€ŒØ´ÙˆÙ…</strong> Ø¨Ø§ Ú©Ø§Ø±Øª Ù…Ù„ÛŒ Ùˆ Ú©Ø¯ ØªØ­ÙˆÛŒÙ„ØŒ Ø´Ø®ØµØ§Ù‹ Ø¨Ù‡ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†Ù….
                    </label>
                </div>
            </div>
        </div>

        <!-- Step 2B: Postal Details -->
        <div class="step-section" id="postalSection">
            <div class="card-tm no-hover">
                <h5 class="fw-bold mb-3"><i class="bi bi-envelope me-1"></i>Ø¢Ø¯Ø±Ø³ Ø§Ø±Ø³Ø§Ù„</h5>

                {% if customer_addresses %}
                <div class="mb-3">
                    <label class="form-label-tm fw-bold">Ø§Ù†ØªØ®Ø§Ø¨ Ø¢Ø¯Ø±Ø³ Ø°Ø®ÛŒØ±Ù‡â€ŒØ´Ø¯Ù‡</label>
                    {% for addr in customer_addresses %}
                    <div class="form-check border rounded p-3 mb-2 {% if addr.is_default %}border-success{% endif %}" style="cursor:pointer;"
                         onclick="selectAddress({{ addr.id }}, '{{ addr.province.name if addr.province else '' }}', '{{ addr.city.name if addr.city else '' }}', `{{ addr.address }}`, '{{ addr.postal_code or '' }}')">
                        <input class="form-check-input" type="radio" name="selected_address" value="{{ addr.id }}" id="addr{{ addr.id }}"
                               {% if addr.is_default %}checked{% endif %}>
                        <label class="form-check-label w-100" for="addr{{ addr.id }}">
                            <strong>{{ addr.title }}</strong>
                            {% if addr.is_default %}<span class="badge-tm badge-tm-success ms-1">Ù¾ÛŒØ´â€ŒÙØ±Ø¶</span>{% endif %}
                            <div class="small text-muted">{{ addr.province.name if addr.province else '' }}ØŒ {{ addr.city.name if addr.city else '' }}{% if addr.district %}ØŒ {{ addr.district.name }}{% endif %} â€” {{ addr.address }}</div>
                            {% if addr.postal_code %}<div class="small text-muted" dir="ltr">ğŸ“® {{ addr.postal_code }}</div>{% endif %}
                        </label>
                    </div>
                    {% endfor %}
                </div>
                {% else %}
                <div class="alert-tm-warning py-2 small">
                    <i class="bi bi-info-circle me-1"></i>
                    Ù‡Ù†ÙˆØ² Ø¢Ø¯Ø±Ø³ÛŒ Ø«Ø¨Øª Ù†Ú©Ø±Ø¯Ù‡â€ŒØ§ÛŒØ¯.
                    <a href="/addresses" class="alert-link">Ø§Ø¨ØªØ¯Ø§ Ø¢Ø¯Ø±Ø³ Ø®ÙˆØ¯ Ø±Ø§ Ø«Ø¨Øª Ú©Ù†ÛŒØ¯</a>
                </div>
                {% endif %}

                <!-- Hidden fields that get filled from selected address -->
                <input type="hidden" name="shipping_province" id="shippingProvince">
                <input type="hidden" name="shipping_city" id="shippingCity">
                <input type="hidden" name="shipping_address" id="shippingAddress">
                <input type="hidden" name="shipping_postal_code" id="shippingPostalCode">

                <div class="alert-tm-info py-2 mt-3 small">
                    <i class="bi bi-shield-check me-1"></i>
                    Ú©Ø§Ù„Ø§ÛŒ Ø´Ù…Ø§ Ø¨Ø§ <strong>Ø¨ÛŒÙ…Ù‡ Ú©Ø§Ù…Ù„</strong> Ùˆ Ø¨Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ø§ÛŒÙ…Ù† Ø§Ø±Ø³Ø§Ù„ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
                    Ù¾Ø³ Ø§Ø² ØªØ­ÙˆÛŒÙ„ Ø¨Ù‡ Ù¾Ø³ØªØŒ Ú©Ø¯ Ø±Ù‡Ú¯ÛŒØ±ÛŒ Ø¨Ø±Ø§ÛŒØªØ§Ù† Ù¾ÛŒØ§Ù…Ú© Ø®ÙˆØ§Ù‡Ø¯ Ø´Ø¯.
                </div>
            </div>
        </div>
    </div>

    <!-- Summary Sidebar -->
    <div class="col-lg-4">
        <div class="card-tm no-hover sticky-top" style="top:80px;z-index:1;">
            <h6 class="fw-bold mb-3"><i class="bi bi-receipt me-1"></i>Ø®Ù„Ø§ØµÙ‡ Ø³ÙØ§Ø±Ø´</h6>

            {% for item in items %}
            <div class="d-flex justify-content-between small mb-2">
                <span>{{ item.product.name }} Ã— {{ item.quantity }}</span>
                <span>{{ item.line_total | toman }} ØªÙˆÙ…Ø§Ù†</span>
            </div>
            {% endfor %}

            <hr>
            <div class="d-flex justify-content-between mb-1">
                <span class="text-muted">Ø¬Ù…Ø¹ Ú©Ø§Ù„Ø§Ù‡Ø§</span>
                <span>{{ total_price | toman }} <small>ØªÙˆÙ…Ø§Ù†</small></span>
            </div>

            <!-- Shipping costs (shown for postal) -->
            <div id="shippingCostRow" class="d-none">
                <div class="d-flex justify-content-between mb-1">
                    <span class="text-muted">Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø±Ø³Ø§Ù„</span>
                    <span id="shippingCostVal">{{ postal_info.shipping_cost | toman }} <small>ØªÙˆÙ…Ø§Ù†</small></span>
                </div>
                <div class="d-flex justify-content-between mb-1">
                    <span class="text-muted">Ø¨ÛŒÙ…Ù‡</span>
                    <span id="insuranceCostVal">{{ postal_info.insurance_cost | toman }} <small>ØªÙˆÙ…Ø§Ù†</small></span>
                </div>
            </div>

            <div id="freeDeliveryRow" class="d-none">
                <div class="d-flex justify-content-between mb-1">
                    <span class="text-muted">Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø±Ø³Ø§Ù„</span>
                    <span class="text-success">Ø±Ø§ÛŒÚ¯Ø§Ù†</span>
                </div>
            </div>

            <!-- Coupon -->
            <div class="mb-2 mt-2">
                <label class="form-label-tm small fw-bold mb-1">
                    <i class="bi bi-ticket-perforated me-1"></i>Ú©Ø¯ ØªØ®ÙÛŒÙ
                </label>
                <div class="input-group input-group-sm">
                    <input type="text" id="couponInput" class="form-control form-control-tm" dir="ltr"
                           placeholder="Ù…Ø«Ø§Ù„: SUMMER2026" style="text-transform:uppercase;">
                    <button type="button" class="btn btn-tm-outline" id="couponCheckBtn" onclick="checkCoupon()">
                        Ø§Ø¹Ù…Ø§Ù„
                    </button>
                </div>
                <div id="couponResult" class="mt-1 small"></div>
            </div>

            <!-- Applied coupon row -->
            <div id="couponRow" class="d-none">
                <div class="d-flex justify-content-between mb-1">
                    <span class="text-muted">
                        <span id="couponTypeLabel">ØªØ®ÙÛŒÙ</span>
                        <button type="button" class="btn-sm p-0 text-danger border-0" onclick="removeCoupon()" title="Ø­Ø°Ù">
                            <i class="bi bi-x-circle"></i>
                        </button>
                    </span>
                    <span class="text-success fw-bold" id="couponAmountVal">âˆ’0 ØªÙˆÙ…Ø§Ù†</span>
                </div>
            </div>

            <hr>
            <div class="d-flex justify-content-between">
                <span class="fw-bold fs-5">Ù…Ø¨Ù„Øº Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª</span>
                <span class="fw-bold fs-5 text-tm-primary" id="grandTotalVal">
                    {{ total_price | toman }} <small>ØªÙˆÙ…Ø§Ù†</small>
                </span>
            </div>

            <!-- Gift Option -->
            <div class="form-check mt-3 p-3 rounded" style="background: var(--tm-info-900);">
                <input type="checkbox" class="form-check-input" id="giftCheck"
                       onchange="document.getElementById('isGiftInput').value = this.checked ? '1' : '0'">
                <label class="form-check-label" for="giftCheck">
                    <i class="bi bi-gift me-1"></i>
                    <strong>Ø§ÛŒÙ† Ø³ÙØ§Ø±Ø´ Ù‡Ø¯ÛŒÙ‡ Ø§Ø³Øª</strong>
                    <div class="small text-muted mt-1">Ø´Ù…Ø´ Ø¨Ù‡ Ù†Ø§Ù… Ø®Ø±ÛŒØ¯Ø§Ø± Ø«Ø¨Øª Ù†Ù…ÛŒâ€ŒØ´ÙˆØ¯. Ú©Ø¯ Ø«Ø¨Øª Ù…Ø§Ù„Ú©ÛŒØª Ø¯Ø§Ø®Ù„ Ø¨Ø³ØªÙ‡ Ù‚Ø±Ø§Ø± Ù…ÛŒâ€ŒÚ¯ÛŒØ±Ø¯.</div>
                </label>
            </div>

            <button type="submit" class="btn btn-tm-primary w-100 mt-3 py-2" id="submitBtn" disabled>
                <i class="bi bi-lock me-1"></i> Ø«Ø¨Øª Ø³ÙØ§Ø±Ø´ Ùˆ Ù¾Ø±Ø¯Ø§Ø®Øª
            </button>

            <a href="/cart" class="btn btn-sm btn-tm-outline w-100 mt-2">
                <i class="bi bi-arrow-right me-1"></i> Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø³Ø¨Ø¯ Ø®Ø±ÛŒØ¯
            </a>
        </div>
    </div>
</div>
</form>
{% endblock %}

{% block shop_js %}
<script>
(function(){
    const totalPrice = {{ total_price }};
    const shippingCost = {{ postal_info.shipping_cost }};
    const insuranceCost = {{ postal_info.insurance_cost }};

    let selectedMethod = '';
    let selectedLocationId = null;
    let couponDiscount = 0;  // in rial
    let couponCode = '';
    let couponIsCashback = false;

    // ==============================
    // Coupon
    // ==============================
    window.checkCoupon = async function() {
        const input = document.getElementById('couponInput');
        const code = input.value.trim().toUpperCase();
        const result = document.getElementById('couponResult');
        const btn = document.getElementById('couponCheckBtn');

        if (!code) {
            result.innerHTML = '<span class="text-danger">Ù„Ø·ÙØ§Ù‹ Ú©Ø¯ Ø±Ø§ ÙˆØ§Ø±Ø¯ Ú©Ù†ÛŒØ¯</span>';
            return;
        }

        btn.disabled = true;
        btn.textContent = '...';

        try {
            const resp = await fetch(`/api/coupon/check?code=${encodeURIComponent(code)}`);
            if (resp.status === 401) { window.location.href = '/auth/login?next=' + encodeURIComponent(window.location.pathname); return; }
            const data = await resp.json();

            if (data.valid) {
                couponDiscount = data.discount_amount;
                couponCode = data.code;
                couponIsCashback = data.is_cashback;

                document.getElementById('couponCodeInput').value = data.code;
                document.getElementById('couponRow').classList.remove('d-none');
                document.getElementById('couponAmountVal').textContent =
                    'âˆ’' + formatToman(data.discount_amount) + ' ØªÙˆÙ…Ø§Ù†';
                document.getElementById('couponTypeLabel').textContent =
                    data.is_cashback ? 'Ú©Ø´Ø¨Ú© (ÙˆØ§Ø±ÛŒØ² Ø¨Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„)' : 'ØªØ®ÙÛŒÙ';

                result.innerHTML = `<span class="text-success"><i class="bi bi-check-circle me-1"></i>${data.title} â€” ${data.discount_display}</span>`;
                input.readOnly = true;
                input.classList.add('bg-light');

                updateGrandTotal();
            } else {
                result.innerHTML = `<span class="text-danger"><i class="bi bi-x-circle me-1"></i>${data.error}</span>`;
                couponDiscount = 0;
            }
        } catch(e) {
            result.innerHTML = '<span class="text-danger">Ø®Ø·Ø§ Ø¯Ø± Ø¨Ø±Ø±Ø³ÛŒ Ú©Ø¯</span>';
        }

        btn.disabled = false;
        btn.textContent = 'Ø§Ø¹Ù…Ø§Ù„';
    };

    window.removeCoupon = function() {
        couponDiscount = 0;
        couponCode = '';
        couponIsCashback = false;
        document.getElementById('couponCodeInput').value = '';
        document.getElementById('couponRow').classList.add('d-none');
        document.getElementById('couponResult').innerHTML = '';
        const input = document.getElementById('couponInput');
        input.value = '';
        input.readOnly = false;
        input.classList.remove('bg-light');
        updateGrandTotal();
    };

    function updateGrandTotal() {
        let grand = totalPrice;
        if (selectedMethod === 'Postal') {
            grand += shippingCost + insuranceCost;
        }
        // Apply discount (cashback doesn't reduce total, only pure discount does)
        if (couponDiscount > 0 && !couponIsCashback) {
            grand = Math.max(0, grand - couponDiscount);
        }
        document.getElementById('grandTotalVal').innerHTML =
            formatToman(grand) + ' <small>ØªÙˆÙ…Ø§Ù†</small>';
    }

    // ==============================
    // Method Selection
    // ==============================
    window.selectMethod = function(method) {
        selectedMethod = method;
        document.getElementById('deliveryMethodInput').value = method;

        // Toggle active class
        document.getElementById('optPickup').classList.toggle('active', method === 'Pickup');
        document.getElementById('optPostal').classList.toggle('active', method === 'Postal');

        // Toggle sections
        document.getElementById('pickupSection').classList.toggle('active', method === 'Pickup');
        document.getElementById('postalSection').classList.toggle('active', method === 'Postal');

        // Toggle costs
        document.getElementById('shippingCostRow').classList.toggle('d-none', method !== 'Postal');
        document.getElementById('freeDeliveryRow').classList.toggle('d-none', method !== 'Pickup');

        // Update total
        updateGrandTotal();

        updateSubmitButton();
    };

    // ==============================
    // Province / City / Location AJAX
    // ==============================
    window.onProvinceChange = async function() {
        const province = document.getElementById('provinceSelect').value;
        const citySelect = document.getElementById('citySelect');

        if (!province) {
            citySelect.innerHTML = '<option value="">Ø§Ø¨ØªØ¯Ø§ Ø§Ø³ØªØ§Ù† Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯</option>';
            citySelect.disabled = true;
            document.getElementById('locationsList').innerHTML = '';
            return;
        }

        // Show loading
        document.getElementById('locationsLoading').classList.remove('d-none');
        document.getElementById('noLocations').classList.add('d-none');

        try {
            const resp = await fetch(`/api/delivery/locations?province=${encodeURIComponent(province)}`);
            if (resp.status === 401) { window.location.href = '/auth/login?next=' + encodeURIComponent(window.location.pathname); return; }
            const data = await resp.json();

            // Fill cities
            citySelect.innerHTML = '<option value="">Ù‡Ù…Ù‡ Ø´Ù‡Ø±Ù‡Ø§</option>';
            data.cities.forEach(c => {
                citySelect.innerHTML += `<option value="${c}">${c}</option>`;
            });
            citySelect.disabled = false;

            // Show locations
            renderLocations(data.locations);
        } catch(e) {
            console.error(e);
        }

        document.getElementById('locationsLoading').classList.add('d-none');
    };

    window.onCityChange = async function() {
        const province = document.getElementById('provinceSelect').value;
        const city = document.getElementById('citySelect').value;

        document.getElementById('locationsLoading').classList.remove('d-none');

        try {
            let url = `/api/delivery/locations?province=${encodeURIComponent(province)}`;
            if (city) url += `&city=${encodeURIComponent(city)}`;
            const resp = await fetch(url);
            if (resp.status === 401) { window.location.href = '/auth/login?next=' + encodeURIComponent(window.location.pathname); return; }
            const data = await resp.json();
            renderLocations(data.locations);
        } catch(e) {
            console.error(e);
        }

        document.getElementById('locationsLoading').classList.add('d-none');
    };

    function renderLocations(locations) {
        const container = document.getElementById('locationsList');
        const noLoc = document.getElementById('noLocations');

        // Only show dealers that have stock
        const available = locations.filter(loc => loc.stock > 0);

        if (!available.length) {
            container.innerHTML = '';
            noLoc.classList.remove('d-none');
            return;
        }
        noLoc.classList.add('d-none');

        container.innerHTML = available.map(loc => {
            const hasStock = loc.stock > 0;
            return `
                <div class="col-md-6">
                    <div class="location-card ${hasStock ? '' : 'no-stock'} ${selectedLocationId == loc.id ? 'selected' : ''}"
                         ${hasStock ? `onclick="selectLocation(${loc.id})"` : ''}>
                        <div class="d-flex justify-content-between align-items-start">
                            <div>
                                <div class="fw-bold"><i class="bi bi-shop me-1"></i>${loc.name}</div>
                                <div class="small text-muted">${loc.city}${loc.province ? ' - ' + loc.province : ''}</div>
                                ${loc.address ? `<div class="small text-muted mt-1"><i class="bi bi-geo me-1"></i>${loc.address}</div>` : ''}
                                ${loc.phone ? `<div class="small text-muted" dir="ltr"><i class="bi bi-telephone me-1"></i>${loc.phone}</div>` : ''}
                            </div>
                            <span class="${hasStock ? 'badge-tm badge-tm-success' : 'badge-tm badge-tm-info'}">
                                ${hasStock ? loc.stock + ' Ù…ÙˆØ¬ÙˆØ¯' : 'Ù†Ø§Ù…ÙˆØ¬ÙˆØ¯'}
                            </span>
                        </div>
                    </div>
                </div>`;
        }).join('');
    }

    window.selectLocation = function(id) {
        selectedLocationId = id;
        document.getElementById('pickupLocationInput').value = id;

        // Toggle selected class
        document.querySelectorAll('.location-card').forEach(el => el.classList.remove('selected'));
        event.currentTarget.classList.add('selected');

        updateSubmitButton();
    };

    // ==============================
    // Address Selection (Postal)
    // ==============================
    window.selectAddress = function(id, province, city, address, postalCode) {
        document.getElementById('shippingProvince').value = province;
        document.getElementById('shippingCity').value = city;
        document.getElementById('shippingAddress').value = address;
        document.getElementById('shippingPostalCode').value = postalCode;
        updateSubmitButton();
    };

    // Auto-select default address on load
    const defaultAddr = document.querySelector('input[name="selected_address"]:checked');
    if (defaultAddr) { defaultAddr.closest('.form-check').click(); }

    // ==============================
    // Submit Button State
    // ==============================
    function updateSubmitButton() {
        const btn = document.getElementById('submitBtn');
        let enabled = false;

        if (selectedMethod === 'Pickup') {
            const committed = document.getElementById('commitmentCheck').checked;
            enabled = selectedLocationId && committed;
        } else if (selectedMethod === 'Postal') {
            const addr = document.getElementById('shippingAddress');
            enabled = addr && addr.value.length > 0;
        }

        btn.disabled = !enabled;
    }

    // Listen for commitment checkbox
    document.getElementById('commitmentCheck').addEventListener('change', updateSubmitButton);

    // ==============================
    // Format
    // ==============================
    function formatToman(rial) {
        const toman = Math.floor(rial / 10);
        return toman.toLocaleString('fa-IR');
    }
})();
</script>
{% endblock %}
