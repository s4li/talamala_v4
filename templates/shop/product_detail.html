{% extends "shop/base_shop.html" %}
{% block title %}{{ p.name }} - طلاملا{% endblock %}

{% block shop_css %}
<style>
    .detail-gallery img {
        width: 100%;
        max-height: 500px;
        object-fit: contain;
        border-radius: 12px;
        background: #f8f9fa;
    }
    .gallery-thumbs img {
        width: 70px;
        height: 70px;
        object-fit: cover;
        border-radius: 8px;
        cursor: pointer;
        border: 2px solid transparent;
        transition: border-color 0.2s;
    }
    .gallery-thumbs img:hover,
    .gallery-thumbs img.active {
        border-color: var(--tm-primary);
    }
    .invoice-table td {
        padding: 0.4rem 0;
    }
    .invoice-table .total-row td {
        border-top: 2px solid var(--tm-primary);
        font-weight: bold;
        font-size: 1.1rem;
        padding-top: 0.75rem;
    }
    .review-img { width:64px; height:64px; object-fit:cover; border-radius:8px; cursor:pointer; border:2px solid var(--tm-border); }
    .comment-thread { border-right: 3px solid var(--tm-border); padding-right: 1rem; margin-right: 0.5rem; }
</style>
{% endblock %}

{% block shop_content %}
<!-- Breadcrumb -->
<nav class="mb-3">
    <ol class="breadcrumb small">
        <li class="breadcrumb-item"><a href="/" class="text-decoration-none">فروشگاه</a></li>
        <li class="breadcrumb-item active">{{ p.name }}</li>
    </ol>
</nav>

<div class="row g-4">
    <!-- Gallery -->
    <div class="col-md-5 tm-animate-fade-in">
        <div class="detail-gallery">
            {% if p.images %}
            <img src="/{{ p.images[0].file_path }}" id="mainImage" alt="{{ p.name }}">
            {% if p.images|length > 1 %}
            <div class="gallery-thumbs d-flex gap-2 mt-2 justify-content-center">
                {% for img in p.images %}
                <img src="/{{ img.file_path }}"
                     class="{% if loop.first %}active{% endif %}"
                     onclick="document.getElementById('mainImage').src=this.src; document.querySelectorAll('.gallery-thumbs img').forEach(i=>i.classList.remove('active')); this.classList.add('active');">
                {% endfor %}
            </div>
            {% endif %}
            {% else %}
            <div class="bg-light d-flex align-items-center justify-content-center" style="height:400px;border-radius:12px;">
                <i class="bi bi-image text-muted" style="font-size:5rem;"></i>
            </div>
            {% endif %}
        </div>

        {% if p.description %}
        <div class="card-tm no-hover mt-3">
            <h6 class="fw-bold mb-2"><i class="bi bi-file-text me-1"></i>توضیحات محصول</h6>
            <p class="mb-0 text-muted" style="white-space: pre-line;">{{ p.description }}</p>
        </div>
        {% endif %}
    </div>

    <!-- Product Info -->
    <div class="col-md-7 tm-animate-slide-right tm-delay-2">
        <h3 class="fw-bold">{{ p.name }}</h3>

        <div class="d-flex gap-3 mt-2 mb-3">
            <span class="badge bg-light text-dark border">{{ p.weight }} گرم</span>
            <span class="badge bg-light text-dark border">عیار {{ p.purity|purity }}</span>
            {% if p.design %}
            <span class="badge bg-light text-dark border">{{ p.design }}</span>
            {% endif %}
        </div>

        <!-- Stock -->
        <div class="mb-3">
            {% if inventory > 0 %}
            <span class="badge-tm badge-tm-success"><i class="bi bi-check-circle me-1"></i>{{ inventory }} عدد موجود</span>
            {% else %}
            <span class="badge-tm badge-tm-info"><i class="bi bi-x-circle me-1"></i>ناموجود</span>
            {% endif %}
        </div>

        <!-- Location Availability -->
        {% if location_inventory %}
        <div class="mb-3">
            <h6 class="fw-bold small"><i class="bi bi-geo-alt me-1"></i>محل موجودی:</h6>
            <div class="d-flex flex-wrap gap-2">
                {% for loc in location_inventory %}
                <div class="border rounded-3 p-2 small" style="min-width:140px;">
                    <div class="fw-bold">{{ loc.name }}</div>
                    {% if loc.city %}<div class="text-muted">{{ loc.city }}</div>{% endif %}
                    <span class="badge-tm badge-tm-success mt-1">{{ loc.count }} عدد</span>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Price Breakdown -->
        {% if invoice and not invoice.get('error') %}
        <div class="card-tm no-hover">
            <h6 class="fw-bold mb-3"><i class="bi bi-receipt me-1"></i>ریز قیمت</h6>
            <table class="table table-tm table-borderless invoice-table mb-0">
                <tr>
                    <td class="text-muted">ارزش طلای خام</td>
                    <td class="text-start">{{ invoice.raw_gold | toman }} <small>تومان</small></td>
                </tr>
                {% if invoice.wage %}
                <tr>
                    <td class="text-muted">اجرت ساخت</td>
                    <td class="text-start">{{ invoice.wage | toman }} <small>تومان</small></td>
                </tr>
                {% endif %}
                {% if invoice.tax %}
                <tr>
                    <td class="text-muted">مالیات ({{ tax_percent }}%)</td>
                    <td class="text-start">{{ invoice.tax | toman }} <small>تومان</small></td>
                </tr>
                {% endif %}
                <tr class="total-row">
                    <td class="text-tm-primary">جمع کل</td>
                    <td class="text-start text-tm-primary">{{ invoice.total | toman }} <small>تومان</small></td>
                </tr>
                {% if invoice.wage %}
                <tr>
                    <td class="text-success">
                        <i class="bi bi-arrow-repeat me-1"></i>مبلغ بازخرید
                        <i class="bi bi-exclamation-circle-fill text-warning ms-1"
                           style="cursor:pointer;"
                           data-bs-toggle="tooltip"
                           data-bs-placement="top"
                           title="این مبلغ در زمان فروش بصورت اعتبار کیف پول جهت خرید‌های دیگر به حساب شما واریز می‌گردد"></i>
                    </td>
                    <td class="text-start text-success">{{ invoice.wage | toman }} <small>تومان</small></td>
                </tr>
                {% endif %}
            </table>
        </div>
        {% endif %}

        <!-- Package Selection -->
        {% if packages %}
        <div class="card-tm no-hover mt-3">
            <h6 class="fw-bold mb-3"><i class="bi bi-gift me-1"></i>انتخاب بسته‌بندی</h6>
            <div class="d-flex flex-column gap-2" id="packageOptions">
                <label class="d-flex align-items-center gap-3 p-2 border rounded-3 border-warning bg-warning-subtle package-option"
                       style="cursor:pointer;">
                    <input type="radio" name="package_choice" value="" checked class="form-check-input"
                           onchange="selectPackage(this)">
                    <div class="flex-grow-1">
                        <span class="fw-bold small">بدون بسته‌بندی خاص</span>
                        <div class="text-muted" style="font-size:0.75rem;">بسته‌بندی استاندارد</div>
                    </div>
                    <span class="text-success fw-bold small">رایگان</span>
                </label>
                {% for pkg in packages %}
                <label class="d-flex align-items-center gap-3 p-2 border rounded-3 package-option"
                       style="cursor:pointer;">
                    <input type="radio" name="package_choice" value="{{ pkg.id }}" class="form-check-input"
                           onchange="selectPackage(this)">
                    {% if pkg.default_image %}
                    <img src="/{{ pkg.default_image }}" style="width:48px;height:48px;object-fit:cover;border-radius:8px;cursor:zoom-in;" alt="{{ pkg.name }}"
                         onclick="event.preventDefault(); event.stopPropagation(); openPkgGallery({{ pkg.id }})">
                    {% endif %}
                    <div class="flex-grow-1">
                        <span class="fw-bold small">{{ pkg.name }}</span>
                    </div>
                    {% if pkg.price > 0 %}
                    <span class="text-tm-primary fw-bold small">{{ pkg.price | toman }} تومان</span>
                    {% else %}
                    <span class="text-success fw-bold small">رایگان</span>
                    {% endif %}
                </label>
                {% endfor %}
            </div>
        </div>
        {% endif %}

        <!-- Add to Cart -->
        <div class="mt-3">
            {% if inventory > 0 and gold_price %}
                {% set in_cart = cart_map.get(p.id, 0) %}
                {% if in_cart %}
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <form method="POST" action="/cart/update">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <input type="hidden" name="product_id" value="{{ p.id }}">
                        <input type="hidden" name="action" value="decrease">
                        <button class="btn btn-lg btn-tm-danger"><i class="bi bi-dash-lg"></i></button>
                    </form>
                    <span class="fs-4 fw-bold">{{ in_cart }}</span>
                    <form method="POST" action="/cart/update">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <input type="hidden" name="product_id" value="{{ p.id }}">
                        <input type="hidden" name="action" value="increase">
                        <input type="hidden" name="package_type_id" class="pkg-hidden" value="">
                        <button class="btn btn-lg btn-tm-success"><i class="bi bi-plus-lg"></i></button>
                    </form>
                    <a href="/cart" class="btn btn-lg btn-tm-primary flex-grow-1">
                        <i class="bi bi-cart-check me-1"></i> مشاهده سبد
                    </a>
                </div>
                {% else %}
                <form method="POST" action="/cart/update">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="product_id" value="{{ p.id }}">
                    <input type="hidden" name="action" value="increase">
                    <input type="hidden" name="package_type_id" class="pkg-hidden" value="">
                    <button class="btn btn-lg btn-tm-primary w-100 w-sm-auto">
                        <i class="bi bi-cart-plus me-1"></i> افزودن به سبد خرید
                    </button>
                </form>
                {% endif %}
            {% else %}
            <button class="btn btn-lg btn-tm-outline" disabled>
                <i class="bi bi-x-circle me-1"></i> ناموجود
            </button>
            {% endif %}
        </div>
    </div>
</div>

<!-- ========================= REVIEWS ========================= -->
{% if reviews %}
<div class="mt-4">
    <div class="card-tm no-hover">
        <h5 class="fw-bold mb-3"><i class="bi bi-star me-2"></i>دیدگاه خریداران
            {% if review_stats.count %}<span class="badge bg-warning text-dark ms-2">{{ review_stats.avg }} از ۵ ({{ review_stats.count }} نظر)</span>{% endif %}
        </h5>
        {% for r in reviews %}
        <div class="pb-3 mb-3 {% if not loop.last %}border-bottom{% endif %}">
            <div class="d-flex justify-content-between align-items-start mb-1">
                <div>
                    <span class="text-warning">{% for i in range(1,6) %}<i class="bi bi-star{% if i <= r.rating %}-fill{% endif %}"></i>{% endfor %}</span>
                    <span class="fw-bold small ms-2">{{ r.customer.full_name if r.customer else 'مشتری' }}</span>
                </div>
                <span class="text-muted small">{{ r.created_at | jdate }}</span>
            </div>
            <p class="mb-1">{{ r.body }}</p>
            {% if r.images %}
            <div class="d-flex gap-2 flex-wrap mb-2">
                {% for img in r.images %}
                <img src="/{{ img.file_path }}" class="review-img" alt="تصویر">
                {% endfor %}
            </div>
            {% endif %}
            {% if r.admin_reply %}
            <div class="p-2 bg-success bg-opacity-10 rounded-3 mt-2 small">
                <span class="badge-tm badge-tm-success me-1">پشتیبانی</span>{{ r.admin_reply }}
            </div>
            {% endif %}
        </div>
        {% endfor %}
    </div>
</div>
{% endif %}

<!-- ========================= COMMENTS & Q&A ========================= -->
<div class="mt-4" id="comments">
    <div class="card-tm no-hover mb-4">
        <h5 class="fw-bold mb-3"><i class="bi bi-chat-dots me-2"></i>نظرات و دیدگاه‌ها</h5>

        {% if user and not user.is_staff %}
        <form method="POST" action="/reviews/comment" enctype="multipart/form-data">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <input type="hidden" name="product_id" value="{{ p.id }}">
            <div class="mb-2">
                <textarea name="body" class="form-control form-control-tm" rows="3" placeholder="سوال یا نظر خود را بنویسید..." required></textarea>
            </div>
            {% if has_purchased %}
            <div class="mb-2">
                <label class="form-label-tm small">تصاویر (اختیاری)</label>
                <input type="file" name="files" class="form-control form-control-tm form-control-sm" accept="image/*" multiple>
            </div>
            {% endif %}
            <button type="submit" class="btn btn-tm-primary">
                <i class="bi bi-send me-1"></i>ارسال نظر
            </button>
        </form>
        {% elif not user %}
        <div class="alert-tm-warning py-2 small">
            <i class="bi bi-info-circle me-1"></i>
            برای ثبت نظر ابتدا <a href="/auth/login?next=/product/{{ p.id }}" class="fw-bold">وارد شوید</a>.
        </div>
        {% endif %}
    </div>

    {% if product_comments %}
    {% for c in product_comments %}
    <div class="card-tm no-hover mb-3" {% if c.is_admin %}style="border-right:3px solid var(--tm-positive);background:rgba(var(--tm-positive-rgb,40,167,69),0.07);"{% endif %}>
        <div class="d-flex justify-content-between align-items-start mb-2">
            <div>
                <span class="badge-tm badge-tm-{{ c.sender_badge_color }} me-1">{{ c.sender_type_label }}</span>
                <span class="fw-bold small">{{ c.sender_name }}</span>
            </div>
            <span class="text-muted small">{{ c.created_at | jdate }}</span>
        </div>
        <p class="mb-2">{{ c.body }}</p>
        {% if c.images %}
        <div class="d-flex gap-2 flex-wrap mb-2">
            {% for img in c.images %}
            <img src="/{{ img.file_path }}" class="review-img" alt="تصویر">
            {% endfor %}
        </div>
        {% endif %}

        <!-- Like button for parent comment -->
        {% set cl = comment_likes.get(c.id, {"count": 0, "liked": false}) %}
        <button class="btn btn-sm {% if cl.liked %}btn-tm-primary{% else %}btn-tm-outline{% endif %} like-btn"
                data-comment-id="{{ c.id }}" onclick="toggleLike(this)">
            <i class="bi {% if cl.liked %}bi-heart-fill{% else %}bi-heart{% endif %} me-1"></i>
            <span class="like-count">{{ cl.count }}</span>
        </button>

        {% if c.replies %}
        <div class="comment-thread mt-3">
            {% for reply in c.replies %}
            <div class="mb-2 pb-2 {% if not loop.last %}border-bottom{% endif %}" {% if reply.is_admin %}style="border-right:3px solid var(--tm-positive);background:rgba(var(--tm-positive-rgb,40,167,69),0.07);padding:0.5rem;border-radius:8px;"{% endif %}>
                <div class="d-flex justify-content-between align-items-start mb-1">
                    <div>
                        <span class="badge-tm badge-tm-{{ reply.sender_badge_color }} me-1">{{ reply.sender_type_label }}</span>
                        <span class="fw-bold small">{{ reply.sender_name }}</span>
                    </div>
                    <span class="text-muted small">{{ reply.created_at | jdate }}</span>
                </div>
                <p class="mb-1 small">{{ reply.body }}</p>
                <!-- Like button for reply -->
                {% set rl = comment_likes.get(reply.id, {"count": 0, "liked": false}) %}
                <button class="btn btn-sm {% if rl.liked %}btn-tm-primary{% else %}btn-tm-outline{% endif %} like-btn"
                        data-comment-id="{{ reply.id }}" onclick="toggleLike(this)" style="font-size:0.75rem;">
                    <i class="bi {% if rl.liked %}bi-heart-fill{% else %}bi-heart{% endif %} me-1"></i>
                    <span class="like-count">{{ rl.count }}</span>
                </button>
            </div>
            {% endfor %}
        </div>
        {% endif %}

        {% if user and not user.is_staff %}
        <div class="mt-2">
            <button class="btn btn-sm btn-tm-outline" type="button"
                    data-bs-toggle="collapse" data-bs-target="#reply-{{ c.id }}">
                <i class="bi bi-reply me-1"></i>پاسخ
            </button>
            <div class="collapse mt-2" id="reply-{{ c.id }}">
                <form method="POST" action="/reviews/comment" enctype="multipart/form-data">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <input type="hidden" name="product_id" value="{{ p.id }}">
                    <input type="hidden" name="parent_id" value="{{ c.id }}">
                    <div class="mb-2">
                        <textarea name="body" class="form-control form-control-tm form-control-sm" rows="2" placeholder="پاسخ خود را بنویسید..." required></textarea>
                    </div>
                    {% if has_purchased %}
                    <input type="file" name="files" class="form-control form-control-tm form-control-sm mb-2" accept="image/*" multiple>
                    {% endif %}
                    <button type="submit" class="btn btn-sm btn-tm-primary">
                        <i class="bi bi-send me-1"></i>ارسال
                    </button>
                </form>
            </div>
        </div>
        {% endif %}
    </div>
    {% endfor %}
    {% endif %}
<!-- Package Image Modal -->
<div class="modal fade" id="pkgImageModal" tabindex="-1">
    <div class="modal-dialog modal-dialog-centered modal-lg">
        <div class="modal-content" style="border-radius:16px;overflow:hidden;background:var(--tm-info-900);">
            <div class="modal-header border-0 pb-0">
                <h6 class="modal-title fw-bold" id="pkgModalTitle"></h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center p-3">
                <img id="pkgModalImg" src="" alt="" style="max-width:100%;max-height:70vh;border-radius:12px;object-fit:contain;">
                <div id="pkgModalThumbs" class="d-flex justify-content-center gap-2 mt-3 flex-wrap"></div>
            </div>
        </div>
    </div>
</div>

</div>
{% endblock %}

{% block shop_js %}
<script>
    document.querySelectorAll('[data-bs-toggle="tooltip"]').forEach(function(el) {
        new bootstrap.Tooltip(el);
    });

    var pkgImages = {
        {% for pkg in packages %}
        {{ pkg.id }}: { name: "{{ pkg.name }}", images: [{% for img in pkg.images %}"/{{ img.file_path }}"{% if not loop.last %},{% endif %}{% endfor %}] },
        {% endfor %}
    };

    function openPkgGallery(pkgId) {
        var data = pkgImages[pkgId];
        if (!data || data.images.length === 0) return;
        document.getElementById('pkgModalTitle').textContent = data.name;
        document.getElementById('pkgModalImg').src = data.images[0];
        var thumbsEl = document.getElementById('pkgModalThumbs');
        thumbsEl.innerHTML = '';
        if (data.images.length > 1) {
            data.images.forEach(function(src, i) {
                var thumb = document.createElement('img');
                thumb.src = src;
                thumb.style.cssText = 'width:56px;height:56px;object-fit:cover;border-radius:8px;cursor:pointer;border:2px solid ' + (i === 0 ? 'var(--tm-primary)' : 'transparent');
                thumb.onclick = function() {
                    document.getElementById('pkgModalImg').src = src;
                    thumbsEl.querySelectorAll('img').forEach(function(t) { t.style.borderColor = 'transparent'; });
                    thumb.style.borderColor = 'var(--tm-primary)';
                };
                thumbsEl.appendChild(thumb);
            });
        }
        new bootstrap.Modal(document.getElementById('pkgImageModal')).show();
    }

    function selectPackage(radio) {
        document.querySelectorAll('.package-option').forEach(function(el) {
            el.classList.remove('border-warning', 'bg-warning-subtle');
        });
        radio.closest('.package-option').classList.add('border-warning', 'bg-warning-subtle');
        document.querySelectorAll('.pkg-hidden').forEach(function(h) {
            h.value = radio.value;
        });
    }

    function toggleLike(btn) {
        var commentId = btn.getAttribute('data-comment-id');
        fetch('/reviews/comment/' + commentId + '/like', { method: 'POST' })
            .then(function(res) {
                if (res.status === 401 || res.status === 403) {
                    window.location.href = '/auth/login?next=/product/{{ p.id }}';
                    return null;
                }
                return res.json();
            })
            .then(function(data) {
                if (!data) return;
                var icon = btn.querySelector('i');
                var countEl = btn.querySelector('.like-count');
                countEl.textContent = data.count;
                if (data.liked) {
                    btn.classList.remove('btn-tm-outline');
                    btn.classList.add('btn-tm-primary');
                    icon.classList.remove('bi-heart');
                    icon.classList.add('bi-heart-fill');
                } else {
                    btn.classList.remove('btn-tm-primary');
                    btn.classList.add('btn-tm-outline');
                    icon.classList.remove('bi-heart-fill');
                    icon.classList.add('bi-heart');
                }
            });
    }
</script>
{% endblock %}
