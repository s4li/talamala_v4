{% extends "shop/base_shop.html" %}
{% block title %}Ø³ÙØ§Ø±Ø´ #{{ order.id }} - Ø·Ù„Ø§Ù…Ù„Ø§{% endblock %}

{% block shop_css %}
<style>
    .invoice-card { border-radius: 12px; }
    .item-row { border-bottom: 1px solid #f0f0f0; }
    .item-row:last-child { border-bottom: none; }
    .btn-breakdown {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        border: none;
        background: linear-gradient(135deg, #f8f4ef, #f1ebe2);
        color: #8b7355;
        font-size: 0.78rem;
        font-weight: 600;
        padding: 4px 12px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.25s ease;
    }
    .btn-breakdown:hover {
        background: linear-gradient(135deg, #f1ebe2, #e8dfd3);
        color: #6b5a42;
    }
    .btn-breakdown i {
        font-size: 0.7rem;
        transition: transform 0.3s ease;
    }
    .btn-breakdown[aria-expanded="true"] i {
        transform: rotate(180deg);
    }
    .breakdown-panel {
        background: linear-gradient(135deg, #fdfbf8, #f9f5ef);
        border-radius: 10px;
        border: 1px solid #f0e8db;
        padding: 12px 14px;
        margin-top: 8px;
    }
    .breakdown-panel .breakdown-item {
        display: flex;
        justify-content: space-between;
        padding: 3px 0;
        font-size: 0.82rem;
        color: #6b5a42;
    }
    .breakdown-panel .breakdown-item + .breakdown-item {
        border-top: 1px dashed #efe7da;
    }
    .star-rating { display:flex; flex-direction:row-reverse; gap:4px; justify-content:flex-end; }
    .star-rating input { display:none; }
    .star-rating label { cursor:pointer; font-size:1.5rem; color:#ddd; transition:color 0.15s; }
    .star-rating input:checked ~ label, .star-rating label:hover, .star-rating label:hover ~ label { color:#f5a623; }
    .review-img { width:64px; height:64px; object-fit:cover; border-radius:8px; border:2px solid var(--tm-border); }
    @media print {
        .no-print { display: none !important; }
        .shop-navbar, footer, .gold-price-banner { display: none !important; }
    }
</style>
{% endblock %}

{% block shop_content %}
<!-- Breadcrumb -->
<nav class="mb-3 no-print">
    <ol class="breadcrumb small">
        <li class="breadcrumb-item"><a href="/orders" class="text-decoration-none">Ø³ÙØ§Ø±Ø´Ø§Øª</a></li>
        <li class="breadcrumb-item active">Ø³ÙØ§Ø±Ø´ #{{ order.id }}</li>
    </ol>
</nav>

{% if msg %}<div class="alert-tm-success py-2 no-print">{{ msg }}</div>{% endif %}
{% if error %}<div class="alert-tm-danger py-2 no-print"><i class="bi bi-exclamation-triangle me-1"></i>{{ error }}</div>{% endif %}

<div class="row g-4">
    <!-- Order Info -->
    <div class="col-lg-8 tm-animate-fade-in-up">
        <div class="card-tm no-hover invoice-card">
            <div class="border-bottom pb-3 mb-3 d-flex justify-content-between align-items-center py-3">
                <div>
                    <h5 class="fw-bold mb-0">ÙØ§Ú©ØªÙˆØ± Ø³ÙØ§Ø±Ø´ #{{ order.id }}</h5>
                    <small class="text-muted">{{ order.created_at | jdate if order.created_at else '' }}</small>
                </div>
                <span class="badge-tm badge-tm-{{ order.status_color }} fs-6">{{ order.status_label }}</span>
            </div>

            <!-- Buyer / Seller Info -->
            <div class="row g-3 mb-3">
                <div class="col-sm-6">
                    <div class="bg-light rounded-3 p-3 h-100">
                        <div class="fw-bold small mb-2"><i class="bi bi-shop me-1"></i>ÙØ±ÙˆØ´Ù†Ø¯Ù‡</div>
                        <div class="small">
                            <div class="fw-bold">{{ get_setting_value('site_name', 'Ø·Ù„Ø§Ù…Ù„Ø§') }}</div>
                            {% set seller_phone = get_setting_value('support_phone', '') %}
                            {% if seller_phone %}<div class="text-muted mt-1"><i class="bi bi-telephone me-1"></i><span dir="ltr">{{ seller_phone }}</span></div>{% endif %}
                            {% set seller_telegram = get_setting_value('support_telegram', '') %}
                            {% if seller_telegram %}<div class="text-muted"><i class="bi bi-send me-1"></i>{{ seller_telegram }}</div>{% endif %}
                        </div>
                    </div>
                </div>
                {% if order.customer %}
                <div class="col-sm-6">
                    <div class="bg-light rounded-3 p-3 h-100">
                        <div class="fw-bold small mb-2"><i class="bi bi-person me-1"></i>Ø®Ø±ÛŒØ¯Ø§Ø±</div>
                        <div class="small">
                            {% if order.customer.customer_type == 'legal' and order.customer.company_name %}
                            <div class="fw-bold">{{ order.customer.company_name }}</div>
                            {% else %}
                            <div class="fw-bold">{{ order.customer.full_name }}</div>
                            {% endif %}
                            {% if order.customer.national_id %}<div class="text-muted mt-1"><i class="bi bi-card-text me-1"></i>{{ 'Ø´Ù†Ø§Ø³Ù‡ Ù…Ù„ÛŒ' if order.customer.customer_type == 'legal' else 'Ú©Ø¯ Ù…Ù„ÛŒ' }}: <span dir="ltr">{{ order.customer.national_id }}</span></div>{% endif %}
                            <div class="text-muted"><i class="bi bi-phone me-1"></i><span dir="ltr">{{ order.customer.mobile }}</span></div>
                            {% if order.customer.address %}<div class="text-muted"><i class="bi bi-geo-alt me-1"></i>{{ order.customer.address }}</div>{% endif %}
                            {% if order.customer.postal_code %}<div class="text-muted"><i class="bi bi-mailbox me-1"></i>Ú©Ø¯ Ù¾Ø³ØªÛŒ: <span dir="ltr">{{ order.customer.postal_code }}</span></div>{% endif %}
                        </div>
                    </div>
                </div>
                {% endif %}
            </div>

            <!-- Header Row -->
            <div class="d-flex px-3 py-2 bg-light fw-bold small text-muted">
                <div style="flex:3;">Ù…Ø­ØµÙˆÙ„</div>
                <div style="flex:1;" class="text-center">ÙˆØ²Ù†</div>
                <div style="flex:1;" class="text-center">Ø¹ÛŒØ§Ø±</div>
                <div style="flex:2;" class="text-end">Ù…Ø¨Ù„Øº</div>
            </div>

            <!-- Items -->
            {% for item in order.items %}
            <div class="d-flex align-items-center px-3 py-3 item-row">
                <div style="flex:3;">
                    <div class="fw-bold">{{ item.product.name if item.product else 'Ù…Ø­ØµÙˆÙ„ Ø­Ø°Ùâ€ŒØ´Ø¯Ù‡' }}</div>
                    {% if order.status == 'Paid' and item.bar %}
                    <small class="text-muted">
                        Ø³Ø±ÛŒØ§Ù„ Ø´Ù…Ø´: <code>{{ item.bar.serial_code }}</code>
                    </small>
                    {% endif %}
                    {% if item.package_type %}
                    <small class="text-muted d-block">
                        <i class="bi bi-gift me-1"></i>Ø¨Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ: {{ item.package_type.name }}
                        {% if item.applied_package_price > 0 %}
                        ({{ item.applied_package_price | toman }} ØªÙˆÙ…Ø§Ù†)
                        {% endif %}
                    </small>
                    {% endif %}
                </div>
                <div style="flex:1;" class="text-center">{{ item.applied_weight }}g</div>
                <div style="flex:1;" class="text-center">{{ item.applied_purity|purity }}</div>
                <div style="flex:2;" class="text-end">
                    <div class="fw-bold">{{ item.line_total | toman }} <small class="text-muted">ØªÙˆÙ…Ø§Ù†</small></div>
                </div>
            </div>

            <!-- Detailed breakdown (collapsed) -->
            <div class="px-3 pb-2">
                <button class="btn-breakdown no-print"
                        type="button" data-bs-toggle="collapse" data-bs-target="#detail-{{ item.id }}"
                        aria-expanded="false" aria-controls="detail-{{ item.id }}">
                    <i class="bi bi-chevron-down"></i>
                    Ø±ÛŒØ² Ù‚ÛŒÙ…Øª
                </button>
                <div class="collapse" id="detail-{{ item.id }}">
                    <div class="breakdown-panel">
                        <div class="breakdown-item">
                            <span>Ø·Ù„Ø§ÛŒ Ø®Ø§Ù…</span>
                            <span>{{ item.final_gold_amount | toman }} ØªÙˆÙ…Ø§Ù†</span>
                        </div>
                        <div class="breakdown-item">
                            <span>Ø§Ø¬Ø±Øª</span>
                            <span>{{ item.final_wage_amount | toman }} ØªÙˆÙ…Ø§Ù†</span>
                        </div>
                        <div class="breakdown-item">
                            <span>Ù…Ø§Ù„ÛŒØ§Øª ({{ item.applied_tax_percent }}%)</span>
                            <span>{{ item.final_tax_amount | toman }} ØªÙˆÙ…Ø§Ù†</span>
                        </div>
                        {% if item.applied_package_price > 0 %}
                        <div class="breakdown-item">
                            <span>Ø¨Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ ({{ item.package_type.name if item.package_type else '' }})</span>
                            <span>{{ item.applied_package_price | toman }} ØªÙˆÙ…Ø§Ù†</span>
                        </div>
                        {% endif %}
                        <div class="breakdown-item">
                            <span>Ù‚ÛŒÙ…Øª Ø·Ù„Ø§</span>
                            <span>{{ item.applied_gold_price | toman }} ØªÙˆÙ…Ø§Ù†/Ú¯Ø±Ù…</span>
                        </div>
                    </div>
                </div>
            </div>
            {% endfor %}

            <!-- Reviews for Paid Orders -->
            {% if order.status == 'Paid' and not user.is_staff and item_reviews is defined %}
            <div class="px-3 py-3 bg-light rounded-3 mb-2">
                <h6 class="fw-bold mb-3"><i class="bi bi-star me-1"></i>Ø«Ø¨Øª Ù†Ø¸Ø± Ø¨Ø±Ø§ÛŒ Ù…Ø­ØµÙˆÙ„Ø§Øª</h6>
                {% for item in order.items %}
                <div class="mb-3 pb-3 {% if not loop.last %}border-bottom{% endif %}">
                    <div class="fw-bold small mb-2">{{ item.product.name if item.product else '' }}</div>
                    {% if item_reviews.get(item.id) %}
                    {% set rv = item_reviews[item.id] %}
                    <div class="p-2 bg-success bg-opacity-10 rounded-3 small">
                        <span class="text-warning">{% for i in range(1,6) %}<i class="bi bi-star{% if i <= rv.rating %}-fill{% endif %}"></i>{% endfor %}</span>
                        <span class="ms-2">{{ rv.body }}</span>
                    </div>
                    {% else %}
                    <form method="POST" action="/reviews/submit" enctype="multipart/form-data">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                        <input type="hidden" name="order_item_id" value="{{ item.id }}">
                        <input type="hidden" name="product_id" value="{{ item.product_id }}">
                        <input type="hidden" name="order_id" value="{{ order.id }}">
                        <div class="star-rating mb-2">
                            {% for i in [5,4,3,2,1] %}
                            <input type="radio" id="star-{{ item.id }}-{{ i }}" name="rating" value="{{ i }}">
                            <label for="star-{{ item.id }}-{{ i }}"><i class="bi bi-star-fill"></i></label>
                            {% endfor %}
                        </div>
                        <div class="text-danger small d-none mb-1 review-error"></div>
                        <textarea name="body" class="form-control form-control-tm form-control-sm mb-2" rows="2" placeholder="Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯..."></textarea>
                        <input type="file" name="files" class="form-control form-control-tm form-control-sm mb-2" accept="image/*" multiple>
                        <button type="submit" class="btn btn-sm btn-tm-primary"><i class="bi bi-send me-1"></i>Ø«Ø¨Øª Ù†Ø¸Ø±</button>
                    </form>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Totals -->
            <div class="border-top pt-3 mt-3">
                {% if order.promo_amount %}
                <div class="d-flex justify-content-between mb-1">
                    <span class="text-muted">
                        {% if order.promo_choice == 'DISCOUNT' %}ØªØ®ÙÛŒÙ{% else %}Ú©Ø´Ø¨Ú©{% endif %}
                        {% if order.coupon_code %}<small>({{ order.coupon_code }})</small>{% endif %}
                    </span>
                    <span class="text-success">âˆ’{{ order.promo_amount | toman }} ØªÙˆÙ…Ø§Ù†</span>
                </div>
                {% endif %}
                {% if order.shipping_cost %}
                <div class="d-flex justify-content-between mb-1">
                    <span class="text-muted">Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø±Ø³Ø§Ù„</span>
                    <span>{{ order.shipping_cost | toman }} ØªÙˆÙ…Ø§Ù†</span>
                </div>
                {% endif %}
                {% if order.insurance_cost %}
                <div class="d-flex justify-content-between mb-1">
                    <span class="text-muted">Ø¨ÛŒÙ…Ù‡</span>
                    <span>{{ order.insurance_cost | toman }} ØªÙˆÙ…Ø§Ù†</span>
                </div>
                {% endif %}
                <div class="d-flex justify-content-between">
                    <span class="fw-bold fs-5">Ø¬Ù…Ø¹ Ù‚Ø§Ø¨Ù„ Ù¾Ø±Ø¯Ø§Ø®Øª</span>
                    <span class="fw-bold fs-5 text-tm-primary">{{ order.grand_total | toman }} <small>ØªÙˆÙ…Ø§Ù†</small></span>
                </div>
            </div>
        </div>
    </div>

    <!-- Side Panel -->
    <div class="col-lg-4 tm-animate-slide-right tm-delay-3">
        <!-- Actions -->
        <div class="card-tm no-hover no-print">
            {% if order.status == 'Pending' %}
            <div class="alert-tm-warning py-2 small mb-3">
                <i class="bi bi-clock me-1"></i>
                Ø§ÛŒÙ† Ø³ÙØ§Ø±Ø´ Ø¯Ø± Ø§Ù†ØªØ¸Ø§Ø± Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø³Øª. Ø´Ù…Ø´â€ŒÙ‡Ø§ Ø¨Ù‡ Ù…Ø¯Øª Ù…Ø­Ø¯ÙˆØ¯ Ø±Ø²Ø±Ùˆ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯.
            </div>

            {% if order.grand_total == 0 %}
            <!-- Free order (100% discount) -->
            <div class="alert-tm-success py-2 small mb-3">
                <i class="bi bi-gift me-1"></i>
                Ø§ÛŒÙ† Ø³ÙØ§Ø±Ø´ Ø¨Ø§ ØªØ®ÙÛŒÙ Û±Û°Û°Ùª Ø±Ø§ÛŒÚ¯Ø§Ù† Ø´Ø¯Ù‡ Ø§Ø³Øª.
            </div>
            <form method="POST" action="/payment/{{ order.id }}/wallet"
                  onsubmit="return confirm('Ø¢ÛŒØ§ Ø§Ø² ØªØ£ÛŒÛŒØ¯ Ø³ÙØ§Ø±Ø´ Ø±Ø§ÛŒÚ¯Ø§Ù† Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ØŸ')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button class="btn btn-tm-primary w-100 mb-2">
                    <i class="bi bi-check-circle me-1"></i> ØªØ£ÛŒÛŒØ¯ Ùˆ Ø«Ø¨Øª Ù†Ù‡Ø§ÛŒÛŒ Ø³ÙØ§Ø±Ø´
                </button>
            </form>
            {% else %}
            <!-- Pay from Wallet -->
            {% if wallet_balance and wallet_balance.available >= order.grand_total %}
            <form method="POST" action="/payment/{{ order.id }}/wallet"
                  onsubmit="return confirm('Ø¢ÛŒØ§ Ø§Ø² Ù¾Ø±Ø¯Ø§Ø®Øª {{ order.grand_total | toman }} ØªÙˆÙ…Ø§Ù† Ø§Ø² Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ØŸ')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button class="btn btn-tm-primary w-100 mb-1">
                    <i class="bi bi-wallet2 me-1"></i> Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø² Ú©ÛŒÙ Ù¾ÙˆÙ„
                </button>
            </form>
            <div class="text-center text-muted mb-2" style="font-size:0.75rem;">
                Ù…ÙˆØ¬ÙˆØ¯ÛŒ: {{ wallet_balance.available | toman }} ØªÙˆÙ…Ø§Ù†
            </div>
            {% else %}
            <div class="mb-2">
                <button class="btn btn-tm-outline w-100" disabled>
                    <i class="bi bi-wallet2 me-1"></i> Ù¾Ø±Ø¯Ø§Ø®Øª Ø§Ø² Ú©ÛŒÙ Ù¾ÙˆÙ„
                </button>
                <div class="text-center mt-1" style="font-size:0.75rem;">
                    {% if wallet_balance %}
                    <div class="text-danger">Ù…ÙˆØ¬ÙˆØ¯ÛŒ: {{ wallet_balance.available | toman }} ØªÙˆÙ…Ø§Ù†</div>
                    <div class="text-danger">Ú©Ø³Ø±ÛŒ: {{ (order.grand_total - wallet_balance.available) | toman }} ØªÙˆÙ…Ø§Ù†</div>
                    {% else %}
                    <span class="text-danger">Ú©ÛŒÙ Ù¾ÙˆÙ„ Ø®Ø§Ù„ÛŒ Ø§Ø³Øª</span>
                    {% endif %}
                </div>
                <a href="/wallet" class="btn btn-sm btn-tm-success w-100 mt-1">
                    <i class="bi bi-plus-circle me-1"></i> Ø´Ø§Ø±Ú˜ Ú©ÛŒÙ Ù¾ÙˆÙ„
                </a>
            </div>
            {% endif %}

            <!-- Gateway Payment -->
            <form method="POST" action="/payment/{{ order.id }}/zibal">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button class="btn btn-tm-outline w-100 mb-2">
                    <i class="bi bi-credit-card me-1"></i> Ù¾Ø±Ø¯Ø§Ø®Øª Ø¢Ù†Ù„Ø§ÛŒÙ†
                </button>
            </form>
            {% endif %}

            <hr class="my-2">

            <form method="POST" action="/orders/{{ order.id }}/cancel"
                  onsubmit="return confirm('Ø¢ÛŒØ§ Ø§Ø² Ù„ØºÙˆ Ø³ÙØ§Ø±Ø´ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ØŸ Ø´Ù…Ø´â€ŒÙ‡Ø§ Ø¢Ø²Ø§Ø¯ Ø®ÙˆØ§Ù‡Ù†Ø¯ Ø´Ø¯.')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button class="btn btn-tm-danger w-100">
                    <i class="bi bi-x-lg me-1"></i> Ù„ØºÙˆ Ø³ÙØ§Ø±Ø´
                </button>
            </form>

            {% elif order.status == 'Paid' %}
            {% if order.is_gift %}
            <div class="alert-tm-success py-2 small mb-3">
                <i class="bi bi-gift me-1"></i>
                Ø³ÙØ§Ø±Ø´ Ù‡Ø¯ÛŒÙ‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ù¾Ø±Ø¯Ø§Ø®Øª Ø´Ø¯.
            </div>
            <div class="card-tm no-hover border border-warning mb-3 p-3">
                <div class="fw-bold small mb-2">
                    <i class="bi bi-key me-1 text-warning"></i>
                    Ú©Ø¯ Ø«Ø¨Øª Ù…Ø§Ù„Ú©ÛŒØª â€” Ø¨Ù‡ Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ù‡Ø¯ÛŒÙ‡ Ø¨Ø¯Ù‡ÛŒØ¯
                </div>
                {% for item in order.items %}
                {% if item.bar and item.bar.claim_code %}
                <div class="d-flex justify-content-between align-items-center py-2 {% if not loop.last %}border-bottom{% endif %}">
                    <div>
                        <small class="text-muted">{{ item.product.name if item.product else '' }}</small>
                        <div class="font-monospace small" dir="ltr">{{ item.bar.serial_code }}</div>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-warning text-dark fs-6 font-monospace px-3">{{ item.bar.claim_code }}</span>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
                <div class="mt-2 small text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    Ú¯ÛŒØ±Ù†Ø¯Ù‡ Ø¨Ø§ Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ø¨Ù‡ <strong>Ø«Ø¨Øª Ù…Ø§Ù„Ú©ÛŒØª</strong> Ùˆ ÙˆØ§Ø±Ø¯ Ú©Ø±Ø¯Ù† Ø³Ø±ÛŒØ§Ù„ + Ú©Ø¯ Ø¨Ø§Ù„Ø§ØŒ Ù…Ø§Ù„Ú© Ø´Ù…Ø´ Ù…ÛŒâ€ŒØ´ÙˆØ¯.
                </div>
            </div>
            {% else %}
            <div class="alert-tm-success py-2 small mb-3">
                <i class="bi bi-check-circle me-1"></i>
                Ù¾Ø±Ø¯Ø§Ø®Øª Ù…ÙˆÙÙ‚. Ø´Ù…Ø´â€ŒÙ‡Ø§ Ø¨Ù‡ Ù†Ø§Ù… Ø´Ù…Ø§ Ø«Ø¨Øª Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯.
            </div>
            {% endif %}
            {% if order.payment_method %}
            <div class="small text-muted mb-2">
                <div><strong>Ø±ÙˆØ´ Ù¾Ø±Ø¯Ø§Ø®Øª:</strong>
                    {% if order.payment_method == 'wallet' %}Ú©ÛŒÙ Ù¾ÙˆÙ„
                    {% elif 'zibal' in (order.payment_method or '') %}Ø¯Ø±Ú¯Ø§Ù‡ Ø²ÛŒØ¨Ø§Ù„
                    {% elif 'sepehr' in (order.payment_method or '') %}Ø¯Ø±Ú¯Ø§Ù‡ Ø³Ù¾Ù‡Ø±
                    {% else %}{{ order.payment_method }}{% endif %}
                </div>
                {% if order.payment_ref %}<div><strong>Ø´Ù…Ø§Ø±Ù‡ Ù…Ø±Ø¬Ø¹:</strong> <code>{{ order.payment_ref }}</code></div>{% endif %}
                {% if order.paid_at %}<div><strong>ØªØ§Ø±ÛŒØ® Ù¾Ø±Ø¯Ø§Ø®Øª:</strong> {{ order.paid_at | jdate }}</div>{% endif %}
            </div>
            {% endif %}
            <button class="btn btn-tm-outline w-100" onclick="window.print()">
                <i class="bi bi-printer me-1"></i> Ú†Ø§Ù¾ ÙØ§Ú©ØªÙˆØ±
            </button>

            {% elif order.status == 'Cancelled' %}
            <div class="alert-tm-danger py-2 small mb-3">
                <i class="bi bi-x-circle me-1"></i>
                Ø³ÙØ§Ø±Ø´ Ù„ØºÙˆ Ø´Ø¯Ù‡ Ùˆ Ø´Ù…Ø´â€ŒÙ‡Ø§ Ø¢Ø²Ø§Ø¯ Ø´Ø¯Ù‡â€ŒØ§Ù†Ø¯.
            </div>
            {% if order.cancellation_reason %}
            <div class="p-2 bg-light rounded small mb-2">
                <i class="bi bi-info-circle text-muted me-1"></i>
                <strong>Ø¯Ù„ÛŒÙ„ Ù„ØºÙˆ:</strong> {{ order.cancellation_reason }}
            </div>
            {% endif %}
            {% if order.cancelled_at %}
            <div class="text-muted small mb-0">
                <i class="bi bi-clock me-1"></i>
                ØªØ§Ø±ÛŒØ® Ù„ØºÙˆ: {{ order.cancelled_at | jdate }}
            </div>
            {% endif %}
            {% endif %}
        </div>

        {% if user.is_staff %}
        <!-- Admin: Gift claim codes for packaging -->
        {% if order.is_gift and order.status == 'Paid' %}
        <div class="card-tm no-hover mt-3 border-start border-4 border-warning">
            <div class="border-bottom pb-3 mb-3 fw-bold small">
                <i class="bi bi-gift me-1 text-warning"></i>Ø³ÙØ§Ø±Ø´ Ù‡Ø¯ÛŒÙ‡ â€” Ú©Ø¯Ù‡Ø§ÛŒ Ø«Ø¨Øª Ù…Ø§Ù„Ú©ÛŒØª
            </div>
            <p class="small text-muted mb-2">Ú©Ø¯Ù‡Ø§ÛŒ Ø²ÛŒØ± Ø¨Ø§ÛŒØ¯ Ø¯Ø± Ø¨Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ Ù‚Ø±Ø§Ø± Ø¯Ø§Ø¯Ù‡ Ø´ÙˆÙ†Ø¯:</p>
            {% for item in order.items %}
            {% if item.bar and item.bar.claim_code %}
            <div class="d-flex justify-content-between align-items-center py-2 {% if not loop.last %}border-bottom{% endif %}">
                <div>
                    <small>{{ item.product.name if item.product else '' }}</small>
                    <div class="font-monospace small" dir="ltr">{{ item.bar.serial_code }}</div>
                </div>
                <code class="fs-6 fw-bold">{{ item.bar.claim_code }}</code>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        <!-- Admin Delivery Management -->
        {% if order.status == 'Paid' and order.delivery_method %}
        <div class="card-tm no-hover mt-3 border-start border-4 border-warning">
            <div class="border-bottom pb-3 mb-3 fw-bold small">
                <i class="bi bi-gear me-1"></i>Ù…Ø¯ÛŒØ±ÛŒØª ØªØ­ÙˆÛŒÙ„
            </div>
            {% if order.delivery_method == 'Pickup' and order.delivery_status != 'Delivered' %}
            <!-- Pickup: verify code -->
            <form method="POST" action="/admin/orders/{{ order.id }}/confirm-pickup" class="mb-3">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <label class="form-label-tm small fw-bold">ØªØ£ÛŒÛŒØ¯ ØªØ­ÙˆÛŒÙ„ Ø­Ø¶ÙˆØ±ÛŒ</label>
                <div class="input-group">
                    <input type="text" name="delivery_code" class="form-control form-control-tm" dir="ltr"
                           placeholder="Ú©Ø¯ Û¶ Ø±Ù‚Ù…ÛŒ ØªØ­ÙˆÛŒÙ„" maxlength="6" required>
                    <button class="btn btn-tm-success" type="submit">
                        <i class="bi bi-check-lg me-1"></i>ØªØ£ÛŒÛŒØ¯
                    </button>
                </div>
                <small class="text-muted">Ú©Ø¯ ØªØ­ÙˆÛŒÙ„ Ø¨Ù‡ Ù…Ø´ØªØ±ÛŒ Ù¾ÛŒØ§Ù…Ú© Ø´Ø¯Ù‡ Ø§Ø³Øª.</small>
            </form>
            {% endif %}

            {% if order.delivery_method == 'Postal' or order.delivery_status != 'Delivered' %}
            <!-- Update delivery status -->
            <form method="POST" action="/admin/orders/{{ order.id }}/delivery-status">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div class="mb-2">
                    <label class="form-label-tm small fw-bold">ÙˆØ¶Ø¹ÛŒØª ØªØ­ÙˆÛŒÙ„</label>
                    <select name="delivery_status" class="form-select form-select-tm form-select-sm">
                        <option value="Waiting" {% if order.delivery_status == 'Waiting' %}selected{% endif %}>
                            {{ 'Ù…Ù†ØªØ¸Ø± Ù…Ø±Ø§Ø¬Ø¹Ù‡' if order.delivery_method == 'Pickup' else 'Ø¯Ø± Ø­Ø§Ù„ Ø¢Ù…Ø§Ø¯Ù‡â€ŒØ³Ø§Ø²ÛŒ' }}
                        </option>
                        <option value="Preparing" {% if order.delivery_status == 'Preparing' %}selected{% endif %}>Ø¯Ø± Ø­Ø§Ù„ Ø¨Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</option>
                        {% if order.delivery_method == 'Postal' %}
                        <option value="Shipped" {% if order.delivery_status == 'Shipped' %}selected{% endif %}>Ø§Ø±Ø³Ø§Ù„ Ø´Ø¯Ù‡</option>
                        {% endif %}
                        <option value="Delivered" {% if order.delivery_status == 'Delivered' %}selected{% endif %}>ØªØ­ÙˆÛŒÙ„ Ø¯Ø§Ø¯Ù‡ Ø´Ø¯Ù‡</option>
                        <option value="Returned" {% if order.delivery_status == 'Returned' %}selected{% endif %}>Ù…Ø±Ø¬ÙˆØ¹ÛŒ</option>
                    </select>
                </div>
                {% if order.delivery_method == 'Postal' %}
                <div class="mb-2">
                    <label class="form-label-tm small fw-bold">Ú©Ø¯ Ø±Ù‡Ú¯ÛŒØ±ÛŒ Ù¾Ø³Øª</label>
                    <input type="text" name="postal_tracking_code" class="form-control form-control-tm form-control-sm" dir="ltr"
                           value="{{ order.postal_tracking_code or '' }}" placeholder="Ú©Ø¯ Ø±Ù‡Ú¯ÛŒØ±ÛŒ Ù¾Ø³Øª">
                </div>
                {% endif %}
                <button class="btn btn-sm btn-tm-warning w-100" type="submit">
                    <i class="bi bi-arrow-repeat me-1"></i>Ø¨Ø±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ
                </button>
            </form>
            {% endif %}

            {% if order.delivery_status == 'Delivered' %}
            <div class="alert-tm-success py-2 mt-2 mb-0 small">
                <i class="bi bi-check-circle me-1"></i>ØªØ­ÙˆÛŒÙ„ ØªÚ©Ù…ÛŒÙ„ Ø´Ø¯Ù‡
                {% if order.delivered_at %}
                <br><small>{{ order.delivered_at | jdate }}</small>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% endif %}

        <!-- Admin: Refund -->
        {% if user.is_staff and order.status == 'Paid' %}
        <div class="card-tm no-hover mt-3 border-start border-4 border-danger">
            <div class="border-bottom pb-3 mb-3 fw-bold small text-danger">
                <i class="bi bi-arrow-counterclockwise me-1"></i>Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø³ÙØ§Ø±Ø´
            </div>
            <p class="small text-muted mb-2">Ù…Ø¨Ù„Øº {{ order.grand_total | toman }} ØªÙˆÙ…Ø§Ù† Ø¨Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„ Ù…Ø´ØªØ±ÛŒ Ø¨Ø§Ø²Ú¯Ø´Øª Ø¯Ø§Ø¯Ù‡ Ù…ÛŒâ€ŒØ´ÙˆØ¯ Ùˆ Ø´Ù…Ø´â€ŒÙ‡Ø§ Ø¢Ø²Ø§Ø¯ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯.</p>
            <form method="POST" action="/payment/{{ order.id }}/refund"
                  onsubmit="return confirm('Ø¢ÛŒØ§ Ø§Ø² Ø§Ø³ØªØ±Ø¯Ø§Ø¯ ÙˆØ¬Ù‡ Ùˆ Ù„ØºÙˆ Ø³ÙØ§Ø±Ø´ Ù…Ø·Ù…Ø¦Ù†ÛŒØ¯ØŸ')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div class="mb-2">
                    <input type="text" name="admin_note" class="form-control form-control-tm form-control-sm" placeholder="ÛŒØ§Ø¯Ø¯Ø§Ø´Øª (Ø§Ø®ØªÛŒØ§Ø±ÛŒ)">
                </div>
                <button class="btn btn-sm btn-tm-danger w-100">
                    <i class="bi bi-arrow-counterclockwise me-1"></i>Ø§Ø³ØªØ±Ø¯Ø§Ø¯ Ø¨Ù‡ Ú©ÛŒÙ Ù¾ÙˆÙ„
                </button>
            </form>
        </div>
        {% endif %}
        {% endif %}

        <!-- Delivery Info -->
        {% if order.delivery_method %}
        <div class="card-tm no-hover mt-3">
            <div class="border-bottom pb-3 mb-3 fw-bold small">
                <i class="bi bi-truck me-1"></i>Ø§Ø·Ù„Ø§Ø¹Ø§Øª ØªØ­ÙˆÛŒÙ„
            </div>
            <table class="table table-tm table-borderless mb-0">
                <tr>
                    <td class="text-muted">Ø±ÙˆØ´ ØªØ­ÙˆÛŒÙ„</td>
                    <td class="fw-bold">{{ order.delivery_method_label }}</td>
                </tr>
                <tr>
                    <td class="text-muted">ÙˆØ¶Ø¹ÛŒØª</td>
                    <td><span class="badge-tm badge-tm-{{ order.delivery_status_color }}">{{ order.delivery_status_label }}</span></td>
                </tr>

                {% if order.delivery_method == 'Pickup' %}
                <tr>
                    <td class="text-muted">Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ</td>
                    <td>
                        {% if order.pickup_dealer %}
                        <strong>{{ order.pickup_dealer.full_name }}</strong>
                        {% if order.pickup_dealer.city %}<br><small>{{ order.pickup_dealer.city.name }}{% if order.pickup_dealer.province %} - {{ order.pickup_dealer.province.name }}{% endif %}</small>{% endif %}
                        {% if order.pickup_dealer.address %}<br><small class="text-muted">{{ order.pickup_dealer.address }}</small>{% endif %}
                        {% if order.pickup_dealer.landline_phone %}<br><small dir="ltr">ğŸ“ {{ order.pickup_dealer.landline_phone }}</small>{% endif %}
                        {% endif %}
                    </td>
                </tr>
                {% if order.status == 'Paid' and not user.is_staff %}
                <tr>
                    <td class="text-muted">Ø±Ø§Ù‡Ù†Ù…Ø§</td>
                    <td class="small">
                        <i class="bi bi-info-circle text-primary me-1"></i>
                        Ø¨Ø§ <strong>Ú©Ø§Ø±Øª Ù…Ù„ÛŒ</strong> Ùˆ <strong>Ú©Ø¯ ØªØ­ÙˆÛŒÙ„</strong> (Ø§Ø±Ø³Ø§Ù„â€ŒØ´Ø¯Ù‡ Ø¨Ù‡ Ù…ÙˆØ¨Ø§ÛŒÙ„) Ø¨Ù‡ Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ Ù…Ø±Ø§Ø¬Ø¹Ù‡ Ú©Ù†ÛŒØ¯.
                    </td>
                </tr>
                {% endif %}

                {% elif order.delivery_method == 'Postal' %}
                <tr>
                    <td class="text-muted">Ø¢Ø¯Ø±Ø³</td>
                    <td>
                        {{ order.shipping_address or '' }}
                        <br><small>{{ order.shipping_city or '' }}{% if order.shipping_province %} - {{ order.shipping_province }}{% endif %}</small>
                        {% if order.shipping_postal_code %}<br><small dir="ltr">ğŸ“® {{ order.shipping_postal_code }}</small>{% endif %}
                    </td>
                </tr>
                {% if order.shipping_cost %}
                <tr>
                    <td class="text-muted">Ù‡Ø²ÛŒÙ†Ù‡ Ø§Ø±Ø³Ø§Ù„</td>
                    <td>{{ order.shipping_cost | toman }} ØªÙˆÙ…Ø§Ù†</td>
                </tr>
                {% endif %}
                {% if order.insurance_cost %}
                <tr>
                    <td class="text-muted">Ø¨ÛŒÙ…Ù‡</td>
                    <td>{{ order.insurance_cost | toman }} ØªÙˆÙ…Ø§Ù†</td>
                </tr>
                {% endif %}
                {% if order.postal_tracking_code %}
                <tr>
                    <td class="text-muted">Ú©Ø¯ Ø±Ù‡Ú¯ÛŒØ±ÛŒ Ù¾Ø³Øª</td>
                    <td><code class="fw-bold">{{ order.postal_tracking_code }}</code></td>
                </tr>
                {% endif %}
                {% endif %}

                {% if order.delivered_at %}
                <tr>
                    <td class="text-muted">ØªØ§Ø±ÛŒØ® ØªØ­ÙˆÛŒÙ„</td>
                    <td>{{ order.delivered_at | jdate }}</td>
                </tr>
                {% endif %}
            </table>
        </div>
        {% endif %}

        <!-- Order Meta -->
        <div class="card-tm no-hover mt-3">
            <table class="table table-tm table-borderless mb-0">
                <tr><td class="text-muted">Ø´Ù…Ø§Ø±Ù‡ Ø³ÙØ§Ø±Ø´</td><td class="fw-bold">#{{ order.id }}</td></tr>
                <tr><td class="text-muted">ØªØ§Ø±ÛŒØ®</td><td>{{ order.created_at | jdate if order.created_at else '' }}</td></tr>
                {% if order.track_id %}
                <tr><td class="text-muted">Ú©Ø¯ Ù¾ÛŒÚ¯ÛŒØ±ÛŒ</td><td dir="ltr"><code>{{ order.track_id }}</code></td></tr>
                {% endif %}
                <tr><td class="text-muted">ØªØ¹Ø¯Ø§Ø¯</td><td>{{ order.items|length }} Ø´Ù…Ø´</td></tr>
            </table>
        </div>
    </div>
</div>
{% endblock %}

{% block shop_js %}
<script>
document.querySelectorAll('form[action="/reviews/submit"]').forEach(function(form) {
    form.addEventListener('submit', function(e) {
        var err = form.querySelector('.review-error');
        var rating = form.querySelector('input[name="rating"]:checked');
        var body = form.querySelector('textarea[name="body"]');
        if (!rating) {
            e.preventDefault();
            err.textContent = 'Ù„Ø·ÙØ§Ù‹ Ø§Ù…ØªÛŒØ§Ø² Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯.';
            err.classList.remove('d-none');
            return;
        }
        if (!body.value.trim()) {
            e.preventDefault();
            err.textContent = 'Ù„Ø·ÙØ§Ù‹ Ù…ØªÙ† Ù†Ø¸Ø± Ø±Ø§ Ø¨Ù†ÙˆÛŒØ³ÛŒØ¯.';
            err.classList.remove('d-none');
            return;
        }
        err.classList.add('d-none');
    });
});
</script>
{% endblock %}
