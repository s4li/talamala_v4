{% extends "shop/base_shop.html" %}
{% block title %}سفارش #{{ order.id }} - طلاملا{% endblock %}

{% block shop_css %}
<style>
    /* ==============================
       Invoice — horizontal layout
       ============================== */
    .invoice-wrap {
        background: #fff;
        border: 2px solid #e8dfd3;
        border-radius: 14px;
        overflow: hidden;
    }
    .invoice-header {
        background: linear-gradient(135deg, #fdfbf7 0%, #f6f0e6 100%);
        border-bottom: 2px solid #e8dfd3;
        padding: 20px 28px;
    }
    .invoice-logo {
        font-size: 1.6rem;
        font-weight: 900;
        color: var(--tm-primary, #8b1a2b);
    }
    .invoice-logo small {
        font-size: 0.7rem;
        font-weight: 400;
        color: #999;
    }

    /* Buyer / Seller boxes */
    .party-box {
        border: 1.5px solid #e0d8cc;
        border-radius: 10px;
        padding: 16px 18px;
        height: 100%;
        background: #fefdfb;
        position: relative;
    }
    .party-box .party-label {
        position: absolute;
        top: -11px;
        right: 14px;
        background: #fff;
        padding: 0 10px;
        font-size: 0.78rem;
        font-weight: 700;
        color: #8b7355;
        border: 1px solid #e0d8cc;
        border-radius: 6px;
    }
    .party-box .party-name {
        font-size: 1rem;
        font-weight: 700;
        margin-top: 6px;
        margin-bottom: 8px;
        color: #333;
    }
    .party-box .party-detail {
        font-size: 0.82rem;
        color: #666;
        line-height: 1.8;
    }
    .party-box .party-detail i {
        width: 18px;
        text-align: center;
        color: #a08c6e;
    }

    /* Items table */
    .invoice-table {
        width: 100%;
        border-collapse: collapse;
    }
    .invoice-table thead {
        background: linear-gradient(135deg, #f8f4ef, #f1ebe2);
    }
    .invoice-table thead th {
        padding: 10px 14px;
        font-size: 0.82rem;
        font-weight: 700;
        color: #8b7355;
        border-bottom: 2px solid #e8dfd3;
        white-space: nowrap;
    }
    .invoice-table tbody td {
        padding: 12px 14px;
        font-size: 0.88rem;
        border-bottom: 1px solid #f0ece5;
        vertical-align: middle;
    }
    .invoice-table tbody tr:last-child td {
        border-bottom: none;
    }
    .invoice-table .row-num {
        color: #bbb;
        font-size: 0.8rem;
        font-weight: 600;
    }

    /* Totals section */
    .invoice-totals {
        border-top: 2px solid #e8dfd3;
        padding: 18px 28px;
        background: linear-gradient(135deg, #fdfbf7 0%, #f6f0e6 100%);
    }
    .totals-line {
        display: flex;
        justify-content: space-between;
        padding: 4px 0;
        font-size: 0.88rem;
        color: #666;
    }
    .totals-line.total-grand {
        padding-top: 10px;
        margin-top: 6px;
        border-top: 1.5px dashed #d4c9b8;
        font-size: 1.1rem;
        font-weight: 800;
        color: var(--tm-primary, #8b1a2b);
    }

    /* Breakdown */
    .btn-breakdown {
        display: inline-flex;
        align-items: center;
        gap: 4px;
        border: none;
        background: linear-gradient(135deg, #f8f4ef, #f1ebe2);
        color: #8b7355;
        font-size: 0.75rem;
        font-weight: 600;
        padding: 3px 10px;
        border-radius: 20px;
        cursor: pointer;
        transition: all 0.25s ease;
    }
    .btn-breakdown:hover {
        background: linear-gradient(135deg, #f1ebe2, #e8dfd3);
        color: #6b5a42;
    }
    .btn-breakdown i { font-size: 0.68rem; transition: transform 0.3s ease; }
    .btn-breakdown[aria-expanded="true"] i { transform: rotate(180deg); }
    .breakdown-panel {
        background: linear-gradient(135deg, #fdfbf8, #f9f5ef);
        border-radius: 8px;
        border: 1px solid #f0e8db;
        padding: 10px 12px;
        margin-top: 6px;
    }
    .breakdown-panel .breakdown-item {
        display: flex;
        justify-content: space-between;
        padding: 2px 0;
        font-size: 0.78rem;
        color: #6b5a42;
    }
    .breakdown-panel .breakdown-item + .breakdown-item {
        border-top: 1px dashed #efe7da;
    }

    /* Mobile items */
    .item-mobile {
        border-bottom: 1px solid #f0ece5;
        padding: 12px 16px;
    }
    .item-mobile:last-child { border-bottom: none; }

    /* Footer */
    .invoice-footer {
        text-align: center;
        padding: 12px;
        font-size: 0.72rem;
        color: #bbb;
        border-top: 1px dashed #e8dfd3;
    }

    /* Print */
    @media print {
        .no-print { display: none !important; }
        .shop-navbar, footer, .gold-price-banner { display: none !important; }
        .invoice-wrap { box-shadow: none !important; border: 1px solid #ccc !important; }
        .breakdown-panel { background: #fafafa !important; border: 1px solid #ddd !important; }
        .btn-breakdown { display: none !important; }
        .collapse { display: block !important; height: auto !important; }
        body { font-size: 12px; }
    }

    /* Responsive adjustments */
    @media (max-width: 767px) {
        .invoice-header { padding: 14px 16px; }
        .invoice-totals { padding: 14px 16px; }
        .party-box { padding: 14px; }
        .invoice-table thead th,
        .invoice-table tbody td { padding: 8px 10px; font-size: 0.82rem; }
    }
</style>
{% endblock %}

{% block shop_content %}
<!-- Breadcrumb -->
<nav class="mb-3 no-print">
    <ol class="breadcrumb small">
        <li class="breadcrumb-item"><a href="/orders" class="text-decoration-none">سفارشات</a></li>
        <li class="breadcrumb-item active">سفارش #{{ order.id }}</li>
    </ol>
</nav>

{% if msg %}<div class="alert-tm-success py-2 no-print">{{ msg }}</div>{% endif %}
{% if error %}<div class="alert-tm-danger py-2 no-print"><i class="bi bi-exclamation-triangle me-1"></i>{{ error }}</div>{% endif %}

<!-- ============================== -->
<!-- INVOICE                        -->
<!-- ============================== -->
<div class="invoice-wrap tm-animate-fade-in-up mb-4">

    <!-- Header -->
    <div class="invoice-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
            <div class="invoice-logo">
                <i class="bi bi-gem me-1"></i>طلاملا
                <small class="d-block">TalaMala Gold — فاکتور فروش</small>
            </div>
        </div>
        <div class="text-start">
            <div class="fw-bold" style="font-size:1.05rem;">فاکتور #{{ order.id }}</div>
            <div class="text-muted small">{{ order.created_at | jdate if order.created_at else '' }}</div>
            <span class="badge-tm badge-tm-{{ order.status_color }} mt-1">{{ order.status_label }}</span>
        </div>
    </div>

    <!-- Buyer / Seller -->
    <div class="p-3 px-md-4">
        <div class="row g-3 mb-0">
            <!-- Seller -->
            <div class="col-md-6">
                <div class="party-box">
                    <div class="party-label"><i class="bi bi-shop me-1"></i>فروشنده</div>
                    <div class="party-name">{{ get_setting_value('site_name', 'طلاملا') }}</div>
                    <div class="party-detail">
                        {% set seller_phone = get_setting_value('support_phone', '') %}
                        {% set seller_telegram = get_setting_value('support_telegram', '') %}
                        {% if seller_phone %}
                        <div><i class="bi bi-telephone me-1"></i><span dir="ltr">{{ seller_phone }}</span></div>
                        {% endif %}
                        {% if seller_telegram %}
                        <div><i class="bi bi-send me-1"></i>{{ seller_telegram }}</div>
                        {% endif %}
                        {% if not seller_phone and not seller_telegram %}
                        <div class="text-muted">—</div>
                        {% endif %}
                    </div>
                </div>
            </div>

            <!-- Buyer -->
            {% if order.customer %}
            <div class="col-md-6">
                <div class="party-box">
                    <div class="party-label"><i class="bi bi-person me-1"></i>خریدار</div>
                    <div class="party-name">
                        {% if order.customer.customer_type == 'legal' and order.customer.company_name %}
                            {{ order.customer.company_name }}
                        {% else %}
                            {{ order.customer.full_name }}
                        {% endif %}
                    </div>
                    <div class="party-detail">
                        {% if order.customer.national_id %}
                        <div><i class="bi bi-card-text me-1"></i>{{ 'شناسه ملی' if order.customer.customer_type == 'legal' else 'کد ملی' }}: <span dir="ltr">{{ order.customer.national_id }}</span></div>
                        {% endif %}
                        <div><i class="bi bi-phone me-1"></i><span dir="ltr">{{ order.customer.mobile }}</span></div>
                        {% if order.customer.address %}
                        <div><i class="bi bi-geo-alt me-1"></i>{{ order.customer.address }}</div>
                        {% endif %}
                        {% if order.customer.postal_code %}
                        <div><i class="bi bi-mailbox me-1"></i>کد پستی: <span dir="ltr">{{ order.customer.postal_code }}</span></div>
                        {% endif %}
                    </div>
                </div>
            </div>
            {% endif %}
        </div>
    </div>

    <!-- Items — Desktop Table -->
    <div class="d-none d-md-block px-md-4 pb-2">
        <table class="invoice-table">
            <thead>
                <tr>
                    <th style="width:40px;">#</th>
                    <th>محصول</th>
                    <th class="text-center">وزن</th>
                    <th class="text-center">عیار</th>
                    <th class="text-center">بسته‌بندی</th>
                    <th class="text-end">مبلغ (تومان)</th>
                    <th style="width:80px;"></th>
                </tr>
            </thead>
            <tbody>
                {% for item in order.items %}
                <tr>
                    <td class="row-num">{{ loop.index }}</td>
                    <td>
                        <div class="fw-bold">{{ item.product.name if item.product else 'محصول حذف‌شده' }}</div>
                        {% if order.status == 'Paid' and item.bar %}
                        <small class="text-muted">سریال: <code>{{ item.bar.serial_code }}</code></small>
                        {% endif %}
                    </td>
                    <td class="text-center">{{ item.applied_weight }}g</td>
                    <td class="text-center">{{ item.applied_purity|purity }}</td>
                    <td class="text-center small">
                        {% if item.package_type %}
                        {{ item.package_type.name }}
                        {% if item.applied_package_price > 0 %}
                        <br><span class="text-muted">({{ item.applied_package_price | toman }} ت)</span>
                        {% endif %}
                        {% else %}
                        —
                        {% endif %}
                    </td>
                    <td class="text-end fw-bold">{{ item.line_total | toman }}</td>
                    <td class="text-center">
                        <button class="btn-breakdown no-print"
                                type="button" data-bs-toggle="collapse" data-bs-target="#detail-{{ item.id }}"
                                aria-expanded="false">
                            <i class="bi bi-chevron-down"></i> ریز
                        </button>
                    </td>
                </tr>
                <tr class="collapse-row">
                    <td colspan="7" class="p-0 border-0">
                        <div class="collapse" id="detail-{{ item.id }}">
                            <div class="breakdown-panel mx-3 mb-2">
                                <div class="breakdown-item">
                                    <span>قیمت طلا (هر گرم)</span>
                                    <span>{{ item.applied_gold_price | toman }} تومان</span>
                                </div>
                                <div class="breakdown-item">
                                    <span>طلای خام</span>
                                    <span>{{ item.final_gold_amount | toman }} تومان</span>
                                </div>
                                <div class="breakdown-item">
                                    <span>اجرت ({{ item.applied_wage_percent }}%)</span>
                                    <span>{{ item.final_wage_amount | toman }} تومان</span>
                                </div>
                                <div class="breakdown-item">
                                    <span>مالیات ({{ item.applied_tax_percent }}%)</span>
                                    <span>{{ item.final_tax_amount | toman }} تومان</span>
                                </div>
                                {% if item.applied_package_price > 0 %}
                                <div class="breakdown-item">
                                    <span>بسته‌بندی ({{ item.package_type.name if item.package_type else '' }})</span>
                                    <span>{{ item.applied_package_price | toman }} تومان</span>
                                </div>
                                {% endif %}
                            </div>
                        </div>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Items — Mobile Cards -->
    <div class="d-md-none">
        {% for item in order.items %}
        <div class="item-mobile">
            <div class="d-flex justify-content-between align-items-start mb-1">
                <div>
                    <span class="text-muted small">{{ loop.index }}.</span>
                    <span class="fw-bold" style="font-size:0.9rem;">{{ item.product.name if item.product else 'محصول حذف‌شده' }}</span>
                </div>
                <div class="fw-bold text-tm-primary text-nowrap" style="font-size:0.9rem;">{{ item.line_total | toman }} <small class="text-muted">ت</small></div>
            </div>
            <div class="d-flex gap-2 small text-muted">
                <span>{{ item.applied_weight }}g</span>
                <span>عیار {{ item.applied_purity|purity }}</span>
                {% if item.package_type %}<span>{{ item.package_type.name }}</span>{% endif %}
            </div>
            {% if order.status == 'Paid' and item.bar %}
            <small class="text-muted d-block mt-1">سریال: <code>{{ item.bar.serial_code }}</code></small>
            {% endif %}
            <div class="mt-1">
                <button class="btn-breakdown no-print"
                        type="button" data-bs-toggle="collapse" data-bs-target="#detail-m-{{ item.id }}"
                        aria-expanded="false">
                    <i class="bi bi-chevron-down"></i> ریز قیمت
                </button>
                <div class="collapse" id="detail-m-{{ item.id }}">
                    <div class="breakdown-panel">
                        <div class="breakdown-item">
                            <span>قیمت طلا (هر گرم)</span>
                            <span>{{ item.applied_gold_price | toman }} تومان</span>
                        </div>
                        <div class="breakdown-item">
                            <span>طلای خام</span>
                            <span>{{ item.final_gold_amount | toman }} تومان</span>
                        </div>
                        <div class="breakdown-item">
                            <span>اجرت ({{ item.applied_wage_percent }}%)</span>
                            <span>{{ item.final_wage_amount | toman }} تومان</span>
                        </div>
                        <div class="breakdown-item">
                            <span>مالیات ({{ item.applied_tax_percent }}%)</span>
                            <span>{{ item.final_tax_amount | toman }} تومان</span>
                        </div>
                        {% if item.applied_package_price > 0 %}
                        <div class="breakdown-item">
                            <span>بسته‌بندی</span>
                            <span>{{ item.applied_package_price | toman }} تومان</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    <!-- Totals -->
    <div class="invoice-totals">
        <div class="row">
            <div class="col-md-6 offset-md-6 col-lg-5 offset-lg-7">
                <div class="totals-line">
                    <span>جمع کالاها ({{ order.items|length }} شمش)</span>
                    <span>{{ order.total_amount | toman }} تومان</span>
                </div>
                {% if order.promo_amount %}
                <div class="totals-line text-success">
                    <span>
                        {% if order.promo_choice == 'DISCOUNT' %}تخفیف{% else %}کشبک{% endif %}
                        {% if order.coupon_code %}<small>({{ order.coupon_code }})</small>{% endif %}
                    </span>
                    <span>−{{ order.promo_amount | toman }} تومان</span>
                </div>
                {% endif %}
                {% if order.shipping_cost %}
                <div class="totals-line">
                    <span>هزینه ارسال</span>
                    <span>{{ order.shipping_cost | toman }} تومان</span>
                </div>
                {% endif %}
                {% if order.insurance_cost %}
                <div class="totals-line">
                    <span>بیمه</span>
                    <span>{{ order.insurance_cost | toman }} تومان</span>
                </div>
                {% endif %}
                <div class="totals-line total-grand">
                    <span>جمع قابل پرداخت</span>
                    <span>{{ order.grand_total | toman }} تومان</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="invoice-footer">
        {% if order.track_id %}کد پیگیری: <code>{{ order.track_id }}</code> — {% endif %}
        این فاکتور به صورت الکترونیکی صادر شده و معتبر است.
    </div>
</div>


<!-- ============================== -->
<!-- ACTIONS & INFO (below invoice) -->
<!-- ============================== -->
<div class="row g-4">
    <!-- Actions Panel -->
    <div class="col-lg-4 order-lg-2 tm-animate-fade-in-up tm-delay-1">
        <div class="card-tm no-hover no-print">
            {% if order.status == 'Pending' %}
            <div class="alert-tm-warning py-2 small mb-3">
                <i class="bi bi-clock me-1"></i>
                این سفارش در انتظار پرداخت است. شمش‌ها به مدت محدود رزرو شده‌اند.
            </div>

            {% if order.grand_total == 0 %}
            <div class="alert-tm-success py-2 small mb-3">
                <i class="bi bi-gift me-1"></i>
                این سفارش با تخفیف ۱۰۰٪ رایگان شده است.
            </div>
            <form method="POST" action="/payment/{{ order.id }}/wallet"
                  onsubmit="return confirm('آیا از تأیید سفارش رایگان مطمئنید؟')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button class="btn btn-tm-primary w-100 mb-2">
                    <i class="bi bi-check-circle me-1"></i> تأیید و ثبت نهایی سفارش
                </button>
            </form>
            {% else %}
            {% if wallet_balance and wallet_balance.available >= order.grand_total %}
            <form method="POST" action="/payment/{{ order.id }}/wallet"
                  onsubmit="return confirm('آیا از پرداخت {{ order.grand_total | toman }} تومان از کیف پول مطمئنید؟')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button class="btn btn-tm-primary w-100 mb-1">
                    <i class="bi bi-wallet2 me-1"></i> پرداخت از کیف پول
                </button>
            </form>
            <div class="text-center text-muted mb-2" style="font-size:0.75rem;">
                موجودی: {{ wallet_balance.available | toman }} تومان
            </div>
            {% else %}
            <div class="mb-2">
                <button class="btn btn-tm-outline w-100" disabled>
                    <i class="bi bi-wallet2 me-1"></i> پرداخت از کیف پول
                </button>
                <div class="text-center mt-1" style="font-size:0.75rem;">
                    {% if wallet_balance %}
                    <div class="text-danger">موجودی: {{ wallet_balance.available | toman }} تومان</div>
                    <div class="text-danger">کسری: {{ (order.grand_total - wallet_balance.available) | toman }} تومان</div>
                    {% else %}
                    <span class="text-danger">کیف پول خالی است</span>
                    {% endif %}
                </div>
                <a href="/wallet" class="btn btn-sm btn-tm-success w-100 mt-1">
                    <i class="bi bi-plus-circle me-1"></i> شارژ کیف پول
                </a>
            </div>
            {% endif %}

            {% if enabled_gateways and enabled_gateways|length > 0 %}
            <form method="POST" action="/payment/{{ order.id }}/gateway">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div class="mb-2">
                    <label class="form-label-tm small fw-bold">انتخاب درگاه پرداخت:</label>
                    {% for gw in enabled_gateways %}
                    <div class="form-check mb-1">
                        <input class="form-check-input" type="radio" name="gateway" value="{{ gw }}" id="gw_{{ gw }}"
                               {{ 'checked' if loop.first }}>
                        <label class="form-check-label" for="gw_{{ gw }}">
                            {% if gw == 'sepehr' %}درگاه سپهر
                            {% elif gw == 'top' %}درگاه تاپ
                            {% elif gw == 'parsian' %}درگاه پارسیان
                            {% else %}{{ gw }}{% endif %}
                        </label>
                    </div>
                    {% endfor %}
                </div>
                <button class="btn btn-tm-outline w-100 mb-2">
                    <i class="bi bi-credit-card me-1"></i> پرداخت آنلاین
                </button>
            </form>
            {% endif %}
            {% endif %}

            <hr class="my-2">

            <form method="POST" action="/orders/{{ order.id }}/cancel"
                  onsubmit="return confirm('آیا از لغو سفارش مطمئنید؟ شمش‌ها آزاد خواهند شد.')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button class="btn btn-tm-danger w-100">
                    <i class="bi bi-x-lg me-1"></i> لغو سفارش
                </button>
            </form>

            {% elif order.status == 'Paid' %}
            {% if order.is_gift %}
            <div class="alert-tm-success py-2 small mb-3">
                <i class="bi bi-gift me-1"></i>
                سفارش هدیه با موفقیت پرداخت شد.
            </div>
            <div class="card-tm no-hover border border-warning mb-3 p-3">
                <div class="fw-bold small mb-2">
                    <i class="bi bi-key me-1 text-warning"></i>
                    کد ثبت مالکیت — به گیرنده هدیه بدهید
                </div>
                {% for item in order.items %}
                {% if item.bar and item.bar.claim_code %}
                <div class="d-flex justify-content-between align-items-center py-2 {% if not loop.last %}border-bottom{% endif %}">
                    <div>
                        <small class="text-muted">{{ item.product.name if item.product else '' }}</small>
                        <div class="font-monospace small" dir="ltr">{{ item.bar.serial_code }}</div>
                    </div>
                    <div class="text-end">
                        <span class="badge bg-warning text-dark fs-6 font-monospace px-3">{{ item.bar.claim_code }}</span>
                    </div>
                </div>
                {% endif %}
                {% endfor %}
                <div class="mt-2 small text-muted">
                    <i class="bi bi-info-circle me-1"></i>
                    گیرنده با مراجعه به <strong>ثبت مالکیت</strong> و وارد کردن سریال + کد بالا، مالک شمش می‌شود.
                </div>
            </div>
            {% else %}
            <div class="alert-tm-success py-2 small mb-3">
                <i class="bi bi-check-circle me-1"></i>
                پرداخت موفق. شمش‌ها به نام شما ثبت شده‌اند.
            </div>
            {% endif %}
            {% if order.payment_method %}
            <div class="small text-muted mb-2">
                <div><strong>روش پرداخت:</strong>
                    {% if order.payment_method == 'wallet' %}کیف پول
                    {% elif 'zibal' in (order.payment_method or '') %}درگاه زیبال
                    {% elif 'sepehr' in (order.payment_method or '') %}درگاه سپهر
                    {% elif 'top' in (order.payment_method or '') %}درگاه تاپ
                    {% elif 'parsian' in (order.payment_method or '') %}درگاه پارسیان
                    {% elif order.payment_method == 'coupon_free' %}تخفیف ۱۰۰٪
                    {% else %}{{ order.payment_method }}{% endif %}
                </div>
                {% if order.payment_ref %}<div><strong>شماره مرجع:</strong> <code>{{ order.payment_ref }}</code></div>{% endif %}
                {% if order.paid_at %}<div><strong>تاریخ پرداخت:</strong> {{ order.paid_at | jdate }}</div>{% endif %}
            </div>
            {% endif %}
            <button class="btn btn-tm-outline w-100" onclick="window.print()">
                <i class="bi bi-printer me-1"></i> چاپ فاکتور
            </button>

            {% elif order.status == 'Cancelled' %}
            <div class="alert-tm-danger py-2 small mb-3">
                <i class="bi bi-x-circle me-1"></i>
                سفارش لغو شده و شمش‌ها آزاد شده‌اند.
            </div>
            {% if order.cancellation_reason %}
            <div class="p-2 bg-light rounded small mb-2">
                <i class="bi bi-info-circle text-muted me-1"></i>
                <strong>دلیل لغو:</strong> {{ order.cancellation_reason }}
            </div>
            {% endif %}
            {% if order.cancelled_at %}
            <div class="text-muted small mb-0">
                <i class="bi bi-clock me-1"></i>
                تاریخ لغو: {{ order.cancelled_at | jdate }}
            </div>
            {% endif %}
            {% endif %}
        </div>

        {% if user.is_staff %}
        {% if order.is_gift and order.status == 'Paid' %}
        <div class="card-tm no-hover mt-3 border-start border-4 border-warning no-print">
            <div class="border-bottom pb-3 mb-3 fw-bold small">
                <i class="bi bi-gift me-1 text-warning"></i>سفارش هدیه — کدهای ثبت مالکیت
            </div>
            <p class="small text-muted mb-2">کدهای زیر باید در بسته‌بندی قرار داده شوند:</p>
            {% for item in order.items %}
            {% if item.bar and item.bar.claim_code %}
            <div class="d-flex justify-content-between align-items-center py-2 {% if not loop.last %}border-bottom{% endif %}">
                <div>
                    <small>{{ item.product.name if item.product else '' }}</small>
                    <div class="font-monospace small" dir="ltr">{{ item.bar.serial_code }}</div>
                </div>
                <code class="fs-6 fw-bold">{{ item.bar.claim_code }}</code>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}

        {% if order.status == 'Paid' and order.delivery_method %}
        <div class="card-tm no-hover mt-3 border-start border-4 border-warning no-print">
            <div class="border-bottom pb-3 mb-3 fw-bold small">
                <i class="bi bi-gear me-1"></i>مدیریت تحویل
            </div>
            {% if order.delivery_method == 'Pickup' and order.delivery_status != 'Delivered' %}
            <form method="POST" action="/admin/orders/{{ order.id }}/confirm-pickup" class="mb-3">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <label class="form-label-tm small fw-bold">تأیید تحویل حضوری</label>
                <div class="input-group">
                    <input type="text" name="delivery_code" class="form-control form-control-tm" dir="ltr"
                           placeholder="کد ۶ رقمی تحویل" maxlength="6" required>
                    <button class="btn btn-tm-success" type="submit">
                        <i class="bi bi-check-lg me-1"></i>تأیید
                    </button>
                </div>
                <small class="text-muted">کد تحویل به مشتری پیامک شده است.</small>
            </form>
            {% endif %}

            {% if order.delivery_method == 'Postal' or order.delivery_status != 'Delivered' %}
            <form method="POST" action="/admin/orders/{{ order.id }}/delivery-status">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div class="mb-2">
                    <label class="form-label-tm small fw-bold">وضعیت تحویل</label>
                    <select name="delivery_status" class="form-select form-select-tm form-select-sm">
                        <option value="Waiting" {% if order.delivery_status == 'Waiting' %}selected{% endif %}>
                            {{ 'منتظر مراجعه' if order.delivery_method == 'Pickup' else 'در حال آماده‌سازی' }}
                        </option>
                        <option value="Preparing" {% if order.delivery_status == 'Preparing' %}selected{% endif %}>در حال بسته‌بندی</option>
                        {% if order.delivery_method == 'Postal' %}
                        <option value="Shipped" {% if order.delivery_status == 'Shipped' %}selected{% endif %}>ارسال شده</option>
                        {% endif %}
                        <option value="Delivered" {% if order.delivery_status == 'Delivered' %}selected{% endif %}>تحویل داده شده</option>
                        <option value="Returned" {% if order.delivery_status == 'Returned' %}selected{% endif %}>مرجوعی</option>
                    </select>
                </div>
                {% if order.delivery_method == 'Postal' %}
                <div class="mb-2">
                    <label class="form-label-tm small fw-bold">کد رهگیری پست</label>
                    <input type="text" name="postal_tracking_code" class="form-control form-control-tm form-control-sm" dir="ltr"
                           value="{{ order.postal_tracking_code or '' }}" placeholder="کد رهگیری پست">
                </div>
                {% endif %}
                <button class="btn btn-sm btn-tm-warning w-100" type="submit">
                    <i class="bi bi-arrow-repeat me-1"></i>بروزرسانی
                </button>
            </form>
            {% endif %}

            {% if order.delivery_status == 'Delivered' %}
            <div class="alert-tm-success py-2 mt-2 mb-0 small">
                <i class="bi bi-check-circle me-1"></i>تحویل تکمیل شده
                {% if order.delivered_at %}
                <br><small>{{ order.delivered_at | jdate }}</small>
                {% endif %}
            </div>
            {% endif %}
        </div>
        {% endif %}
        {% endif %}
    </div>

    <!-- Delivery Info + History -->
    <div class="col-lg-8 order-lg-1 tm-animate-fade-in-up tm-delay-2">
        {% if order.delivery_method %}
        <div class="card-tm no-hover mb-3">
            <div class="border-bottom pb-3 mb-3 fw-bold small">
                <i class="bi bi-truck me-1"></i>اطلاعات تحویل
            </div>
            <table class="table table-tm table-borderless mb-0">
                <tr>
                    <td class="text-muted" style="width:130px;">روش تحویل</td>
                    <td class="fw-bold">{{ order.delivery_method_label }}</td>
                </tr>
                <tr>
                    <td class="text-muted">وضعیت</td>
                    <td><span class="badge-tm badge-tm-{{ order.delivery_status_color }}">{{ order.delivery_status_label }}</span></td>
                </tr>

                {% if order.delivery_method == 'Pickup' %}
                <tr>
                    <td class="text-muted">نمایندگی</td>
                    <td>
                        {% if order.pickup_dealer %}
                        <strong>{{ order.pickup_dealer.full_name }}</strong>
                        {% if order.pickup_dealer.city %}<br><small>{{ order.pickup_dealer.city.name }}{% if order.pickup_dealer.province %} - {{ order.pickup_dealer.province.name }}{% endif %}</small>{% endif %}
                        {% if order.pickup_dealer.address %}<br><small class="text-muted">{{ order.pickup_dealer.address }}</small>{% endif %}
                        {% if order.pickup_dealer.landline_phone %}<br><small dir="ltr">{{ order.pickup_dealer.landline_phone }}</small>{% endif %}
                        {% endif %}
                    </td>
                </tr>
                {% if order.status == 'Paid' and not user.is_staff %}
                <tr>
                    <td class="text-muted">راهنما</td>
                    <td class="small">
                        <i class="bi bi-info-circle text-primary me-1"></i>
                        با <strong>کارت ملی</strong> و <strong>کد تحویل</strong> (ارسال‌شده به موبایل) به نمایندگی مراجعه کنید.
                    </td>
                </tr>
                {% endif %}

                {% elif order.delivery_method == 'Postal' %}
                <tr>
                    <td class="text-muted">آدرس</td>
                    <td>
                        {{ order.shipping_address or '' }}
                        <br><small>{{ order.shipping_city or '' }}{% if order.shipping_province %} - {{ order.shipping_province }}{% endif %}</small>
                        {% if order.shipping_postal_code %}<br><small dir="ltr">{{ order.shipping_postal_code }}</small>{% endif %}
                    </td>
                </tr>
                {% if order.shipping_cost %}
                <tr>
                    <td class="text-muted">هزینه ارسال</td>
                    <td>{{ order.shipping_cost | toman }} تومان</td>
                </tr>
                {% endif %}
                {% if order.insurance_cost %}
                <tr>
                    <td class="text-muted">بیمه</td>
                    <td>{{ order.insurance_cost | toman }} تومان</td>
                </tr>
                {% endif %}
                {% if order.postal_tracking_code %}
                <tr>
                    <td class="text-muted">کد رهگیری پست</td>
                    <td><code class="fw-bold">{{ order.postal_tracking_code }}</code></td>
                </tr>
                {% endif %}
                {% endif %}

                {% if order.delivered_at %}
                <tr>
                    <td class="text-muted">تاریخ تحویل</td>
                    <td>{{ order.delivered_at | jdate }}</td>
                </tr>
                {% endif %}
            </table>
        </div>
        {% endif %}

        <!-- Status History Timeline -->
        {% if order.status_logs %}
        <div class="card-tm no-hover">
            <div class="border-bottom pb-3 mb-3 fw-bold small">
                <i class="bi bi-clock-history me-1"></i>تاریخچه وضعیت
            </div>
            <div class="position-relative" style="padding-right: 20px;">
                <div class="position-absolute" style="right: 6px; top: 0; bottom: 0; width: 2px; background: #e9ecef;"></div>
                {% for log in order.status_logs|reverse %}
                <div class="d-flex align-items-start mb-3 position-relative">
                    <div class="position-absolute" style="right: -17px; top: 4px; width: 10px; height: 10px; border-radius: 50%; background: {{ 'var(--tm-primary)' if loop.last else '#dee2e6' }}; border: 2px solid #fff; z-index: 1;"></div>
                    <div class="flex-grow-1">
                        <div class="small fw-bold">
                            {% if log.field == 'status' %}
                            <span class="badge bg-{{ 'success' if log.new_value == 'Paid' else ('danger' if log.new_value == 'Cancelled' else 'warning') }} me-1">{{ log.new_value | fa_label }}</span>
                            {% else %}
                            <span class="badge bg-info me-1">{{ log.new_value | fa_label }}</span>
                            {% endif %}
                        </div>
                        {% if log.description %}
                        <div class="text-muted" style="font-size: 0.78rem;">{{ log.description }}</div>
                        {% endif %}
                        <div class="text-muted" style="font-size: 0.72rem;">
                            {{ log.created_at | jdate }}
                            {% if log.changed_by and user.is_staff %}
                            <span class="ms-1">— {{ log.changed_by }}</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %}
