{% extends "admin/base_admin.html" %}
{% set active_page = "locations" %}
{% block title %}Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§ - Ù¾Ù†Ù„ Ù…Ø¯ÛŒØ±ÛŒØª{% endblock %}

{% block content %}
<div class="page-header d-flex justify-content-between align-items-center">
    <h4 class="fw-bold mb-0"><i class="bi bi-geo-alt me-2"></i>Ù…Ø¯ÛŒØ±ÛŒØª Ù…Ú©Ø§Ù†â€ŒÙ‡Ø§</h4>
    <button class="btn btn-sm btn-tm-primary" data-bs-toggle="modal" data-bs-target="#addModal">
        <i class="bi bi-plus-lg me-1"></i> Ø§ÙØ²ÙˆØ¯Ù† Ù…Ú©Ø§Ù†
    </button>
</div>

{% if msg %}<div class="alert-tm-success py-2"><i class="bi bi-check-lg me-1"></i>{{ msg }}</div>{% endif %}

<div class="row g-3">
    {% for loc in locations %}
    <div class="col-md-6 col-lg-4">
        <div class="card-tm no-hover h-100">
            <div class="d-flex justify-content-between align-items-start mb-2">
                <div>
                    <h6 class="fw-bold mb-0">
                        <i class="{{ loc.type_icon }} me-1"></i>{{ loc.name }}
                    </h6>
                    <span class="badge bg-{{ loc.type_color }} mt-1">{{ loc.type_label }}</span>
                    {% if not loc.is_active %}
                    <span class="badge-tm badge-tm-danger mt-1">ØºÛŒØ±ÙØ¹Ø§Ù„</span>
                    {% endif %}
                    {% if loc.is_postal_hub %}
                    <span class="badge-tm badge-tm-info mt-1"><i class="bi bi-envelope me-1"></i>Ø§Ø±Ø³Ø§Ù„ Ù¾Ø³ØªÛŒ</span>
                    {% endif %}
                </div>
                <span class="badge bg-light text-dark border">
                    {{ bar_counts.get(loc.id, 0) }} Ø´Ù…Ø´
                </span>
            </div>

            {% if loc.province %}
            <div class="small text-muted"><i class="bi bi-map me-1"></i>{{ loc.province }}</div>
            {% endif %}
            {% if loc.city %}
            <div class="small text-muted"><i class="bi bi-pin-map me-1"></i>{{ loc.city }}</div>
            {% endif %}
            {% if loc.address %}
            <div class="small text-muted mt-1"><i class="bi bi-geo me-1"></i>{{ loc.address }}</div>
            {% endif %}
            {% if loc.phone %}
            <div class="small text-muted mt-1" dir="ltr"><i class="bi bi-telephone me-1"></i>{{ loc.phone }}</div>
            {% endif %}

            <div class="border-top mt-3 pt-3 d-flex gap-1">
                <button class="btn btn-sm btn-tm-outline flex-grow-1"
                        data-bs-toggle="modal" data-bs-target="#editModal-{{ loc.id }}">
                    <i class="bi bi-pencil me-1"></i>ÙˆÛŒØ±Ø§ÛŒØ´
                </button>
                <a href="/admin/bars?location_id={{ loc.id }}" class="btn btn-sm btn-tm-outline">
                    <i class="bi bi-upc-scan"></i>
                </a>
                {% if bar_counts.get(loc.id, 0) == 0 %}
                <form method="POST" action="/admin/locations/delete/{{ loc.id }}"
                      onsubmit="return confirm('Ø­Ø°Ù Ù…Ú©Ø§Ù† Â«{{ loc.name }}Â»ØŸ')">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <button class="btn btn-sm btn-tm-danger"><i class="bi bi-trash"></i></button>
                </form>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Edit Modal -->
    <div class="modal fade" id="editModal-{{ loc.id }}">
        <div class="modal-dialog">
            <div class="modal-content">
                <form method="POST" action="/admin/locations/update/{{ loc.id }}">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <div class="modal-header"><h6 class="modal-title fw-bold">ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ú©Ø§Ù†</h6>
                        <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                    <div class="modal-body">
                        <div class="mb-3"><label class="form-label-tm">Ù†Ø§Ù…</label>
                            <input name="name" class="form-control form-control-tm" value="{{ loc.name }}" required></div>
                        <div class="mb-3"><label class="form-label-tm">Ù†ÙˆØ¹</label>
                            <select name="location_type" class="form-select form-select-tm">
                                {% for t in location_types %}
                                <option value="{{ t.value }}" {% if loc.location_type == t.value %}selected{% endif %}>
                                    {{ {"Factory":"Ú©Ø§Ø±Ø®Ø§Ù†Ù‡","Warehouse":"Ø§Ù†Ø¨Ø§Ø± Ù…Ø±Ú©Ø²ÛŒ","Branch":"Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ","InTransit":"Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªÙ‚Ø§Ù„","OnlinePlatform":"Ù¾Ù„ØªÙØ±Ù… Ø¢Ù†Ù„Ø§ÛŒÙ†"}[t.value] }}
                                </option>
                                {% endfor %}
                            </select></div>
                        <div class="mb-3"><label class="form-label-tm">Ø§Ø³ØªØ§Ù†</label>
                            <input name="province" class="form-control form-control-tm" value="{{ loc.province or '' }}"></div>
                        <div class="mb-3"><label class="form-label-tm">Ø´Ù‡Ø±</label>
                            <input name="city" class="form-control form-control-tm" value="{{ loc.city or '' }}"></div>
                        <div class="mb-3"><label class="form-label-tm">Ø¢Ø¯Ø±Ø³</label>
                            <textarea name="address" class="form-control form-control-tm" rows="2">{{ loc.address or '' }}</textarea></div>
                        <div class="mb-3"><label class="form-label-tm">ØªÙ„ÙÙ†</label>
                            <input name="phone" class="form-control form-control-tm" dir="ltr" value="{{ loc.phone or '' }}"></div>
                        <div class="form-check mb-2">
                            <input type="checkbox" name="is_postal_hub" value="true" class="form-check-input"
                                   {% if loc.is_postal_hub %}checked{% endif %}>
                            <label class="form-check-label"><i class="bi bi-envelope me-1"></i>Ø§Ù†Ø¨Ø§Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾Ø³ØªÛŒ</label>
                        </div>
                        <div class="form-check">
                            <input type="checkbox" name="is_active" value="true" class="form-check-input"
                                   {% if loc.is_active %}checked{% endif %}>
                            <label class="form-check-label">ÙØ¹Ø§Ù„</label>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button type="submit" class="btn btn-tm-primary">Ø°Ø®ÛŒØ±Ù‡</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12 text-center py-5">
        <div style="font-size:4rem;">ğŸ“</div>
        <h5 class="text-muted mt-3">Ù‡Ù†ÙˆØ² Ù…Ú©Ø§Ù†ÛŒ Ø«Ø¨Øª Ù†Ø´Ø¯Ù‡</h5>
    </div>
    {% endfor %}
</div>

<!-- Add Modal -->
<div class="modal fade" id="addModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="POST" action="/admin/locations/create">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <div class="modal-header"><h6 class="modal-title fw-bold">Ø§ÙØ²ÙˆØ¯Ù† Ù…Ú©Ø§Ù† Ø¬Ø¯ÛŒØ¯</h6>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
                <div class="modal-body">
                    <div class="mb-3"><label class="form-label-tm">Ù†Ø§Ù… <span class="text-danger">*</span></label>
                        <input name="name" class="form-control form-control-tm" required placeholder="Ù…Ø«Ø§Ù„: Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ Ø§ØµÙÙ‡Ø§Ù†"></div>
                    <div class="mb-3"><label class="form-label-tm">Ù†ÙˆØ¹</label>
                        <select name="location_type" class="form-select form-select-tm">
                            {% for t in location_types %}
                            <option value="{{ t.value }}">
                                {{ {"Factory":"Ú©Ø§Ø±Ø®Ø§Ù†Ù‡","Warehouse":"Ø§Ù†Ø¨Ø§Ø± Ù…Ø±Ú©Ø²ÛŒ","Branch":"Ù†Ù…Ø§ÛŒÙ†Ø¯Ú¯ÛŒ","InTransit":"Ø¯Ø± Ø­Ø§Ù„ Ø§Ù†ØªÙ‚Ø§Ù„","OnlinePlatform":"Ù¾Ù„ØªÙØ±Ù… Ø¢Ù†Ù„Ø§ÛŒÙ†"}[t.value] }}
                            </option>
                            {% endfor %}
                        </select></div>
                    <div class="mb-3"><label class="form-label-tm">Ø§Ø³ØªØ§Ù†</label>
                        <input name="province" class="form-control form-control-tm" placeholder="Ø§ØµÙÙ‡Ø§Ù†"></div>
                    <div class="mb-3"><label class="form-label-tm">Ø´Ù‡Ø±</label>
                        <input name="city" class="form-control form-control-tm" placeholder="Ø§ØµÙÙ‡Ø§Ù†"></div>
                    <div class="mb-3"><label class="form-label-tm">Ø¢Ø¯Ø±Ø³</label>
                        <textarea name="address" class="form-control form-control-tm" rows="2" placeholder="Ø®ÛŒØ§Ø¨Ø§Ù† ..."></textarea></div>
                    <div class="mb-3"><label class="form-label-tm">ØªÙ„ÙÙ†</label>
                        <input name="phone" class="form-control form-control-tm" dir="ltr" placeholder="021-12345678"></div>
                    <div class="form-check mb-2">
                        <input type="checkbox" name="is_postal_hub" value="true" class="form-check-input" id="addPostalHub">
                        <label class="form-check-label" for="addPostalHub">
                            <i class="bi bi-envelope me-1"></i>Ø§Ù†Ø¨Ø§Ø± Ø§Ø±Ø³Ø§Ù„ Ù¾Ø³ØªÛŒ
                        </label>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="submit" class="btn btn-tm-primary">Ø§ÛŒØ¬Ø§Ø¯</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
