{% extends "admin/base_admin.html" %}
{% set active_page = "reconciliation" %}
{% block title %}انبارگردانی #{{ recon.id }} - پنل مدیریت{% endblock %}

{% block content %}
<div class="page-header tm-animate-fade-in">
    <h4 class="fw-bold mb-0">
        <i class="bi bi-clipboard2-check me-2"></i>
        انبارگردانی #{{ recon.id }}
        <span class="badge bg-{{ recon.status_color }} ms-2">{{ recon.status_label }}</span>
    </h4>
    <a href="/admin/reconciliation" class="btn btn-sm btn-tm-outline"><i class="bi bi-arrow-right me-1"></i>بازگشت</a>
</div>

<!-- Session Header -->
<div class="card-tm no-hover mb-3 tm-animate-fade-in-up tm-delay-1">
    <div class="row g-3">
        <div class="col-md-3">
            <small class="text-muted d-block">نمایندگی</small>
            <strong>{{ recon.dealer.full_name if recon.dealer else '—' }}</strong>
        </div>
        <div class="col-md-2">
            <small class="text-muted d-block">شروع‌کننده</small>
            <strong>{{ recon.initiated_by }}</strong>
        </div>
        <div class="col-md-2">
            <small class="text-muted d-block">تاریخ شروع</small>
            <strong>{{ recon.started_at | jdate }}</strong>
        </div>
        <div class="col-md-5">
            <!-- Progress -->
            {% set scanned = recon.total_scanned or 0 %}
            {% set expected = recon.total_expected or 1 %}
            {% set pct = (scanned * 100 / expected) | int %}
            <small class="text-muted d-block">پیشرفت ({{ scanned | persian_number }} / {{ expected | persian_number }})</small>
            <div class="progress mt-1" style="height:20px;">
                <div class="progress-bar bg-tm-primary" style="width:{{ pct if pct <= 100 else 100 }}%">{{ pct | persian_number }}%</div>
            </div>
        </div>
    </div>

    <!-- Summary stats (visible after completion) -->
    {% if recon.status.value != 'InProgress' %}
    <div class="row g-3 mt-3 pt-3 border-top">
        <div class="col-auto"><span class="badge bg-success px-3 py-2"><i class="bi bi-check-circle me-1"></i>تطابق: {{ (recon.total_matched or 0) | persian_number }}</span></div>
        <div class="col-auto"><span class="badge bg-danger px-3 py-2"><i class="bi bi-x-circle me-1"></i>مفقود: {{ (recon.total_missing or 0) | persian_number }}</span></div>
        <div class="col-auto"><span class="badge bg-warning px-3 py-2"><i class="bi bi-exclamation-triangle me-1"></i>اضافی: {{ (recon.total_unexpected or 0) | persian_number }}</span></div>
    </div>
    {% if recon.notes %}
    <div class="mt-2"><small class="text-muted"><i class="bi bi-sticky me-1"></i>{{ recon.notes }}</small></div>
    {% endif %}
    {% endif %}
</div>

<!-- Scanner Area (only during in-progress) -->
{% if recon.status.value == 'InProgress' %}
<div class="card-tm no-hover mb-3 tm-animate-fade-in-up tm-delay-2">
    <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-upc-scan me-1"></i> اسکن شمش</h6>

    {% if user.has_permission("inventory", "edit") %}
    <div class="row g-2 align-items-end">
        <div class="col-md-6">
            <div class="input-group">
                <input type="text" id="scanSerial" class="form-control form-control-tm"
                       placeholder="سریال شمش..." dir="ltr" maxlength="12" style="text-transform:uppercase;">
                <button class="btn btn-tm-primary" id="scanBtn" type="button">
                    <i class="bi bi-search"></i> اسکن
                </button>
            </div>
        </div>
        <div class="col-auto">
            <button class="btn btn-outline-primary btn-sm" id="startCamBtn" type="button">
                <i class="bi bi-camera me-1"></i> دوربین
            </button>
            <button class="btn btn-outline-secondary btn-sm" id="stopCamBtn" type="button" style="display:none;">
                <i class="bi bi-stop-circle me-1"></i> توقف
            </button>
        </div>
    </div>

    <div id="cameraArea" style="display:none;" class="mt-2">
        <div id="recon_reader" style="width:100%;max-width:400px;"></div>
    </div>

    <div id="scanResult" class="mt-2"></div>
    <div id="scanError" class="alert alert-danger py-2 d-none mt-2"></div>
    {% endif %}

    <!-- Actions -->
    <div class="d-flex gap-2 mt-3 pt-3 border-top">
        {% if user.has_permission("inventory", "full") %}
        <form method="POST" action="/admin/reconciliation/{{ recon.id }}/finalize" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <input type="text" name="notes" class="form-control form-control-sm d-inline-block" style="width:250px;"
                   placeholder="یادداشت (اختیاری)">
            <button class="btn btn-sm btn-success" onclick="return confirm('آیا مطمئنید؟ پس از تکمیل، موارد اسکن‌نشده مفقود اعلام می‌شوند.')">
                <i class="bi bi-check2-all me-1"></i> تکمیل انبارگردانی
            </button>
        </form>
        <form method="POST" action="/admin/reconciliation/{{ recon.id }}/cancel" class="d-inline">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button class="btn btn-sm btn-outline-danger" onclick="return confirm('لغو انبارگردانی؟')">
                <i class="bi bi-x-lg me-1"></i> لغو
            </button>
        </form>
        {% endif %}
    </div>
</div>
{% endif %}

<!-- Scan Feed / Items Table -->
<div class="card-tm no-hover tm-animate-fade-in-up tm-delay-3">
    <h6 class="border-bottom pb-2 mb-3"><i class="bi bi-list-check me-1"></i> نتایج اسکن</h6>
    <div class="p-0">
        <table class="table table-tm table-sm mb-0">
            <thead>
                <tr><th>سریال</th><th>وضعیت</th><th>محصول</th><th>وضعیت شمش</th><th>زمان اسکن</th></tr>
            </thead>
            <tbody id="scanFeed">
                {% for item in recon.items %}
                <tr class="{% if item.item_status.value == 'Missing' %}table-danger{% elif item.item_status.value == 'Unexpected' %}table-warning{% endif %}">
                    <td dir="ltr"><strong>{{ item.serial_code }}</strong></td>
                    <td><span class="badge bg-{{ item.item_status_color }}">{{ item.item_status_label }}</span></td>
                    <td>{{ item.expected_product or '—' }}</td>
                    <td>{{ item.expected_status or '—' }}</td>
                    <td><small>{{ item.scanned_at | jdate if item.scanned_at else '—' }}</small></td>
                </tr>
                {% else %}
                <tr id="emptyRow"><td colspan="5" class="text-center text-muted py-3">هنوز اسکنی انجام نشده</td></tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>
{% endblock %}

{% block page_js %}
{% if recon.status.value == 'InProgress' %}
<script src="/static/vendor/html5-qrcode/html5-qrcode.min.js?v={{ STATIC_VER }}"></script>
<script src="/static/js/scanner.js?v={{ STATIC_VER }}"></script>
<script>
(function(){
    const csrf = '{{ csrf_token }}';
    const scanUrl = '/admin/reconciliation/{{ recon.id }}/scan';
    const serialInput = document.getElementById('scanSerial');
    const scanBtn = document.getElementById('scanBtn');
    const scanFeed = document.getElementById('scanFeed');
    const scanResult = document.getElementById('scanResult');
    const scanError = document.getElementById('scanError');
    const startCam = document.getElementById('startCamBtn');
    const stopCam = document.getElementById('stopCamBtn');
    const cameraArea = document.getElementById('cameraArea');

    function showError(msg) {
        scanError.textContent = msg;
        scanError.classList.remove('d-none');
        setTimeout(() => scanError.classList.add('d-none'), 4000);
    }

    function doScan(serial) {
        if (!serial) return;
        scanResult.innerHTML = '';
        scanError.classList.add('d-none');

        const fd = new FormData();
        fd.append('serial', serial);
        fd.append('csrf_token', csrf);

        fetch(scanUrl, { method: 'POST', body: fd })
            .then(r => r.json())
            .then(data => {
                if (data.error) { showError(data.error); return; }

                // Remove empty row
                const emptyRow = document.getElementById('emptyRow');
                if (emptyRow) emptyRow.remove();

                const cls = data.status === 'matched' ? '' : 'table-warning';
                const badge = data.status === 'matched'
                    ? '<span class="badge bg-success">تطابق</span>'
                    : '<span class="badge bg-warning">اضافی</span>';
                const row = `<tr class="${cls}">
                    <td dir="ltr"><strong>${data.serial}</strong></td>
                    <td>${badge}</td>
                    <td>${data.product || '—'}</td>
                    <td>${data.bar_status || '—'}</td>
                    <td><small>الان</small></td>
                </tr>`;
                scanFeed.insertAdjacentHTML('afterbegin', row);

                scanResult.innerHTML = data.status === 'matched'
                    ? '<div class="alert alert-success py-2"><i class="bi bi-check-circle me-1"></i>تطابق: ' + data.serial + '</div>'
                    : '<div class="alert alert-warning py-2"><i class="bi bi-exclamation-triangle me-1"></i>اضافی: ' + data.serial + '</div>';

                serialInput.value = '';
                serialInput.focus();
            })
            .catch(() => showError('خطا در ارتباط با سرور'));
    }

    scanBtn.addEventListener('click', () => doScan(serialInput.value.trim().toUpperCase()));
    serialInput.addEventListener('keydown', e => {
        if (e.key === 'Enter') { e.preventDefault(); doScan(serialInput.value.trim().toUpperCase()); }
    });

    // Camera
    startCam.addEventListener('click', () => {
        cameraArea.style.display = 'block';
        startCam.style.display = 'none';
        stopCam.style.display = '';
        TmScanner.startCamera();
    });
    stopCam.addEventListener('click', () => {
        TmScanner.stopCamera();
        cameraArea.style.display = 'none';
        stopCam.style.display = 'none';
        startCam.style.display = '';
    });

    TmScanner.init({
        containerId: 'recon_reader',
        onScan: (code) => doScan(code),
        onError: (err) => showError(err)
    });

    serialInput.focus();
})();
</script>
{% endif %}
{% endblock %}
