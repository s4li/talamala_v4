{% extends "admin/base_admin.html" %}

{% block title %}{% if dealer %}ویرایش{% else %}ایجاد{% endif %} نماینده - طلامالا{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
    <h4 class="mb-0 fw-bold">
        <i class="bi bi-{% if dealer %}pencil{% else %}plus-circle{% endif %} text-tm-primary"></i>
        {% if dealer %}ویرایش نماینده: {{ dealer.full_name }}{% else %}ایجاد نماینده جدید{% endif %}
    </h4>
    <a href="/admin/dealers" class="btn btn-sm btn-tm-outline">
        <i class="bi bi-arrow-right me-1"></i> بازگشت
    </a>
</div>

{% if error %}
<div class="alert-tm-danger">
    <i class="bi bi-exclamation-triangle me-1"></i>
    {{ error }}
</div>
{% endif %}

<div class="card-tm no-hover">
        <form method="POST" action="{% if dealer %}/admin/dealers/{{ dealer.id }}/edit{% else %}/admin/dealers/create{% endif %}">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

            {% if not dealer %}
            <div class="mb-3">
                <label class="form-label-tm fw-bold">شماره موبایل <span class="text-danger">*</span></label>
                <input type="tel" name="mobile" class="form-control form-control-tm" dir="ltr"
                       placeholder="09xxxxxxxxx" pattern="09[0-9]{9}" maxlength="11" required>
            </div>
            {% endif %}

            <div class="mb-3">
                <label class="form-label-tm fw-bold">نام کامل <span class="text-danger">*</span></label>
                <input type="text" name="full_name" class="form-control form-control-tm" required
                       value="{{ dealer.full_name if dealer else '' }}">
            </div>

            {% if not dealer %}
            <div class="mb-3">
                <label class="form-label-tm fw-bold">کد ملی</label>
                <input type="text" name="national_id" class="form-control form-control-tm" dir="ltr"
                       maxlength="10" pattern="[0-9]{10}">
            </div>
            {% endif %}

            <div class="mb-3">
                <label class="form-label-tm fw-bold">محل نمایندگی</label>
                <select name="location_id" class="form-select form-select-tm">
                    <option value="">-- بدون نمایندگی --</option>
                    {% for loc in locations %}
                    <option value="{{ loc.id }}" {% if dealer and dealer.location_id == loc.id %}selected{% endif %}>
                        {{ loc.name }} ({{ loc.city }})
                    </option>
                    {% endfor %}
                </select>
            </div>

            <div class="mb-3">
                <label class="form-label-tm fw-bold">سطح نمایندگی</label>
                <select name="tier_id" class="form-select form-select-tm">
                    <option value="">-- بدون سطح --</option>
                    {% for tier in tiers %}
                    <option value="{{ tier.id }}" {% if dealer and dealer.tier_id == tier.id %}selected{% endif %}>
                        {{ tier.name }}
                    </option>
                    {% endfor %}
                </select>
                <small class="text-muted">سود نماینده بر اساس اختلاف اجرت سطح نمایندگی و مشتری نهایی محاسبه می‌شود</small>
            </div>

            {% if dealer %}
            <div class="mb-3">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" name="is_active" id="isActive"
                           {% if dealer.is_active %}checked{% endif %}>
                    <label class="form-check-label fw-bold" for="isActive">فعال</label>
                </div>
            </div>
            {% endif %}

            <button type="submit" class="btn-tm-primary btn btn-lg px-5">
                <i class="bi bi-check-circle me-1"></i>
                {% if dealer %}ذخیره تغییرات{% else %}ایجاد نماینده{% endif %}
            </button>
        </form>
</div>

{% if dealer %}
<!-- API Key Management (POS Device) -->
<div class="card-tm no-hover mt-4">
    <div class="border-bottom pb-3 mb-3">
        <h6 class="fw-bold mb-0">
            <i class="bi bi-key text-tm-primary me-1"></i>
            کلید API دستگاه POS
        </h6>
    </div>
        {% if dealer.api_key %}
        <div class="mb-3">
            <label class="form-label-tm fw-bold">کلید فعلی</label>
            <div class="input-group">
                <input type="text" class="form-control form-control-tm font-monospace" dir="ltr"
                       id="apiKeyField"
                       value="{{ dealer.api_key[:8] }}...{{ dealer.api_key[-8:] }}"
                       data-full="{{ dealer.api_key }}" readonly>
                <button class="btn btn-tm-outline" type="button"
                        onclick="let f=document.getElementById('apiKeyField'); if(f.value.includes('...')){f.value=f.dataset.full;this.innerHTML='<i class=\'bi bi-eye-slash\'></i>'}else{f.value=f.dataset.full.substring(0,8)+'...'+f.dataset.full.substring(f.dataset.full.length-8);this.innerHTML='<i class=\'bi bi-eye\'></i>'}">
                    <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-tm-outline" type="button"
                        onclick="navigator.clipboard.writeText(document.getElementById('apiKeyField').dataset.full)">
                    <i class="bi bi-clipboard"></i>
                </button>
            </div>
            <small class="text-muted">این کلید در هدر <code dir="ltr">X-API-Key</code> درخواست‌های POS ارسال می‌شود.</small>
        </div>
        <div class="d-flex gap-2">
            <form method="POST" action="/admin/dealers/{{ dealer.id }}/generate-api-key"
                  onsubmit="return confirm('کلید قبلی لغو و کلید جدید تولید می‌شود. ادامه می‌دهید؟')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button class="btn btn-sm btn-tm-warning">
                    <i class="bi bi-arrow-repeat me-1"></i> تولید کلید جدید
                </button>
            </form>
            <form method="POST" action="/admin/dealers/{{ dealer.id }}/revoke-api-key"
                  onsubmit="return confirm('کلید API حذف می‌شود و دستگاه POS دیگر نمی‌تواند متصل شود. ادامه می‌دهید؟')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button class="btn btn-sm btn-tm-danger">
                    <i class="bi bi-x-circle me-1"></i> لغو کلید
                </button>
            </form>
        </div>
        {% else %}
        <p class="text-muted mb-3">هنوز کلید API برای این نماینده تولید نشده است.</p>
        <form method="POST" action="/admin/dealers/{{ dealer.id }}/generate-api-key">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button class="btn btn-sm btn-tm-primary">
                <i class="bi bi-key me-1"></i> تولید کلید API
            </button>
        </form>
        {% endif %}
</div>
{% endif %}
{% endblock %}
