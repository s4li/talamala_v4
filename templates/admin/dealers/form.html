{% extends "admin/base_admin.html" %}

{% block title %}{% if dealer %}ویرایش{% else %}ایجاد{% endif %} نماینده - طلاملا{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4">
    <h4 class="mb-0 fw-bold">
        <i class="bi bi-{% if dealer %}pencil{% else %}plus-circle{% endif %} text-tm-primary"></i>
        {% if dealer %}ویرایش نماینده: {{ dealer.full_name }}{% else %}ایجاد نماینده جدید{% endif %}
    </h4>
    <a href="/admin/dealers" class="btn btn-sm btn-tm-outline">
        <i class="bi bi-arrow-right me-1"></i> بازگشت
    </a>
</div>

{% if error %}
<div class="alert-tm-danger">
    <i class="bi bi-exclamation-triangle me-1"></i>
    {{ error }}
</div>
{% endif %}

<div class="card-tm no-hover">
    <form method="POST" action="{% if dealer %}/admin/dealers/{{ dealer.id }}/edit{% else %}/admin/dealers/create{% endif %}">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

        <!-- اطلاعات پایه -->
        <h6 class="fw-bold mb-3 pb-2" style="border-bottom: 1px solid var(--tm-primary-100);">
            <i class="bi bi-person text-tm-primary me-1"></i> اطلاعات پایه
        </h6>

        {% if not dealer %}
        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <label class="form-label-tm fw-bold">شماره موبایل <span class="text-danger">*</span></label>
                <input type="tel" name="mobile" class="form-control form-control-tm" dir="ltr"
                       placeholder="09xxxxxxxxx" pattern="09[0-9]{9}" maxlength="11" required>
            </div>
            <div class="col-md-6">
                <label class="form-label-tm fw-bold">کد ملی</label>
                <input type="text" name="national_id" class="form-control form-control-tm" dir="ltr"
                       maxlength="10" pattern="[0-9]{10}">
            </div>
        </div>
        {% endif %}

        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <label class="form-label-tm fw-bold">نام کامل <span class="text-danger">*</span></label>
                <input type="text" name="full_name" class="form-control form-control-tm" required
                       value="{{ dealer.full_name if dealer else '' }}">
            </div>
            <div class="col-md-6">
                <label class="form-label-tm fw-bold">سطح نمایندگی</label>
                <select name="tier_id" class="form-select form-select-tm">
                    <option value="">-- انتخاب سطح --</option>
                    {% for tier in tiers %}
                    <option value="{{ tier.id }}" {% if dealer and dealer.tier_id == tier.id %}selected{% endif %}>
                        {{ tier.name }}
                    </option>
                    {% endfor %}
                </select>
                <small class="text-muted">سود نماینده بر اساس اختلاف اجرت سطح نمایندگی و مشتری نهایی محاسبه می‌شود</small>
            </div>
        </div>

        <!-- آدرس نمایندگی -->
        <h6 class="fw-bold mb-3 mt-4 pb-2" style="border-bottom: 1px solid var(--tm-primary-100);">
            <i class="bi bi-geo-alt text-tm-primary me-1"></i> آدرس نمایندگی
        </h6>

        <div class="row g-3 mb-3">
            <div class="col-md-4">
                <label class="form-label-tm fw-bold">استان <span class="text-danger">*</span></label>
                <select name="province_id" id="provinceSelect" class="form-select form-select-tm"
                        onchange="loadCities(this.value)">
                    <option value="">-- انتخاب استان --</option>
                    {% for p in provinces %}
                    <option value="{{ p.id }}" {% if dealer and dealer.province_id == p.id %}selected{% endif %}>
                        {{ p.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label-tm fw-bold">شهر <span class="text-danger">*</span></label>
                <select name="city_id" id="citySelect" class="form-select form-select-tm"
                        onchange="loadDistricts(this.value)" {% if not cities %}disabled{% endif %}>
                    <option value="">-- انتخاب شهر --</option>
                    {% for c in cities %}
                    <option value="{{ c.id }}" {% if dealer and dealer.city_id == c.id %}selected{% endif %}>
                        {{ c.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <label class="form-label-tm fw-bold">محله / منطقه</label>
                <select name="district_id" id="districtSelect" class="form-select form-select-tm"
                        {% if not districts %}disabled{% endif %}>
                    <option value="">-- انتخاب محله --</option>
                    {% for d in districts %}
                    <option value="{{ d.id }}" {% if dealer and dealer.district_id == d.id %}selected{% endif %}>
                        {{ d.name }}
                    </option>
                    {% endfor %}
                </select>
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label-tm fw-bold">آدرس کامل پستی</label>
            <textarea name="address" class="form-control form-control-tm" rows="2"
                      placeholder="خیابان، کوچه، پلاک، واحد...">{{ dealer.address if dealer and dealer.address else '' }}</textarea>
        </div>

        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <label class="form-label-tm fw-bold">کد پستی</label>
                <input type="text" name="postal_code" class="form-control form-control-tm" dir="ltr"
                       maxlength="10" pattern="[0-9]{10}" placeholder="۱۰ رقمی"
                       value="{{ dealer.postal_code if dealer and dealer.postal_code else '' }}">
            </div>
            <div class="col-md-6">
                <label class="form-label-tm fw-bold">تلفن ثابت</label>
                <input type="tel" name="landline_phone" class="form-control form-control-tm" dir="ltr"
                       placeholder="021xxxxxxxx"
                       value="{{ dealer.landline_phone if dealer and dealer.landline_phone else '' }}">
            </div>
        </div>

        <!-- نوع نمایندگی -->
        <h6 class="fw-bold mb-3 mt-4 pb-2" style="border-bottom: 1px solid var(--tm-primary-100);">
            <i class="bi bi-building text-tm-primary me-1"></i> نوع نمایندگی
        </h6>
        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" name="is_warehouse" id="isWarehouse"
                           {% if dealer and dealer.is_warehouse %}checked{% endif %}>
                    <label class="form-check-label fw-bold" for="isWarehouse">
                        <i class="bi bi-box-seam me-1"></i> انبار مرکزی
                    </label>
                    <div class="small text-muted">بدون فروش POS — فقط ذخیره و ارسال</div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" name="is_postal_hub" id="isPostalHub"
                           {% if dealer and dealer.is_postal_hub %}checked{% endif %}>
                    <label class="form-check-label fw-bold" for="isPostalHub">
                        <i class="bi bi-envelope me-1"></i> هاب ارسال پستی
                    </label>
                    <div class="small text-muted">شمش‌های سفارش پستی از اینجا ارسال می‌شوند</div>
                </div>
            </div>
        </div>

        <!-- وضعیت (فقط ویرایش) -->
        {% if dealer %}
        <h6 class="fw-bold mb-3 mt-4 pb-2" style="border-bottom: 1px solid var(--tm-primary-100);">
            <i class="bi bi-toggles text-tm-primary me-1"></i> وضعیت
        </h6>
        <div class="mb-3">
            <div class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="is_active" id="isActive"
                       {% if dealer.is_active %}checked{% endif %}>
                <label class="form-check-label fw-bold" for="isActive">فعال</label>
            </div>
        </div>
        {% endif %}

        <button type="submit" class="btn-tm-primary btn btn-lg px-5 mt-3">
            <i class="bi bi-check-circle me-1"></i>
            {% if dealer %}ذخیره تغییرات{% else %}ایجاد نماینده{% endif %}
        </button>
    </form>
</div>

{% if dealer %}
<!-- API Key Management (POS Device) -->
<div class="card-tm no-hover mt-4">
    <div class="border-bottom pb-3 mb-3">
        <h6 class="fw-bold mb-0">
            <i class="bi bi-key text-tm-primary me-1"></i>
            کلید API دستگاه POS
        </h6>
    </div>
        {% if dealer.api_key %}
        <div class="mb-3">
            <label class="form-label-tm fw-bold">کلید فعلی</label>
            <div class="input-group">
                <input type="text" class="form-control form-control-tm font-monospace" dir="ltr"
                       id="apiKeyField"
                       value="{{ dealer.api_key[:8] }}...{{ dealer.api_key[-8:] }}"
                       data-full="{{ dealer.api_key }}" readonly>
                <button class="btn btn-tm-outline" type="button"
                        onclick="let f=document.getElementById('apiKeyField'); if(f.value.includes('...')){f.value=f.dataset.full;this.innerHTML='<i class=\'bi bi-eye-slash\'></i>'}else{f.value=f.dataset.full.substring(0,8)+'...'+f.dataset.full.substring(f.dataset.full.length-8);this.innerHTML='<i class=\'bi bi-eye\'></i>'}">
                    <i class="bi bi-eye"></i>
                </button>
                <button class="btn btn-tm-outline" type="button"
                        onclick="navigator.clipboard.writeText(document.getElementById('apiKeyField').dataset.full)">
                    <i class="bi bi-clipboard"></i>
                </button>
            </div>
            <small class="text-muted">این کلید در هدر <code dir="ltr">X-API-Key</code> درخواست‌های POS ارسال می‌شود.</small>
        </div>
        <div class="d-flex gap-2">
            <form method="POST" action="/admin/dealers/{{ dealer.id }}/generate-api-key"
                  onsubmit="return confirm('کلید قبلی لغو و کلید جدید تولید می‌شود. ادامه می‌دهید؟')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button class="btn btn-sm btn-tm-warning">
                    <i class="bi bi-arrow-repeat me-1"></i> تولید کلید جدید
                </button>
            </form>
            <form method="POST" action="/admin/dealers/{{ dealer.id }}/revoke-api-key"
                  onsubmit="return confirm('کلید API حذف می‌شود و دستگاه POS دیگر نمی‌تواند متصل شود. ادامه می‌دهید؟')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button class="btn btn-sm btn-tm-danger">
                    <i class="bi bi-x-circle me-1"></i> لغو کلید
                </button>
            </form>
        </div>
        {% else %}
        <p class="text-muted mb-3">هنوز کلید API برای این نماینده تولید نشده است.</p>
        <form method="POST" action="/admin/dealers/{{ dealer.id }}/generate-api-key">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button class="btn btn-sm btn-tm-primary">
                <i class="bi bi-key me-1"></i> تولید کلید API
            </button>
        </form>
        {% endif %}
</div>

<!-- Rasis POS Sync -->
<div class="card-tm no-hover mt-4">
    <h6 class="fw-bold border-bottom pb-2 mb-3"><i class="bi bi-terminal me-1"></i>همگام‌سازی پوز راسیس</h6>
    {% if dealer.rasis_sharepoint %}
    <div class="d-flex align-items-center gap-3 mb-3">
        <span class="badge bg-success"><i class="bi bi-check-circle me-1"></i>ثبت شده</span>
        <span class="text-muted small">Sharepoint: <code>{{ dealer.rasis_sharepoint }}</code></span>
    </div>
    {% else %}
    <p class="text-muted mb-3">این نماینده هنوز در سیستم پوز راسیس ثبت نشده است.</p>
    {% endif %}
    <form method="POST" action="/admin/dealers/{{ dealer.id }}/rasis-sync">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <button class="btn btn-sm btn-tm-primary">
            <i class="bi bi-arrow-repeat me-1"></i>
            {% if dealer.rasis_sharepoint %}همگام‌سازی مجدد{% else %}ثبت و همگام‌سازی{% endif %}
        </button>
    </form>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script>
async function loadCities(provinceId) {
    const citySelect = document.getElementById('citySelect');
    const districtSelect = document.getElementById('districtSelect');

    // Reset city & district
    citySelect.innerHTML = '<option value="">-- انتخاب شهر --</option>';
    citySelect.disabled = true;
    districtSelect.innerHTML = '<option value="">-- انتخاب محله --</option>';
    districtSelect.disabled = true;

    if (!provinceId) return;

    const res = await fetch('/api/geo/cities?province_id=' + provinceId);
    const cities = await res.json();
    cities.forEach(c => {
        const opt = document.createElement('option');
        opt.value = c.id;
        opt.textContent = c.name;
        citySelect.appendChild(opt);
    });
    citySelect.disabled = false;
}

async function loadDistricts(cityId) {
    const districtSelect = document.getElementById('districtSelect');
    districtSelect.innerHTML = '<option value="">-- انتخاب محله --</option>';
    districtSelect.disabled = true;

    if (!cityId) return;

    const res = await fetch('/api/geo/districts?city_id=' + cityId);
    const districts = await res.json();
    districts.forEach(d => {
        const opt = document.createElement('option');
        opt.value = d.id;
        opt.textContent = d.name;
        districtSelect.appendChild(opt);
    });
    districtSelect.disabled = false;
}
</script>
{% endblock %}
