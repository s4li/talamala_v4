{% extends "admin/base_admin.html" %}
{% block title %}کوپن {{ coupon.code }} - طلاملا{% endblock %}

{% block content %}
<div class="page-header">
    <div>
        <h4 class="mb-1">
            <i class="bi bi-ticket-perforated me-2"></i>
            <code class="fs-4">{{ coupon.code }}</code>
        </h4>
        <small class="text-muted">{{ coupon.title }}</small>
    </div>
    <div class="d-flex gap-2">
        <a href="/admin/coupons/{{ coupon.id }}/edit" class="btn btn-tm-outline">
            <i class="bi bi-pencil me-1"></i> ویرایش
        </a>
        <a href="/admin/coupons" class="btn btn-tm-outline">
            <i class="bi bi-arrow-right me-1"></i> بازگشت
        </a>
    </div>
</div>

{% if msg %}
<div class="alert alert-tm-success alert-dismissible fade show">
    <i class="bi bi-check-circle me-1"></i> {{ msg }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}
{% if error %}
<div class="alert alert-tm-danger alert-dismissible fade show">
    <i class="bi bi-exclamation-triangle me-1"></i> {{ error }}
    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
</div>
{% endif %}

<div class="row g-4">
    <!-- Coupon Info -->
    <div class="col-md-5">
        <div class="card-tm no-hover">
            <div class="border-bottom pb-3 mb-3 d-flex justify-content-between">
                <span><i class="bi bi-info-circle me-1"></i> مشخصات</span>
                <span class="badge-tm badge-tm-{{ coupon.status_color }}">{{ coupon.status_label }}</span>
            </div>
                <table class="table table-tm table-sm mb-0">
                    <tr>
                        <td class="text-muted" style="width:40%;">نوع</td>
                        <td>
                            <span class="badge-tm badge-tm-{{ 'success' if coupon.coupon_type == 'DISCOUNT' else 'info' }}">
                                {{ coupon.coupon_type_label }}
                            </span>
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted">مقدار</td>
                        <td class="fw-bold">{{ coupon.discount_display }}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">دامنه</td>
                        <td>
                            {{ coupon.scope_label }}
                            {% if coupon.scope_product %}
                            <br><small class="text-muted">{{ coupon.scope_product.name }}</small>
                            {% endif %}
                            {% if coupon.scope_category %}
                            <br><small class="text-muted">{{ coupon.scope_category }}</small>
                            {% endif %}
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted">استفاده</td>
                        <td>
                            <span class="fw-bold">{{ coupon.current_uses }}</span>
                            {% if coupon.max_total_uses %}/ {{ coupon.max_total_uses }}{% endif %}
                            <small class="text-muted">(هر مشتری: {{ coupon.max_per_customer }})</small>
                        </td>
                    </tr>
                    <tr>
                        <td class="text-muted">حداقل سفارش</td>
                        <td>
                            {% if coupon.min_order_amount %}{{ coupon.min_order_amount | toman }} تومان{% else %}—{% endif %}
                        </td>
                    </tr>
                    {% if coupon.max_order_amount %}
                    <tr>
                        <td class="text-muted">حداکثر سفارش</td>
                        <td>{{ coupon.max_order_amount | toman }} تومان</td>
                    </tr>
                    {% endif %}
                    <tr>
                        <td class="text-muted">شروع</td>
                        <td>{% if coupon.starts_at %}{{ coupon.starts_at | jdate }}{% else %}فوری{% endif %}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">انقضا</td>
                        <td>{% if coupon.expires_at %}{{ coupon.expires_at | jdate }}{% else %}بدون انقضا{% endif %}</td>
                    </tr>
                    <tr>
                        <td class="text-muted">ویژگی‌ها</td>
                        <td>
                            {% if coupon.first_purchase_only %}<span class="badge-tm badge-tm-warning me-1">اولین خرید</span>{% endif %}
                            {% if coupon.is_combinable %}<span class="badge-tm badge-tm-info me-1">قابل ترکیب</span>{% endif %}
                            {% if coupon.is_private %}<span class="badge-tm badge-tm-info me-1">خصوصی</span>{% endif %}
                            {% if not coupon.first_purchase_only and not coupon.is_combinable and not coupon.is_private %}—{% endif %}
                        </td>
                    </tr>
                    {% if coupon.description %}
                    <tr>
                        <td class="text-muted">توضیحات</td>
                        <td class="small">{{ coupon.description }}</td>
                    </tr>
                    {% endif %}
                </table>
            <div class="border-top pt-3 mt-3 text-center">
                <form method="post" action="/admin/coupons/{{ coupon.id }}/delete" style="display:inline;">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <button type="submit" class="btn btn-sm btn-tm-danger"
                            onclick="return confirm('آیا از حذف این کوپن اطمینان دارید؟');">
                        <i class="bi bi-trash me-1"></i> حذف کوپن
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Mobile Whitelist -->
    <div class="col-md-7">
        <div class="card-tm no-hover mb-4">
            <div class="border-bottom pb-3 mb-3 d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-phone me-1"></i> شماره‌های مجاز
                    <span class="badge-tm badge-tm-info ms-1">{{ coupon.allowed_mobiles | length }}</span>
                </span>
            </div>
                {% if coupon.allowed_mobiles %}
                <div class="mb-3" style="max-height:200px;overflow-y:auto;">
                    <table class="table table-tm table-sm mb-0">
                        <thead><tr><th>شماره</th><th>یادداشت</th><th style="width:50px;"></th></tr></thead>
                        <tbody>
                            {% for m in coupon.allowed_mobiles %}
                            <tr>
                                <td><code>{{ m.mobile }}</code></td>
                                <td class="small text-muted">{{ m.note or '—' }}</td>
                                <td>
                                    <form method="post" action="/admin/coupons/{{ coupon.id }}/mobiles/{{ m.id }}/remove" style="display:inline;">
                                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                        <button class="btn btn-sm btn-tm-danger py-0" title="حذف">
                                            <i class="bi bi-x"></i>
                                        </button>
                                    </form>
                                </td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
                {% else %}
                <p class="text-muted small mb-3">
                    <i class="bi bi-globe me-1"></i> بدون محدودیت شماره — برای همه مشتریان فعال است.
                </p>
                {% endif %}

                <!-- Add mobiles -->
                <div class="border-top pt-3">
                    <form method="post" action="/admin/coupons/{{ coupon.id }}/mobiles/add">
                        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">

                        <!-- Single -->
                        <div class="row g-2 mb-2">
                            <div class="col-5">
                                <input type="text" name="single_mobile" class="form-control form-control-tm form-control-sm" dir="ltr"
                                       placeholder="09121234567">
                            </div>
                            <div class="col-5">
                                <input type="text" name="note" class="form-control form-control-tm form-control-sm"
                                       placeholder="یادداشت (اختیاری)">
                            </div>
                            <div class="col-2">
                                <button type="submit" class="btn btn-sm btn-tm-success w-100">
                                    <i class="bi bi-plus"></i>
                                </button>
                            </div>
                        </div>

                        <!-- Bulk -->
                        <details class="small">
                            <summary class="text-muted cursor-pointer">افزودن گروهی...</summary>
                            <textarea name="mobiles_text" class="form-control form-control-tm form-control-sm mt-2" rows="3" dir="ltr"
                                      placeholder="هر شماره در یک خط یا با کاما جدا کنید"></textarea>
                            <button type="submit" class="btn btn-sm btn-tm-outline mt-2">
                                <i class="bi bi-upload me-1"></i> افزودن گروهی
                            </button>
                        </details>
                    </form>
                </div>
        </div>

        <!-- Usage History -->
        <div class="card-tm no-hover">
            <div class="border-bottom pb-3 mb-3">
                <i class="bi bi-clock-history me-1"></i> تاریخچه استفاده
                <span class="badge-tm badge-tm-info ms-1">{{ usage_total }}</span>
            </div>
                {% if usages %}
                <table class="table table-tm table-sm mb-0 align-middle">
                    <thead>
                        <tr>
                            <th>مشتری</th>
                            <th>سفارش</th>
                            <th>مبلغ تخفیف</th>
                            <th>کشبک</th>
                            <th>تاریخ</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for u in usages %}
                        <tr>
                            <td>
                                {{ u.customer.full_name if u.customer else '—' }}
                                <br><small class="text-muted">{{ u.customer.mobile if u.customer else '' }}</small>
                            </td>
                            <td>
                                {% if u.order_id %}
                                <a href="/admin/orders#{{ u.order_id }}" class="text-decoration-none">#{{ u.order_id }}</a>
                                {% else %}—{% endif %}
                            </td>
                            <td class="fw-bold text-success">{{ u.discount_amount | toman }} تومان</td>
                            <td>
                                {% if u.cashback_settled %}
                                <span class="badge-tm badge-tm-success">واریز شده</span>
                                {% else %}
                                <span class="badge-tm badge-tm-info">—</span>
                                {% endif %}
                            </td>
                            <td class="small text-muted">{{ u.created_at | jdate if u.created_at else '—' }}</td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
                {% else %}
                <div class="text-center text-muted py-4">
                    <i class="bi bi-inbox"></i> هنوز استفاده‌ای ثبت نشده
                </div>
                {% endif %}
        </div>
    </div>
</div>
{% endblock %}
