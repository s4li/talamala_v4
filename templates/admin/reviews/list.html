{% extends "admin/base_admin.html" %}
{% block title %}نظرات و دیدگاه‌ها - پنل مدیریت{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h4 class="fw-bold mb-0"><i class="bi bi-chat-square-text me-2"></i>نظرات و دیدگاه‌ها</h4>
</div>

<!-- Tabs -->
<ul class="nav nav-pills mb-3">
    <li class="nav-item">
        <a class="nav-link {% if tab == 'reviews' %}active{% endif %}" href="/admin/reviews?tab=reviews">
            <i class="bi bi-star me-1"></i>دیدگاه‌ها (امتیاز)
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if tab == 'comments' %}active{% endif %}" href="/admin/reviews?tab=comments">
            <i class="bi bi-chat-dots me-1"></i>نظرات و پرسش‌ها
        </a>
    </li>
</ul>

<!-- Search -->
<form method="GET" action="/admin/reviews" class="mb-3">
    <input type="hidden" name="tab" value="{{ tab }}">
    <div class="input-group">
        <input type="text" name="search" class="form-control form-control-tm" value="{{ search }}"
               placeholder="جستجو (نام محصول، موبایل، متن نظر)...">
        <button class="btn btn-tm-primary" type="submit"><i class="bi bi-search"></i></button>
    </div>
</form>

{% if tab == 'reviews' %}
<!-- Reviews Table -->
<div class="card-tm no-hover">
    {% if reviews %}
    <div class="table-responsive">
        <table class="table table-tm align-middle mb-0">
            <thead>
                <tr>
                    <th>#</th>
                    <th>محصول</th>
                    <th>مشتری</th>
                    <th>امتیاز</th>
                    <th>متن</th>
                    <th>پاسخ ادمین</th>
                    <th>تاریخ</th>
                    <th>عملیات</th>
                </tr>
            </thead>
            <tbody>
                {% for r in reviews %}
                <tr>
                    <td>{{ r.id }}</td>
                    <td>
                        <a href="/product/{{ r.product_id }}" class="text-decoration-none fw-bold" target="_blank">
                            {{ r.product.name if r.product else '—' }}
                        </a>
                    </td>
                    <td>
                        {% if r.customer %}
                        <div class="small">{{ r.customer.full_name or '—' }}</div>
                        <div class="text-muted small" dir="ltr">{{ r.customer.mobile }}</div>
                        {% else %}—{% endif %}
                    </td>
                    <td>
                        <span class="text-warning">
                            {% for i in range(1, 6) %}
                            <i class="bi bi-star{% if i <= r.rating %}-fill{% endif %}"></i>
                            {% endfor %}
                        </span>
                    </td>
                    <td>
                        <div class="small" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                            {{ r.body }}
                        </div>
                        {% if r.images %}
                        <span class="badge bg-light text-dark"><i class="bi bi-image"></i> {{ r.images|length }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if r.admin_reply %}
                        <span class="badge-tm badge-tm-success">پاسخ داده شده</span>
                        {% else %}
                        <span class="badge-tm badge-tm-warning">بدون پاسخ</span>
                        {% endif %}
                    </td>
                    <td class="small text-muted">{{ r.created_at | jdate }}</td>
                    <td>
                        <a href="/admin/reviews/{{ r.id }}" class="btn btn-sm btn-tm-outline">
                            <i class="bi bi-eye"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-5 text-muted">
        <i class="bi bi-star" style="font-size:3rem;"></i>
        <p class="mt-2">هنوز دیدگاهی ثبت نشده</p>
    </div>
    {% endif %}
</div>

{% else %}
<!-- Comments Table -->
<div class="card-tm no-hover">
    {% if comments %}
    <div class="table-responsive">
        <table class="table table-tm align-middle mb-0">
            <thead>
                <tr>
                    <th>#</th>
                    <th>محصول</th>
                    <th>فرستنده</th>
                    <th>متن</th>
                    <th>پاسخ‌ها</th>
                    <th>تاریخ</th>
                    <th>عملیات</th>
                </tr>
            </thead>
            <tbody>
                {% for c in comments %}
                <tr>
                    <td>{{ c.id }}</td>
                    <td>
                        <a href="/product/{{ c.product_id }}" class="text-decoration-none fw-bold" target="_blank">
                            {{ c.product.name if c.product else '—' }}
                        </a>
                    </td>
                    <td>
                        <div class="small fw-bold">{{ c.sender_name }}</div>
                        {% if c.customer %}
                        <div class="text-muted small" dir="ltr">{{ c.customer.mobile }}</div>
                        {% endif %}
                    </td>
                    <td>
                        <div class="small" style="max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">
                            {{ c.body }}
                        </div>
                        {% if c.images %}
                        <span class="badge bg-light text-dark"><i class="bi bi-image"></i> {{ c.images|length }}</span>
                        {% endif %}
                    </td>
                    <td>
                        {% if c.replies %}
                        <span class="badge-tm badge-tm-info">{{ c.replies|length }} پاسخ</span>
                        {% else %}
                        <span class="text-muted small">—</span>
                        {% endif %}
                    </td>
                    <td class="small text-muted">{{ c.created_at | jdate }}</td>
                    <td>
                        <a href="/admin/reviews/comments/{{ c.id }}" class="btn btn-sm btn-tm-outline">
                            <i class="bi bi-eye"></i>
                        </a>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
    {% else %}
    <div class="text-center py-5 text-muted">
        <i class="bi bi-chat-dots" style="font-size:3rem;"></i>
        <p class="mt-2">هنوز نظری ثبت نشده</p>
    </div>
    {% endif %}
</div>
{% endif %}

<!-- Pagination -->
{% if total_pages > 1 %}
<nav class="mt-3">
    <ul class="pagination justify-content-center">
        {% for p in range(1, total_pages + 1) %}
        <li class="page-item {% if p == page %}active{% endif %}">
            <a class="page-link" href="/admin/reviews?tab={{ tab }}&search={{ search }}&page={{ p }}">{{ p }}</a>
        </li>
        {% endfor %}
    </ul>
</nav>
{% endif %}
{% endblock %}
