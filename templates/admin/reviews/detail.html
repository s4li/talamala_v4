{% extends "admin/base_admin.html" %}
{% block title %}{% if view_type == 'review' %}دیدگاه #{{ review.id }}{% else %}نظر #{{ comment.id }}{% endif %} - پنل مدیریت{% endblock %}

{% block content %}
<nav class="mb-3">
    <ol class="breadcrumb small">
        <li class="breadcrumb-item"><a href="/admin/reviews{% if view_type == 'comment' %}?tab=comments{% endif %}" class="text-decoration-none">نظرات و دیدگاه‌ها</a></li>
        <li class="breadcrumb-item active">{% if view_type == 'review' %}دیدگاه #{{ review.id }}{% else %}نظر #{{ comment.id }}{% endif %}</li>
    </ol>
</nav>

{% if view_type == 'review' %}
<!-- ========================= REVIEW DETAIL ========================= -->
<div class="row g-4">
    <div class="col-lg-8">
        <div class="card-tm no-hover">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h5 class="fw-bold mb-1">دیدگاه برای: {{ review.product.name if review.product else '—' }}</h5>
                    <div class="text-warning mb-2">
                        {% for i in range(1, 6) %}
                        <i class="bi bi-star{% if i <= review.rating %}-fill{% endif %} fs-5"></i>
                        {% endfor %}
                        <span class="text-muted ms-2 small">{{ review.rating }} از ۵</span>
                    </div>
                </div>
                <a href="/product/{{ review.product_id }}" target="_blank" class="btn btn-sm btn-tm-outline">
                    <i class="bi bi-box-arrow-up-right me-1"></i>مشاهده محصول
                </a>
            </div>

            <div class="p-3 bg-light rounded-3 mb-3">
                {{ review.body }}
            </div>

            {% if review.images %}
            <div class="d-flex gap-2 flex-wrap mb-3">
                {% for img in review.images %}
                <a href="/{{ img.file_path }}" target="_blank">
                    <img src="/{{ img.file_path }}" class="img-thumb-lg" alt="تصویر">
                </a>
                {% endfor %}
            </div>
            {% endif %}

            <div class="small text-muted">
                <i class="bi bi-clock me-1"></i>{{ review.created_at | jdate }}
            </div>
        </div>

        <!-- Admin Reply Section -->
        <div class="card-tm no-hover mt-3">
            <h6 class="fw-bold mb-3"><i class="bi bi-reply me-1"></i>پاسخ مدیریت</h6>

            {% if review.admin_reply %}
            <div class="p-3 bg-success bg-opacity-10 rounded-3 mb-3">
                <div class="small text-muted mb-1">
                    <i class="bi bi-check-circle text-success me-1"></i>
                    پاسخ داده شده — {{ review.admin_reply_at | jdate if review.admin_reply_at else '' }}
                </div>
                {{ review.admin_reply }}
            </div>
            {% endif %}

            <form method="POST" action="/admin/reviews/{{ review.id }}/reply">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <textarea name="reply_text" class="form-control form-control-tm mb-2" rows="3"
                          placeholder="پاسخ خود را بنویسید...">{{ review.admin_reply or '' }}</textarea>
                <button class="btn btn-tm-success">
                    <i class="bi bi-send me-1"></i>{% if review.admin_reply %}ویرایش پاسخ{% else %}ارسال پاسخ{% endif %}
                </button>
            </form>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Customer Info -->
        <div class="card-tm no-hover">
            <h6 class="fw-bold mb-3"><i class="bi bi-person me-1"></i>اطلاعات مشتری</h6>
            {% if review.customer %}
            <table class="table table-tm table-borderless table-sm mb-0">
                <tr><td class="text-muted">نام</td><td class="fw-bold">{{ review.customer.full_name or '—' }}</td></tr>
                <tr><td class="text-muted">موبایل</td><td dir="ltr">{{ review.customer.mobile }}</td></tr>
            </table>
            {% endif %}
        </div>

        <!-- Delete -->
        <div class="card-tm no-hover mt-3 border-start border-4 border-danger">
            <form method="POST" action="/admin/reviews/{{ review.id }}/delete"
                  onsubmit="return confirm('آیا از حذف این دیدگاه مطمئنید؟')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button class="btn btn-tm-danger w-100">
                    <i class="bi bi-trash me-1"></i>حذف دیدگاه
                </button>
            </form>
        </div>
    </div>
</div>

{% else %}
<!-- ========================= COMMENT DETAIL ========================= -->
<div class="row g-4">
    <div class="col-lg-8">
        <div class="card-tm no-hover">
            <div class="d-flex justify-content-between align-items-start mb-3">
                <div>
                    <h5 class="fw-bold mb-1">نظر برای: {{ comment.product.name if comment.product else '—' }}</h5>
                </div>
                <a href="/product/{{ comment.product_id }}" target="_blank" class="btn btn-sm btn-tm-outline">
                    <i class="bi bi-box-arrow-up-right me-1"></i>مشاهده محصول
                </a>
            </div>

            <!-- Original Comment -->
            <div class="p-3 bg-light rounded-3 mb-3">
                <div class="d-flex justify-content-between mb-2">
                    <span class="fw-bold small">
                        <span class="badge-tm badge-tm-{{ comment.sender_badge_color }} me-1">{{ comment.sender_type_label }}</span>
                        {{ comment.sender_name }}
                    </span>
                    <span class="small text-muted">{{ comment.created_at | jdate }}</span>
                </div>
                {{ comment.body }}
            </div>

            {% if comment.images %}
            <div class="d-flex gap-2 flex-wrap mb-3">
                {% for img in comment.images %}
                <a href="/{{ img.file_path }}" target="_blank">
                    <img src="/{{ img.file_path }}" class="img-thumb-lg" alt="تصویر">
                </a>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Replies -->
            {% if replies %}
            <h6 class="fw-bold mt-4 mb-3"><i class="bi bi-chat-left-text me-1"></i>پاسخ‌ها ({{ replies|length }})</h6>
            {% for reply in replies %}
            <div class="p-3 rounded-3 mb-2 {% if reply.is_admin %}bg-success bg-opacity-10{% else %}bg-light{% endif %}" style="margin-right:1.5rem;">
                <div class="d-flex justify-content-between mb-1">
                    <span class="fw-bold small">
                        <span class="badge-tm badge-tm-{{ reply.sender_badge_color }} me-1">{{ reply.sender_type_label }}</span>
                        {{ reply.sender_name }}
                    </span>
                    <div>
                        <span class="small text-muted me-2">{{ reply.created_at | jdate }}</span>
                        <form method="POST" action="/admin/reviews/comments/{{ reply.id }}/delete" class="d-inline"
                              onsubmit="return confirm('حذف این پاسخ؟')">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <button class="btn btn-sm text-danger p-0"><i class="bi bi-trash"></i></button>
                        </form>
                    </div>
                </div>
                {{ reply.body }}
                {% if reply.images %}
                <div class="d-flex gap-2 flex-wrap mt-2">
                    {% for img in reply.images %}
                    <a href="/{{ img.file_path }}" target="_blank">
                        <img src="/{{ img.file_path }}" class="img-thumb" alt="تصویر">
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
            {% endfor %}
            {% endif %}

            <!-- Admin Reply Form -->
            <div class="mt-4 pt-3 border-top">
                <h6 class="fw-bold mb-2"><i class="bi bi-reply me-1"></i>پاسخ مدیریت</h6>
                <form method="POST" action="/admin/reviews/comments/{{ comment.id }}/reply">
                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                    <textarea name="reply_text" class="form-control form-control-tm mb-2" rows="3"
                              placeholder="پاسخ خود را بنویسید..."></textarea>
                    <button class="btn btn-tm-success">
                        <i class="bi bi-send me-1"></i>ارسال پاسخ
                    </button>
                </form>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Sender Info -->
        <div class="card-tm no-hover">
            <h6 class="fw-bold mb-3"><i class="bi bi-person me-1"></i>اطلاعات فرستنده</h6>
            {% if comment.customer %}
            <table class="table table-tm table-borderless table-sm mb-0">
                <tr><td class="text-muted">نام</td><td class="fw-bold">{{ comment.customer.full_name or comment.sender_name }}</td></tr>
                <tr><td class="text-muted">موبایل</td><td dir="ltr">{{ comment.customer.mobile }}</td></tr>
            </table>
            {% else %}
            <div class="text-muted small">{{ comment.sender_name }}</div>
            {% endif %}
        </div>

        <!-- Delete -->
        <div class="card-tm no-hover mt-3 border-start border-4 border-danger">
            <p class="small text-muted mb-2">با حذف این نظر، تمام پاسخ‌های آن نیز حذف خواهند شد.</p>
            <form method="POST" action="/admin/reviews/comments/{{ comment.id }}/delete"
                  onsubmit="return confirm('آیا از حذف این نظر و تمام پاسخ‌هایش مطمئنید؟')">
                <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                <button class="btn btn-tm-danger w-100">
                    <i class="bi bi-trash me-1"></i>حذف نظر
                </button>
            </form>
        </div>
    </div>
</div>
{% endif %}
{% endblock %}
