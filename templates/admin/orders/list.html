{% extends "admin/base_admin.html" %}
{% set active_page = "orders" %}
{% block title %}مدیریت سفارشات - پنل مدیریت{% endblock %}

{% block content %}
<div class="page-header tm-animate-fade-in">
    <h4 class="fw-bold mb-0"><i class="bi bi-bag-check me-2"></i>مدیریت سفارشات</h4>
</div>

{% if msg %}<div class="alert-tm-success py-2">{{ msg }}</div>{% endif %}
{% if error %}<div class="alert-tm-danger py-2">{{ error }}</div>{% endif %}

<!-- Pending Delivery Stats: Gold -->
{% if pending_stats and pending_stats.gold.total_bars > 0 %}
<div class="card-tm no-hover mb-3 tm-animate-fade-in-up" style="border-right:3px solid var(--tm-warning);">
    <div class="d-flex justify-content-between align-items-center"
         data-bs-toggle="collapse" data-bs-target="#pendingGoldDetail" role="button" style="cursor:pointer;">
        <div class="d-flex align-items-center gap-3">
            <div class="text-center" style="min-width:50px;">
                <i class="bi bi-safe2 text-warning" style="font-size:1.8rem;"></i>
            </div>
            <div>
                <div class="fw-bold">طلای امانی (تحویل حضوری — منتظر مراجعه)</div>
                <div class="text-muted small">
                    {{ pending_stats.gold.total_bars }} شمش &bull;
                    <span class="fw-bold text-warning">{{ pending_stats.gold.total_weight }} گرم</span>
                </div>
            </div>
        </div>
        <i class="bi bi-chevron-down text-muted"></i>
    </div>
    <div class="collapse mt-3" id="pendingGoldDetail">
        <div class="table-responsive">
            <table class="table table-tm table-sm mb-0 align-middle">
                <thead>
                    <tr>
                        <th>سفارش</th>
                        <th>خریدار</th>
                        <th>مالک فعلی</th>
                        <th>محصول</th>
                        <th>سریال</th>
                        <th>وزن (گرم)</th>
                        <th>وضعیت تحویل</th>
                        <th>تاریخ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bar in pending_stats.gold.bars %}
                    <tr>
                        <td><a href="/orders/{{ bar.order_id }}" class="fw-bold text-decoration-none">#{{ bar.order_id }}</a></td>
                        <td>
                            {{ bar.buyer_name }}
                            <small class="d-block text-muted">{{ bar.buyer_mobile | persian_number }}</small>
                        </td>
                        <td>
                            {% if bar.ownership_transferred %}
                            <span class="fw-bold" style="color:var(--tm-primary);">{{ bar.owner_name }}</span>
                            <small class="d-block text-muted">{{ bar.owner_mobile | persian_number }}</small>
                            <span class="badge bg-info badge-sm mt-1"><i class="bi bi-arrow-left-right me-1"></i>انتقال یافته</span>
                            {% else %}
                            {{ bar.owner_name }}
                            <small class="d-block text-muted">{{ bar.owner_mobile | persian_number }}</small>
                            {% endif %}
                        </td>
                        <td>{{ bar.product_name }}</td>
                        <td><code dir="ltr">{{ bar.serial_code }}</code></td>
                        <td class="fw-bold">{{ bar.weight }}</td>
                        <td>{{ bar.delivery_status }}</td>
                        <td><small>{{ bar.order_date | jdate if bar.order_date else '' }}</small></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Pending Delivery Stats: Silver -->
{% if pending_stats and pending_stats.silver.total_bars > 0 %}
<div class="card-tm no-hover mb-3 tm-animate-fade-in-up" style="border-right:3px solid #adb5bd;">
    <div class="d-flex justify-content-between align-items-center"
         data-bs-toggle="collapse" data-bs-target="#pendingSilverDetail" role="button" style="cursor:pointer;">
        <div class="d-flex align-items-center gap-3">
            <div class="text-center" style="min-width:50px;">
                <i class="bi bi-safe2" style="font-size:1.8rem;color:#adb5bd;"></i>
            </div>
            <div>
                <div class="fw-bold">نقره امانی (تحویل حضوری — منتظر مراجعه)</div>
                <div class="text-muted small">
                    {{ pending_stats.silver.total_bars }} شمش &bull;
                    <span class="fw-bold" style="color:#6c757d;">{{ pending_stats.silver.total_weight }} گرم</span>
                </div>
            </div>
        </div>
        <i class="bi bi-chevron-down text-muted"></i>
    </div>
    <div class="collapse mt-3" id="pendingSilverDetail">
        <div class="table-responsive">
            <table class="table table-tm table-sm mb-0 align-middle">
                <thead>
                    <tr>
                        <th>سفارش</th>
                        <th>خریدار</th>
                        <th>مالک فعلی</th>
                        <th>محصول</th>
                        <th>سریال</th>
                        <th>وزن (گرم)</th>
                        <th>وضعیت تحویل</th>
                        <th>تاریخ</th>
                    </tr>
                </thead>
                <tbody>
                    {% for bar in pending_stats.silver.bars %}
                    <tr>
                        <td><a href="/orders/{{ bar.order_id }}" class="fw-bold text-decoration-none">#{{ bar.order_id }}</a></td>
                        <td>
                            {{ bar.buyer_name }}
                            <small class="d-block text-muted">{{ bar.buyer_mobile | persian_number }}</small>
                        </td>
                        <td>
                            {% if bar.ownership_transferred %}
                            <span class="fw-bold" style="color:var(--tm-primary);">{{ bar.owner_name }}</span>
                            <small class="d-block text-muted">{{ bar.owner_mobile | persian_number }}</small>
                            <span class="badge bg-info badge-sm mt-1"><i class="bi bi-arrow-left-right me-1"></i>انتقال یافته</span>
                            {% else %}
                            {{ bar.owner_name }}
                            <small class="d-block text-muted">{{ bar.owner_mobile | persian_number }}</small>
                            {% endif %}
                        </td>
                        <td>{{ bar.product_name }}</td>
                        <td><code dir="ltr">{{ bar.serial_code }}</code></td>
                        <td class="fw-bold">{{ bar.weight }}</td>
                        <td>{{ bar.delivery_status }}</td>
                        <td><small>{{ bar.order_date | jdate if bar.order_date else '' }}</small></td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endif %}

<!-- Delivery Method Tabs -->
<ul class="nav nav-tabs mb-3 tm-animate-fade-in-up tm-delay-1">
    <li class="nav-item">
        <a class="nav-link {% if not delivery_filter %}active{% endif %}"
           href="/admin/orders{% if status_filter %}?status={{ status_filter }}{% endif %}{% if search_query %}{{ '&' if status_filter else '?' }}search={{ search_query }}{% endif %}">
            <i class="bi bi-list-ul me-1"></i> همه
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if delivery_filter == 'Pickup' %}active{% endif %}"
           href="/admin/orders?delivery=Pickup{% if status_filter %}&status={{ status_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">
            <i class="bi bi-shop me-1"></i> تحویل حضوری
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if delivery_filter == 'Postal' %}active{% endif %}"
           href="/admin/orders?delivery=Postal{% if status_filter %}&status={{ status_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}">
            <i class="bi bi-envelope me-1"></i> ارسال پستی
        </a>
    </li>
</ul>

<!-- Status Filter -->
<div class="card-tm no-hover mb-3 tm-animate-fade-in-up tm-delay-2">
    <div class="py-2">
        <form method="GET" action="/admin/orders" class="d-flex gap-2 align-items-center flex-wrap">
            {% if delivery_filter %}
            <input type="hidden" name="delivery" value="{{ delivery_filter }}">
            {% endif %}
            <div class="input-group input-group-sm" style="max-width:280px;">
                <span class="input-group-text"><i class="bi bi-search"></i></span>
                <input type="text" name="search" class="form-control form-control-tm" placeholder="نام مشتری یا موبایل..."
                       value="{{ search_query }}">
            </div>
            <select name="status" class="form-select form-select-tm form-select-sm" style="max-width:200px;">
                <option value="">همه وضعیت‌ها</option>
                {% for s in order_statuses %}
                <option value="{{ s.value }}" {% if status_filter == s.value %}selected{% endif %}>{{ s.value | fa_label }}</option>
                {% endfor %}
            </select>
            <button class="btn btn-sm btn-tm-primary"><i class="bi bi-funnel"></i> فیلتر</button>
            <a href="/admin/orders{% if delivery_filter %}?delivery={{ delivery_filter }}{% endif %}" class="btn btn-sm btn-light">پاک</a>
        </form>
    </div>
</div>

<div class="card-tm no-hover tm-animate-fade-in-up tm-delay-2">
    <div class="p-0">
        <div class="table-responsive">
            <table class="table table-tm table-sm mb-0 align-middle">
                <thead>
                    <tr>
                        <th>#</th>
                        <th>مشتری</th>
                        <th>شماره تماس</th>
                        <th>تعداد</th>
                        <th>مبلغ (تومان)</th>
                        <th>تحویل</th>
                        <th>وضعیت سفارش</th>
                        <th>وضعیت تحویل</th>
                        <th>شماره مرسوله</th>
                        <th>تاریخ</th>
                        <th>عملیات</th>
                    </tr>
                </thead>
                <tbody>
                    {% for order in orders %}
                    <tr>
                        <td>
                            <strong>{{ order.id }}</strong>
                            {% if order.is_gift %}<span class="badge-tm badge-tm-info ms-1" title="سفارش هدیه"><i class="bi bi-gift"></i></span>{% endif %}
                        </td>
                        <td>
                            {% if order.customer %}{{ order.customer.full_name }}{% else %}—{% endif %}
                        </td>
                        <td>
                            {% if order.customer %}<small dir="ltr">{{ order.customer.mobile }}</small>{% else %}—{% endif %}
                        </td>
                        <td>{{ order.items|length }}</td>
                        <td class="fw-bold">{{ order.grand_total | toman }}</td>
                        <td>
                            {% if order.delivery_method %}
                            <span class="badge-tm badge-tm-{{ 'info' if order.delivery_method == 'Pickup' else 'primary' }}">
                                <i class="bi bi-{{ 'shop' if order.delivery_method == 'Pickup' else 'envelope' }} me-1"></i>{{ order.delivery_method_label }}
                            </span>
                            {% if order.delivery_method == 'Pickup' and order.pickup_dealer %}
                            <small class="d-block text-muted">{{ order.pickup_dealer.full_name }}</small>
                            {% endif %}
                            {% else %}—{% endif %}
                        </td>
                        <td>
                            <span class="badge bg-{{ order.status_color }}">{{ order.status_label }}</span>
                            {% if order.is_gift and order.status == 'Paid' %}
                            <div class="mt-1">
                                {% for oi in order.items %}
                                {% if oi.bar and oi.bar.claim_code %}
                                <small class="d-block font-monospace" dir="ltr" style="color:var(--tm-primary);">{{ oi.bar.serial_code }}: {{ oi.bar.claim_code }}</small>
                                {% endif %}
                                {% endfor %}
                            </div>
                            {% endif %}
                        </td>
                        <td>
                            {% if order.delivery_status and order.status == 'Paid' %}
                            <span class="badge bg-{{ order.delivery_status_color }}">{{ order.delivery_status_label }}</span>
                            {% else %}—{% endif %}
                        </td>
                        <td>
                            {% if order.postal_tracking_code %}
                            <small dir="ltr">{{ order.postal_tracking_code }}</small>
                            {% else %}—{% endif %}
                        </td>
                        <td><small>{{ order.created_at | jdate if order.created_at else '' }}</small></td>
                        <td>
                            <div class="d-flex gap-1">
                                <a href="/orders/{{ order.id }}" class="btn btn-sm btn-tm-outline" title="مشاهده">
                                    <i class="bi bi-eye"></i>
                                </a>
                                {% if order.status == 'Pending' %}
                                <form method="POST" action="/admin/orders/{{ order.id }}/approve"
                                      onsubmit="return confirm('تأیید سفارش و انتقال مالکیت شمش‌ها؟')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                    <button class="btn btn-sm btn-tm-success" title="تأیید"><i class="bi bi-check-lg"></i></button>
                                </form>
                                <form method="POST" action="/admin/orders/{{ order.id }}/cancel"
                                      onsubmit="return confirm('لغو سفارش و آزادسازی شمش‌ها؟')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                    <button class="btn btn-sm btn-tm-danger" title="لغو"><i class="bi bi-x-lg"></i></button>
                                </form>
                                {% endif %}
                                {% if order.status == 'Paid' %}
                                <form method="POST" action="/payment/{{ order.id }}/refund"
                                      onsubmit="return confirm('استرداد وجه به کیف پول مشتری و لغو سفارش؟')">
                                    <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                                    <button class="btn btn-sm btn-tm-danger" title="استرداد"><i class="bi bi-arrow-counterclockwise"></i></button>
                                </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>
                    {% else %}
                    <tr><td colspan="11" class="text-center text-muted py-4">سفارشی یافت نشد</td></tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>
{% endblock %}
