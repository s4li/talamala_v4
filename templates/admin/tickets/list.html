{% extends "admin/base_admin.html" %}
{% block title %}تیکت‌های پشتیبانی - طلاملا{% endblock %}

{# URL builder macro — always produces correct ?key=val&key2=val2 #}
{% macro ticket_url(status='', sender_type='', category='', search='') -%}
{%- set ns = namespace(parts=[]) -%}
{%- if status -%}{%- set ns.parts = ns.parts + ['status=' + status] -%}{%- endif -%}
{%- if sender_type -%}{%- set ns.parts = ns.parts + ['sender_type=' + sender_type] -%}{%- endif -%}
{%- if category -%}{%- set ns.parts = ns.parts + ['category=' + category] -%}{%- endif -%}
{%- if search -%}{%- set ns.parts = ns.parts + ['search=' + search] -%}{%- endif -%}
/admin/tickets{%- if ns.parts %}?{{ ns.parts | join('&') }}{%- endif -%}
{%- endmacro %}

{% block content %}
<div class="page-header tm-animate-fade-in">
    <h4 class="mb-0 fw-bold">
        <i class="bi bi-headset text-tm-primary"></i>
        تیکت‌های پشتیبانی
    </h4>
    <div class="d-flex gap-2 align-items-center">
        <span class="badge-tm badge-tm-primary fs-6">{{ stats.open }} باز</span>
        <span class="badge-tm badge-tm-warning fs-6">{{ stats.in_progress }} در حال بررسی</span>
    </div>
</div>

<!-- Search -->
<div class="mb-3 tm-animate-fade-in-up tm-delay-1">
    <form method="GET" action="/admin/tickets" class="d-flex gap-2">
        {% if status_filter %}<input type="hidden" name="status" value="{{ status_filter }}">{% endif %}
        {% if sender_type_filter %}<input type="hidden" name="sender_type" value="{{ sender_type_filter }}">{% endif %}
        {% if category_filter %}<input type="hidden" name="category" value="{{ category_filter }}">{% endif %}
        <input type="text" name="search" value="{{ search_query }}" class="form-control form-control-tm form-control-sm"
               placeholder="جستجو: شماره تیکت، موضوع، نام یا موبایل..." style="max-width:400px;">
        <button class="btn btn-sm btn-tm-outline"><i class="bi bi-search"></i></button>
        {% if search_query %}
        <a href="{{ ticket_url(status=status_filter, sender_type=sender_type_filter, category=category_filter) }}"
           class="btn btn-sm btn-tm-outline">پاک کردن</a>
        {% endif %}
    </form>
</div>

<!-- Sender Type Tabs -->
<ul class="nav nav-tabs mb-3">
    <li class="nav-item">
        <a class="nav-link {% if not sender_type_filter %}active{% endif %}"
           href="{{ ticket_url(status=status_filter, category=category_filter, search=search_query) }}">
            همه
            <span class="badge-tm badge-tm-info ms-1">{{ stats.total }}</span>
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if sender_type_filter == 'CUSTOMER' %}active{% endif %}"
           href="{{ ticket_url(sender_type='CUSTOMER', status=status_filter, category=category_filter, search=search_query) }}">
            <i class="bi bi-person me-1"></i>مشتریان
            <span class="badge-tm badge-tm-info ms-1">{{ stats.customer_count }}</span>
        </a>
    </li>
    <li class="nav-item">
        <a class="nav-link {% if sender_type_filter == 'DEALER' %}active{% endif %}"
           href="{{ ticket_url(sender_type='DEALER', status=status_filter, category=category_filter, search=search_query) }}">
            <i class="bi bi-shop me-1"></i>نمایندگان
            <span class="badge ms-1" style="background:#6f42c1;color:#fff;">{{ stats.dealer_count }}</span>
        </a>
    </li>
</ul>

<!-- Status Filter -->
<div class="mb-2">
    <div class="btn-group" role="group">
        <a href="{{ ticket_url(sender_type=sender_type_filter, category=category_filter, search=search_query) }}"
           class="btn btn-sm {% if not status_filter %}btn-dark{% else %}btn-outline-dark{% endif %}">همه</a>
        <a href="{{ ticket_url(status='Open', sender_type=sender_type_filter, category=category_filter, search=search_query) }}"
           class="btn btn-sm {% if status_filter == 'Open' %}btn-tm-primary{% else %}btn-tm-outline{% endif %}">باز ({{ stats.open }})</a>
        <a href="{{ ticket_url(status='InProgress', sender_type=sender_type_filter, category=category_filter, search=search_query) }}"
           class="btn btn-sm {% if status_filter == 'InProgress' %}btn-tm-warning{% else %}btn-tm-outline{% endif %}">در حال بررسی ({{ stats.in_progress }})</a>
        <a href="{{ ticket_url(status='Answered', sender_type=sender_type_filter, category=category_filter, search=search_query) }}"
           class="btn btn-sm {% if status_filter == 'Answered' %}btn-tm-success{% else %}btn-tm-outline{% endif %}">پاسخ داده شده ({{ stats.answered }})</a>
        <a href="{{ ticket_url(status='Closed', sender_type=sender_type_filter, category=category_filter, search=search_query) }}"
           class="btn btn-sm {% if status_filter == 'Closed' %}btn-tm-secondary{% else %}btn-tm-outline{% endif %}">بسته ({{ stats.closed }})</a>
    </div>
    <span class="ms-2 text-muted small">{{ total }} تیکت</span>
</div>

<!-- Category Filter -->
<div class="mb-3">
    <div class="btn-group" role="group">
        <a href="{{ ticket_url(status=status_filter, sender_type=sender_type_filter, search=search_query) }}"
           class="btn btn-sm {% if not category_filter %}btn-dark{% else %}btn-outline-dark{% endif %}">همه دپارتمان‌ها</a>
        <a href="{{ ticket_url(category='Financial', status=status_filter, sender_type=sender_type_filter, search=search_query) }}"
           class="btn btn-sm {% if category_filter == 'Financial' %}btn-tm-warning{% else %}btn-tm-outline{% endif %}">مالی</a>
        <a href="{{ ticket_url(category='Technical', status=status_filter, sender_type=sender_type_filter, search=search_query) }}"
           class="btn btn-sm {% if category_filter == 'Technical' %}btn-tm-info{% else %}btn-tm-outline{% endif %}">فنی</a>
        <a href="{{ ticket_url(category='Sales', status=status_filter, sender_type=sender_type_filter, search=search_query) }}"
           class="btn btn-sm {% if category_filter == 'Sales' %}btn-tm-success{% else %}btn-tm-outline{% endif %}">فروش</a>
        <a href="{{ ticket_url(category='Complaints', status=status_filter, sender_type=sender_type_filter, search=search_query) }}"
           class="btn btn-sm {% if category_filter == 'Complaints' %}btn-tm-danger{% else %}btn-tm-outline{% endif %}">شکایات</a>
        <a href="{{ ticket_url(category='Other', status=status_filter, sender_type=sender_type_filter, search=search_query) }}"
           class="btn btn-sm {% if category_filter == 'Other' %}btn-tm-secondary{% else %}btn-tm-outline{% endif %}">سایر</a>
    </div>
</div>

<!-- Table -->
<div class="card-tm no-hover tm-animate-fade-in-up tm-delay-2">
    <div class="table-responsive">
        <table class="table table-tm mb-0">
            <thead>
                <tr>
                    <th>#</th>
                    <th>فرستنده</th>
                    <th>موضوع</th>
                    <th>دپارتمان</th>
                    <th>اولویت</th>
                    <th>وضعیت</th>
                    <th>اختصاص</th>
                    <th>بروزرسانی</th>
                    <th></th>
                </tr>
            </thead>
            <tbody>
                {% for t in tickets %}
                <tr>
                    <td class="fw-bold">{{ t.id }}</td>
                    <td>
                        {% if t.sender_type == 'DEALER' %}
                        <span class="badge" style="background:#6f42c1;">نماینده</span>
                        {% else %}
                        <span class="badge-tm badge-tm-info">مشتری</span>
                        {% endif %}
                        <br><small class="fw-bold">{{ t.sender_name }}</small>
                        <br><small class="text-muted" dir="ltr">{{ t.sender_mobile }}</small>
                    </td>
                    <td>
                        <a href="/admin/tickets/{{ t.id }}" class="text-decoration-none fw-bold">
                            {{ t.subject[:50] }}{% if t.subject|length > 50 %}...{% endif %}
                        </a>
                        {% if t.message_count > 0 %}
                        <small class="text-muted">({{ t.message_count }} پیام)</small>
                        {% endif %}
                    </td>
                    <td>
                        <form method="POST" action="/admin/tickets/{{ t.id }}/category" class="d-inline ticket-cat-form">
                            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
                            <select name="new_category" class="form-select form-select-sm border-0 py-0 pe-4 ps-1 fw-bold"
                                    style="font-size:0.75rem; width:auto; min-width:70px; background-color:transparent;"
                                    onchange="this.form.submit()">
                                {% for cat in categories %}
                                <option value="{{ cat.value }}" {% if t.category == cat.value %}selected{% endif %}>{{ cat.value | ticket_category_label }}</option>
                                {% endfor %}
                            </select>
                        </form>
                    </td>
                    <td><span class="badge-tm badge-tm-{{ t.priority_color }}">{{ t.priority_label }}</span></td>
                    <td><span class="badge-tm badge-tm-{{ t.status_color }}">{{ t.status_label }}</span></td>
                    <td>
                        <small>{{ t.assigned_staff.full_name if t.assigned_staff else '—' }}</small>
                    </td>
                    <td><small>{{ t.updated_at | jdate }}</small></td>
                    <td>
                        <a href="/admin/tickets/{{ t.id }}" class="btn btn-sm btn-tm-outline">
                            <i class="bi bi-eye"></i>
                        </a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="9" class="text-center text-muted py-4">
                        <i class="bi bi-chat-dots" style="font-size:2rem;"></i>
                        <br>تیکتی یافت نشد
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Pagination -->
{% from "components/pagination.html" import pagination %}
{% set qs %}{% if status_filter %}&status={{ status_filter }}{% endif %}{% if sender_type_filter %}&sender_type={{ sender_type_filter }}{% endif %}{% if category_filter %}&category={{ category_filter }}{% endif %}{% if search_query %}&search={{ search_query }}{% endif %}{% endset %}
{{ pagination(page, total_pages, '/admin/tickets', qs) }}
{% endblock %}
