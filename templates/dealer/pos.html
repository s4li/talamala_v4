{% extends "dealer/base_dealer.html" %}

{% block title %}فروش حضوری - طلاملا{% endblock %}

{% block content %}
<div class="d-flex align-items-center justify-content-between mb-4 tm-animate-fade-in">
    <h4 class="mb-0 fw-bold">
        <i class="bi bi-cart-plus text-tm-primary"></i>
        فروش حضوری (POS)
    </h4>
    <a href="/dealer/sales" class="btn btn-sm btn-tm-outline">
        <i class="bi bi-receipt me-1"></i> تاریخچه فروش
    </a>
</div>

{% if error %}
<div class="alert-tm-danger">
    <i class="bi bi-exclamation-triangle me-1"></i>
    {{ error }}
</div>
{% endif %}

{% if success %}
<div class="alert alert-tm-success">
    <i class="bi bi-check-circle me-1"></i>
    {{ success }}
</div>
{% endif %}

{% if claim_code %}
<div class="card-tm no-hover mb-4 text-center" style="border: 2px dashed var(--tm-primary);">
    <p class="mb-1 text-muted"><i class="bi bi-upc-scan me-1"></i>کد ثبت مالکیت (روی رسید چاپ شود)</p>
    <h2 class="fw-bold font-monospace mb-1" dir="ltr" style="letter-spacing: 6px; color: var(--tm-primary);">{{ claim_code }}</h2>
    <small class="text-muted">مشتری با این کد می‌تواند شمش را در پنل کاربری خود ثبت کند</small>
</div>
{% endif %}

<div class="card-tm no-hover tm-animate-fade-in-up tm-delay-2">
    <form method="POST" action="/dealer/pos">
        <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
        <input type="hidden" name="sale_price" id="salePriceInput" value="">
        <input type="hidden" name="discount_wage_percent" id="discountWageHidden" value="0">

        <!-- Bar Selection -->
        <div class="mb-3">
            <label class="form-label-tm fw-bold">انتخاب شمش <span class="text-danger">*</span></label>
            {% if bars|length > 0 %}
            <select name="bar_id" id="barSelect" class="form-select form-select-tm" required>
                <option value="">-- انتخاب کنید --</option>
                {% for bar in bars %}
                <option value="{{ bar.id }}">
                    {{ bar.serial_code }} — {{ bar.product.name if bar.product else 'نامشخص' }}
                    ({{ bar.product.weight if bar.product else '?' }}g)
                </option>
                {% endfor %}
            </select>
            <small class="text-muted">{{ bars|length }} شمش موجود در محل نمایندگی</small>
            {% else %}
            <div class="alert-tm-warning mb-0">
                <i class="bi bi-exclamation-triangle me-1"></i>
                هیچ شمشی در محل نمایندگی شما موجود نیست.
            </div>
            {% endif %}
        </div>

        <!-- Price Info Box (auto-filled) -->
        <div id="priceInfoBox" class="mb-3" style="display:none;">
            <div class="p-3 rounded" style="background:var(--tm-info-900, #f8f5f0); border:1px solid var(--tm-primary-100, #ddd);">
                <div class="d-flex align-items-center justify-content-between mb-2">
                    <span class="fw-bold"><i class="bi bi-calculator me-1"></i> قیمت سیستمی (مشتری نهایی)</span>
                    <span id="systemPriceDisplay" class="fw-bold fs-5" style="color:var(--tm-primary);"></span>
                </div>
                <div class="row small text-muted">
                    <div class="col">ارزش طلا: <span id="rawGoldDisplay">-</span></div>
                    <div class="col">اجرت (<span id="ecWagePctLabel">-</span>%): <span id="wageDisplay">-</span></div>
                    <div class="col">مالیات: <span id="taxDisplay">-</span></div>
                </div>
            </div>
        </div>

        <!-- Dealer Margin & Discount Section -->
        <div id="discountSection" class="mb-3" style="display:none;">
            <!-- Margin Info -->
            <div class="p-3 rounded mb-2" style="background:#edf7ed; border:1px solid #c3e6cb;">
                <div class="d-flex align-items-center justify-content-between mb-1">
                    <span class="fw-bold" style="color:#28a745;">
                        <i class="bi bi-piggy-bank me-1"></i>
                        سهم اجرت شما
                    </span>
                    <span id="marginDisplay" class="fw-bold" style="color:#28a745;"></span>
                </div>
                <div class="small text-muted">
                    اجرت مشتری نهایی: <span id="ecWageDisplay" class="fw-bold">-</span>%
                    &nbsp;|&nbsp;
                    اجرت سطح شما: <span id="dealerWageDisplay" class="fw-bold">-</span>%
                    &nbsp;|&nbsp;
                    حاشیه سود: <span id="marginPctDisplay" class="fw-bold" style="color:#28a745;">-</span>%
                </div>
            </div>

            <!-- Discount Input -->
            <div class="p-3 rounded" style="background:#fff8e1; border:1px solid #ffe082;">
                <label class="form-label-tm fw-bold mb-2">
                    <i class="bi bi-percent me-1"></i>
                    تخفیف از سهم اجرت شما (اختیاری)
                </label>
                <div class="row align-items-center g-3">
                    <div class="col-md-3">
                        <div class="input-group">
                            <input type="number" id="discountInput" step="0.01" min="0" max="0"
                                   class="form-control form-control-tm text-center" value="0" dir="ltr">
                            <span class="input-group-text">%</span>
                        </div>
                        <small class="text-muted">حداکثر: <span id="maxDiscountDisplay">0</span>%</small>
                    </div>
                    <div class="col-md-3">
                        <div class="input-group">
                            <input type="number" id="discountTomanInput" step="1" min="0" max="0"
                                   class="form-control form-control-tm text-center" value="0" dir="ltr">
                            <span class="input-group-text">تومان</span>
                        </div>
                        <small class="text-muted">از ۰ تا <span id="maxDiscountTomanDisplay">۰</span> تومان</small>
                    </div>
                    <div class="col-md-6">
                        <input type="range" id="discountSlider" min="0" max="0" step="0.01" value="0"
                               class="form-range" style="direction:ltr;">
                    </div>
                </div>

                <!-- Discount Summary -->
                <div id="discountSummary" class="mt-3 pt-2" style="border-top:1px dashed #ccc; display:none;">
                    <div class="row small">
                        <div class="col-md-4 mb-1">
                            <span class="text-muted">قیمت اصلی:</span>
                            <span id="originalPriceDisp" class="fw-bold">-</span>
                        </div>
                        <div class="col-md-4 mb-1">
                            <span class="text-danger"><i class="bi bi-arrow-down-circle me-1"></i>مبلغ تخفیف:</span>
                            <span id="discountAmountDisp" class="fw-bold text-danger">-</span>
                        </div>
                        <div class="col-md-4 mb-1">
                            <span style="color:var(--tm-primary);"><i class="bi bi-check-circle me-1"></i>قیمت نهایی:</span>
                            <span id="finalPriceDisp" class="fw-bold" style="color:var(--tm-primary);">-</span>
                        </div>
                    </div>
                    <div class="small mt-1">
                        <span class="text-muted">سود طلایی باقیمانده:</span>
                        <span id="remainingProfitDisp" class="fw-bold text-success">-</span>
                    </div>
                </div>
            </div>
        </div>

        <!-- Final Sale Price Display -->
        <div id="finalPriceBox" class="mb-3" style="display:none;">
            <div class="p-3 rounded text-center" style="background:var(--tm-primary-100, #f5eef1); border:2px solid var(--tm-primary);">
                <span class="small" style="color:#d4c5a9;">مبلغ فروش نهایی</span>
                <div id="finalSalePriceDisplay" class="fw-bold fs-4" style="color:#d4c5a9;"></div>
            </div>
        </div>

        <hr>
        <h6 class="fw-bold text-muted mb-3">
            <i class="bi bi-person me-1"></i>
            اطلاعات مشتری (اختیاری)
        </h6>

        <div class="row">
            <div class="col-md-4 mb-3">
                <label class="form-label-tm">نام مشتری</label>
                <input type="text" name="customer_name" class="form-control form-control-tm" placeholder="نام و نام خانوادگی">
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label-tm">موبایل مشتری</label>
                <input type="tel" name="customer_mobile" class="form-control form-control-tm" dir="ltr"
                       placeholder="09xxxxxxxxx" pattern="09[0-9]{9}" maxlength="11">
            </div>
            <div class="col-md-4 mb-3">
                <label class="form-label-tm">کد ملی</label>
                <input type="text" name="customer_national_id" class="form-control form-control-tm" dir="ltr"
                       maxlength="10" pattern="[0-9]{10}">
            </div>
        </div>

        <div class="mb-3">
            <label class="form-label-tm">توضیحات</label>
            <textarea name="description" class="form-control form-control-tm" rows="2" placeholder="توضیح اختیاری..."></textarea>
        </div>

        <button type="submit" class="btn btn-lg btn-tm-primary px-5" id="submitBtn" {% if bars|length == 0 %}disabled{% endif %}>
            <i class="bi bi-check-circle me-1"></i>
            ثبت فروش
        </button>
    </form>
</div>
{% endblock %}

{% block page_js %}
<script>
(function(){
    const barPrices = {{ bar_prices_json | safe }};
    const barSelect = document.getElementById('barSelect');
    const priceBox = document.getElementById('priceInfoBox');
    const discountSection = document.getElementById('discountSection');
    const finalPriceBox = document.getElementById('finalPriceBox');
    const salePriceInput = document.getElementById('salePriceInput');
    const discountInput = document.getElementById('discountInput');
    const discountSlider = document.getElementById('discountSlider');
    const discountHidden = document.getElementById('discountWageHidden');
    const discountTomanInput = document.getElementById('discountTomanInput');
    const submitBtn = document.getElementById('submitBtn');

    let currentBar = null;
    let maxDiscountToman = 0;

    function fmt(n) {
        return Number(n).toLocaleString('fa-IR') + ' تومان';
    }

    // Mirror calculate_bar_price() from Python using Math.floor (ROUND_FLOOR)
    function recalcPrice(bd, discPct) {
        var w = parseFloat(bd.weight);
        var pur = parseInt(bd.purity);
        var gp = bd.gold_price;
        var tp = bd.tax_percent;
        var effWage = bd.ec_wage_pct - discPct;

        var pricePerGram = (gp / 750) * pur;
        var unitPrice = Math.floor(pricePerGram);
        var rawGold = Math.floor(w * unitPrice);
        var wage = Math.floor(rawGold * effWage / 100);
        var tax = Math.floor(wage * tp / 100);
        var total = rawGold + wage + tax;
        return { rawGold: rawGold, wage: wage, tax: tax, total: total, totalToman: Math.floor(total / 10) };
    }

    // Convert Toman discount to approximate wage percent
    function tomanToPct(bd, tomanDisc) {
        if (!bd || tomanDisc <= 0) return 0;
        var rawGold = recalcPrice(bd, 0).rawGold;
        var taxFactor = 1 + bd.tax_percent / 100;
        // discount_toman ≈ rawGold × pct/100 × (1+tax/100) / 10
        var pct = tomanDisc * 10 * 100 / (rawGold * taxFactor);
        // Clamp to margin
        if (pct > bd.margin_pct) pct = bd.margin_pct;
        if (pct < 0) pct = 0;
        return Math.round(pct * 100) / 100;
    }

    function updateDiscount(source) {
        if (!currentBar) return;
        var disc = parseFloat(discountInput.value) || 0;
        var margin = currentBar.margin_pct;

        // Clamp
        if (disc < 0) disc = 0;
        if (disc > margin) disc = margin;

        discountHidden.value = disc;
        discountSlider.value = disc;

        var result = recalcPrice(currentBar, disc);
        salePriceInput.value = result.totalToman;

        // Sync Toman field (unless Toman was the source of change)
        if (source !== 'toman') {
            var origResult = recalcPrice(currentBar, 0);
            var tomanVal = origResult.totalToman - result.totalToman;
            discountTomanInput.value = tomanVal;
        }

        // Update final price display
        document.getElementById('finalSalePriceDisplay').textContent = fmt(result.totalToman);
        finalPriceBox.style.display = 'block';

        if (disc > 0) {
            var origResult = recalcPrice(currentBar, 0);
            var discountAmount = origResult.totalToman - result.totalToman;
            var remainingMargin = margin - disc;
            var goldProfitGrams = parseFloat(currentBar.weight) * remainingMargin / 100;

            document.getElementById('discountSummary').style.display = 'block';
            document.getElementById('originalPriceDisp').textContent = fmt(origResult.totalToman);
            document.getElementById('discountAmountDisp').textContent = fmt(discountAmount);
            document.getElementById('finalPriceDisp').textContent = fmt(result.totalToman);
            document.getElementById('remainingProfitDisp').textContent =
                goldProfitGrams.toFixed(3) + ' گرم';
        } else {
            document.getElementById('discountSummary').style.display = 'none';
        }
    }

    if (barSelect) {
        barSelect.addEventListener('change', function(){
            var barId = this.value;
            if (barId && barPrices[barId]) {
                currentBar = barPrices[barId];
                var p = currentBar;

                // System price display
                salePriceInput.value = p.total_toman;
                document.getElementById('systemPriceDisplay').textContent = fmt(p.total_toman);
                document.getElementById('rawGoldDisplay').textContent = fmt(p.raw_gold_toman);
                document.getElementById('wageDisplay').textContent = fmt(p.wage_toman);
                document.getElementById('taxDisplay').textContent = fmt(p.tax_toman);
                document.getElementById('ecWagePctLabel').textContent = p.ec_wage_pct;
                priceBox.style.display = 'block';

                // Final price display (initially = system price)
                document.getElementById('finalSalePriceDisplay').textContent = fmt(p.total_toman);
                finalPriceBox.style.display = 'block';

                // Margin/discount section
                if (p.margin_pct > 0) {
                    document.getElementById('ecWageDisplay').textContent = p.ec_wage_pct;
                    document.getElementById('dealerWageDisplay').textContent = p.dealer_wage_pct;
                    document.getElementById('marginPctDisplay').textContent = p.margin_pct;
                    document.getElementById('marginDisplay').textContent = p.margin_pct + '%';
                    document.getElementById('maxDiscountDisplay').textContent = p.margin_pct;

                    discountSlider.max = p.margin_pct;
                    discountSlider.value = 0;
                    discountInput.value = 0;
                    discountInput.max = p.margin_pct;
                    discountHidden.value = 0;

                    // Calculate max discount in Toman
                    var fullPrice = recalcPrice(p, 0);
                    var minPrice = recalcPrice(p, p.margin_pct);
                    maxDiscountToman = fullPrice.totalToman - minPrice.totalToman;
                    discountTomanInput.value = 0;
                    discountTomanInput.max = maxDiscountToman;
                    document.getElementById('maxDiscountTomanDisplay').textContent =
                        Number(maxDiscountToman).toLocaleString('fa-IR');

                    document.getElementById('discountSummary').style.display = 'none';
                    discountSection.style.display = 'block';
                } else {
                    discountSection.style.display = 'none';
                }

                submitBtn.disabled = false;
            } else {
                currentBar = null;
                salePriceInput.value = '';
                priceBox.style.display = 'none';
                discountSection.style.display = 'none';
                finalPriceBox.style.display = 'none';
                submitBtn.disabled = true;
            }
        });
    }

    // Sync slider <-> pct input <-> toman input
    if (discountInput) {
        discountInput.addEventListener('input', function() {
            discountSlider.value = this.value;
            updateDiscount('pct');
        });
    }
    if (discountSlider) {
        discountSlider.addEventListener('input', function() {
            discountInput.value = this.value;
            updateDiscount('slider');
        });
    }
    if (discountTomanInput) {
        discountTomanInput.addEventListener('input', function() {
            var tomanVal = parseInt(this.value) || 0;
            if (tomanVal < 0) tomanVal = 0;
            if (tomanVal > maxDiscountToman) tomanVal = maxDiscountToman;
            var pct = tomanToPct(currentBar, tomanVal);
            discountInput.value = pct;
            discountSlider.value = pct;
            updateDiscount('toman');
        });
    }
})();
</script>
{% endblock %}
