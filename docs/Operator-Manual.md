# راهنمای اپراتور سیستم طلاملا v4

> این سند برای اپراتورهای غیرفنی نوشته شده و تمام عملیات روزانه را قدم‌به‌قدم توضیح می‌دهد.
> پیش‌نیاز: داشتن حساب اپراتور (نقش operator یا super_admin).

---

## فهرست مطالب

1. [شروع سریع](#1-شروع-سریع)
2. [سناریو ۱: مدیریت انبار و شمش‌ها](#2-سناریو-۱-مدیریت-انبار-و-شمشها)
3. [سناریو ۲: فرآیند فروش و سفارشات](#3-سناریو-۲-فرآیند-فروش-و-سفارشات)
4. [سناریو ۳: مدیریت نمایندگان](#4-سناریو-۳-مدیریت-نمایندگان)
5. [سناریو ۴: مدیریت کوپن‌ها](#5-سناریو-۴-مدیریت-کوپنها)
6. [سناریو ۵: احراز اصالت و کیف پول](#6-سناریو-۵-احراز-اصالت-و-کیف-پول)
7. [سناریو ۶: مدیریت تیکت‌های پشتیبانی](#7-سناریو-۶-مدیریت-تیکتهای-پشتیبانی)
8. [سناریو ۷: مدیریت کلید API دستگاه POS](#8-سناریو-۷-مدیریت-کلید-api-دستگاه-pos)
9. [سناریو ۸: صفحات ثابت و فوتر](#9-سناریو-۸-صفحات-ثابت-و-فوتر)
10. [سناریو ۹: ثبت مالکیت، خرید هدیه و انتقال شمش](#10-سناریو-۹-ثبت-مالکیت-خرید-هدیه-و-انتقال-شمش)
11. [سناریو ۱۰: مدیریت کاربران](#11-سناریو-۱۰-مدیریت-کاربران)
12. [سناریو ۱۱: مدیریت بسته‌بندی و قیمت‌گذاری](#12-سناریو-۱۱-مدیریت-بستهبندی-و-قیمتگذاری)
13. [سناریو ۱۲: گزارش فروش نمایندگان (POS)](#13-سناریو-۱۲-گزارش-فروش-نمایندگان-pos)
14. [سناریو ۱۳: تغییر درگاه پرداخت (Gateway Switching)](#14-سناریو-۱۳-تغییر-درگاه-پرداخت-gateway-switching)
15. [سناریو ۱۴: بررسی درخواست‌های نمایندگی (Dealer Requests)](#15-سناریو-۱۴-بررسی-درخواستهای-نمایندگی-dealer-requests)
16. [عیب‌یابی (Troubleshooting)](#16-عیبیابی)
17. [واژه‌نامه](#17-واژهنامه)

---

## 1. شروع سریع

### نحوه ورود به پنل مدیریت

1. مرورگر را باز کنید و به آدرس سایت بروید (مثلاً `http://127.0.0.1:8000`)
2. روی «ورود» کلیک کنید یا مستقیم به `/auth/login` بروید
3. شماره موبایل اپراتور خود را وارد کنید
4. کد OTP دریافتی از SMS را وارد کنید
5. سیستم شما را به **داشبورد مدیریت** هدایت می‌کند

### آشنایی با داشبورد

پس از ورود، داشبورد شامل موارد زیر است:

- **کارت‌های آماری بالا**: درآمد کل، تعداد سفارشات، تعداد مشتریان، تعداد شمش‌ها
- **کارت‌های آماری دوم**: سفارش امروز، درآمد امروز، در انتظار پرداخت، شمش موجود، نماینده فعال، درخواست برداشت
- **نمودار درآمد**: نمودار خطی درآمد ۳۰ روز اخیر
- **نمودار موجودی**: نمودار دایره‌ای وضعیت شمش‌ها
- **آخرین سفارشات**: جدول ۱۰ سفارش اخیر
- **دسترسی سریع**: لینک به بخش‌های مختلف
- **قیمت طلا**: قیمت فعلی طلای ۱۸ عیار
- **هشدارها**: تعداد موارد در انتظار بررسی

### تازگی داده‌ها (No-Cache)

صفحات پنل مدیریت و پنل نماینده به‌گونه‌ای تنظیم شده‌اند که مرورگر آن‌ها را **کش نمی‌کند**. یعنی هنگام استفاده از دکمه‌های «عقب» و «جلو» مرورگر یا بازگشت به صفحه قبلی، آمار و داده‌ها همیشه **تازه و به‌روز** از دیتابیس بارگذاری می‌شوند. نیازی به رفرش دستی صفحه برای دیدن آخرین اطلاعات نیست.

### منوی کناری (Sidebar)

| آیکون | بخش | توضیح |
|--------|------|--------|
| داشبورد | `/admin/dashboard` | صفحه اصلی مدیریت |
| محصولات | `/admin/products` | مدیریت محصولات (شمش‌ها) |
| دسته‌بندی | `/admin/categories` | دسته‌بندی محصولات |
| طرح کارت | `/admin/designs` | طرح‌های کارت هدیه |
| بسته‌بندی | `/admin/packages` | انواع بسته‌بندی |
| بچ‌ها | `/admin/batches` | بچ‌های تولید |
| شمش‌ها | `/admin/bars` | انبارداری شمش |
| سفارشات | `/admin/orders` | مدیریت سفارشات |
| کیف پول | `/admin/wallets` | حساب‌های کیف پول |
| برداشت‌ها | `/admin/wallets/withdrawals/list` | درخواست‌های برداشت |
| کوپن‌ها | `/admin/coupons` | مدیریت کوپن تخفیف |
| نمایندگان | `/admin/dealers` | مدیریت نمایندگان |
| فروش نمایندگان | `/admin/dealers/sales` | گزارش فروش حضوری (POS) نمایندگان |
| بازخرید | `/admin/dealers/buybacks` | درخواست‌های بازخرید |
| تیکت‌ها | `/admin/tickets` | تیکت‌های پشتیبانی |
| مدیریت کاربران | `/admin/customers` | لیست و جزئیات مشتریان |
| درخواست‌های نمایندگی | `/admin/dealer-requests` | بررسی درخواست‌های نمایندگی |
| لاگ درخواست‌ها | `/admin/logs` | لاگ تمام درخواست‌های HTTP |
| تنظیمات | `/admin/settings` | تنظیمات سیستم (فقط مدیرکل) |

---

## 2. سناریو ۱: مدیریت انبار و شمش‌ها

### ۲.۱ ایجاد و ویرایش محصول

**کی لازم است؟** وقتی محصول جدیدی (نوع شمش) به سیستم اضافه می‌شود یا مشخصات محصول موجود تغییر می‌کند.

1. از منو **محصولات** را انتخاب کنید
2. برای ایجاد: روی **«ایجاد محصول جدید»** کلیک کنید
3. برای ویرایش: روی **«ویرایش»** کنار محصول کلیک کنید
4. فرم را پر کنید:
   - **نام**: نام محصول (مثلاً «شمش ۱ گرمی ۱۸ عیار»)
   - **دسته‌بندی‌ها**: با **چک‌باکس** یک یا چند دسته‌بندی انتخاب کنید — هر محصول می‌تواند در **چند دسته‌بندی** قرار بگیرد (مثلاً هم «شمش گرمی» و هم «شمش سرمایه‌ای»)
   - **وزن**: وزن شمش (گرم)
   - **عیار**: خلوص طلا (۷۵۰ = ۱۸ عیار)
   - **اجرت ساخت**: درصدی (از ارزش طلای خام)
5. **«ذخیره»** را بزنید

**نکته مهم درباره دسته‌بندی‌ها**: حداقل یک دسته‌بندی باید انتخاب شود. محصولاتی که در چند دسته‌بندی هستند، هنگام فیلتر بر اساس هر یک از دسته‌بندی‌هایشان در فروشگاه نمایش داده می‌شوند.

### ۲.۲ ثبت شمش جدید

**کی لازم است؟** وقتی شمش‌های جدید از کارخانه دریافت می‌شوند.

**توجه**: شمش‌ها معمولاً از طریق `seed.py` یا ایمپورت دسته‌ای وارد سیستم می‌شوند. مدیریت تکی شمش‌ها از طریق صفحه ویرایش انجام می‌شود.

### ۲.۳ مشاهده و فیلتر شمش‌ها

1. از منو **شمش‌ها** را انتخاب کنید
2. فیلترهای موجود:
   - **وضعیت**: خام (Raw)، تخصیص (Assigned)، رزرو (Reserved)، فروخته (Sold)
   - **جستجو**: بر اساس سریال‌کد
3. هر ردیف نمایش می‌دهد: سریال‌کد، محصول، وضعیت، نمایندگی، مشتری

### ۲.۴ ویرایش شمش

1. در لیست شمش‌ها روی **«ویرایش»** کلیک کنید
2. می‌توانید تغییر دهید:
   - **محصول تخصیص‌یافته**: کدام محصول به این شمش وصل است
   - **نمایندگی**: شمش در کدام نمایندگی/انبار است
   - **بچ تولید**: متعلق به کدام ذوب
   - **طرح کارت**: طرح بسته‌بندی
   - **نوع بسته‌بندی**: نوع جعبه
3. **ذخیره** کنید

### ۲.۵ چرخه حیات شمش

```
  خام (Raw)
    │
    ▼  ← تخصیص محصول
  تخصیص (Assigned)  ← آماده فروش
    │
    ▼  ← مشتری به سبد اضافه می‌کند
  رزرو (Reserved)   ← در سبد خرید
    │
    ├── ▼ پرداخت موفق
    │  فروخته (Sold)  ← مالکیت مشتری
    │
    └── ▼ لغو / تایم‌اوت
       تخصیص (Assigned)  ← برگشت به فروش
```

---

## 3. سناریو ۲: فرآیند فروش و سفارشات

### ۳.۱ جریان خرید مشتری (آنلاین)

مشتری این مراحل را طی می‌کند:

1. ورود به فروشگاه → مشاهده محصولات
2. افزودن محصول به سبد خرید
3. **تکمیل پروفایل (الزامی)**: قبل از ورود به صفحه چک‌اوت، پروفایل مشتری باید کامل باشد:
   - **نوع مشتری**: حقیقی (شخص حقیقی با کد ملی) یا حقوقی (شرکت/موسسه با نام شرکت، کد ملی و کد اقتصادی)
   - **کد پستی** و **آدرس**
   - اگر پروفایل ناقص باشد، مشتری به صفحه پروفایل (`/profile`) هدایت می‌شود و پیام خطا نمایش داده می‌شود
4. صفحه چک‌اوت:
   - انتخاب روش تحویل (حضوری / پستی)
   - وارد کردن کوپن تخفیف (اختیاری)
5. پرداخت (کیف پول یا درگاه بانکی)
6. دریافت سفارش

### ۳.۲ مدیریت سفارشات (اپراتور)

1. از منو **سفارشات** را انتخاب کنید
2. فیلتر بر اساس وضعیت:
   - **همه**: تمام سفارشات
   - **در انتظار**: هنوز پرداخت نشده
   - **پرداخت شده**: آماده ارسال
   - **ارسال شده**: در حال ارسال
   - **تحویل شده**: تکمیل
   - **لغو شده**: لغو شده
3. هر ردیف نمایش می‌دهد:
   - شماره سفارش، نام مشتری، مبلغ، وضعیت، روش تحویل، تاریخ

### ۳.۳ تغییر وضعیت سفارش

**پس از پرداخت و آماده‌سازی شمش:**

1. سفارش را پیدا کنید (وضعیت: پرداخت شده)
2. شمش‌ها را آماده و بسته‌بندی کنید
3. وضعیت ارسال را به‌روزرسانی کنید:
   - **حضوری**: هماهنگی با نمایندگی برای تحویل
   - **پستی**: ثبت کد پیگیری پستی

### ۳.۴ استرداد سفارش

**توجه**: استرداد فقط توسط ادمین قابل انجام است.

1. سفارش مورد نظر را باز کنید
2. دکمه **«استرداد»** را بزنید
3. مبلغ به کیف پول مشتری برگشت داده می‌شود
4. شمش‌ها آزاد شده و به وضعیت قبلی برمی‌گردند

### ۳.۵ دلیل لغو سفارش

هنگام لغو سفارش (به هر دلیلی)، دلیل لغو به‌صورت خودکار ثبت و در جزئیات سفارش نمایش داده می‌شود:
- **لغو توسط مشتری**: مشتری خودش سفارش را لغو کرده
- **لغو توسط مدیر سیستم**: مدیر از پنل ادمین سفارش را لغو کرده
- **عدم پرداخت در مهلت مقرر**: سیستم به‌صورت خودکار بعد از اتمام زمان رزرو لغو کرده
- **استرداد وجه توسط مدیر**: مدیر سفارش پرداخت‌شده را استرداد و لغو کرده

### ۳.۶ اطلاعات صورتحساب در فاکتور سفارش

هر سفارش در صفحه جزئیات (`/orders/{id}`) شامل بخش **اطلاعات صورتحساب (Billing Info)** است. این اطلاعات هم برای مشتری و هم برای اپراتور قابل مشاهده است و شامل موارد زیر می‌باشد:

- **نوع مشتری**: حقیقی یا حقوقی
- **نام / نام شرکت**: نام کامل (مشتری حقیقی) یا نام شرکت/موسسه (مشتری حقوقی)
- **کد ملی / شناسه ملی**
- **شماره موبایل** و **شماره تلفن**
- **کد پستی** و **آدرس**
- **کد اقتصادی** (فقط مشتری حقوقی)

**نکته**: این اطلاعات از پروفایل مشتری در لحظه ثبت سفارش ذخیره می‌شوند و جهت صدور فاکتور رسمی و مقاصد حسابداری استفاده می‌شوند.

### ۳.۷ تاریخچه تغییر وضعیت سفارش (Status History Timeline)

در صفحه جزئیات هر سفارش، یک **timeline (خط زمانی)** نمایش داده می‌شود که تمام تغییرات وضعیت و تحویل سفارش را به‌ترتیب زمانی ثبت کرده است. این بخش اپراتور و مشتری را کمک می‌کند تا تاریخ دقیق هر تغییر را دنبال کنند.

**اطلاعات نمایش‌داده‌شده در timeline:**

هر ردیف timeline شامل:
- **تاریخ و ساعت دقیق** تغییر (مثلاً «۱۴۰۲/۱۱/۲۸ ۱۴:۳۵»)
- **نام فیلد تغییریافته** (مثلاً «status»، «delivery_status»، «cancellation_reason»)
- **مقدار قدیمی** → **مقدار جدید** (مثلاً «Pending → Paid» یا «درحال‌ارسال → تحویل‌شده»)
- **نام کاربری تغییر‌دهنده** (مثلاً نام ادمینی که تغییر را انجام داده یا «سیستم» اگر خودکار باشد)
- **توضیح یا علت** (اختیاری — در برخی موارد مثل لغو سفارش)

**نمونه timeline:**
```
[۱۴۰۲/۱۱/۲۸ ۱۰:۱۵] status: — → Pending (توسط: سیستم)
[۱۴۰۲/۱۱/۲۸ ۱۴:۳۵] status: Pending → Paid (توسط: سیستم) توضیح: پرداخت درگاه Zibal
[۱۴۰۲/۱۱/۲۹ ۰۹:۲۰] delivery_status: — → Pending (توسط: سیستم)
[۱۴۰۲/۱۱/۲۹ ۱۳:۰۰] delivery_status: Pending → Shipped (توسط: admin_user) توضیح: تحویل به نماینده
[۱۴۰۲/۱۲/۰۱ ۱۶:۴۵] delivery_status: Shipped → Delivered (توسط: سیستم)
```

**موارد استفاده:**
- اپراتور می‌تواند تاریخ دقیق پرداخت سفارش را ببیند
- اپراتور می‌تواند ببیند کی سفارش ارسال شده و کی تحویل داده شده
- در صورت شکایت مشتری درباره تاریخ، اپراتور می‌تواند timeline را برای شفاف‌سازی نشان دهد
- تمام تغییرات وضعیت و تحویل بدون آن‌که پاک یا تغییر شوند، دائماً ثبت می‌شوند (audit trail = سند حسابی)

---

## 4. سناریو ۳: مدیریت نمایندگان

### ۴.۱ ایجاد نماینده جدید

1. از منو **نمایندگان** را انتخاب کنید
2. روی **«ایجاد نماینده جدید»** کلیک کنید
3. فرم را پر کنید:
   - **شماره موبایل**: شماره ۱۱ رقمی (09xxxxxxxxx) — نماینده با این شماره لاگین می‌کند
   - **نام کامل**: نام و نام خانوادگی
   - **کد ملی**: اختیاری (۱۰ رقمی)
   - **سطح نمایندگی**: انتخاب از لیست سطوح (عامل / بنکدار / نماینده)
   - **آدرس نمایندگی**: استان + شهر + محله (cascade dropdown) + آدرس کامل + کد پستی + تلفن ثابت
   - **نوع نمایندگی**:
     - **انبار مرکزی**: تیک بزنید اگر این نماینده فقط انبار است (بدون فروش POS)
     - **هاب ارسال پستی**: تیک بزنید اگر ارسال پستی از این نماینده انجام می‌شود
4. **«ایجاد نماینده»** را بزنید

### ۴.۲ ویرایش نماینده

1. در لیست نمایندگان روی **«ویرایش»** کلیک کنید
2. قابل تغییر:
   - نام کامل
   - سطح نمایندگی
   - آدرس نمایندگی (استان/شهر/محله/آدرس/کدپستی/تلفن)
   - نوع نمایندگی (انبار مرکزی / هاب پستی)
   - وضعیت فعال/غیرفعال
3. **«ذخیره تغییرات»** را بزنید

**نکته**: غیرفعال کردن نماینده مانع از ورود او به پنل نمایندگی می‌شود.

### ۴.۳ بررسی درخواست‌های بازخرید

**بازخرید چیست؟** وقتی مشتری می‌خواهد شمشی را که قبلاً خریده به فروشنده برگرداند و پول خود را دریافت کند. نماینده درخواست بازخرید ثبت می‌کند و ادمین تایید/رد می‌کند.

1. از منو **بازخرید نمایندگان** را انتخاب کنید
2. فیلتر بر اساس وضعیت:
   - **همه**: تمام درخواست‌ها
   - **در انتظار**: نیاز به بررسی
   - **تایید شده**: تایید شده و آماده تسویه
   - **رد شده**: رد شده
3. برای هر درخواست «در انتظار» دو دکمه وجود دارد:
   - **تایید**: سیستم یادداشت اختیاری می‌خواهد → تایید درخواست
   - **رد**: سیستم دلیل رد را می‌خواهد → رد درخواست

### ۴.۴ تایید بازخرید با بازگشت اجرت (Buyback Wage Refund)

**چه زمانی اتفاق می‌افتد؟** وقتی نماینده درخواست بازخرید شمشی را ثبت می‌کند که قبلاً به یک مشتری ثبت‌نام‌شده فروخته شده است.

**مراحل:**

1. از منو **بازخرید نمایندگان** (`/admin/dealers/buybacks`) را انتخاب کنید
2. درخواست بازخرید «در انتظار» مورد نظر را پیدا کنید
3. دکمه **«تایید»** را بزنید
4. در صورت نیاز یادداشت ادمین وارد کنید (اختیاری)
5. سیستم به‌صورت خودکار اقدامات زیر را انجام می‌دهد:
   - وضعیت شمش از **فروخته (SOLD)** به **تخصیص (ASSIGNED)** تغییر می‌کند
   - مالکیت شمش حذف می‌شود (customer_id → null)
   - یک رکورد **OwnershipHistory** ثبت می‌شود
   - اجرت اصلی که هنگام فروش شمش پرداخت شده بود (از `OrderItem.final_wage_amount`) جستجو می‌شود
   - در صورت یافتن: مبلغ اجرت به‌عنوان **اعتبار فروشگاهی غیرقابل برداشت** به کیف پول مشتری واریز می‌شود
   - پیام موفقیت با مبلغ اعتبار واریزشده نمایش داده می‌شود

**آنچه اپراتور می‌بیند:**
- پیام موفقیت: **«بازخرید #X تایید شد — اعتبار اجرت Y تومان به کیف پول مشتری واریز شد»**
- در جدول بازخریدها، ستون **«اعتبار اجرت»** مبلغ واریزشده را نشان می‌دهد

**حالات خاص:**
- اگر شمش از طریق POS فروخته شده باشد (بدون OrderItem): بازگشت اجرت انجام نمی‌شود. تایید بازخرید بدون مشکل ادامه می‌یابد.
- اگر شمش فاقد customer_id باشد: بازگشت اجرت انجام نمی‌شود.

**تایید اعتبار واریزشده:**
1. به **کیف پول** → **حساب‌ها** (`/admin/wallets`) بروید
2. مشتری مربوطه را پیدا کنید و وارد جزئیات کیف پول شوید
3. در خلاصه موجودی، مبلغ **«اعتبار فروشگاهی»** قابل مشاهده است
4. در لیست تراکنش‌ها، یک رکورد CREDIT با توضیحات **«اعتبار بازگشت اجرت بازخرید شمش {سریال}»** وجود دارد

**مشتری چه می‌بیند؟**
- اعتبار فروشگاهی در صفحه کیف پول تحت عنوان **«اعتبار فروشگاهی»** نمایش داده می‌شود
- این اعتبار برای خرید قابل استفاده است اما **قابل برداشت نیست**
- در فرم برداشت، موجودی «قابل برداشت» نمایش داده می‌شود (بدون احتساب اعتبار فروشگاهی)

### ۴.۵ مشاهده آمار نمایندگان

در صفحه لیست نمایندگان، ۶ کارت آماری بالای صفحه نمایش داده می‌شود:
- تعداد کل نمایندگان
- نمایندگان فعال
- کل فروش حضوری
- درآمد فروش حضوری
- کل کمیسیون پرداختی
- درخواست‌های بازخرید در انتظار

---

## 5. سناریو ۴: مدیریت کوپن‌ها

### ۵.۱ ایجاد کوپن تخفیف

1. از منو **کوپن‌ها** را انتخاب کنید
2. روی **«ایجاد کوپن جدید»** کلیک کنید
3. فیلدهای اصلی:
   - **کد کوپن**: کدی که مشتری وارد می‌کند (مثلاً WELCOME10)
   - **عنوان**: نام نمایشی
   - **نوع**: تخفیف (DISCOUNT) یا کشبک (CASHBACK)
   - **حالت تخفیف**: درصدی (PERCENT) یا مبلغ ثابت (FIXED)
   - **مقدار تخفیف**: عدد درصد یا مبلغ (تومان)
4. محدودیت‌ها (اختیاری):
   - **سقف تخفیف**: حداکثر مبلغ تخفیف (برای حالت درصدی)
   - **حداقل سفارش**: حداقل مبلغ سفارش برای استفاده از کوپن
   - **حداکثر سفارش**: سقف مبلغ سفارش
   - **سقف استفاده کل**: چند بار در کل قابل استفاده است
   - **سقف هر مشتری**: هر مشتری چند بار می‌تواند استفاده کند
   - **تاریخ شروع / انقضا**: بازه زمانی اعتبار
5. تنظیمات خاص:
   - **فقط اولین خرید**: فقط مشتریانی که خرید قبلی ندارند
   - **خصوصی**: فقط با وارد کردن کد (نه در لیست عمومی)
6. **«ایجاد کوپن»** را بزنید

### ۵.۲ تفاوت تخفیف و کشبک

| ویژگی | تخفیف (DISCOUNT) | کشبک (CASHBACK) |
|--------|-------------------|-----------------|
| زمان اعمال | هنگام خرید | پس از تحویل |
| نحوه اعمال | کسر از مبلغ سفارش | واریز به کیف پول |
| مشتری می‌بیند | قیمت کمتر در چک‌اوت | مبلغ واریزشده در کیف پول |

### ۵.۳ مثال‌های کاربردی

**مثال ۱ — کوپن خوش‌آمدگویی:**
- کد: `WELCOME10`
- نوع: تخفیف درصدی ۱۰٪
- سقف تخفیف: ۲,۰۰۰,۰۰۰ تومان
- فقط اولین خرید: بله

**مثال ۲ — کشبک مناسبتی:**
- کد: `CASHBACK5`
- نوع: کشبک درصدی ۵٪
- بدون سقف
- سقف استفاده کل: ۱۰۰ بار

**مثال ۳ — تخفیف مبلغ ثابت:**
- کد: `FIXED500`
- نوع: تخفیف مبلغ ثابت ۵۰۰,۰۰۰ تومان
- حداقل سفارش: ۵,۰۰۰,۰۰۰ تومان

**مثال ۴ — کوپن VIP (لیست سفید موبایل):**
- کد: `VIP2026`
- نوع: تخفیف درصدی ۱۵٪
- خصوصی: بله
- موبایل‌های مجاز: فقط شماره‌های اضافه‌شده در بخش «لیست سفید»

### ۵.۴ محدودیت دسته‌بندی (کوپن تخصصی دسته)

**کی لازم است؟** وقتی می‌خواهید کوپن فقط برای دسته‌بندی‌های خاصی معتبر باشد (مثلاً فقط شمش گرمی، یا فقط شمش ۱۰ مثقالی).

1. در فرم ایجاد/ویرایش کوپن، در قسمت **«محدودیت‌ها»**:
   - فیلد **«محدوده کوپن»** را پیدا کنید
   - **«دسته‌بندی»** (CATEGORY) را انتخاب کنید
2. لیست تمام دسته‌بندی‌های محصول با چک‌باکس نمایش داده می‌شود
3. دسته‌بندی‌هایی که می‌خواهید کوپن برای آن‌ها معتبر باشد را **تیک** بزنید
4. **«ایجاد کوپن»** یا **«ذخیره تغییرات»** را بزنید

**نحوه عملکرد**:
- اگر سبد خرید مشتری **حداقل یک محصول** از دسته‌بندی‌های انتخاب‌شده داشته باشد → کوپن معتبر است
- اگر سبد خرید **هیچ محصولی** از دسته‌بندی‌های انتخاب‌شده نداشته باشد → سیستم پیام می‌دهد: «این کد فقط برای دسته‌بندی خاصی معتبر است»
- اگر هیچ دسته‌بندی انتخاب نشود → کوپن برای **تمام دسته‌بندی‌ها** معتبر است

**مثال عملی — کوپن GOLD10:**
- کد: `GOLD10`
- نوع: تخفیف درصدی ۱۰٪
- محدوده: دسته‌بندی
- دسته‌بندی‌های انتخاب‌شده: فقط **«شمش گرمی»**
- نتیجه: مشتری فقط اگر شمش گرمی در سبد داشته باشد می‌تواند از این کوپن استفاده کند

### ۵.۵ غیرفعال کردن کوپن

1. کوپن مورد نظر را باز کنید
2. وضعیت را به **«غیرفعال»** تغییر دهید
3. ذخیره کنید

---

## 6. سناریو ۵: احراز اصالت و کیف پول

### ۶.۱ احراز اصالت شمش

**صفحه عمومی** — هر کسی می‌تواند اصالت شمش را بررسی کند:

1. به آدرس `/verify` بروید
2. سریال‌کد ۸ کاراکتری شمش را وارد کنید
3. سیستم نمایش می‌دهد:
   - **شمش اصل**: نام محصول، وزن، عیار، وضعیت فعلی
   - **شمش نامعتبر**: پیام «سریال‌کد یافت نشد»

### ۶.۲ مدیریت حساب‌های کیف پول

1. از منو **کیف پول** → **حساب‌ها** را انتخاب کنید
2. لیست تمام حساب‌های مشتریان نمایش داده می‌شود:
   - نام مشتری، موجودی، مبلغ بلوکه‌شده
3. روی هر حساب کلیک کنید تا جزئیات و تاریخچه تراکنش‌ها را ببینید

### ۶.۳ بررسی درخواست‌های برداشت

**برداشت چیست؟** مشتری می‌خواهد مبلغی از کیف پول خود به حساب بانکی واریز شود.

1. از منو **کیف پول** → **برداشت‌ها** را انتخاب کنید
2. درخواست‌های «در انتظار» را بررسی کنید:
   - نام مشتری، مبلغ درخواستی، شماره شبا، نام صاحب حساب
3. اقدام:
   - **تایید**: مبلغ را به حساب بانکی مشتری واریز کنید، سپس دکمه «تایید» را بزنید
   - **رد**: در صورت مشکل (شبا نامعتبر، مغایرت نام) دکمه «رد» را بزنید

**مهم**: تایید درخواست برداشت فقط به معنای تایید در سیستم است. واریز واقعی به حساب بانکی باید **دستی** توسط حسابدار انجام شود.

### ۶.۴ تنظیمات سیستم (فقط مدیرکل)

**توجه**: فقط کاربران با نقش `super_admin` به تنظیمات دسترسی دارند.

1. از منو **تنظیمات** را انتخاب کنید
2. تنظیمات قابل تغییر:
   - **دارایی‌ها (طلا، نقره)**: هر دارایی کارت مستقل خود را دارد:
     - **قیمت فعلی**: قیمت هر گرم به ریال — مبنای محاسبه قیمت محصولات
     - **آستانه انقضا** (دقیقه): اگر قیمت بیش از این مدت به‌روز نشده باشد، خرید/فروش بلاک می‌شود
     - **بازه بروزرسانی خودکار** (دقیقه): هر چند دقیقه سیستم از API خارجی قیمت جدید دریافت کند
     - **بروزرسانی خودکار** (سوئیچ): روشن = خودکار از goldis.ir / خاموش = فقط دستی
     - **نشان تازگی**: سبز = قیمت تازه / قرمز = قیمت قدیمی
     - **دکمه بروزرسانی دستی**: کلیک کنید تا قیمت فوراً از goldis.ir دریافت شود
   - **درصد مالیات**: درصد مالیات بر ارزش افزوده
   - **هزینه ارسال**: هزینه پایه ارسال پستی
   - **بیمه ارسال**: هزینه بیمه مرسوله
   - **درگاه پرداخت فعال**: از dropdown درگاه مورد نظر را انتخاب کنید (زیبال / سپهر / تاپ / پارسیان)
3. **«ذخیره»** را بزنید

**هشدار**: تغییر قیمت طلا فوراً روی قیمت تمام محصولات در فروشگاه اثر می‌گذارد.

**نکته مهم — انقضای قیمت**: اگر قیمت طلا بیش از آستانه تعیین‌شده (پیش‌فرض ۱۵ دقیقه) به‌روز نشده باشد:
- خرید آنلاین (checkout) بلاک می‌شود
- فروش حضوری (POS) بلاک می‌شود
- تبدیل کیف پول (ریال ↔ طلا) بلاک می‌شود
- در فروشگاه بنر هشدار زرد نمایش داده می‌شود

برای رفع: یا بروزرسانی خودکار را فعال کنید، یا از دکمه «بروزرسانی دستی» استفاده کنید.

---

## 7. سناریو ۶: مدیریت تیکت‌های پشتیبانی

### ۷.۱ آشنایی با سیستم تیکت

مشتریان و نمایندگان می‌توانند از طریق سیستم تیکت، سوالات و مشکلات خود را مطرح کنند. اپراتور تیکت‌ها را بررسی و پاسخ می‌دهد.

**نکته کلیدی**: تیکت‌های مشتریان و نمایندگان با **تب‌های جداگانه** و **badge رنگی** مشخص می‌شوند تا اپراتور به سادگی تشخیص دهد هر تیکت از کجا آمده.

### ۷.۲ مشاهده لیست تیکت‌ها

1. از منو **تیکت‌های پشتیبانی** را انتخاب کنید (`/admin/tickets`)
2. بالای صفحه **تب‌ها** نمایش داده می‌شود:
   - **همه**: تمام تیکت‌ها (با badge تعداد کل)
   - **مشتریان**: فقط تیکت‌های مشتریان (badge آبی)
   - **نمایندگان**: فقط تیکت‌های نمایندگان (badge بنفش)
3. **دکمه‌های فیلتر وضعیت**:
   - باز | در حال بررسی | پاسخ داده شده | بسته
4. جدول نمایش می‌دهد:
   - نوع فرستنده (مشتری / نماینده) با badge رنگی
   - موضوع تیکت
   - اولویت (کم / متوسط / بالا)
   - وضعیت
   - اپراتور تخصیص‌یافته
   - تعداد پیام‌ها
   - تاریخ ایجاد

### ۷.۳ پاسخ دادن به تیکت

1. روی تیکت مورد نظر کلیک کنید
2. **بخش مکالمه** (سمت چپ):
   - پیام اولیه فرستنده
   - تمام پاسخ‌ها به ترتیب زمانی
   - پیام‌های اپراتور با **پس‌زمینه سبز** مشخص می‌شوند
3. در فرم پاسخ، متن خود را بنویسید و **«ارسال پاسخ»** را بزنید
4. وضعیت تیکت به‌صورت خودکار به **«پاسخ داده شده»** تغییر می‌کند
5. اگر تیکت هنوز تخصیص نشده، **خودکار** به شما تخصیص داده می‌شود

### ۷.۴ تخصیص تیکت به اپراتور

1. صفحه جزئیات تیکت را باز کنید
2. در **پنل کناری** (سمت راست):
   - قسمت **«تخصیص»** را پیدا کنید
   - از لیست کشویی اپراتور مورد نظر را انتخاب کنید
   - **«تخصیص»** را بزنید
3. اگر تیکت «باز» باشد، وضعیت خودکار به **«در حال بررسی»** تغییر می‌کند

### ۷.۵ تغییر وضعیت تیکت

1. در پنل کناری جزئیات تیکت:
   - از لیست کشویی **«تغییر وضعیت»** وضعیت جدید را انتخاب کنید
   - **«اعمال»** را بزنید
2. وضعیت‌های ممکن: باز، در حال بررسی، پاسخ داده شده، بسته

### ۷.۶ بستن تیکت

1. در پنل کناری دکمه **«بستن تیکت»** (قرمز) را بزنید
2. تیکت بسته شده و دیگر امکان پاسخ دادن وجود ندارد

**نکته**: مشتری یا نماینده هم می‌توانند تیکت خود را ببندند.

### ۷.۷ رفتار خودکار وضعیت

| اقدام | تغییر وضعیت خودکار |
|--------|---------------------|
| اپراتور پاسخ می‌دهد | → پاسخ داده شده (Answered) |
| مشتری/نماینده پاسخ می‌دهد (وقتی وضعیت Answered است) | → باز (Open) — تیکت بازگشایی می‌شود |
| تخصیص به اپراتور (وقتی باز است) | → در حال بررسی (InProgress) |
| اولین پاسخ اپراتور (بدون تخصیص) | → تخصیص خودکار به اپراتور پاسخ‌دهنده |

### ۷.۸ پیوست فایل در تیکت

**کی لازم است؟** وقتی مشتری یا نماینده می‌خواهد اسکرین‌شات، رسید پرداخت، یا تصویری را به تیکت ضمیمه کند. اپراتور هم می‌تواند هنگام پاسخ‌دهی فایل پیوست کند.

**فرمت‌های مجاز:** JPG، PNG، WEBP — **حداکثر حجم: ۱۰ مگابایت** برای هر فایل.

**ارسال فایل توسط مشتری/نماینده:**

1. مشتری یا نماینده تیکت جدید ایجاد می‌کند یا به تیکت موجود پاسخ می‌دهد
2. در فرم ارسال، فیلد **«پیوست فایل»** وجود دارد
3. فایل تصویری را انتخاب می‌کند (JPG/PNG/WEBP تا ۱۰MB)
4. پس از ارسال، تصویر در کنار متن پیام نمایش داده می‌شود

**ارسال فایل توسط اپراتور:**

1. صفحه جزئیات تیکت را باز کنید
2. در فرم پاسخ، متن پاسخ را بنویسید
3. در صورت نیاز از فیلد **«پیوست فایل»** یک تصویر انتخاب کنید
4. **«ارسال پاسخ»** را بزنید — متن و تصویر همراه هم ارسال می‌شوند

**نکات مهم:**
- اگر حجم فایل بیشتر از ۱۰ مگابایت باشد، سیستم پیام خطا نمایش می‌دهد
- اگر فرمت فایل غیرمجاز باشد (مثلاً PDF یا ZIP)، آپلود انجام نمی‌شود
- تصاویر پیوست‌شده در بخش مکالمه تیکت به‌صورت thumbnail قابل مشاهده هستند

### ۷.۹ دسته‌بندی / دپارتمان تیکت

**کی لازم است؟** برای دسته‌بندی تیکت‌ها بر اساس نوع درخواست و هدایت آن‌ها به دپارتمان مناسب.

**دپارتمان‌های موجود:**
| دپارتمان | توضیح |
|-----------|--------|
| مالی | سوالات مربوط به پرداخت، کیف پول، استرداد |
| فنی | مشکلات فنی سایت، اپلیکیشن، دستگاه POS |
| فروش | سوالات قبل از خرید، مشاوره محصول |
| شکایات | شکایت از خدمات، محصول، نماینده |
| سایر | موارد متفرقه |

**هنگام ایجاد تیکت (مشتری/نماینده):**

1. در فرم ایجاد تیکت، فیلد **«دپارتمان»** را انتخاب کنید
2. دپارتمان مناسب را از لیست کشویی انتخاب کنید (مالی / فنی / فروش / شکایات / سایر)
3. تیکت ثبت شده با دپارتمان مشخص‌شده نمایش داده می‌شود

**فیلتر بر اساس دپارتمان (اپراتور):**

1. در صفحه لیست تیکت‌ها (`/admin/tickets`)
2. علاوه بر تب‌ها (همه/مشتریان/نمایندگان) و فیلتر وضعیت، **فیلتر دپارتمان** نیز وجود دارد
3. دپارتمان مورد نظر را انتخاب کنید تا فقط تیکت‌های آن دپارتمان نمایش داده شوند
4. فیلتر دپارتمان با سایر فیلترها (وضعیت، نوع فرستنده) ترکیب می‌شود

**مزیت:** اپراتورهایی که مسئول یک دپارتمان خاص هستند می‌توانند فقط تیکت‌های مرتبط با حوزه خود را ببینند.

### ۷.۱۰ یادداشت داخلی (Internal Notes)

**کی لازم است؟** وقتی اپراتور نیاز دارد نکته‌ای را برای سایر اپراتورها ثبت کند بدون اینکه مشتری یا نماینده آن را ببیند.

**ایجاد یادداشت داخلی:**

1. صفحه جزئیات تیکت را باز کنید
2. در فرم پاسخ، علاوه بر دکمه **«ارسال پاسخ»**، دکمه‌ای با عنوان **«یادداشت داخلی»** وجود دارد
3. متن یادداشت خود را بنویسید
4. **«یادداشت داخلی»** را بزنید

**نمایش یادداشت‌ها:**
- یادداشت‌های داخلی با **آیکون قفل/هشدار** و **پس‌زمینه متفاوت** (زرد/نارنجی) از پاسخ‌های عادی مشخص می‌شوند
- برچسب **«یادداشت داخلی — فقط قابل مشاهده توسط کارکنان»** در بالای یادداشت نمایش داده می‌شود
- **مشتری و نماینده این یادداشت‌ها را نمی‌بینند** — فقط کارکنان (اپراتور و مدیرکل) دسترسی دارند

**موارد استفاده:**
- «با تیم مالی هماهنگ شد — در انتظار تایید»
- «منتظر تایید مدیر هستیم»
- «مشتری قبلاً هم همین مشکل را داشته — پرونده قبلی #۲۳ مرتبط است»
- «شماره شبا مشتری بررسی شد — مغایرت نام وجود دارد»

### ۷.۱۱ جستجوی تیکت

**کی لازم است؟** وقتی اپراتور به دنبال تیکت خاصی است و نمی‌خواهد تک‌تک صفحات را مرور کند.

**نحوه جستجو:**

1. در صفحه لیست تیکت‌ها (`/admin/tickets`)
2. فیلد **جستجو** در بالای صفحه (کنار فیلترها) وجود دارد
3. عبارت مورد نظر را تایپ کنید و **جستجو** را بزنید

**قابلیت جستجو بر اساس:**
- **شماره تیکت**: مثلاً `۱۲۳` یا `123`
- **موضوع تیکت**: بخشی از متن موضوع (مثلاً «پرداخت» یا «ارسال»)
- **نام مشتری/نماینده**: نام فرستنده تیکت
- **شماره موبایل**: شماره موبایل فرستنده

**نکته مهم:** جستجو با فیلترهای موجود (وضعیت، دپارتمان، نوع فرستنده) ترکیب می‌شود. یعنی اگر تب «مشتریان» فعال باشد و وضعیت «باز» انتخاب شده باشد، جستجو فقط در تیکت‌های باز مشتریان انجام می‌شود.

### ۷.۱۲ اطلاع‌رسانی پیامکی تیکت

**سیستم در موارد زیر پیامک اطلاع‌رسانی ارسال می‌کند:**

| رویداد | گیرنده | متن تقریبی |
|--------|---------|------------|
| اپراتور به تیکت پاسخ می‌دهد | مشتری/نماینده | «پاسخ جدیدی برای تیکت #X ارسال شد» |
| وضعیت تیکت تغییر می‌کند | مشتری/نماینده | «وضعیت تیکت #X به Y تغییر یافت» |

**نکات:**
- اطلاع‌رسانی فقط به **مشتری یا نماینده** فرستنده تیکت ارسال می‌شود (نه به اپراتور)
- شماره موبایل گیرنده از پروفایل مشتری یا اطلاعات نماینده خوانده می‌شود
- در **محیط توسعه** (بدون `SMS_API_KEY`): پیامک واقعی ارسال نمی‌شود و فقط در **کنسول سرور** چاپ می‌شود (لاگ)
- در **محیط تولید** (با `SMS_API_KEY` معتبر): پیامک از طریق سرویس کاوه‌نگار ارسال می‌شود
- اپراتور نیازی به تنظیم خاصی ندارد — اطلاع‌رسانی **خودکار** است

---

## 8. سناریو ۷: مدیریت کلید API دستگاه POS

### ۸.۱ آشنایی

نمایندگان از دستگاه‌های POS اندرویدی برای فروش حضوری شمش استفاده می‌کنند. هر دستگاه با **کلید API** احراز هویت می‌شود که توسط اپراتور تولید و مدیریت می‌شود.

### ۸.۲ تولید کلید API

1. از منو **نمایندگان** را انتخاب کنید (`/admin/dealers`)
2. نماینده مورد نظر را **ویرایش** کنید
3. در بخش **کلید API دستگاه POS** (پایین فرم):
   - روی **«تولید کلید API»** کلیک کنید
4. کلید تولید شده نمایش داده می‌شود
5. با دکمه **کپی** کلید را کپی کرده و در اختیار تیم فنی یا نماینده قرار دهید

**نکته**: هر نماینده فقط یک کلید API فعال دارد. تولید کلید جدید، کلید قبلی را باطل می‌کند.

### ۸.۳ لغو کلید API

1. صفحه ویرایش نماینده را باز کنید
2. در بخش کلید API، روی **«لغو کلید»** کلیک کنید
3. تایید کنید — کلید حذف و دستگاه POS از کار می‌افتد

### ۸.۴ عیب‌یابی دستگاه POS

| مشکل | راه‌حل |
|--------|--------|
| دستگاه خطای «کلید نامعتبر» می‌دهد | کلید API را لغو و مجدد تولید کنید |
| لیست محصولات خالی است | مطمئن شوید شمش‌هایی با وضعیت ASSIGNED در شعبه نماینده وجود دارد |
| فروش ثبت نمی‌شود | سریال شمش را بررسی کنید — شمش باید ASSIGNED و در شعبه نماینده باشد |

### ۸.۵ تخفیف اجرت در فروش حضوری (POS)

نمایندگان هنگام فروش حضوری می‌توانند اختیاری بخشی از سهم اجرت خود را به مشتری تخفیف دهند تا قیمت نهایی کاهش یابد.

**نحوه کار:**
1. نماینده وارد صفحه فروش حضوری (`/dealer/pos`) می‌شود
2. شمش مورد نظر را انتخاب می‌کند
3. سیستم اطلاعات سهم اجرت را نمایش می‌دهد:
   - **اجرت مشتری نهایی**: درصد اجرت محصول برای مشتری نهایی (ec_wage%)
   - **اجرت سطح شما**: درصد اجرت محصول برای سطح نماینده (dealer_wage%)
   - **سهم شما**: اختلاف دو اجرت = سود نماینده (margin%)
4. نماینده با اسلایدر یا عدد، مقدار تخفیف را تنظیم می‌کند (۰ تا سهم کامل)
5. سیستم قیمت نهایی با تخفیف، مبلغ تخفیف، و سود طلایی باقی‌مانده را نمایش می‌دهد
6. نماینده فرم را ثبت می‌کند

**نکات مهم:**
- تخفیف از سود طلایی نماینده کسر می‌شود (نه از سیستم)
- اگر نماینده کل سهم خود را تخفیف دهد، سود طلایی صفر خواهد شد
- تخفیف بیش از سهم نماینده مجاز نیست
- تاریخچه فروش (`/dealer/sales`) ستون تخفیف اجرت را نمایش می‌دهد

---

## 9. سناریو ۸: صفحات ثابت و فوتر

### ۹.۱ آشنایی

سایت فروشگاهی شامل چند صفحه اطلاع‌رسانی ثابت است که بدون نیاز به لاگین قابل‌دسترسی هستند. این صفحات اطلاعات عمومی شرکت، سوالات متداول، راه‌های ارتباطی و قوانین استفاده از سایت را نمایش می‌دهند.

### ۹.۲ صفحات موجود

| صفحه | آدرس | توضیح |
|--------|------|--------|
| درباره ما | `/about` | معرفی شرکت طلاملا، تاریخچه و ماموریت |
| سوالات متداول | `/faq` | سوالات پرتکرار مشتریان با پاسخ |
| تماس با ما | `/contact` | آدرس، تلفن، ایمیل، ساعت کاری |
| قوانین و مقررات | `/terms` | شرایط استفاده از خدمات فروشگاه |

### ۹.۳ به‌روزرسانی محتوای صفحات ثابت

**کی لازم است؟** وقتی اطلاعات شرکت تغییر می‌کند (آدرس جدید، تلفن جدید، تغییر ساعت کاری) یا نیاز به افزودن/ویرایش سوالات متداول وجود دارد.

**نکته مهم**: محتوای صفحات ثابت در فایل‌های قالب (Template) ذخیره شده و از طریق پنل مدیریت قابل‌ویرایش **نیست**. برای تغییر محتوا باید فایل‌های زیر توسط تیم فنی ویرایش شوند:

| صفحه | فایل قالب |
|--------|-----------|
| درباره ما | `templates/shop/about.html` |
| سوالات متداول | `templates/shop/faq.html` |
| تماس با ما | `templates/shop/contact.html` |
| قوانین و مقررات | `templates/shop/terms.html` |

**مراحل درخواست تغییر:**

1. متن جدید یا تغییرات مورد نظر را تهیه کنید
2. درخواست تغییر را به تیم فنی ارسال کنید (یا تیکت داخلی ثبت کنید)
3. تیم فنی فایل قالب مربوطه را ویرایش و deploy می‌کند
4. پس از deploy، تغییرات بلافاصله در سایت اعمال می‌شوند

### ۹.۴ فوتر سایت

فوتر سایت در تمام صفحات فروشگاه نمایش داده می‌شود و شامل:

- **اطلاعات شرکت**: نام، توضیح، آدرس فیزیکی، تلفن، ایمیل
- **لینک‌های سریع**: لینک به صفحات اصلی سایت (فروشگاه، احراز اصالت، سوالات متداول، درباره ما، تماس با ما، قوانین)
- **نشان‌های اعتماد**: لوگوهای اعتماد الکترونیکی (enamad، ساماندهی)
- **شبکه‌های اجتماعی**: لینک به اینستاگرام، تلگرام، واتساپ
- **لینک‌های عضویت**: لینک به انجمن‌های صنفی و مجامع مرتبط

**تغییر اطلاعات فوتر** نیز توسط تیم فنی در فایل `templates/shop/base_shop.html` انجام می‌شود.

### ۹.۵ صفحه ۴۰۴ (صفحه یافت نشد)

اگر کاربر آدرسی نامعتبر در سایت وارد کند، یک صفحه ۴۰۴ سفارشی و زیبا نمایش داده می‌شود (به‌جای صفحه خطای پیش‌فرض). این صفحه شامل:

- پیام فارسی «صفحه مورد نظر یافت نشد»
- دکمه بازگشت به صفحه اصلی
- طراحی مطابق با سایر صفحات سایت

### ۹.۶ لینک‌های ناوبار

ناوبار (منوی بالای سایت) در صفحات فروشگاه شامل لینک‌های زیر است:

- احراز اصالت (`/verify`)
- سوالات متداول (`/faq`)
- درباره ما (`/about`)
- تماس با ما (`/contact`)

---

## 10. سناریو ۹: ثبت مالکیت، خرید هدیه و انتقال شمش

### ۱۰.۱ آشنایی

سیستم سه قابلیت جدید مرتبط با مالکیت شمش دارد:

1. **کد ثبت مالکیت (Claim Code)**: کدی ۶ کاراکتری که هنگام فروش حضوری (POS) یا خرید هدیه تولید می‌شود و خریدار با آن مالکیت شمش را در سایت ثبت می‌کند
2. **خرید هدیه (Gift Purchase)**: مشتری می‌تواند شمشی را به‌عنوان هدیه بخرد — شمش به نام خریدار ثبت نمی‌شود و گیرنده هدیه خودش مالکیت را ثبت می‌کند
3. **انتقال مالکیت (Ownership Transfer)**: مشتری می‌تواند شمش خود را به شخص دیگری منتقل کند

### ۱۰.۲ فروش حضوری (POS) با کد ثبت مالکیت

**چه اتفاقی می‌افتد؟** وقتی نماینده یک شمش را از طریق POS می‌فروشد:

1. نماینده فروش را در POS ثبت می‌کند (وب یا API)
2. سیستم خودکار یک **کد ثبت مالکیت** ۶ کاراکتری تولید می‌کند
3. کد در **رسید فروش** نمایش داده می‌شود (و در پاسخ API برگردانده می‌شود)
4. نماینده کد را به خریدار اعلام می‌کند (روی رسید چاپ شده یا شفاهی)

**آنچه اپراتور باید بداند:**
- کد ثبت مالکیت **خودکار** تولید می‌شود — نیازی به اقدام اپراتور نیست
- خریدار پس از ورود به سایت، از طریق **منوی کشویی کاربر → «ثبت شمش»** یا **لینک فوتر → «ثبت شمش»** وارد فرم ثبت مالکیت می‌شود و با وارد کردن سریال‌کد + کد ثبت مالکیت، شمش را به نام خود ثبت می‌کند
- در لیست شمش‌ها (پنل مدیریت → شمش‌ها)، شمش‌های فروخته‌شده از POS تا زمان ثبت مالکیت، ستون «مالک» خالی است اما وضعیت **SOLD** دارند

**مشاهده کد ثبت مالکیت در پنل ادمین:**
- **لیست شمش‌ها**: زیر سریال‌کد هر شمش، اگر کد ثبت مالکیت وجود داشته باشد، با آیکن کلید (🔑) نمایش داده می‌شود
- **صفحه ویرایش شمش**: در بخش «اطلاعات سریع» سمت راست، ردیف «کد ثبت مالکیت» نمایش داده می‌شود
- پس از ثبت مالکیت توسط مشتری، کد حذف شده و دیگر نمایش داده نمی‌شود

### ۱۰.۳ سفارش هدیه (Gift Order)

**چه اتفاقی می‌افتد؟** وقتی مشتری هنگام ثبت سفارش آنلاین گزینه «خرید به‌عنوان هدیه» را فعال می‌کند:

1. مشتری در صفحه checkout تیک **«خرید به‌عنوان هدیه»** را می‌زند
2. پس از پرداخت موفق:
   - شمش وضعیت **SOLD** می‌گیرد
   - `customer_id` شمش **NULL** می‌ماند (به نام خریدار ثبت نمی‌شود)
   - سیستم **کد ثبت مالکیت** تولید و به خریدار نمایش می‌دهد
3. خریدار کد را به گیرنده هدیه می‌دهد

**آنچه اپراتور باید بداند (بسته‌بندی و ارسال):**
- سفارش‌های هدیه در لیست سفارشات با علامت **«هدیه»** مشخص هستند
- بسته‌بندی سفارش هدیه ممکن است نیاز به توجه خاص داشته باشد (بدون فاکتور قیمت داخل بسته)
- روند ارسال و تحویل مانند سفارشات عادی است

### ۱۰.۴ ثبت مالکیت توسط مشتری (Claim Bar)

**این فرآیند توسط مشتری انجام می‌شود (نه اپراتور):**

**دسترسی مشتری:** مشتری از طریق منوی کشویی کاربر (آیتم «ثبت شمش»)، لینک فوتر، یا دکمه در صفحه «شمش‌های من» به فرم ثبت مالکیت دسترسی دارد.

1. مشتری پس از ورود به سایت، از **منوی کشویی کاربر → «ثبت شمش»** یا **صفحه شمش‌های من → دکمه «ثبت شمش جدید»** وارد فرم ثبت مالکیت می‌شود
2. **سریال‌کد** شمش (روی شمش حک شده) و **کد ثبت مالکیت** (از رسید POS یا از خریدار هدیه) را وارد می‌کند
3. سیستم بررسی می‌کند:
   - سریال‌کد معتبر و شمش در سیستم وجود دارد
   - کد ثبت مالکیت صحیح است
   - شمش قبلاً به کسی ثبت نشده
4. مالکیت شمش به مشتری ثبت می‌شود

**اگر مشتری مشکل داشت:**
- اگر کد ثبت مالکیت را گم کرده: باید با پشتیبانی تماس بگیرد (تیکت ثبت کند)
- اگر سریال‌کد اشتباه وارد شده: سیستم پیام خطای مناسب نمایش می‌دهد
- اگر شمش قبلاً ثبت شده: سیستم اجازه ثبت مجدد نمی‌دهد

### ۱۰.۵ مشاهده شمش‌های من (My Bars)

مشتری از طریق **منوی کشویی کاربر → «شمش‌های من»** می‌تواند تمام شمش‌هایی که مالک آن‌هاست را ببیند:
- سریال‌کد
- نام محصول، وزن، عیار
- امکان انتقال هر شمش به شخص دیگر

### ۱۰.۶ انتقال مالکیت شمش (Ownership Transfer)

**چه اتفاقی می‌افتد؟** وقتی مشتری می‌خواهد شمش خود را به شخص دیگری منتقل کند:

**مراحل (از دید مشتری):**

1. مشتری از طریق **منوی کشویی → «شمش‌های من»** وارد لیست شمش‌ها شده و روی دکمه **«انتقال»** کنار شمش مورد نظر کلیک می‌کند
2. **مرحله ۱ — وارد کردن شماره گیرنده**: شماره موبایل شخصی که قرار است شمش به او منتقل شود را وارد می‌کند
3. **مرحله ۲ — تایید هویت فرستنده**: سیستم یک **OTP** به موبایل **مالک فعلی** (فرستنده) ارسال می‌کند — نه گیرنده
4. **مرحله ۳ — تایید نهایی**: مالک OTP را وارد و تایید می‌کند
5. مالکیت شمش به گیرنده منتقل می‌شود:
   - اگر گیرنده حساب کاربری ندارد، سیستم خودکار حساب ایجاد می‌کند
   - شمش در صفحه «شمش‌های من» گیرنده نمایش داده می‌شود
   - شمش از صفحه «شمش‌های من» فرستنده حذف می‌شود

**آنچه اپراتور باید بداند:**
- انتقال مالکیت **کاملاً خودکار** است و نیازی به تایید اپراتور ندارد
- تاریخچه انتقال در **OwnershipHistory** ثبت می‌شود
- اپراتور می‌تواند سابقه مالکیت شمش را در بخش **ویرایش شمش** (`/admin/bars/{id}/edit`) مشاهده کند

### ۱۰.۷ نکات مهم برای اپراتور

| موقعیت | نکته |
|---------|-------|
| فروش POS | کد ثبت مالکیت خودکار تولید می‌شود — مطمئن شوید نماینده کد را به خریدار اعلام کند |
| سفارش هدیه | فاکتور قیمت داخل بسته قرار ندهید — سفارش‌های هدیه علامت‌گذاری شده‌اند |
| شکایت «نمی‌توانم شمش را ثبت کنم» | سریال‌کد و کد ثبت مالکیت را از مشتری بخواهید و در سیستم بررسی کنید |
| شکایت «شمش انتقال نمی‌شود» | بررسی کنید آیا شمش واقعاً به نام مشتری ثبت شده (وضعیت SOLD + customer_id) |
| شکایت «کد ثبت مالکیت گم شده» | در لیست شمش‌ها سریال را جستجو کنید — claim_code قابل مشاهده است |

---

## 11. سناریو ۱۰: مدیریت کاربران

### ۱۱.۱ آشنایی

بخش مدیریت کاربران به اپراتور امکان مشاهده لیست تمام مشتریان ثبت‌نام‌شده، جستجو و فیلتر، بررسی جزئیات هر مشتری (اطلاعات پروفایل، تراکنش‌های کیف پول، سفارشات و درخواست‌های برداشت) و **ویرایش اطلاعات مشتری** را می‌دهد.

### ۱۱.۲ مشاهده لیست مشتریان

1. از منو **مدیریت کاربران** (آیکون bi-people) را انتخاب کنید (`/admin/customers`)
2. **کارت‌های آماری بالای صفحه**:
   - تعداد کل مشتریان
   - مشتریان فعال
   - ثبت‌نام‌های امروز
   - مشتریان دارای سفارش
3. **جدول مشتریان**: نام، موبایل، کد ملی، تاریخ ثبت‌نام، وضعیت، تعداد سفارش
4. جدول **صفحه‌بندی‌شده** است — از دکمه‌های صفحه‌بندی برای مرور استفاده کنید

### ۱۱.۳ جستجوی مشتری

1. در فیلد **جستجو** بالای جدول، عبارت مورد نظر را وارد کنید
2. **قابلیت جستجو بر اساس:**
   - نام مشتری (مثلاً «علی»)
   - شماره موبایل (مثلاً `09351234567`)
   - کد ملی (مثلاً `1234567890`)
3. دکمه **جستجو** را بزنید — نتایج فیلتر می‌شوند

### ۱۱.۴ فیلتر بر اساس وضعیت

1. از فیلتر **وضعیت** استفاده کنید:
   - **همه**: تمام مشتریان
   - **فعال**: فقط مشتریان فعال
   - **غیرفعال**: فقط مشتریان غیرفعال
2. فیلتر وضعیت با جستجو ترکیب می‌شود

### ۱۱.۵ مشاهده جزئیات مشتری

1. در لیست مشتریان روی نام مشتری یا دکمه **«مشاهده»** کلیک کنید
2. صفحه جزئیات مشتری (`/admin/customers/{id}`) شامل **۴ تب** است:

**تب خلاصه (Overview):**
- اطلاعات مشتری: نام، موبایل، کد ملی، نوع مشتری (حقیقی/حقوقی)، تاریخ ثبت‌نام
- **نوع مشتری**:
  - **حقیقی**: شخص حقیقی — نام کامل + کد ملی
  - **حقوقی**: شرکت یا موسسه — نام شرکت + شناسه ملی + کد اقتصادی
- کارت‌های موجودی کیف پول: موجودی ریالی (IRR) + موجودی طلایی (XAU_MG)

**تب کیف پول (Wallet):**
- لیست صفحه‌بندی‌شده تمام تراکنش‌های حسابداری مشتری
- شامل تراکنش‌های ریالی و طلایی
- اطلاعات هر تراکنش: نوع، مبلغ، توضیحات، تاریخ

**تب سفارشات (Orders):**
- لیست صفحه‌بندی‌شده تمام سفارشات مشتری
- اطلاعات هر سفارش: شماره سفارش، وضعیت، مبلغ، روش تحویل، تاریخ

**تب برداشت‌ها (Withdrawals):**
- لیست صفحه‌بندی‌شده درخواست‌های برداشت بانکی مشتری
- اطلاعات هر درخواست: مبلغ، وضعیت (در انتظار / تایید / رد)، شماره شبا، تاریخ

### ۱۱.۶ ویرایش اطلاعات مشتری

1. در صفحه جزئیات مشتری (`/admin/customers/{id}`)، تب **خلاصه (Overview)** را مشاهده کنید
2. **فرم ویرایش inline** زیر اطلاعات مشتری قرار دارد — فیلدهای قابل ویرایش:
   - نام، نام خانوادگی
   - شماره موبایل
   - کد ملی
   - نوع مشتری (حقیقی / حقوقی) — با تغییر به حقوقی، فیلدهای نام شرکت و کد اقتصادی نمایش داده می‌شوند
   - نام شرکت، کد اقتصادی (فقط برای مشتری حقوقی)
   - کد پستی، آدرس، تلفن ثابت
   - تاریخ تولد
   - وضعیت فعال/غیرفعال (سوییچ `is_active`)
3. تغییرات را اعمال کنید و **«ذخیره»** بزنید
4. سیستم **یکتایی موبایل و کد ملی** را بررسی می‌کند — در صورت تکراری بودن، پیام خطا نمایش داده می‌شود

> ⚠️ **نکته**: غیرفعال کردن مشتری (`is_active = False`) باعث محدودیت دسترسی مشتری به سیستم می‌شود.

### ۱۱.۷ موارد استفاده عملی

| موقعیت | اقدام |
|---------|--------|
| مشتری تماس می‌گیرد و می‌پرسد موجودی کیف پولش چقدر است | جستجو بر اساس موبایل → تب خلاصه → مشاهده موجودی |
| بررسی سابقه خرید مشتری | جستجو → تب سفارشات → مرور لیست سفارشات |
| بررسی تراکنش‌های مشکوک کیف پول | جستجو → تب کیف پول → مرور لیست تراکنش‌ها |
| بررسی وضعیت درخواست برداشت مشتری | جستجو → تب برداشت‌ها → مشاهده وضعیت |
| آمار سریع از تعداد مشتریان | مشاهده کارت‌های آماری بالای لیست |
| مشتری شماره موبایلش تغییر کرده | جستجو → تب خلاصه → فرم ویرایش → موبایل جدید وارد کنید → ذخیره |
| تبدیل مشتری حقیقی به حقوقی | جستجو → تب خلاصه → فرم ویرایش → نوع را به «حقوقی» تغییر دهید → نام شرکت و کد اقتصادی را پر کنید → ذخیره |
| غیرفعال کردن مشتری متخلف | جستجو → تب خلاصه → فرم ویرایش → سوییچ «فعال» را خاموش کنید → ذخیره |

---

## 12. سناریو ۱۱: مدیریت بسته‌بندی و قیمت‌گذاری

### ۱۲.۱ مشاهده و ویرایش قیمت بسته‌بندی (ادمین)

**کی لازم است؟** وقتی قیمت یک بسته‌بندی تغییر کرده یا بسته‌بندی جدیدی اضافه/غیرفعال می‌شود.

1. از منو **بسته‌بندی** (`/admin/packages`) را انتخاب کنید
2. لیست بسته‌بندی‌های موجود نمایش داده می‌شود — هر کارت شامل:
   - **نام**: نام بسته‌بندی (قابل ویرایش)
   - **قیمت (تومان)**: قیمت بسته‌بندی (۰ = رایگان)
   - **وضعیت**: فعال/غیرفعال (بسته‌بندی غیرفعال به مشتری نمایش داده نمی‌شود)
   - **تصاویر**: آپلود تصاویر بسته‌بندی
3. برای ویرایش: مقادیر را تغییر دهید و **«ذخیره»** بزنید
4. برای افزودن: روی **«افزودن بسته‌بندی»** کلیک کنید → فرم مودال باز شده → نام، قیمت و وضعیت را وارد کنید

> ⚠️ **نکته مهم**: قیمت بسته‌بندی به **تومان** وارد می‌شود (سیستم خودکار به ریال ذخیره می‌کند). اگر قیمت ۰ وارد شود، بسته‌بندی «رایگان» نمایش داده می‌شود.

### ۱۲.۲ نحوه انتخاب بسته‌بندی توسط مشتری

- مشتری در **صفحه جزئیات محصول** (`/product/{id}`) بخش «انتخاب بسته‌بندی» را می‌بیند
- گزینه پیش‌فرض: «بدون بسته‌بندی خاص» (رایگان)
- مشتری یکی از بسته‌بندی‌ها را با کلیک روی رادیو باتن انتخاب می‌کند
- قیمت بسته‌بندی کنار نام آن نمایش داده می‌شود
- پس از افزودن به سبد خرید، بسته‌بندی ذخیره می‌شود
- مشتری در **صفحه سبد خرید** (`/cart`) می‌تواند بسته‌بندی هر آیتم را با dropdown تغییر دهد
- در **صفحه چک‌اوت** و **جزئیات سفارش**: نام و قیمت بسته‌بندی نمایش داده می‌شود

### ۱۲.۳ تأثیر بسته‌بندی بر قیمت سفارش

- قیمت بسته‌بندی **به ازای هر شمش** اضافه می‌شود (نه کل سبد)
- مبلغ بسته‌بندی در فاکتور سفارش جداگانه نمایش داده می‌شود
- قیمت بسته‌بندی در لحظه ثبت سفارش **اسنپ‌شات** می‌شود — تغییر قیمت بعدی تأثیری بر سفارشات قبلی ندارد

---

## 13. سناریو ۱۲: گزارش فروش نمایندگان (POS)

### ۱۳.۱ آشنایی

بخش گزارش فروش نمایندگان به اپراتور امکان مشاهده تمام فروش‌های حضوری (POS) ثبت‌شده توسط نمایندگان را می‌دهد. این صفحه شامل آمار تجمیعی، فیلترهای پیشرفته و جدول جزئیات هر فروش است.

**مسیر دسترسی**: از منوی کناری پنل مدیریت، آیتم **«فروش نمایندگان»** (آیکون `bi-receipt-cutoff`) را انتخاب کنید (`/admin/dealers/sales`).

### ۱۳.۲ کارت‌های آماری

بالای صفحه ۴ کارت آماری تجمیعی نمایش داده می‌شود که بر اساس فیلترهای فعال به‌روزرسانی می‌شوند:

| کارت | توضیح |
|-------|--------|
| **تعداد فروش** | تعداد کل فروش‌های ثبت‌شده (با احتساب فیلتر فعال) |
| **مجموع فروش (تومان)** | جمع مبالغ تمام فروش‌ها به تومان |
| **سود طلایی کل** | مجموع سود طلایی نمایندگان (بر حسب میلی‌گرم طلا) |
| **فروش با تخفیف اجرت** | تعداد فروش‌هایی که نماینده تخفیف اجرت اعمال کرده |

### ۱۳.۳ فیلتر کردن فروش‌ها

زیر کارت‌های آماری، نوار فیلتر قرار دارد. فیلترها با یکدیگر ترکیب می‌شوند:

1. **جستجو**: متن آزاد — جستجو بر اساس نام مشتری، شماره موبایل مشتری، یا سریال‌کد شمش
2. **نماینده**: لیست کشویی نمایندگان فعال — انتخاب یک نماینده خاص یا «همه نمایندگان»
3. **از تاریخ / تا تاریخ**: فیلتر بازه زمانی — فرمت تاریخ میلادی (فیلد date picker)
4. **تخفیف**: فیلتر وضعیت تخفیف اجرت — سه گزینه:
   - **همه**: تمام فروش‌ها
   - **دارد**: فقط فروش‌هایی که تخفیف اجرت دارند
   - **ندارد**: فقط فروش‌هایی که تخفیف اجرت ندارند
5. دکمه **«فیلتر»** را بزنید تا نتایج اعمال شوند
6. اگر فیلتری فعال باشد، دکمه **«پاک کردن فیلترها»** (آیکون ×) نمایش داده می‌شود — با کلیک تمام فیلترها حذف شده و لیست کامل نمایش داده می‌شود

### ۱۳.۴ جدول جزئیات فروش‌ها

جدول اصلی صفحه شامل ستون‌های زیر است:

| ستون | توضیح |
|-------|--------|
| **#** | شماره شناسه فروش |
| **نماینده** | نام نماینده (لینک به صفحه ویرایش نماینده) + شماره موبایل |
| **سریال شمش** | سریال‌کد شمش فروخته‌شده + کد ثبت مالکیت (در صورت وجود) |
| **مشتری** | نام، شماره موبایل و کد ملی خریدار (اطلاعاتی که نماینده هنگام فروش وارد کرده) |
| **مبلغ فروش** | مبلغ فروش به تومان |
| **سود طلایی** | سود طلایی نماینده از این فروش (میلی‌گرم طلا) |
| **تخفیف اجرت** | درصد تخفیف اجرتی که نماینده اعمال کرده — اگر تخفیف نداشته باشد «—» نمایش داده می‌شود |
| **توضیحات** | یادداشت نماینده درباره فروش (حداکثر ۵۰ کاراکتر اول) |
| **تاریخ** | تاریخ ثبت فروش به شمسی |

### ۱۳.۵ صفحه‌بندی

- هر صفحه **۳۰ فروش** نمایش می‌دهد
- از دکمه‌های صفحه‌بندی پایین جدول برای مرور صفحات استفاده کنید
- فیلترهای فعال هنگام تغییر صفحه حفظ می‌شوند

### ۱۳.۶ موارد استفاده عملی

| موقعیت | اقدام |
|---------|--------|
| بررسی عملکرد یک نماینده خاص | فیلتر «نماینده» را روی نماینده مورد نظر تنظیم کنید |
| بررسی فروش‌های امروز | بازه تاریخ «از تاریخ» و «تا تاریخ» را روی تاریخ امروز تنظیم کنید |
| مشاهده فروش‌هایی که تخفیف اجرت دارند | فیلتر «تخفیف» را روی «دارد» تنظیم کنید |
| جستجوی فروش خاص با سریال‌کد شمش | سریال‌کد را در فیلد جستجو وارد کنید |
| جستجوی فروش‌های یک مشتری خاص | نام یا شماره موبایل مشتری را در فیلد جستجو وارد کنید |
| بررسی کل درآمد فروش حضوری در یک ماه | بازه تاریخ یک ماهه تنظیم کنید و کارت «مجموع فروش» را مشاهده کنید |
| پاک کردن تمام فیلترها و بازگشت به لیست کامل | روی دکمه × (پاک کردن فیلترها) کلیک کنید |

---

## 14. سناریو ۱۳: تغییر درگاه پرداخت (Gateway Switching)

### ۱۴.۱ درگاه‌های پشتیبانی‌شده

سیستم از ۴ درگاه پرداخت بانکی پشتیبانی می‌کند:

| درگاه | نام فنی | توضیح |
|--------|---------|--------|
| **زیبال (Zibal)** | `zibal` | درگاه پیش‌فرض — دارای حالت sandbox (تست) |
| **سپهر (Sepehr)** | `sepehr` | درگاه بانک صادرات |
| **تاپ (Top)** | `top` | درگاه پرداخت تاپ |
| **پارسیان (Parsian)** | `parsian` | درگاه بانک پارسیان |

### ۱۴.۲ تغییر درگاه فعال

**کی لازم است؟** وقتی درگاه فعلی مشکل دارد یا می‌خواهید به درگاه دیگری مهاجرت کنید.

**دسترسی**: فقط **مدیرکل** (super_admin)

1. به **تنظیمات** (`/admin/settings`) بروید
2. بخش **«درگاه پرداخت فعال»** را پیدا کنید
3. از منوی dropdown درگاه مورد نظر را انتخاب کنید
4. **«ذخیره»** را بزنید

**تاثیر فوری**: پس از ذخیره، تمام پرداخت‌های جدید (هم سفارشات و هم شارژ کیف پول) از درگاه جدید استفاده می‌کنند. پرداخت‌هایی که قبلاً شروع شده‌اند (مشتری در صفحه درگاه است) از درگاه قبلی تکمیل می‌شوند.

### ۱۴.۳ نکات مهم

- **Sandbox زیبال**: اگر درگاه فعال `zibal` باشد و مقدار `ZIBAL_MERCHANT=zibal` در تنظیمات سرور باشد، پرداخت‌ها خودکار موفق هستند (محیط تست)
- **پرداخت‌های قبلی**: تغییر درگاه روی پرداخت‌های قبلی و سفارشات پرداخت‌شده تاثیر ندارد
- **شارژ کیف پول**: شارژ کیف پول هم از درگاه فعال استفاده می‌کند
- **اطلاعات درگاه**: هر پرداخت ثبت می‌کند که از کدام درگاه انجام شده (برای پیگیری آینده)

### ۱۴.۴ عیب‌یابی درگاه

| مشکل | راه‌حل |
|-------|--------|
| خطا در اتصال به درگاه | بررسی کنید env vars مربوط به درگاه (مثلاً `ZIBAL_MERCHANT`) صحیح تنظیم شده باشند |
| مشتری به درگاه هدایت نمی‌شود | بررسی کنید `active_gateway` در تنظیمات مقدار معتبر داشته باشد |
| callback پرداخت کار نمی‌کند | مطمئن شوید `BASE_URL` در تنظیمات سرور صحیح باشد |
| درگاه خاصی کار نمی‌کند | درگاه فعال را موقتاً عوض کنید و مشکل را به تیم فنی گزارش دهید |

---

## 15. سناریو ۱۴: بررسی درخواست‌های نمایندگی (Dealer Requests)

### ۱۵.۱ مشاهده لیست درخواست‌ها

**کی لازم است؟** وقتی مشتریان درخواست نمایندگی ثبت کرده‌اند و باید بررسی شوند.

1. از منو **درخواست‌های نمایندگی** (`/admin/dealer-requests`) را انتخاب کنید
2. کارت‌های آماری بالای صفحه نمایش می‌دهند: تعداد کل، در انتظار، تایید‌شده، رد‌شده، **نیاز به اصلاح**
3. تب‌های فیلتر:
   - **همه**: تمام درخواست‌ها
   - **در انتظار**: نیاز به بررسی اولیه
   - **تایید شده**: قبلاً تایید شده
   - **رد شده**: قبلاً رد شده
   - **نیاز به اصلاح**: منتظر ویرایش و ارسال مجدد توسط مشتری
4. جستجو بر اساس نام، موبایل یا ایمیل امکان‌پذیر است

### ۱۵.۲ تایید درخواست

1. درخواست «در انتظار» مورد نظر را باز کنید
2. اطلاعات مشتری و مدارک پیوست را بررسی کنید
3. دکمه **«تایید»** را بزنید
4. در صورت نیاز یادداشت وارد کنید (اختیاری)
5. وضعیت درخواست به **تایید شده** تغییر می‌کند

### ۱۵.۳ رد درخواست

1. درخواست «در انتظار» مورد نظر را باز کنید
2. دکمه **«رد»** را بزنید
3. یادداشت (دلیل رد) وارد کنید (اختیاری)
4. وضعیت درخواست به **رد شده** تغییر می‌کند

### ۱۵.۴ درخواست اصلاح (Revision)

**کی لازم است؟** وقتی اطلاعات درخواست ناقص یا نادرست است و مشتری باید آن‌ها را اصلاح کند.

1. درخواست «در انتظار» مورد نظر را باز کنید
2. دکمه **«درخواست اصلاح»** را بزنید
3. **یادداشت ادمین** (توضیح اینکه چه چیزی باید اصلاح شود) وارد کنید — این یادداشت به مشتری نمایش داده می‌شود
4. وضعیت درخواست به **نیاز به اصلاح (RevisionNeeded)** تغییر می‌کند
5. مشتری در صفحه وضعیت درخواست خود، یادداشت ادمین و دکمه **«ویرایش و ارسال مجدد»** را می‌بیند
6. پس از ویرایش و ارسال مجدد توسط مشتری، وضعیت به **در انتظار** برمی‌گردد و دوباره در لیست بررسی ظاهر می‌شود

**نکته**: فقط درخواست‌های با وضعیت «در انتظار» قابل ارسال برای اصلاح هستند.

### ۱۵.۵ جریان کامل درخواست نمایندگی

```
مشتری فرم ثبت درخواست نمایندگی را پر می‌کند
    │
    ▼
درخواست با وضعیت «در انتظار» ثبت می‌شود
    │
    ▼
اپراتور/ادمین درخواست را بررسی می‌کند
    │
    ├── تایید → وضعیت: «تایید شده»
    │
    ├── رد → وضعیت: «رد شده»
    │
    └── درخواست اصلاح → وضعیت: «نیاز به اصلاح»
                            │
                            ▼
                      مشتری فرم را ویرایش و ارسال مجدد می‌کند
                            │
                            ▼
                      وضعیت: «در انتظار» (بررسی مجدد)
```

---

## 16. عیب‌یابی

### مشکل: خطای CSRF بعد از مدت طولانی بی‌کاری

**علامت**: پس از باز ماندن طولانی صفحه، هنگام ثبت فرم خطا می‌دهد.

**راه‌حل**: صفحه را رفرش کنید (Ctrl+F5) و دوباره امتحان کنید.

---

### مشکل: قیمت محصول صفر نمایش می‌دهد

**دلایل احتمالی**:
1. قیمت طلا در جدول دارایی (Asset) صفر است
2. وزن یا عیار محصول صفر است

**راه‌حل**:
1. به تنظیمات بروید و قیمت طلا را بررسی کنید — اگر صفر است، دکمه «بروزرسانی دستی» را بزنید
2. محصول را ویرایش کنید و وزن/عیار صحیح وارد کنید

---

### مشکل: خرید/فروش بلاک شده — «قیمت به‌روز نیست»

**دلیل**: قیمت طلا بیش از آستانه انقضا (پیش‌فرض ۱۵ دقیقه) به‌روز نشده است.

**راه‌حل**:
1. به **تنظیمات** بروید و وضعیت نشان تازگی قیمت را بررسی کنید
2. اگر نشان **قرمز** است: دکمه **«بروزرسانی دستی»** را بزنید
3. بررسی کنید سوئیچ **بروزرسانی خودکار** روشن باشد
4. اگر مشکل ادامه دارد: ممکن است سایت goldis.ir در دسترس نباشد — قیمت را دستی وارد کنید

---

### مشکل: مشتری نمی‌تواند وارد صفحه چک‌اوت شود (پروفایل ناقص)

**علامت**: مشتری پس از کلیک روی «تکمیل خرید» به صفحه پروفایل هدایت شده و پیام خطا می‌بیند.

**دلیل**: پروفایل مشتری ناقص است — نوع مشتری (حقیقی/حقوقی)، کد پستی، یا آدرس وارد نشده.

**راه‌حل**:
1. از مشتری بخواهید به صفحه **پروفایل** (`/profile`) برود
2. **نوع مشتری** را انتخاب کند (حقیقی یا حقوقی)
3. فیلدهای الزامی را تکمیل کند:
   - حقیقی: نام کامل، کد ملی، کد پستی، آدرس
   - حقوقی: نام شرکت، شناسه ملی، کد اقتصادی، کد پستی، آدرس
4. پس از ذخیره پروفایل، مجدداً اقدام به خرید کند

---

### مشکل: مشتری نمی‌تواند خرید کند (محصول ناموجود)

**دلیل**: هیچ شمشی با وضعیت «تخصیص» (Assigned) برای آن محصول وجود ندارد.

**راه‌حل**:
1. به بخش شمش‌ها بروید
2. شمش‌های خام را پیدا کنید و محصول مربوطه را به آن‌ها تخصیص دهید

---

### مشکل: نماینده نمی‌تواند وارد شود

**دلایل احتمالی**:
1. حساب نماینده غیرفعال شده
2. شماره موبایل اشتباه ثبت شده

**راه‌حل**:
1. در لیست نمایندگان وضعیت را بررسی کنید
2. در صورت غیرفعال بودن، ویرایش کرده و فعال کنید

---

### مشکل: کوپن کار نمی‌کند

**بررسی‌ها**:
1. آیا کوپن **فعال** (ACTIVE) است؟
2. آیا تاریخ انقضا گذشته؟
3. آیا سقف استفاده پر شده؟
4. آیا حداقل مبلغ سفارش رعایت شده؟
5. آیا کوپن «فقط اولین خرید» است و مشتری خرید قبلی دارد؟
6. آیا کوپن «خصوصی» است و موبایل مشتری در لیست سفید نیست؟
7. آیا کوپن محدود به **دسته‌بندی خاص** است و سبد خرید مشتری محصولی از آن دسته‌بندی‌ها ندارد؟

---

### مشکل: درخواست بازخرید ثبت نمی‌شود

**دلایل احتمالی**:
1. سریال‌کد شمش اشتباه است یا شمش در سیستم وجود ندارد
2. شمش وضعیت «فروخته شده» ندارد (فقط شمش‌های فروخته‌شده قابل بازخرید هستند)

---

### مشکل: مشتری نمی‌تواند مالکیت شمش را ثبت کند (Claim)

**دلایل احتمالی**:
1. سریال‌کد یا کد ثبت مالکیت اشتباه وارد شده
2. شمش قبلاً به مشتری دیگری ثبت شده (دارای customer_id)
3. شمش claim_code ندارد (مثلاً از طریق فروش آنلاین معمولی فروخته شده)

**راه‌حل**:
1. سریال‌کد را در بخش شمش‌ها (`/admin/bars`) جستجو کنید
2. بررسی کنید آیا claim_code وجود دارد و آیا customer_id خالی است
3. اگر شمش قبلاً ثبت شده، به مشتری اطلاع دهید

---

### مشکل: انتقال مالکیت شمش انجام نمی‌شود

**دلایل احتمالی**:
1. شمش به نام مشتری ثبت نیست (customer_id خالی)
2. OTP تایید هویت منقضی شده (مشتری باید مجدداً تلاش کند)
3. شماره موبایل گیرنده اشتباه وارد شده

**راه‌حل**:
1. بررسی کنید شمش واقعاً به نام مشتری درخواست‌کننده ثبت شده باشد
2. از مشتری بخواهید فرآیند را از ابتدا تکرار کند

---

## 17. واژه‌نامه

| اصطلاح | توضیح |
|---------|--------|
| **شمش (Bar)** | قطعه فیزیکی طلا با سریال‌کد یکتا |
| **سریال‌کد** | کد ۸ کاراکتری یکتای هر شمش |
| **عیار (Purity)** | خلوص طلا — ۷۵۰ = ۱۸ عیار |
| **اجرت (Wage)** | هزینه ساخت و طراحی شمش |
| **بچ (Batch)** | گروه شمش‌هایی که در یک ذوب تولید شده‌اند |
| **POS** | فروش حضوری (Point of Sale) توسط نماینده |
| **بازخرید (Buyback)** | خرید شمش از مشتری توسط نماینده |
| **کشبک (Cashback)** | مبلغی که پس از تحویل سفارش به کیف پول مشتری واریز می‌شود |
| **OTP** | رمز یک‌بارمصرف ارسالی از طریق SMS |
| **ریال / تومان** | تمام مبالغ در سیستم ریال هستند، در نمایش تومان (÷۱۰) |
| **CSRF** | مکانیزم امنیتی برای جلوگیری از درخواست‌های جعلی |
| **Sandbox** | محیط تست درگاه پرداخت (پرداخت واقعی نیست) |
| **درگاه فعال (Active Gateway)** | درگاه پرداخت بانکی که در حال حاضر برای تمام پرداخت‌ها استفاده می‌شود — قابل تغییر از تنظیمات |
| **Callback** | آدرسی که درگاه بانکی پس از پرداخت، مشتری را به آن بازمی‌گرداند |
| **لجر (Ledger)** | دفتر حسابداری — هر تغییر موجودی ثبت می‌شود |
| **شبا (IBAN)** | شماره حساب بانکی بین‌المللی (IR + ۲۴ رقم) |
| **تیکت (Ticket)** | درخواست پشتیبانی از طرف مشتری یا نماینده |
| **تخصیص (Assign)** | اختصاص تیکت به یک اپراتور خاص برای پیگیری |
| **دپارتمان تیکت** | دسته‌بندی تیکت بر اساس نوع درخواست (مالی/فنی/فروش/شکایات/سایر) |
| **یادداشت داخلی (Internal Note)** | یادداشتی در تیکت که فقط کارکنان می‌بینند — مشتری و نماینده دسترسی ندارند |
| **پیوست (Attachment)** | فایل تصویری ضمیمه‌شده به پیام تیکت (JPG/PNG/WEBP تا ۱۰MB) |
| **دارایی (Asset)** | رکورد قیمت فلز گرانبها (طلا، نقره) با تنظیمات انقضا و بروزرسانی خودکار |
| **انقضای قیمت (Staleness)** | وضعیتی که قیمت بیش از آستانه تعیین‌شده به‌روز نشده — خرید/فروش بلاک می‌شود |
| **صفحه ثابت (Static Page)** | صفحه اطلاع‌رسانی با محتوای ثابت (درباره ما، سوالات متداول، تماس با ما، قوانین) — بدون نیاز به لاگین |
| **فوتر (Footer)** | بخش پایین تمام صفحات سایت شامل اطلاعات شرکت، لینک‌های سریع و نشان‌های اعتماد |
| **کلید API** | کلید احراز هویت ۶۴ کاراکتری برای دستگاه POS |
| **مشتری حقیقی** | شخص حقیقی — شناسایی با نام کامل و کد ملی ۱۰ رقمی |
| **مشتری حقوقی** | شرکت یا موسسه — شناسایی با نام شرکت، شناسه ملی و کد اقتصادی |
| **صورتحساب (Billing Info)** | اطلاعات حقوقی مشتری (نوع، نام، کد ملی، آدرس، کد پستی) که در فاکتور سفارش ذخیره و نمایش داده می‌شود |
| **اعتبار فروشگاهی (Store Credit)** | مبلغی غیرقابل برداشت که به کیف پول مشتری واریز می‌شود — فقط برای خرید قابل استفاده است |
| **بازگشت اجرت (Wage Refund)** | بازگشت مبلغ اجرت ساخت شمش به مشتری هنگام تایید بازخرید — به‌صورت اعتبار فروشگاهی واریز می‌شود |
| **کد ثبت مالکیت (Claim Code)** | کد ۶ کاراکتری یکتا که هنگام فروش حضوری (POS) یا خرید هدیه تولید می‌شود — خریدار با این کد مالکیت شمش را در سایت ثبت می‌کند |
| **خرید هدیه (Gift Purchase)** | سفارشی که مشتری به‌عنوان هدیه ثبت می‌کند — شمش به نام خریدار ثبت نمی‌شود و کد ثبت مالکیت تولید می‌شود |
| **ثبت مالکیت (Claim)** | فرآیندی که مشتری با سریال‌کد و کد ثبت مالکیت، شمش را به نام خود ثبت می‌کند |
| **انتقال مالکیت (Transfer)** | فرآیندی که مالک شمش آن را به شخص دیگری منتقل می‌کند — نیاز به تایید OTP فرستنده دارد |
| **شمش‌های من (My Bars)** | صفحه‌ای در پنل مشتری که تمام شمش‌های متعلق به مشتری را نمایش می‌دهد |
| **بسته‌بندی (Package)** | نوع بسته‌بندی شمش — مشتری هنگام خرید انتخاب می‌کند (اختیاری) |
| **گزارش فروش نمایندگان** | صفحه ادمین برای مشاهده تمام فروش‌های حضوری (POS) با آمار تجمیعی، فیلتر و جزئیات هر فروش |
| **تخفیف اجرت (Wage Discount)** | درصدی از سهم اجرت نماینده که به مشتری تخفیف داده می‌شود — از سود نماینده کسر می‌شود |
| **سود طلایی (Gold Profit)** | سود نماینده از فروش حضوری بر حسب میلی‌گرم طلا — حاصل اختلاف اجرت نماینده و اجرت مشتری نهایی |
| **درخواست نمایندگی (Dealer Request)** | درخواستی که مشتری برای تبدیل شدن به نماینده فروش ثبت می‌کند — ادمین آن را تایید، رد، یا درخواست اصلاح می‌کند |
| **درخواست اصلاح (Revision)** | وضعیتی که ادمین از مشتری می‌خواهد اطلاعات درخواست نمایندگی را اصلاح و مجدد ارسال کند |

---

## 8. سناریو ۷: لاگ درخواست‌ها (Audit Log)

### ۸.۱ مشاهده لاگ‌ها

تمام درخواست‌های HTTP ورودی به سیستم (بجز فایل‌های استاتیک) به‌صورت خودکار لاگ می‌شوند.

1. از منو **لاگ درخواست‌ها** را انتخاب کنید (`/admin/logs`)
2. اطلاعات هر لاگ:
   - **متد**: GET, POST, PUT, DELETE (badge رنگی)
   - **مسیر**: آدرس درخواست
   - **وضعیت**: کد HTTP پاسخ (2xx/3xx/4xx/5xx)
   - **کاربر**: نوع (مدیر/مشتری/نماینده/ناشناس) + موبایل
   - **IP**: آدرس IP درخواست‌دهنده
   - **زمان پاسخ**: مدت پردازش (میلی‌ثانیه)
   - **بدنه**: برای POST ها، بدنه فرم (با mask اطلاعات حساس)

### ۸.۲ فیلتر لاگ‌ها

فیلترهای موجود:
- **متد**: فیلتر بر اساس GET/POST/PUT/DELETE
- **وضعیت**: 2xx (موفق), 3xx (ریدایرکت), 4xx (خطای کاربر), 5xx (خطای سرور)
- **نوع کاربر**: مدیر / اپراتور / مشتری / نماینده / ناشناس
- **مسیر**: جستجو در آدرس (مثال: `/admin/orders`)
- **IP**: فیلتر بر اساس آدرس IP

### ۸.۳ نکات امنیتی

- اطلاعات حساس (رمز، OTP، CSRF، API Key) در بدنه با `***` جایگزین می‌شوند
- لاگ‌های قدیمی‌تر از ۳۰ روز به‌صورت خودکار حذف می‌شوند
- فایل‌های استاتیک و Health check لاگ نمی‌شوند

---

> این راهنما بر اساس قابلیت‌های فعلی سیستم TalaMala v4 (فازهای ۱-۱۴ + صفحات ثابت و فوتر + ثبت مالکیت و انتقال شمش + ادغام Location در Dealer + لاگ درخواست‌ها + مدیریت کاربران + ویرایش مشتری توسط ادمین + گزارش فروش نمایندگان POS) نوشته شده است.
