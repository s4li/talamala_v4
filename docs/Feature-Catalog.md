# کاتالوگ قابلیت‌های سیستم طلاملا v4

> این سند تمام ماژول‌ها، قابلیت‌ها، نقش‌های کاربری و فرمول قیمت‌گذاری سیستم TalaMala v4 را شرح می‌دهد.
> آخرین به‌روزرسانی: فازهای ۱ تا ۱۴، ۲۱ و ۲۲ تکمیل‌شده + قابلیت بازگشت اجرت بازخرید + بهبود سیستم تیکتینگ + صفحات ثابت و فوتر (Static Pages & Footer) + ثبت مالکیت و انتقال شمش (Bar Claim & Gifting + Ownership Transfer) + ساده‌سازی فرمول قیمت‌گذاری + مدیریت کاربران (Customer Management) + اطلاعات خریدار در فاکتور + الزام تکمیل پروفایل + انتخاب بسته‌بندی مشتری + گزارش فروش نمایندگان (Admin POS Sales Report) + سیستم مدیریت دارایی و قیمت‌گذاری خودکار (Asset Price Management + Goldis Auto-fetch) + چند درگاه پرداخت (Multi-Gateway: Zibal/Sepehr/Top/Parsian) + درخواست نمایندگی با بازبینی (Dealer Request with Revision) + پیگیری تحویل فیزیکی شمش و طلای امانی (Bar-level Delivery Tracking & Custodial Gold) + ماژول نظرات و پرسش‌وپاسخ (Review & Comments) + API دستگاه POS مشتری‌محور (Customer-Facing POS API) + یکپارچه‌سازی دستگاه POS راسیس (Rasis POS Integration) + زیرنمایندگان و سفارش عمده B2B (Sub-Dealers & B2B Orders — Phase 21) + انبارگردانی پیشرفته و رهگیری فیزیکی (Advanced Inventory & Physical Tracking — Phase 22) + سیستم دسترسی سلسله‌مراتبی اپراتورها (Hierarchical Permission System + Staff Management) + سطح‌بندی فعال/غیرفعال خرید و فروش (Trade Guard) + تولید QR Code برای شمش‌ها (QR Code Generation for Bars).

---

## فهرست مطالب

1. [معرفی سیستم](#1-معرفی-سیستم)
2. [نقش‌ها و دسترسی‌ها](#2-نقشها-و-دسترسیها)
3. [ماژول احراز هویت (Auth)](#3-ماژول-احراز-هویت)
4. [ماژول کاتالوگ (Catalog)](#4-ماژول-کاتالوگ)
5. [ماژول انبارداری (Inventory)](#5-ماژول-انبارداری)
6. [ماژول فروشگاه (Shop)](#6-ماژول-فروشگاه)
7. [ماژول سبد خرید و سفارش (Cart & Order)](#7-ماژول-سبد-خرید-و-سفارش)
8. [ماژول پرداخت (Payment)](#8-ماژول-پرداخت)
9. [ماژول کیف پول (Wallet)](#9-ماژول-کیف-پول)
10. [ماژول کوپن (Coupon)](#10-ماژول-کوپن)
11. [ماژول نماینده (Dealer)](#11-ماژول-نماینده)
12. [ماژول احراز اصالت (Verification)](#12-ماژول-احراز-اصالت)
13. [ماژول مشتری (Customer)](#13-ماژول-مشتری)
14. [ماژول مدیریت (Admin)](#14-ماژول-مدیریت)
15. [ماژول تیکتینگ / پشتیبانی (Ticket)](#15-ماژول-تیکتینگ--پشتیبانی)
16. [API نماینده (Dealer POS API)](#16-api-نماینده-dealer-pos-api)
17. [بازگشت اجرت بازخرید (Buyback Wage Refund)](#17-بازگشت-اجرت-بازخرید-buyback-wage-refund)
18. [فرمول قیمت‌گذاری طلا](#18-فرمول-قیمتگذاری-طلا)
19. [جدول جامع دسترسی نقش‌ها](#19-جدول-جامع-دسترسی-نقشها)
20. [صفحات ثابت و فوتر (Static Pages & Footer)](#20-صفحات-ثابت-و-فوتر-static-pages--footer)
21. [ثبت مالکیت و انتقال شمش (Bar Claim & Ownership Transfer)](#21-ثبت-مالکیت-و-انتقال-شمش-bar-claim--ownership-transfer)
22. [مدیریت کاربران (Customer Management)](#22-مدیریت-کاربران-customer-management)
23. [مدیریت دارایی و قیمت‌گذاری خودکار (Asset Price Management)](#23-مدیریت-دارایی-و-قیمتگذاری-خودکار-asset-price-management)
24. [چند درگاه پرداخت (Multi-Gateway Payment)](#24-چند-درگاه-پرداخت-multi-gateway-payment)
25. [درخواست نمایندگی (Dealer Request)](#25-درخواست-نمایندگی-dealer-request)
26. [ماژول نظرات و پرسش‌وپاسخ (Review & Comments)](#26-ماژول-نظرات-و-پرسشوپاسخ-review--comments)
27. [API دستگاه POS مشتری‌محور (Customer-Facing POS API)](#27-api-دستگاه-pos-مشتریمحور-customer-facing-pos-api)
28. [یکپارچه‌سازی دستگاه POS راسیس (Rasis POS Integration)](#28-یکپارچهسازی-دستگاه-pos-راسیس-rasis-pos-integration)
29. [پنل پیشرفته نماینده — زیرنمایندگان و سفارش عمده (Dealer Portal Enhancement — Phase 21)](#29-پنل-پیشرفته-نماینده--زیرنمایندگان-و-سفارش-عمده-dealer-portal-enhancement--phase-21)
30. [انبارگردانی پیشرفته و رهگیری فیزیکی (Advanced Inventory & Physical Tracking — Phase 22)](#30-انبارگردانی-پیشرفته-و-رهگیری-فیزیکی-advanced-inventory--physical-tracking--phase-22)
31. [سطح‌بندی فعال/غیرفعال خرید و فروش — Trade Guard](#31-سطحبندی-فعالغیرفعال-خرید-و-فروش--trade-guard)
32. [تولید QR Code برای شمش‌ها (QR Code Generation for Bars)](#32-تولید-qr-code-برای-شمشها-qr-code-generation-for-bars)

---

## 1. معرفی سیستم

**طلاملا v4** یک سیستم ERP فروش شمش فلزات گرانبها (طلا و نقره) است که شامل:

- **فروشگاه آنلاین**: مشتریان می‌توانند شمش طلا و نقره بخرند
- **پنل مدیریت**: ادمین و اپراتور سیستم را مدیریت می‌کنند
- **پنل نماینده**: نمایندگان فروش حضوری (POS) و بازخرید انجام می‌دهند
- **احراز اصالت**: هر شمش با سریال‌کد قابل بررسی است

### استک فنی
| بخش | فناوری |
|------|--------|
| Backend | FastAPI (Python) |
| Templates | Jinja2 |
| Database | PostgreSQL + SQLAlchemy ORM |
| Migration | Alembic |
| UI | Bootstrap 5 RTL + Vazirmatn Font |
| آیکون‌ها | Bootstrap Icons |
| درگاه پرداخت | زیبال (Zibal)، سپهر (Sepehr)، تاپ (Top)، پارسیان (Parsian) |
| SMS | کاوه‌نگار (Kavenegar) |

### واحد پولی
- تمام مبالغ در دیتابیس به **ریال** ذخیره می‌شوند
- در رابط کاربری به **تومان** نمایش داده می‌شوند (تقسیم بر ۱۰)

---

## 2. نقش‌ها و دسترسی‌ها

سیستم ۴ نقش اصلی دارد:

| نقش | مدل | نحوه لاگین | کوکی JWT | دسترسی |
|------|------|------------|----------|--------|
| **Super Admin** | User (is_admin=True, role=super_admin) | OTP موبایل | `auth_token` | دسترسی کامل به پنل مدیریت |
| **Operator** | User (is_admin=True, role=operator) | OTP موبایل | `auth_token` | دسترسی عملیاتی (بدون تنظیمات سیستمی) |
| **Dealer** | User (is_dealer=True) | OTP موبایل | `auth_token` | پنل نماینده (POS + بازخرید) |
| **Customer** | User (هر کاربر احراز هویت‌شده) | OTP موبایل | `auth_token` | فروشگاه + سبد خرید + کیف پول |

> **نکته معماری**: سیستم از یک جدول یکپارچه `users` با پرچم‌های نقش (`is_dealer`, `is_admin`) استفاده می‌کند. هر کاربر به‌صورت ضمنی مشتری است. تمام نقش‌ها با یک کوکی JWT واحد (`auth_token`) احراز هویت می‌شوند. یک کاربر می‌تواند همزمان دیلر و/یا ادمین باشد.

### تفاوت Super Admin و Operator
- **Super Admin** (`admin_role=="admin"`): دسترسی کامل — تمام بخش‌ها بدون محدودیت. بررسی دسترسی (permission check) را به‌طور کامل دور می‌زند (bypass).
- **Operator** (`admin_role=="operator"`): دسترسی محدود و قابل‌تنظیم — فقط بخش‌هایی که توسط Super Admin تعیین شده، با سطح مشخص‌شده.

### سیستم دسترسی سلسله‌مراتبی اپراتورها (Hierarchical Permission System)

**مسیر فایل‌ها**: `modules/admin/permissions.py`, `modules/user/models.py`, `modules/auth/deps.py`

سیستم دسترسی اپراتورها از مدل باینری (دارد/ندارد) به مدل **سلسله‌مراتبی ۴ سطحی** ارتقا یافته است. هر اپراتور برای هر بخش مدیریتی یک **سطح دسترسی** دریافت می‌کند.

#### سطوح دسترسی (Permission Levels)

سطوح **سلسله‌مراتبی** هستند — هر سطح شامل تمام سطوح پایین‌تر می‌شود:

| سطح | فارسی | شامل | توضیح |
|------|--------|-------|--------|
| `view` | نمایش | — | فقط مسیرهای GET (لیست، جزئیات) |
| `create` | ایجاد | view | + مسیرهای POST ایجاد موجودیت جدید |
| `edit` | ویرایش | view + create | + مسیرهای POST ویرایش موجودیت‌های موجود |
| `full` | کامل | view + create + edit | + حذف + تایید/رد + عملیات حساس |

#### فرمت ذخیره‌سازی (Storage Format)

دسترسی‌ها در فیلد `operator_permissions` (ستون `permissions` در جدول `users`) به صورت **JSON dict** ذخیره می‌شوند:

```json
// قدیمی (لیست — دیگر استفاده نمی‌شود):
["products", "batches"]

// جدید (دیکشنری — کلید: بخش، مقدار: سطح):
{"products": "edit", "batches": "view", "orders": "full", "customers": "create"}
```

#### رجیستری بخش‌ها (Permission Registry)

۱۳ کلید دسترسی تعریف شده در `PERMISSION_REGISTRY`:

| کلید | فارسی | توضیح |
|------|--------|--------|
| `dashboard` | داشبورد | صفحه اصلی مدیریت |
| `products` | محصولات و کاتالوگ | محصولات، دسته‌بندی‌ها، طرح کارت، بسته‌بندی |
| `batches` | بچ / ذوب | مدیریت بچ‌های تولید |
| `inventory` | شمش‌ها (موجودی) | مدیریت شمش‌ها و انبار |
| `orders` | سفارشات | مدیریت سفارشات مشتریان |
| `customers` | مدیریت کاربران | لیست کاربران، جزئیات، ویرایش |
| `wallets` | کیف پول‌ها و برداشت | حساب‌ها و درخواست‌های برداشت |
| `coupons` | کوپن‌ها | مدیریت کوپن‌های تخفیف |
| `dealers` | نمایندگان | مدیریت نمایندگان و زیرنمایندگان |
| `tickets` | تیکت‌های پشتیبانی | مدیریت تیکت‌ها |
| `logs` | لاگ درخواست‌ها | لاگ‌های ثبت‌شده سیستم |
| `settings` | تنظیمات سیستم | قیمت دارایی، مالیات، ارسال |
| `staff` | مدیریت ادمین‌ها | ایجاد/ویرایش اپراتورها و دسترسی‌ها |

#### محافظت مسیرها (Route Protection)

در route های ادمین از `require_permission("key", level="xxx")` استفاده می‌شود:

```python
from modules.auth.deps import require_permission

# GET route — سطح پیش‌فرض view
@router.get("/admin/products")
async def list_products(user=Depends(require_permission("products"))):
    ...

# POST route ایجاد — سطح create
@router.post("/admin/products/create")
async def create_product(user=Depends(require_permission("products", level="create"))):
    ...

# POST route ویرایش — سطح edit
@router.post("/admin/products/{id}/edit")
async def edit_product(user=Depends(require_permission("products", level="edit"))):
    ...

# POST route حذف — سطح full
@router.post("/admin/products/{id}/delete")
async def delete_product(user=Depends(require_permission("products", level="full"))):
    ...
```

- اگر اپراتور سطح مورد نیاز را نداشته باشد، خطای **403 Forbidden** با پیام فارسی نمایش داده می‌شود: `شما دسترسی «ویرایش» به بخش «محصولات و کاتالوگ» ندارید`
- **Super Admin** (`admin_role=="admin"`) همیشه از بررسی دسترسی عبور می‌کند (bypass کامل)
- پشتیبانی از چند کلید همزمان: `require_permission("orders", "wallets", level="view")`

#### پنهان‌سازی عناصر UI در قالب‌ها (Template UI Hiding)

دکمه‌های عملیاتی (ایجاد، ویرایش، حذف، تایید/رد) بر اساس سطح دسترسی اپراتور نمایش/مخفی می‌شوند:

```jinja2
{# نمایش دکمه ایجاد فقط با سطح create یا بالاتر #}
{% if user.has_permission("products", "create") %}
    <a href="/admin/products/create" class="btn btn-success">ایجاد محصول</a>
{% endif %}

{# نمایش دکمه حذف فقط با سطح full #}
{% if user.has_permission("products", "full") %}
    <button class="btn btn-danger">حذف</button>
{% endif %}

{# نمایش آیتم منو فقط اگر هر سطحی وجود داشته باشد (پیش‌فرض: view) #}
{% if user.has_permission("orders") %}
    <a href="/admin/orders">سفارشات</a>
{% endif %}
```

- متد `user.has_permission(key, level)` روی مدل `User` تعریف شده
- پارامتر `level` اختیاری و پیش‌فرض `"view"` است
- سایدبار ادمین (`base_admin.html`) آیتم‌های منو را بر اساس دسترسی اپراتور فیلتر می‌کند

---

## 3. ماژول احراز هویت

**مسیر فایل‌ها**: `modules/auth/`

### قابلیت‌ها
- ورود با رمز یک‌بارمصرف (OTP) از طریق SMS
- شناسایی خودکار نقش کاربر (ادمین/نماینده/مشتری) بر اساس شماره موبایل
- ایجاد خودکار حساب مشتری در اولین ورود
- خروج (logout) با حذف کوکی مربوطه

### جریان لاگین
1. کاربر شماره موبایل وارد می‌کند → `POST /auth/send-otp`
2. سیستم OTP ارسال می‌کند (در محیط توسعه: کد ثابت `111111`)
3. کاربر OTP وارد می‌کند → `POST /auth/verify-otp`
4. سیستم نقش را تشخیص داده و ریدایرکت می‌کند:
   - ادمین/اپراتور → `/admin/dashboard`
   - نماینده → `/dealer/dashboard`
   - مشتری → `/` (صفحه اصلی فروشگاه)

### آدرس‌ها
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/auth/login` | صفحه ورود |
| POST | `/auth/send-otp` | ارسال OTP |
| POST | `/auth/verify-otp` | تایید OTP |
| GET | `/auth/logout` | خروج |

---

## 4. ماژول کاتالوگ

**مسیر فایل‌ها**: `modules/catalog/`

### مدل‌ها

#### ProductCategory (دسته‌بندی محصول)
- نام، slug (برای URL)، ترتیب نمایش، وضعیت فعال/غیرفعال
- Relationship `product_links`: لینک به ProductCategoryLink (رابطه M2M با Product)

#### Product (محصول = شمش فلز گرانبها)
- نام، وزن (گرم)، عیار (750=18K برای طلا، 999 برای نقره)
- **نوع فلز** (`metal_type`): String — `"gold"` یا `"silver"` — مشخص می‌کند قیمت‌گذاری بر اساس کدام فلز انجام شود. مقدار `metal_type` به دیکشنری `PRECIOUS_METALS` در `pricing/calculator.py` مپ می‌شود که `base_purity` هر فلز را تعیین می‌کند (طلا: 750، نقره: 999)
- **دسته‌بندی‌ها**: رابطه Many-to-Many با ProductCategory از طریق جدول واسط `ProductCategoryLink` — هر محصول می‌تواند در **چند دسته‌بندی** قرار بگیرد
- اجرت ساخت (درصدی)
- تصاویر محصول (ProductImage)
- Property `categories`: لیست اشیاء ProductCategory مرتبط
- Property `category_ids`: لیست شناسه‌های دسته‌بندی‌ها (List[int])

#### ProductCategoryLink (رابطه محصول-دسته‌بندی)
- جدول واسط (junction table) برای رابطه Many-to-Many بین Product و ProductCategory
- `product_id` (FK → products): شناسه محصول
- `category_id` (FK → product_categories): شناسه دسته‌بندی
- UniqueConstraint روی (product_id, category_id)

#### CardDesign (طرح کارت هدیه)
- طرح‌های مختلف کارت برای بسته‌بندی شمش
- تصاویر طرح (CardDesignImage)

#### PackageType (نوع بسته‌بندی)
- انواع بسته‌بندی شمش (با قیمت‌گذاری)
- **فیلدهای جدید**: `price` (قیمت به ریال، پیش‌فرض ۰ = رایگان)، `is_active` (وضعیت فعال/غیرفعال)
- تصاویر بسته‌بندی (PackageTypeImage)
- مشتری هنگام خرید می‌تواند بسته‌بندی انتخاب کند — قیمت بسته‌بندی به فاکتور اضافه می‌شود

#### Batch (بچ تولید / ذوب)
- شناسه بچ، توضیحات
- تصاویر بچ (BatchImage)

### آدرس‌های ادمین
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/admin/products` | لیست محصولات |
| GET/POST | `/admin/products/create` | ایجاد محصول |
| GET/POST | `/admin/products/{id}/edit` | ویرایش محصول |
| GET | `/admin/categories` | لیست دسته‌بندی‌ها |
| GET/POST | `/admin/categories/create` | ایجاد دسته‌بندی |
| GET | `/admin/designs` | لیست طرح‌های کارت |
| GET | `/admin/packages` | لیست بسته‌بندی‌ها |
| GET | `/admin/batches` | لیست بچ‌ها |

---

## 5. ماژول انبارداری

**مسیر فایل‌ها**: `modules/inventory/`

### مدل‌ها

#### Bar (شمش طلا)
- سریال‌کد یکتا (۸ کاراکتری)
- **کد ثبت مالکیت** (`claim_code`): کد ۶ کاراکتری یکتا (حروف بزرگ + ارقام بدون ابهام: `ABCDEFGHJKMNPQRSTUVWXYZ23456789`) — هنگام فروش حضوری (POS) یا خرید هدیه (gift) تولید می‌شود
- **تاریخ تحویل فیزیکی** (`delivered_at`): DateTime nullable — زمان تحویل فیزیکی شمش به مشتری
  - `NULL` = شمش هنوز تحویل فیزیکی نشده (**طلای امانی** / custodial gold)
  - مقداردهی‌شده = شمش تحویل داده شده
  - فروش حضوری (POS): بلافاصله مقداردهی می‌شود (تحویل در محل)
  - سفارش آنلاین: هنگام تایید تحویل توسط ادمین (حضوری یا پستی) مقداردهی می‌شود
  - انتقال مالکیت (`Ownership Transfer`): تاثیری بر `delivered_at` ندارد — شمش تا تحویل فیزیکی، امانی باقی می‌ماند
- وضعیت‌ها:
  - **Raw** (خام): فقط سریال دارد، هنوز به محصولی تخصیص نیافته
  - **Assigned** (تخصیص): به محصول وصل شده، آماده فروش
  - **Reserved** (رزرو): در سبد خرید مشتری قرار دارد
  - **Sold** (فروخته شده): فروش نهایی شده
- ارتباطات: محصول، مالک (user_id FK → users)، بچ، طرح کارت، بسته‌بندی، نمایندگی (dealer_id FK → users where is_dealer=True)
- تصاویر شمش (BarImage)

#### طلای امانی (Custodial Gold)
- تعریف: شمشی که فروخته شده (`status=SOLD`) اما هنوز تحویل فیزیکی نشده (`delivered_at IS NULL`)
- محاسبه بر اساس **شمش** (Bar-level) — نه بر اساس سفارش
- انتقال مالکیت تاثیری ندارد: اگر مشتری A شمش را به مشتری B منتقل کند، شمش همچنان امانی باقی می‌ماند تا تحویل فیزیکی انجام شود

#### OwnershipHistory (تاریخچه مالکیت)
- ثبت هر تغییر مالکیت شمش

#### DealerTransfer (تاریخچه جابه‌جایی)
- ثبت هر انتقال شمش بین نمایندگان (from_dealer_id, to_dealer_id — هر دو FK → users)

### آدرس‌های ادمین
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/admin/bars` | لیست شمش‌ها (فیلتر وضعیت، نمایندگی، جستجو سریال) |
| GET/POST | `/admin/bars/{id}/edit` | ویرایش شمش (نمایندگی بجای مکان) + نمایش/دانلود QR Code |
| GET | `/admin/bars/{id}/qr` | دانلود QR Code با کیفیت بالا (PNG) |
| POST | `/admin/bars/{id}/qr/regenerate` | بازتولید QR Code |

---

## 6. ماژول فروشگاه

**مسیر فایل‌ها**: `modules/shop/`

### قابلیت‌ها
- نمایش لیست محصولات با قیمت محاسبه‌شده لحظه‌ای
- فیلتر بر اساس دسته‌بندی (M2M — محصولات چنددسته‌بندی‌ای در نتایج همه دسته‌بندی‌های مرتبط نمایش داده می‌شوند)
- مرتب‌سازی (جدیدترین، ارزان‌ترین، گران‌ترین)
- صفحه جزئیات محصول با ریز قیمت
- انتخاب بسته‌بندی در صفحه جزئیات محصول (رادیو باتن با نام و قیمت)

### نمایش قیمت
قیمت هر محصول **لحظه‌ای** محاسبه می‌شود بر اساس:
- قیمت فلز پایه بر اساس `metal_type` محصول: طلا از `gold_18k` و نقره از `silver` در جدول Asset
- تابع کمکی `get_product_pricing(product, db)` در `pricing/service.py` قیمت و عیار پایه (`base_purity`) مناسب هر محصول را بازمی‌گرداند
- وزن و عیار محصول
- اجرت + مالیات (مالیات فقط روی اجرت)
- سبد خرید مختلط (طلا + نقره): هر آیتم با قیمت فلز خودش قیمت‌گذاری می‌شود

### آدرس‌ها
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/` | صفحه اصلی فروشگاه (لیست محصولات) |
| GET | `/product/{id}` | جزئیات محصول |

---

## 7. ماژول سبد خرید و سفارش

**مسیر فایل‌ها**: `modules/cart/` و `modules/order/`

### سبد خرید
- افزودن محصول به سبد
- تغییر تعداد / حذف آیتم
- نمایش قیمت لحظه‌ای
- انتخاب / تغییر بسته‌بندی هر آیتم (dropdown)
- قیمت بسته‌بندی در مبلغ خط سفارش لحاظ می‌شود

### فرآیند ثبت سفارش (Checkout)
1. مشتری سبد خرید را بررسی می‌کند
2. روش تحویل انتخاب می‌شود:
   - **حضوری (Pickup)**: انتخاب نمایندگی از لیست
   - **پستی (Postal)**: وارد کردن آدرس ارسال
3. **خرید هدیه** (اختیاری): تیک «خرید به‌عنوان هدیه» — شمش به نام خریدار ثبت نمی‌شود و `claim_code` تولید می‌شود تا گیرنده هدیه بتواند مالکیت را ثبت کند
4. کوپن تخفیف (اختیاری)
5. ثبت سفارش → رزرو شمش‌ها

### وضعیت‌های سفارش
| وضعیت | توضیح |
|--------|--------|
| Pending | در انتظار پرداخت |
| Paid | پرداخت شده |
| Shipped | ارسال شده |
| Delivered | تحویل داده شده |
| Cancelled | لغو شده |

### دلیل لغو سفارش
هر سفارش لغو‌شده دارای فیلد `cancellation_reason` و `cancelled_at` است:
| سناریو | دلیل ثبت‌شده |
|---------|-------------|
| لغو توسط مشتری | لغو توسط مشتری |
| لغو توسط مدیر | لغو توسط مدیر سیستم |
| انقضای زمان رزرو | عدم پرداخت در مهلت مقرر (X دقیقه) |
| استرداد (Refund) | استرداد وجه توسط مدیر — [یادداشت] |

دلیل لغو در صفحه جزئیات سفارش به مشتری نمایش داده می‌شود.

### مدل‌های سفارش

#### Order (سفارش)
- شناسه یکتا
- شناسه کاربر (user_id FK → users)
- وضعیت سفارش (Pending/Paid/Shipped/Delivered/Cancelled)
- دلیل و زمان لغو (اگر لغو شده باشد)
- روش تحویل (Pickup/Postal)
- نمایندگی (برای تحویل حضوری)
- آدرس ارسال (برای تحویل پستی)
- خرید هدیه (is_gift: boolean)
- کوپن و تخفیف‌های اعمال‌شده
- کل سفارش، هزینه ارسال، بیمه
- اطلاعات پرداخت (روش، مرجع، تاریخ)
- وضعیت تحویل (delivery_status)
- تاریخ ایجاد / تاریخ پرداخت / تاریخ تحویل

#### OrderItem (ردیف سفارش)
- شناسه یکتا
- شناسه سفارش (FK → orders)
- شناسه محصول
- شناسه شمش (FK → bars)
- مقادیر لحظه‌ای بر اساس قیمت در زمان ثبت سفارش:
  - `applied_metal_price`: قیمت فلز پایه در لحظه ثبت (ریال) — بر اساس نوع فلز محصول (طلا یا نقره)
  - وزن شمش
  - عیار
  - درصد اجرت
  - درصد مالیات
  - مبلغ طلای خالص
  - مبلغ اجرت
  - مبلغ مالیات
- بسته‌بندی انتخاب‌شده (FK → package_types)
- قیمت بسته‌بندی
- مبلغ خط (= طلا + اجرت + مالیات + بسته‌بندی)

#### OrderStatusLog (تاریخچه تغییر وضعیت) — مدل جدید
- شناسه یکتا (id)
- شناسه سفارش (order_id، FK → orders)
- نام فیلد تغییریافته (field): مثلاً "status"، "delivery_status"، "cancellation_reason"
- مقدار قدیمی (old_value): مقدار قبلی فیلد
- مقدار جدید (new_value): مقدار جدید فیلد
- شناسه کاربر تغییر‌دهنده (changed_by): نام یا شناسه کاربری که تغییر را انجام داده (مثلاً نام ادمین یا سیستم)
- توضیح (description): علت یا توضیح تغییر (اختیاری)
- زمان تغییر (created_at): timestamp زمان ثبت تغییر
- این مدل یک **audit trail** (سند حسابی) برای تمام تغییرات وضعیت و تحویل سفارش است

### نمایش تاریخچه وضعیت در صفحه سفارش
در صفحه جزئیات سفارش (مشتری و ادمین)، یک **timeline** نمایش داده می‌شود که تمام تغییرات وضعیت را از کوچک‌ترین به بزرگ‌ترین تاریخ نشان می‌دهد:
- هر ردیف: `[تاریخ و ساعت] [فیلد تغییریافته]: [مقدار قدیمی] → [مقدار جدید]` `(توسط: [نام کاربر])`

### آدرس‌ها (مشتری)
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/cart` | مشاهده سبد خرید |
| POST | `/cart/add` | افزودن به سبد |
| POST | `/cart/update/{pid}` | تغییر تعداد |
| POST | `/cart/remove/{pid}` | حذف از سبد |
| GET | `/checkout` | صفحه ثبت سفارش |
| POST | `/cart/set-package` | تغییر بسته‌بندی آیتم سبد خرید |
| POST | `/cart/checkout` | ثبت نهایی سفارش |
| GET | `/orders` | لیست سفارشات من |
| GET | `/orders/{id}` | جزئیات سفارش |

### آدرس‌های ادمین
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/admin/orders` | لیست سفارشات (فیلتر وضعیت) |

---

## 8. ماژول پرداخت

**مسیر فایل‌ها**: `modules/payment/` + `modules/payment/gateways/`

### روش‌های پرداخت
1. **کیف پول**: از موجودی کیف پول کسر می‌شود
2. **درگاه بانکی**: پرداخت آنلاین از طریق درگاه فعال (Zibal / Sepehr / Top / Parsian)

### معماری چند درگاه (Multi-Gateway)
- **لایه انتزاعی**: `BaseGateway` کلاس پایه با متدهای `request_payment()` و `verify_payment()`
- **الگوی Registry**: `GATEWAY_REGISTRY` در `gateways/__init__.py` — درگاه‌ها با نام ثبت می‌شوند
- **انتخاب درگاه**: SystemSetting `active_gateway` تعیین می‌کند کدام درگاه فعال باشد
- **توابع عمومی**: `create_gateway_payment()` و `verify_gateway_callback()` در service — مستقل از درگاه
- هر درگاه callback مجزا (GET یا POST بسته به پروتکل درگاه) دارد

### درگاه‌های پشتیبانی‌شده
| درگاه | پروتکل | env vars | sandbox |
|--------|---------|----------|---------|
| **Zibal** | REST | `ZIBAL_MERCHANT` | `ZIBAL_MERCHANT=zibal` → auto-succeed |
| **Sepehr** | REST | `SEPEHR_TERMINAL_ID` | `SEPEHR_TERMINAL_ID=99079327` |
| **Top** | REST | `TOP_USERNAME`, `TOP_PASSWORD` | — |
| **Parsian** | SOAP (zeep) | `PARSIAN_PIN` | — |

### جریان پرداخت کیف پول
1. مشتری «پرداخت با کیف پول» را انتخاب می‌کند
2. سیستم بررسی می‌کند موجودی کافی باشد
3. مبلغ از کیف پول کسر + سفارش تایید می‌شود (تراکنش اتمیک)
4. شمش‌ها به مالکیت مشتری در می‌آید

### جریان پرداخت درگاه بانکی
1. مشتری «پرداخت آنلاین» را انتخاب می‌کند
2. سیستم بر اساس `active_gateway` درگاه فعال را شناسایی و درخواست پرداخت ارسال می‌کند
3. مشتری به درگاه بانک هدایت می‌شود
4. پس از پرداخت، callback مربوط به آن درگاه فراخوانی شده و سفارش تایید می‌شود

### آدرس‌ها
| متد | مسیر | توضیح |
|------|------|--------|
| POST | `/payment/{id}/wallet` | پرداخت با کیف پول |
| POST | `/payment/{order_id}/gateway` | پرداخت با درگاه فعال (عمومی) |
| GET | `/payment/zibal/callback` | بازگشت از درگاه زیبال |
| POST | `/payment/sepehr/callback` | بازگشت از درگاه سپهر |
| GET | `/payment/top/callback` | بازگشت از درگاه تاپ |
| POST | `/payment/parsian/callback` | بازگشت از درگاه پارسیان |
| POST | `/payment/{id}/refund` | استرداد (فقط ادمین) |

---

## 9. ماژول کیف پول

**مسیر فایل‌ها**: `modules/wallet/`

### سیستم یکپارچه کیف پول
کیف پول برای **تمام انواع کاربران** (مشتری، نماینده، ادمین) یکپارچه است. تمام نقش‌ها از مسیرهای `/wallet` استفاده می‌کنند. احراز هویت با `require_login` انجام می‌شود (هر کاربر احراز هویت شده، بدون محدودیت نقش).

### سیستم حسابداری دوطرفه
هر تغییر موجودی یک **LedgerEntry** ایجاد می‌کند (تاریخچه تغییرناپذیر).

### انواع تراکنش
| نوع | فارسی | توضیح |
|------|--------|--------|
| Deposit | واریز | شارژ کیف پول |
| Withdraw | برداشت | برداشت نقدی |
| Payment | پرداخت سفارش | خرید محصول |
| Refund | بازگشت وجه | استرداد |
| Hold | بلوکه | قفل موقت مبلغ |
| Release | آزادسازی | رفع بلوکه |
| Commit | تسویه | نهایی‌سازی |
| Credit | اعتبار | واریز اعتبار غیرقابل‌برداشت (بازگشت اجرت بازخرید — [بخش ۱۷](#17-بازگشت-اجرت-بازخرید-buyback-wage-refund)) |

### خرید و فروش فلزات گرانبها (Precious Metal Trading)
سیستم معاملات فلزات گرانبها به صورت **جنریک** (generic) پیاده‌سازی شده و از رجیستری `PRECIOUS_METALS` پشتیبانی می‌کند. در حال حاضر دو فلز فعال است: **طلا** (XAU_MG) و **نقره** (XAG_MG). تمام کاربران (مشتری، نماینده، ادمین) می‌توانند از طریق کیف پول اقدام به خرید و فروش کنند. موجودی هر فلز بر حسب میلی‌گرم در حساب کاربر ذخیره می‌شود.

**کارمزد پویا بر اساس نقش و فلز:**
| فلز | نقش | کارمزد پیش‌فرض | کلید تنظیمات |
|------|------|----------------|---------------|
| طلا | مشتری | ~۲٪ | `gold_fee_customer_percent` |
| طلا | نماینده | ~۰.۵٪ | `gold_fee_dealer_percent` |
| نقره | مشتری | ~۱.۵٪ | `silver_fee_customer_percent` |
| نقره | نماینده | ~۰.۳٪ | `silver_fee_dealer_percent` |

- کارمزد هر فلز از صفحه تنظیمات ادمین قابل تغییر است (SystemSetting)
- در صفحه خرید/فروش هر فلز، کارمزد به صورت شفاف به کاربر نمایش داده می‌شود
- قالب مشترک: `templates/shop/wallet_trade.html` (جایگزین `wallet_gold.html` سابق)

### قابلیت‌ها
- **شارژ**: کاربر از طریق درگاه فعال (active_gateway) کیف پول ریالی را شارژ می‌کند
- **برداشت**: کاربر درخواست برداشت به حساب بانکی می‌دهد (نیاز به تایید ادمین) + نمایش تاریخچه درخواست‌های قبلی
- **خرید فلز گرانبها**: تبدیل موجودی ریالی به طلا (XAU_MG) یا نقره (XAG_MG) با کارمزد پویا بر اساس نقش کاربر و نوع فلز
- **فروش فلز گرانبها**: تبدیل موجودی فلز (میلی‌گرم) به ریال با کارمزد پویا بر اساس نقش کاربر و نوع فلز
- **اعتبار غیرقابل‌برداشت**: موجودی ویژه که فقط برای خرید قابل‌استفاده است (مثلاً بازگشت اجرت بازخرید — [بخش ۱۷](#17-بازگشت-اجرت-بازخرید-buyback-wage-refund))
- **مشاهده تاریخچه**: لیست تمام تراکنش‌ها با فیلتر نوع دارایی (`asset`: all/irr/gold/silver)
- **شفافیت کارمزد**: نمایش درصد و مبلغ کارمزد قبل از تایید معامله هر فلز

### آدرس‌ها (همه کاربران — `require_login`)
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/wallet` | داشبورد کیف پول |
| GET | `/wallet/transactions` | تاریخچه تراکنش‌ها (فیلتر: asset=all/irr/gold/silver) |
| POST | `/wallet/topup` | شارژ کیف پول (via active gateway) |
| GET | `/wallet/topup/zibal/callback` | بازگشت شارژ از زیبال |
| POST | `/wallet/topup/sepehr/callback` | بازگشت شارژ از سپهر |
| GET | `/wallet/topup/top/callback` | بازگشت شارژ از تاپ |
| POST | `/wallet/topup/parsian/callback` | بازگشت شارژ از پارسیان |
| GET/POST | `/wallet/withdraw` | درخواست برداشت (+ تاریخچه درخواست‌های قبلی) |
| GET | `/wallet/{asset_type}` | صفحه خرید/فروش فلز گرانبها (مثلاً `/wallet/gold`، `/wallet/silver`) |
| POST | `/wallet/{asset_type}/buy` | خرید فلز (ریال → میلی‌گرم) |
| POST | `/wallet/{asset_type}/sell` | فروش فلز (میلی‌گرم → ریال) |

### آدرس‌های ادمین
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/admin/wallets` | لیست حساب‌ها |
| GET | `/admin/wallets/{user_id}` | جزئیات حساب کاربر (مشتری، نماینده یا ادمین) |
| GET | `/admin/wallets/withdrawals/list` | درخواست‌های برداشت |
| POST | `/admin/wallets/withdrawals/{id}/approve` | تایید برداشت |
| POST | `/admin/wallets/withdrawals/{id}/reject` | رد برداشت |

---

## 10. ماژول کوپن

**مسیر فایل‌ها**: `modules/coupon/`

### انواع کوپن
1. **DISCOUNT (تخفیف)**: مبلغ مستقیماً از سفارش کم می‌شود
2. **CASHBACK (کشبک)**: مبلغ پس از تحویل به کیف پول واریز می‌شود

### حالت تخفیف
1. **PERCENT (درصدی)**: مثلاً ۱۰٪ تخفیف (با سقف اختیاری)
2. **FIXED (مبلغ ثابت)**: مثلاً ۵۰۰,۰۰۰ تومان

### دامنه اعمال (Scope)
| دامنه | توضیح |
|--------|--------|
| GLOBAL | کل سفارش |
| PRODUCT | فقط محصول خاص |
| CATEGORY | فقط دسته‌بندی خاص (Many-to-Many) |

**ویژگی CATEGORY Scope**:
- جدول `CouponCategory` (junction M2M): هر کوپن می‌تواند به چند دسته‌بندی محدود شود
- در فرم ادمین: انتخاب چندگانه دسته‌بندی‌ها با چک‌باکس
- اعتبارسنجی: کوپن فقط روی آیتم‌هایی اعمال می‌شود که دسته‌بندی‌شان در لیست مجاز باشد
- کوپن seed نمونه: `GOLD10` (10% تخفیف فقط روی دسته شمش گرمی)

### محدودیت‌ها
- حداقل مبلغ سفارش
- حداکثر مبلغ سفارش
- حداقل تعداد اقلام
- سقف تخفیف (برای حالت درصدی)
- محدودیت تعداد استفاده (کل + هر مشتری)
- محدودیت زمانی (تاریخ شروع / انقضا)
- فقط اولین خرید
- لیست سفید موبایل (is_private)

### وضعیت‌های کوپن
| وضعیت | توضیح |
|--------|--------|
| ACTIVE | فعال و قابل استفاده |
| INACTIVE | غیرفعال (موقتاً) |
| EXPIRED | منقضی |

### آدرس‌های ادمین
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/admin/coupons` | لیست کوپن‌ها |
| GET/POST | `/admin/coupons/create` | ایجاد کوپن |
| GET | `/admin/coupons/{id}` | جزئیات کوپن |
| GET/POST | `/admin/coupons/{id}/edit` | ویرایش کوپن |

### API مشتری
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/api/coupon/check?code=X` | بررسی اعتبار کوپن (AJAX) |

---

## 11. ماژول نماینده

**مسیر فایل‌ها**: `modules/dealer/`

### مدل‌ها

#### نماینده (Dealer = User with is_dealer=True)
- نمایندگان در جدول یکپارچه `users` با پرچم `is_dealer=True` ذخیره می‌شوند
- سطح نمایندگی (FK → DealerTier): پخش / بنکدار / فروشگاه
- آدرس: استان (FK → GeoProvince)، شهر (FK → GeoCity)، محله (FK → GeoDistrict)، آدرس متنی، کد پستی، تلفن ثابت
- پرچم‌ها: `is_warehouse` (انبار مرکزی)، `is_postal_hub` (هاب ارسال پستی)
- Properties: `type_label`, `type_icon`, `type_color`, `display_name`
- کلید API یکتا (برای POS)
- وضعیت فعال/غیرفعال
- **فرم ایجاد/ویرایش**: cascade dropdown استان → شهر → محله (مثل آدرس مشتری)
- **دیتای اولیه**: ۹ نماینده (۵ شعبه تهران از صفحه تماس‌باما + تبریز + اصفهان + شیراز + مشهد)

#### DealerSale (فروش حضوری POS)
- شناسه نماینده، شمش فروخته‌شده
- نام/موبایل/کد ملی خریدار
- مبلغ فروش (ریال)، کمیسیون (ریال)
- `applied_metal_price`: قیمت فلز پایه در لحظه فروش (ریال بر گرم) — بر اساس نوع فلز محصول
- `metal_profit_mg`: سود فلزی نماینده (میلی‌گرم) — به کیف پول فلز مربوطه واریز می‌شود (XAU_MG برای طلا، XAG_MG برای نقره)
- `metal_type`: نوع فلز محصول فروخته‌شده (`"gold"` یا `"silver"`) — برای گزارش‌گیری و تفکیک آمار
- `discount_wage_percent` (Numeric 5,2): تخفیف اجرت از سهم نماینده (درصد) — نماینده اختیاری بخشی از سهم اجرت خود را تخفیف می‌دهد

#### BuybackRequest (درخواست بازخرید)
- نماینده درخواست‌دهنده، شمش مورد نظر
- نام/موبایل فروشنده (مشتری)
- مبلغ پیشنهادی بازخرید
- وضعیت: Pending → Approved/Rejected → Completed
- `wage_refund_amount`: مبلغ اجرت بازگشتی به کیف پول مشتری (ریال)
- `wage_refund_user_id`: شناسه کاربر دریافت‌کننده اعتبار (FK → users)
- در صورت تایید ادمین و وجود OrderItem اصلی، اجرت به‌صورت اعتبار غیرقابل‌برداشت واریز می‌شود ([بخش ۱۷](#17-بازگشت-اجرت-بازخرید-buyback-wage-refund))

#### SubDealerRelation (سلسله‌مراتب نمایندگان — فاز ۲۱)
- `id`, `parent_dealer_id` (FK → users), `child_dealer_id` (FK → users, unique — هر نماینده حداکثر یک والد)
- `commission_split_percent` (Numeric 5,2): درصد سود فلزی که به نماینده والد تعلق می‌گیرد
- `is_active` (bool, default True): وضعیت فعال/غیرفعال رابطه
- `created_at`, `deactivated_at`
- **UniqueConstraint**: `(child_dealer_id)` — هر زیرنماینده فقط یک والد دارد (single-level)
- **مکانیزم تقسیم سود**: هنگام فروش POS توسط زیرنماینده، `metal_profit_mg` تقسیم می‌شود: X% به والد (واریز به کیف پول فلز والد) و بقیه به زیرنماینده
- **محدودیت**: فقط یک سطح (والد → فرزند). نماینده والد نمی‌تواند خودش زیرنماینده باشد

#### B2BOrder (سفارش عمده نمایندگان — فاز ۲۱)
- `id`, `dealer_id` (FK → users), `status` (Submitted / Approved / Paid / Fulfilled / Rejected / Cancelled)
- `total_amount` (BigInteger, ریال): مبلغ کل سفارش بر اساس قیمت‌گذاری سطح نماینده
- `admin_note` (Text, nullable): یادداشت ادمین (مثلاً دلیل رد)
- `paid_at`, `fulfilled_at`, `created_at`, `updated_at`
- **چرخه عمر**: Submitted → Approved (ادمین) → Paid (کیف پول) → Fulfilled (تخصیص شمش) — یا Rejected/Cancelled
- **پرداخت**: فقط از کیف پول ریالی (IRR wallet). درگاه بانکی پشتیبانی نمی‌شود
- **تایید ادمین**: الزامی قبل از پرداخت. ادمین قیمت و موجودی را بررسی می‌کند

#### B2BOrderItem (آیتم سفارش عمده — فاز ۲۱)
- `id`, `b2b_order_id` (FK → b2b_orders, CASCADE), `product_id` (FK → products)
- `quantity` (int): تعداد شمش درخواستی
- `unit_price` (BigInteger, ریال): قیمت واحد در لحظه ثبت (بر اساس سطح نماینده)
- `bar_ids` (JSON, nullable): لیست شناسه شمش‌های تخصیص‌یافته (پر می‌شود در مرحله Fulfill)
- `line_total` (BigInteger): مبلغ کل آیتم (quantity × unit_price)

### قابلیت‌های پنل نماینده
1. **داشبورد**: آمار فروش، کمیسیون، بازخرید
2. **POS (فروش حضوری)**: انتخاب شمش + ثبت اطلاعات خریدار + مبلغ فروش + تخفیف اختیاری از سهم اجرت نماینده
3. **بازخرید**: ثبت سریال شمش + اطلاعات فروشنده + مبلغ پیشنهادی
4. **تاریخچه فروش**: لیست فروش‌های انجام‌شده (شامل ستون تخفیف اجرت)
5. **تاریخچه بازخرید**: لیست درخواست‌ها با وضعیت
6. **موجودی نماینده (فاز ۲۱)**: مشاهده شمش‌های تخصیص‌یافته به نماینده (ASSIGNED) با جزئیات محصول و قیمت
7. **زیرنمایندگان (فاز ۲۱)**: مشاهده لیست زیرنمایندگان فعال + آمار فروش + درصد تقسیم سود
8. **سفارش عمده B2B (فاز ۲۱)**: ثبت سفارش عمده شمش از انبار با قیمت‌گذاری سطح نماینده + پرداخت از کیف پول + مشاهده وضعیت سفارشات

### تخفیف اجرت POS (Dealer Wage Discount)
- نماینده هنگام فروش حضوری می‌تواند اختیاری بخشی از سهم اجرت خود را تخفیف دهد
- **محدوده تخفیف**: ۰ تا کل سهم اجرت نماینده (`ec_wage% - dealer_wage%`)
- **مثال**: محصول با ec_wage=42%, dealer_wage=14%, سهم نماینده=28%. نماینده می‌تواند ۰ تا ۲۸% تخفیف بدهد
- **نمایش UI**: باکس سبز (اطلاعات سهم) + اسلایدر/عدد (تنظیم تخفیف) + خلاصه قیمت نهایی
- **اعتبارسنجی سمت سرور**: قیمت فروش با قیمت محاسباتی (اجرت مؤثر) تطبیق داده می‌شود (تلرانس ±10 ریال)
- **سود فلزی** (`metal_profit_mg`): با تخفیف کاهش می‌یابد: `weight × (margin - discount) / 100 × 1000` میلی‌گرم — به کیف پول فلز مربوطه واریز می‌شود (XAU_MG برای طلا، XAG_MG برای نقره)
- **REST API**: فیلد `discount_wage_percent` در `POST /api/dealer/sale` (پیش‌فرض: ۰)
- **API محصولات**: فیلدهای `ec_wage_pct`, `dealer_wage_pct`, `margin_pct` در `GET /api/dealer/products`

### آدرس‌ها (نماینده)
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/dealer/dashboard` | داشبورد نماینده |
| GET | `/dealer/pos` | فرم فروش حضوری |
| POST | `/dealer/pos` | ثبت فروش |
| GET | `/dealer/buyback` | فرم بازخرید |
| POST | `/dealer/buyback` | ثبت درخواست بازخرید |
| GET | `/dealer/sales` | تاریخچه فروش |
| GET | `/dealer/buybacks` | تاریخچه بازخرید |
| GET | `/dealer/inventory` | موجودی شمش نماینده (فاز ۲۱) |
| GET | `/dealer/sub-dealers` | لیست زیرنمایندگان + آمار فروش (فاز ۲۱) |
| GET | `/dealer/b2b-orders/new` | فرم ثبت سفارش عمده (فاز ۲۱) |
| POST | `/dealer/b2b-orders/new` | ثبت سفارش عمده جدید (فاز ۲۱) |
| GET | `/dealer/b2b-orders` | لیست سفارشات عمده نماینده (فاز ۲۱) |
| GET | `/dealer/b2b-orders/{id}` | جزئیات سفارش عمده (فاز ۲۱) |
| POST | `/dealer/b2b-orders/{id}/pay` | پرداخت سفارش عمده از کیف پول (فاز ۲۱) |
| POST | `/dealer/b2b-orders/{id}/cancel` | لغو سفارش عمده (فقط قبل از پرداخت) (فاز ۲۱) |

### گزارش فروش نمایندگان (Admin POS Sales Report)

صفحه مدیریتی برای مشاهده و تحلیل **تمام فروش‌های حضوری (POS) نمایندگان** با فیلتر و آمار تجمیعی.

- **سرویس**: `dealer_service.list_all_sales_admin()`
- **قالب**: `templates/admin/dealers/sales.html`
- **لینک سایدبار**: «فروش نمایندگان» با آیکون `bi-receipt-cutoff`
- **دسترسی**: نیاز به مجوز `dealers`

#### فیلترها
| فیلتر | توضیح |
|--------|--------|
| نماینده | انتخاب نماینده خاص از لیست |
| بازه تاریخی | تاریخ شروع و پایان |
| جستجو | بر اساس نام خریدار، شماره موبایل، سریال‌کد شمش |
| تخفیف | فیلتر فروش‌های دارای تخفیف اجرت |

#### آمار تجمیعی
| آمار | توضیح |
|-------|--------|
| تعداد کل فروش | مجموع تعداد فروش‌های ثبت‌شده |
| درآمد کل | مجموع مبالغ فروش (ریال) |
| سود فلزی | مجموع سود فلزی نمایندگان (میلی‌گرم) — بر اساس `metal_type` هر فروش تفکیک می‌شود (طلا / نقره) |
| تعداد تخفیف‌دار | تعداد فروش‌هایی که تخفیف اجرت داشته‌اند |

#### صفحه‌بندی
- نتایج با pagination نمایش داده می‌شوند

### آدرس‌های ادمین
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/admin/dealers` | لیست نمایندگان |
| GET/POST | `/admin/dealers/create` | ایجاد نماینده |
| GET/POST | `/admin/dealers/{id}/edit` | ویرایش نماینده |
| GET | `/admin/dealers/sales` | گزارش فروش نمایندگان (فیلتر + آمار تجمیعی + صفحه‌بندی) |
| GET | `/admin/dealers/buybacks` | لیست درخواست‌های بازخرید |
| POST | `/admin/dealers/buybacks/{id}/approve` | تایید بازخرید |
| POST | `/admin/dealers/buybacks/{id}/reject` | رد بازخرید |
| GET | `/admin/dealers/stats` | آمار نمایندگان (JSON API) |
| GET | `/admin/dealers/{id}/sub-dealers` | لیست زیرنمایندگان یک نماینده (فاز ۲۱) |
| POST | `/admin/dealers/{id}/sub-dealers/add` | افزودن زیرنماینده به نماینده والد (فاز ۲۱) |
| POST | `/admin/dealers/{id}/sub-dealers/deactivate` | غیرفعال‌سازی رابطه زیرنمایندگی (فاز ۲۱) |
| GET | `/admin/dealers/b2b-orders` | لیست سفارشات عمده نمایندگان (فیلتر: نماینده، وضعیت) (فاز ۲۱) |
| GET | `/admin/dealers/b2b-orders/{id}` | جزئیات سفارش عمده (فاز ۲۱) |
| POST | `/admin/dealers/b2b-orders/{id}/approve` | تایید سفارش عمده (فاز ۲۱) |
| POST | `/admin/dealers/b2b-orders/{id}/reject` | رد سفارش عمده (فاز ۲۱) |
| POST | `/admin/dealers/b2b-orders/{id}/fulfill` | تحویل سفارش عمده — تخصیص شمش به نماینده (فاز ۲۱) |

---

## 12. ماژول احراز اصالت

**مسیر فایل‌ها**: `modules/verification/`

### قابلیت‌ها
- بررسی اصالت شمش با وارد کردن سریال‌کد
- نمایش اطلاعات شمش (محصول، وزن، عیار، وضعیت)
- صفحه عمومی (بدون نیاز به لاگین)
- **تولید QR Code برای شمش‌ها**: QR Code با کیفیت بالا (۹۸۰×۱۰۶۰ پیکسل) با لوگوی برند و متن سریال‌کد — آماده چاپ لیزری روی بسته‌بندی وکیوم (جزئیات کامل: [بخش ۳۲](#32-تولید-qr-code-برای-شمشها-qr-code-generation-for-bars))

### آدرس‌ها
| متد | مسیر | دسترسی | توضیح |
|------|------|--------|--------|
| GET | `/verify` | عمومی | صفحه احراز اصالت |
| GET | `/verify/check?code=X` | عمومی | بررسی سریال‌کد |
| GET | `/admin/bars/{bar_id}/qr` | inventory:view | دانلود QR Code با کیفیت بالا (PNG) |
| POST | `/admin/bars/{bar_id}/qr/regenerate` | inventory:edit | بازتولید QR Code (مثلاً بعد از تغییر لوگو) |

---

## 13. ماژول مشتری

**مسیر فایل‌ها**: `modules/customer/`

### مدل‌ها

#### User (کاربر یکپارچه)
- جدول واحد `users` با پرچم‌های نقش: `is_dealer`, `is_admin` — هر کاربر به‌صورت ضمنی مشتری است
- شماره موبایل (یکتا)، نام کامل، کد ملی، تاریخ تولد
- **نوع مشتری** (`customer_type`): حقیقی (`real`) یا حقوقی (`legal`) — پیش‌فرض: حقیقی
- **فیلدهای حقوقی**: نام شرکت (`company_name`)، کد اقتصادی (`economic_code`) — فقط برای مشتریان حقوقی
- **فیلدهای تماس/آدرس**: تلفن ثابت (`phone`)، کد پستی (`postal_code`)، آدرس (`address`)
- **فیلدهای نماینده**: `tier_id`, `province_id`, `city_id`, `district_id`, `commission_percent`, `api_key`, `is_warehouse`, `is_postal_hub` و غیره
- **فیلدهای ادمین**: `admin_role` (admin/operator), `is_staff` (= `is_admin`), `permissions` (JSON dict — `{"key": "level", ...}` — دسترسی‌های سلسله‌مراتبی اپراتور)
- **Property** `display_name`: برای حقیقی → `full_name`، برای حقوقی → `company_name`
- **Property** `is_profile_complete`: بررسی تکمیل بودن اطلاعات ضروری (نام، کد ملی، کد پستی، آدرس + برای حقوقی: نام شرکت و کد اقتصادی)

#### آدرس‌ها (Geo + Address)
- **GeoProvince**: لیست استان‌ها
- **GeoCity**: شهرهای هر استان
- **GeoDistrict**: مناطق هر شهر
- **CustomerAddress**: دفتر آدرس کاربر (عنوان، آدرس کامل، کدپستی، گیرنده) — `user_id` FK

### قابلیت‌ها
- ویرایش پروفایل (نام، کد ملی، تاریخ تولد، نوع مشتری، فیلدهای حقوقی، تلفن، کد پستی، آدرس)
- **انتخاب نوع مشتری**: حقیقی/حقوقی — در صورت انتخاب حقوقی، فیلدهای نام شرکت و کد اقتصادی نمایش داده می‌شوند
- مدیریت دفتر آدرس (افزودن، ویرایش، حذف، تعیین پیش‌فرض)
- انتخاب آدرس هنگام ثبت سفارش پستی
- **الزام تکمیل پروفایل (Profile Completion Guard)**: هنگام ورود به صفحه checkout (`GET /checkout`) یا ثبت سفارش (`POST /cart/checkout`)، اگر پروفایل مشتری ناقص باشد (`is_profile_complete == False`)، کاربر به صفحه پروفایل (`/profile`) ریدایرکت و پیام هشدار نمایش داده می‌شود
- **اطلاعات خریدار در فاکتور سفارش**: صفحه جزئیات سفارش (`/orders/{id}`) اطلاعات صورتحسابی خریدار را برای **همه کاربران** (نه فقط ادمین) نمایش می‌دهد: نوع مشتری (حقیقی/حقوقی)، نام/نام شرکت، کد ملی، موبایل، تلفن ثابت، کد پستی، آدرس

### آدرس‌ها
| متد | مسیر | توضیح |
|------|------|--------|
| GET/POST | `/profile` | پروفایل مشتری |
| GET/POST | `/addresses` | دفتر آدرس |
| POST | `/addresses/{id}/delete` | حذف آدرس |
| POST | `/addresses/{id}/default` | تعیین آدرس پیش‌فرض |
| GET | `/api/geo/cities?province_id=X` | لیست شهرها (AJAX) |
| GET | `/api/geo/districts?city_id=X` | لیست مناطق (AJAX) |
| GET | `/api/geo/dealers?province_id&city_id&district_id` | فیلتر نمایندگان بر اساس موقعیت (AJAX) |

---

## 14. ماژول مدیریت

**مسیر فایل‌ها**: `modules/admin/`

### داشبورد (فاز ۱۲)
- ۴ کارت آماری اصلی: درآمد کل، سفارشات، مشتریان، شمش‌ها
- ۶ کارت آماری فرعی: سفارش امروز، درآمد امروز، در انتظار پرداخت، شمش موجود، نماینده فعال، درخواست برداشت
- نمودار خطی: درآمد ۳۰ روز اخیر (Chart.js)
- نمودار دایره‌ای: وضعیت موجودی شمش‌ها
- جدول آخرین سفارشات
- لینک‌های دسترسی سریع
- نمایش قیمت طلا
- هشدار برای موارد در انتظار (سفارش، برداشت، بازخرید)

### تنظیمات سیستم
- **مدیریت دارایی‌ها (Asset)**: قیمت هر دارایی (طلا، نقره) با تنظیمات مستقل
  - قیمت فعلی (ریال بر گرم)
  - آستانه انقضای قیمت (`stale_after_minutes`) — قابل ویرایش per-asset
  - بازه بروزرسانی خودکار (`update_interval_minutes`) — قابل ویرایش per-asset
  - سوئیچ بروزرسانی خودکار (auto_update toggle)
  - دکمه بروزرسانی دستی (AJAX fetch از goldis.ir)
  - نشان تازگی قیمت (سبز/قرمز) + زمان آخرین بروزرسانی
- درصد مالیات
- هزینه ارسال پستی
- بیمه ارسال
- **ماتریس Trade Guard**: فعال/غیرفعال کردن خرید و فروش هر فلز در هر کانال — ۱۴ سوئیچ (۷ کانال × ۲ فلز). جزئیات در [بخش ۳۱](#31-سطحبندی-فعالغیرفعال-خرید-و-فروش--trade-guard).

### مدیریت ادمین‌ها و اپراتورها (Staff Management)

**مسیر فایل‌ها**: `modules/admin/staff_routes.py`, `modules/admin/staff_service.py`, `modules/admin/permissions.py`

- لیست تمام ادمین‌ها و اپراتورها با نمایش نقش و تعداد دسترسی‌ها
- ایجاد اپراتور جدید: شماره موبایل + نام + نقش + انتخاب سطح دسترسی برای هر بخش
- ویرایش اپراتور: تغییر نام، نقش و سطوح دسترسی
- فرم دسترسی: برای هر بخش (۱۳ بخش) یک dropdown با ۴ سطح (نمایش/ایجاد/ویرایش/کامل) + گزینه «بدون دسترسی»
- ذخیره‌سازی: دسترسی‌ها به‌صورت JSON dict در فیلد `permissions` ذخیره می‌شوند
- محدودیت: فقط کاربران با دسترسی `staff` می‌توانند این بخش را ببینند/مدیریت کنند

### آدرس‌ها
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/admin/dashboard` | داشبورد |
| GET | `/admin/dashboard/api/stats` | آمار JSON |
| GET/POST | `/admin/settings` | تنظیمات سیستم |
| POST | `/admin/settings/fetch-price` | بروزرسانی دستی قیمت (AJAX — JSON) |
| GET | `/admin/staff` | لیست ادمین‌ها و اپراتورها |
| GET | `/admin/staff/create` | فرم ایجاد اپراتور |
| POST | `/admin/staff/create` | ثبت اپراتور جدید (نیاز به سطح `create` در بخش `staff`) |
| GET | `/admin/staff/{id}/edit` | فرم ویرایش اپراتور |
| POST | `/admin/staff/{id}/edit` | ذخیره تغییرات اپراتور (نیاز به سطح `edit` در بخش `staff`) |

---

## 15. ماژول تیکتینگ / پشتیبانی

**مسیر فایل‌ها**: `modules/ticket/`

### مدل‌ها

#### Ticket (تیکت پشتیبانی)
- موضوع، متن اولیه، وضعیت، اولویت
- **دسته‌بندی** (`category`): TicketCategory enum — مالی / فنی / فروش / شکایات / سایر
- نوع فرستنده (مشتری/نماینده)
- ارتباط: `user_id` (FK → users) — کاربر ایجادکننده تیکت
- تخصیص: assigned_to (FK → users) — کارشناس اختصاص‌یافته
- زمان‌ها: ایجاد، بروزرسانی، بسته شدن

#### TicketMessage (پیام تیکت)
- متن پیام، نوع فرستنده (CUSTOMER/DEALER/STAFF)
- نام فرستنده (denormalized)
- **is_internal** (Boolean): یادداشت داخلی فقط قابل‌مشاهده توسط کارکنان (staff-only note)
- **is_initial** (Boolean): پیام اولیه تیکت (برای پشتیبانی پیوست در ایجاد تیکت)
- **attachments**: رابطه با TicketAttachment (پیوست‌های پیام)
- زمان ایجاد

#### TicketAttachment (پیوست تیکت) — مدل جدید
- **id**: شناسه یکتا
- **message_id** (FK → ticket_messages): پیام مرتبط
- **file_path**: مسیر فایل آپلود‌شده
- **created_at**: زمان ایجاد

### Enum جدید: TicketCategory (دسته‌بندی تیکت)
| مقدار | فارسی |
|--------|--------|
| Financial | مالی |
| Technical | فنی |
| Sales | فروش |
| Complaints | شکایات |
| Other | سایر |

### وضعیت‌های تیکت
| وضعیت | فارسی | توضیح |
|--------|--------|--------|
| Open | باز | تازه ایجاد شده یا بازشده |
| InProgress | در حال بررسی | به اپراتور تخصیص داده شده |
| Answered | پاسخ داده شده | اپراتور پاسخ داده |
| Closed | بسته | بسته شده توسط کاربر یا اپراتور |

### اولویت‌ها
| اولویت | فارسی |
|---------|--------|
| Low | کم |
| Medium | متوسط |
| High | بالا |

### رفتار خودکار وضعیت
- پاسخ اپراتور → وضعیت به **Answered** تغییر می‌کند
- پاسخ کاربر به تیکت Answered → وضعیت به **Open** بازمی‌گردد
- تخصیص به اپراتور → اگر Open باشد، به **InProgress** تغییر می‌کند
- اولین پاسخ ادمین → اگر تخصیص نشده، خودکار assign می‌شود

### اعلان‌ها (Notifications)
- **فایل**: `common/notifications.py`
- تابع `notify_ticket_update()` برای ارسال SMS هنگام رویدادهای تیکت (ایجاد، پاسخ، تغییر وضعیت)
- اعلان به مشتری/نماینده هنگام پاسخ کارکنان
- اعلان به کارکنان هنگام ایجاد تیکت جدید یا پاسخ کاربر

### تمایز مشتری/نماینده در پنل ادمین
- لیست تیکت‌ها با **تب‌ها**: همه | مشتریان (badge آبی) | نمایندگان (badge بنفش)
- Badge تعداد تیکت باز هر نوع روی تب
- فیلتر وضعیت: دکمه‌های وضعیت (باز / در حال بررسی / پاسخ‌داده / بسته)
- **فیلتر دسته‌بندی**: انتخاب دسته‌بندی تیکت (مالی / فنی / فروش / شکایات / سایر)
- **جستجو**: بر اساس شناسه تیکت، موضوع، نام فرستنده، شماره موبایل
- جزئیات تیکت: نوع فرستنده + نام + شماره + تاریخ + دسته‌بندی در پنل کناری

### قابلیت پیوست فایل (File Upload)
- مشتری و نماینده می‌توانند هنگام **ایجاد تیکت** و **ارسال پاسخ** فایل پیوست کنند
- کارکنان می‌توانند هنگام **پاسخ به تیکت** فایل پیوست کنند
- فایل‌های پیوست در مکالمه تیکت نمایش داده می‌شوند
- هر پیام می‌تواند چندین پیوست داشته باشد

### یادداشت داخلی (Internal Notes)
- کارکنان می‌توانند **یادداشت داخلی** ثبت کنند (فقط قابل‌مشاهده توسط ادمین و اپراتور)
- یادداشت‌های داخلی در مکالمه با رنگ متمایز (مثلاً زمینه زرد) نمایش داده می‌شوند
- مشتری و نماینده یادداشت‌های داخلی را **نمی‌بینند**

### قالب‌های بروزرسانی‌شده (Templates)
۶ قالب بهبود یافته:
1. `templates/shop/ticket_new.html` — افزودن dropdown دسته‌بندی + آپلود فایل
2. `templates/shop/ticket_detail.html` — نمایش پیوست‌ها + آپلود فایل در پاسخ
3. `templates/dealer/ticket_new.html` — افزودن dropdown دسته‌بندی + آپلود فایل
4. `templates/dealer/ticket_detail.html` — نمایش پیوست‌ها + آپلود فایل در پاسخ
5. `templates/admin/tickets/list.html` — جستجو + فیلتر دسته‌بندی
6. `templates/admin/tickets/detail.html` — نمایش پیوست‌ها + فرم یادداشت داخلی + آپلود فایل در پاسخ

### آدرس‌ها (مشتری + نماینده)
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/tickets` | لیست تیکت‌های من |
| GET | `/tickets/new` | فرم ایجاد تیکت |
| POST | `/tickets/new` | ثبت تیکت (+ آپلود فایل) |
| GET | `/tickets/{id}` | جزئیات + مکالمه + پیوست‌ها |
| POST | `/tickets/{id}/message` | ارسال پاسخ (+ آپلود فایل) |
| POST | `/tickets/{id}/close` | بستن تیکت |

### آدرس‌های ادمین
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/admin/tickets` | لیست تیکت‌ها (تب + فیلتر وضعیت + فیلتر دسته‌بندی + جستجو) |
| GET | `/admin/tickets/{id}` | جزئیات + پاسخ + تخصیص + پیوست‌ها |
| POST | `/admin/tickets/{id}/reply` | پاسخ ادمین (+ آپلود فایل) |
| POST | `/admin/tickets/{id}/internal-note` | ثبت یادداشت داخلی (فقط کارکنان) |
| POST | `/admin/tickets/{id}/status` | تغییر وضعیت |
| POST | `/admin/tickets/{id}/close` | بستن تیکت |
| POST | `/admin/tickets/{id}/assign` | تخصیص به اپراتور |

### فایل‌های مرتبط با بهبودهای تیکتینگ

| فایل | تغییرات |
|-------|---------|
| `modules/ticket/models.py` | مدل جدید `TicketAttachment`، enum `TicketCategory`، فیلدهای جدید `is_internal`/`is_initial`/`attachments` در TicketMessage، فیلد `category` در Ticket |
| `common/notifications.py` | فایل جدید — تابع `notify_ticket_update()` برای اعلان SMS رویدادهای تیکت |
| `modules/ticket/service.py` | پشتیبانی از پیوست، دسته‌بندی، یادداشت داخلی، جستجو |
| `modules/ticket/routes.py` | آپلود فایل در ایجاد تیکت و ارسال پاسخ |
| `modules/ticket/admin_routes.py` | endpoint جدید `internal-note`، آپلود فایل، جستجو و فیلتر دسته‌بندی |

---

## 15.5 لاگ درخواست‌ها (Request Audit Log)

**مسیر فایل‌ها**: `modules/admin/models.py` (RequestLog), `modules/admin/routes.py`, `main.py` (middleware)

### مدل

| مدل | جدول | ستون‌های کلیدی |
|------|-------|---------------|
| RequestLog | request_logs | method, path, query_string, status_code, ip_address, user_agent, user_type, user_display, body_preview, response_time_ms, created_at |

### Middleware

- `request_logger` در `main.py` — هر درخواست HTTP را لاگ میکنه
- Exclude: `/static/`, `/health`, `favicon.ico`
- POST body: mask حساس (`password`, `otp_code`, `csrf_token`, `api_key`)
- شناسایی کاربر از JWT cookies
- Auto-cleanup: لاگ‌های قدیمی‌تر از ۳۰ روز (APScheduler هر ۶ ساعت)

### مسیرها

| متد | مسیر | توضیح |
|------|------|-------|
| GET | `/admin/logs` | لیست لاگ‌ها + فیلتر (متد، وضعیت، مسیر، نوع کاربر، IP) + pagination |

### Middleware: جلوگیری از کش مرورگر (No-Cache)

- در `main.py` — هدرهای `Cache-Control: no-cache, no-store, must-revalidate`، `Pragma: no-cache` و `Expires: 0` برای تمام مسیرهای `/admin/*` و `/dealer/*` ست می‌شود
- هدف: جلوگیری از نمایش صفحات قدیمی کش‌شده هنگام ناوبری (back/forward) — آمار و داده‌ها همیشه تازه از دیتابیس بارگذاری می‌شوند

---

## 16. API نماینده (Dealer POS API)

**مسیر فایل‌ها**: `modules/dealer/api_routes.py`

### احراز هویت
- هدر `X-API-Key` با کلید ۶۴ کاراکتری یکتا
- کلید توسط ادمین از پنل مدیریت تولید/لغو می‌شود
- بدون نیاز به Cookie یا CSRF (stateless)

### اندپوینت‌ها

| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/api/dealer/info` | اطلاعات نماینده (health check) |
| GET | `/api/dealer/products` | لیست محصولات + قیمت لحظه‌ای + سریال‌کد شمش‌ها + اطلاعات سهم اجرت (`ec_wage_pct`, `dealer_wage_pct`, `margin_pct`) |
| POST | `/api/dealer/sale` | ثبت فروش POS (serial_code, sale_price, discount_wage_percent, اطلاعات مشتری) |
| GET | `/api/dealer/sales` | تاریخچه فروش (صفحه‌بندی) |

### فرمت پاسخ
- موفق: `{"success": true, ...data}`
- خطا: `{"success": false, "error": "message", "code": 400}`
- بدون API Key: `422` (هدر الزامی)
- API Key نامعتبر: `401`

### مدیریت کلید API (ادمین)

| متد | مسیر | توضیح |
|------|------|--------|
| POST | `/admin/dealers/{id}/generate-api-key` | تولید کلید جدید |
| POST | `/admin/dealers/{id}/revoke-api-key` | لغو کلید |

---

## 17. بازگشت اجرت بازخرید (Buyback Wage Refund)

### شرح قابلیت

وقتی مشتری شمش طلایی را که قبلاً از فروشگاه آنلاین خریده بازفروش (بازخرید) می‌کند، سیستم به‌صورت خودکار مبلغ اجرت ساخت (wage) اصلی آن شمش را به کیف پول مشتری به‌عنوان **اعتبار غیرقابل‌برداشت** واریز می‌کند. این اعتبار فقط برای خرید محصولات جدید قابل‌استفاده است و امکان برداشت نقدی به حساب بانکی را ندارد.

### نحوه عملکرد

1. نماینده درخواست بازخرید برای شمشی با وضعیت **SOLD** ثبت می‌کند
2. ادمین/اپراتور درخواست بازخرید را **تایید** می‌کند
3. سیستم در آیتم‌های سفارش اصلی (`OrderItem`) آن شمش را جستجو کرده و مقدار `final_wage_amount` را استخراج می‌کند
4. اگر شمش از طریق **فروشگاه آنلاین** فروخته شده باشد (OrderItem موجود باشد):
   - مبلغ اجرت به‌عنوان اعتبار غیرقابل‌برداشت به کیف پول مشتری واریز می‌شود
   - مقادیر `wage_refund_amount` و `wage_refund_user_id` در BuybackRequest ثبت می‌شود
5. اگر شمش از طریق **POS (فروش حضوری)** فروخته شده باشد (بدون OrderItem):
   - بازگشت اجرت صورت نمی‌گیرد

### تغییرات مدل‌ها

#### Account (حساب کیف پول) — ستون جدید `credit_balance`
- `credit_balance`: موجودی اعتبار غیرقابل‌برداشت (پیش‌فرض ۰)
- **موجودی قابل‌استفاده برای خرید** (`available_balance`): `balance - locked_balance`
- **موجودی قابل‌برداشت** (`withdrawable_balance`): `balance - locked_balance - credit_balance`

#### LedgerEntry (سند حسابداری) — ستون‌های جدید
- `delta_credit`: تغییر اعتبار در این تراکنش
- `credit_after`: موجودی اعتبار پس از تراکنش

#### TransactionType (انواع تراکنش) — نوع جدید
- `CREDIT`: واریز اعتبار غیرقابل‌برداشت (بازگشت اجرت)

#### BuybackRequest (درخواست بازخرید) — ستون‌های جدید
- `wage_refund_amount`: مبلغ اجرت بازگشتی (ریال)
- `wage_refund_user_id`: شناسه کاربر دریافت‌کننده اعتبار (FK → users)

### رفتار کیف پول

| عملیات | balance | credit_balance | توضیح |
|--------|---------|----------------|--------|
| واریز اعتبار (`deposit_credit`) | افزایش | افزایش | هم‌زمان هر دو افزایش می‌یابد |
| خرید با کیف پول | کاهش | بدون تغییر یا کاهش | ابتدا پول عادی مصرف می‌شود؛ اعتبار فقط وقتی موجودی عادی کافی نباشد |
| درخواست برداشت | — | — | فقط `withdrawable_balance` قابل‌برداشت (بدون اعتبار) |

**ترتیب مصرف هنگام خرید:**
1. ابتدا موجودی عادی (`balance - credit_balance`) مصرف می‌شود
2. اگر موجودی عادی کافی نباشد، مابقی از اعتبار (`credit_balance`) کسر می‌شود
3. پارامتر `consume_credit=True` در `wallet_service.withdraw()` این رفتار را فعال می‌کند

**محدودیت برداشت:**
- درخواست‌های برداشت بانکی بر اساس `withdrawable_balance` اعتبارسنجی می‌شوند (نه `available_balance`)
- یعنی اعتبار غیرقابل‌برداشت هرگز قابل انتقال به حساب بانکی نیست

### رابط کاربری (UI)

| صفحه | تغییر |
|-------|--------|
| کیف پول مشتری (`/wallet`) | نمایش موجودی اعتبار + مبلغ قابل‌برداشت |
| جزئیات حساب ادمین (`/admin/wallets/{user_id}`) | نمایش تفکیک: موجودی کل، اعتبار، قابل‌برداشت |
| لیست بازخریدها ادمین (`/admin/dealers/buybacks`) | نمایش مبلغ بازگشت اجرت در هر درخواست |

### فایل‌های مرتبط

| فایل | تغییرات |
|-------|---------|
| `modules/wallet/models.py` | `credit_balance` در Account، `delta_credit`/`credit_after` در LedgerEntry، نوع `CREDIT` در TransactionType |
| `modules/wallet/service.py` | متد `deposit_credit()`، پارامتر `consume_credit` در `withdraw()`، بررسی `withdrawable_balance` |
| `modules/dealer/models.py` | `wage_refund_amount`/`wage_refund_user_id` در BuybackRequest |
| `modules/dealer/service.py` | منطق بازگشت اجرت در `approve_buyback()` |
| `modules/payment/service.py` | ارسال `consume_credit=True` هنگام پرداخت با کیف پول |

---

## 18. فرمول قیمت‌گذاری فلزات گرانبها (Generic Metal Pricing)

**فایل**: `modules/pricing/calculator.py`

### دیکشنری فلزات (`PRECIOUS_METALS`)
| فلز | `metal_type` | `asset_code` | `base_purity` | `wallet_asset` |
|------|-------------|--------------|---------------|----------------|
| طلا | `"gold"` | `gold_18k` | 750 | `XAU_MG` |
| نقره | `"silver"` | `silver` | 999 | `XAG_MG` |

### ورودی‌ها
| پارامتر | توضیح | مثال (طلا) | مثال (نقره) |
|----------|--------|------------|-------------|
| weight | وزن شمش (گرم) | 1.000 | 5.000 |
| purity | عیار (در هزار) | 750 (= 18 عیار) | 999 |
| wage_percent | اجرت ساخت (درصد) | 7 | 3 |
| base_metal_price | قیمت فلز پایه (ریال/گرم) — از جدول Asset | 52,000,000 | 800,000 |
| base_purity | عیار مرجع فلز — از `PRECIOUS_METALS` | 750 | 999 |
| tax_percent | درصد مالیات | 10 | 10 |

### تابع کمکی `get_product_pricing(product, db)`
در `modules/pricing/service.py` — بر اساس `product.metal_type` قیمت فلز و `base_purity` مناسب را برمی‌گرداند:
```python
metal_price, base_purity = get_product_pricing(product, db)
# gold product → (gold_18k_price, 750)
# silver product → (silver_price, 999)
```

### مراحل محاسبه

```
۱. قیمت واحد بر اساس عیار:
   price_per_gram = (base_metal_price / base_purity) × purity

۲. ارزش فلز خام:
   raw_metal = weight × price_per_gram

۳. اجرت ساخت (درصدی از ارزش فلز):
   wage = raw_metal × (wage_percent / 100)

۴. مالیات (فقط روی اجرت):
   tax = wage × (tax_percent / 100)

۵. قیمت نهایی:
   total = raw_metal + wage + tax
```

### نکته مهم
- تمام گِردکردن‌ها به **پایین** (FLOOR) انجام می‌شود
- مالیات فقط روی اجرت (خدمات) اعمال می‌شود — فلز خام معاف از مالیات است
- فیلدهای سود، کمیسیون، سنگ و لوازم جانبی از فرمول حذف شده‌اند
- `calculate_bar_price()` اکنون پارامترهای `base_metal_price` و `base_purity` می‌گیرد (به‌جای مقدار ثابت طلا)
- هر ماژول (shop، cart، order، dealer، pos) از `get_product_pricing()` برای دریافت قیمت و عیار پایه هر محصول استفاده می‌کند

---

## 19. جدول جامع دسترسی نقش‌ها

> **نکته**: ستون «اپراتور» سطح دسترسی مورد نیاز را نشان می‌دهد. اپراتور فقط در صورتی دسترسی دارد که Super Admin آن بخش را با سطح مناسب به او اختصاص داده باشد.
> سطوح: `view` (نمایش) < `create` (ایجاد) < `edit` (ویرایش) < `full` (کامل — شامل حذف و تایید/رد).
> **مدیرکل** (`admin_role=="admin"`) همیشه دسترسی کامل دارد (bypass).

### دسترسی مشتری و نماینده

| عملیات | مشتری | نماینده |
|--------|--------|---------|
| مشاهده فروشگاه | ✅ | — |
| خرید آنلاین | ✅ | — |
| کیف پول (شارژ/برداشت) | ✅ | ✅ |
| خرید/فروش طلا (کیف پول) | ✅ | ✅ |
| خرید/فروش نقره (کیف پول) | ✅ | ✅ |
| مشاهده سفارشات خود | ✅ | — |
| مشاهده شمش‌های من (`/my-bars`) | ✅ | — |
| ثبت مالکیت شمش (`/claim-bar`) | ✅ | — |
| انتقال شمش به دیگران (`/my-bars/{id}/transfer`) | ✅ | — |
| خرید هدیه (gift checkout) | ✅ | — |
| ویرایش پروفایل | ✅ | — |
| دفتر آدرس | ✅ | — |
| مشاهده صفحات ثابت | ✅ | ✅ |
| احراز اصالت شمش | ✅ | ✅ |
| مشاهده اعتبار غیرقابل‌برداشت | ✅ | — |
| ثبت درخواست نمایندگی | ✅ | — |
| ویرایش و ارسال مجدد درخواست (RevisionNeeded) | ✅ | — |
| ارسال تیکت پشتیبانی (+ پیوست) | ✅ | ✅ |
| مشاهده تیکت‌های خود (+ پیوست‌ها) | ✅ | ✅ |
| درخواست تحویل امانی (`/my-bars/{id}/delivery`) | ✅ | — |
| فروش حضوری (POS) | — | ✅ |
| بازخرید شمش | — | ✅ |
| تاریخچه فروش خود | — | ✅ |
| دسترسی API (POS) | — | ✅ |
| مشاهده موجودی نماینده (`/dealer/inventory`) | — | ✅ |
| مشاهده زیرنمایندگان (`/dealer/sub-dealers`) | — | ✅ |
| ثبت سفارش عمده B2B | — | ✅ |
| پرداخت/لغو سفارش عمده | — | ✅ |
| اسکن شمش (Scanner) | — | ✅ |
| انبارگردانی (شروع/اسکن/نهایی/لغو) | — | ✅ |
| تایید تحویل امانی | — | ✅ |
| مشاهده لیست تحویل‌های امانی | — | ✅ |

### دسترسی ادمین و اپراتور (سطوح سلسله‌مراتبی)

| عملیات | کلید دسترسی | سطح مورد نیاز اپراتور | مدیرکل |
|--------|-------------|----------------------|--------|
| **داشبورد مدیریت** | `dashboard` | `view` | ✅ bypass |
| **محصولات — مشاهده لیست** | `products` | `view` | ✅ bypass |
| **محصولات — ایجاد** | `products` | `create` | ✅ bypass |
| **محصولات — ویرایش** | `products` | `edit` | ✅ bypass |
| **محصولات — حذف** | `products` | `full` | ✅ bypass |
| **دسته‌بندی‌ها — مشاهده** | `products` | `view` | ✅ bypass |
| **دسته‌بندی‌ها — ایجاد/ویرایش** | `products` | `create`/`edit` | ✅ bypass |
| **دسته‌بندی‌ها — حذف** | `products` | `full` | ✅ bypass |
| **طرح کارت / بسته‌بندی — مشاهده** | `products` | `view` | ✅ bypass |
| **طرح کارت / بسته‌بندی — ایجاد/ویرایش/حذف** | `products` | `create`/`edit`/`full` | ✅ bypass |
| **بچ/ذوب — مشاهده** | `batches` | `view` | ✅ bypass |
| **بچ/ذوب — ایجاد** | `batches` | `create` | ✅ bypass |
| **بچ/ذوب — ویرایش** | `batches` | `edit` | ✅ bypass |
| **بچ/ذوب — حذف** | `batches` | `full` | ✅ bypass |
| **شمش‌ها — مشاهده** | `inventory` | `view` | ✅ bypass |
| **شمش‌ها — ویرایش/ایجاد** | `inventory` | `edit`/`create` | ✅ bypass |
| **سفارشات — مشاهده** | `orders` | `view` | ✅ bypass |
| **سفارشات — تغییر وضعیت** | `orders` | `edit` | ✅ bypass |
| **سفارشات — لغو/ریفاند** | `orders` | `full` | ✅ bypass |
| **مدیریت کاربران — مشاهده** | `customers` | `view` | ✅ bypass |
| **مدیریت کاربران — ایجاد** | `customers` | `create` | ✅ bypass |
| **مدیریت کاربران — ویرایش** | `customers` | `edit` | ✅ bypass |
| **کیف پول‌ها — مشاهده** | `wallets` | `view` | ✅ bypass |
| **تایید/رد برداشت** | `wallets` | `full` | ✅ bypass |
| **کوپن‌ها — مشاهده** | `coupons` | `view` | ✅ bypass |
| **کوپن‌ها — ایجاد/ویرایش** | `coupons` | `create`/`edit` | ✅ bypass |
| **نمایندگان — مشاهده** | `dealers` | `view` | ✅ bypass |
| **نمایندگان — ایجاد/ویرایش** | `dealers` | `create`/`edit` | ✅ bypass |
| **تایید/رد بازخرید** | `dealers` | `full` | ✅ bypass |
| **بررسی درخواست‌های نمایندگی (تایید/رد/بازبینی)** | `dealers` | `full` | ✅ bypass |
| **مدیریت زیرنمایندگان** | `dealers` | `edit` | ✅ bypass |
| **مدیریت سفارشات عمده B2B (تایید/رد/تحویل)** | `dealers` | `full` | ✅ bypass |
| **گزارش فروش نمایندگان** | `dealers` | `view` | ✅ bypass |
| **تیکت‌ها — مشاهده** | `tickets` | `view` | ✅ bypass |
| **تیکت‌ها — پاسخ/تخصیص** | `tickets` | `edit` | ✅ bypass |
| **تیکت‌ها — بستن** | `tickets` | `full` | ✅ bypass |
| **لاگ درخواست‌ها** | `logs` | `view` | ✅ bypass |
| **تنظیمات سیستم — مشاهده** | `settings` | `view` | ✅ bypass |
| **تنظیمات سیستم — ویرایش** | `settings` | `edit` | ✅ bypass |
| **مدیریت ادمین‌ها — مشاهده** | `staff` | `view` | ✅ bypass |
| **مدیریت ادمین‌ها — ایجاد** | `staff` | `create` | ✅ bypass |
| **مدیریت ادمین‌ها — ویرایش** | `staff` | `edit` | ✅ bypass |
| **انبارگردانی ادمین** | `inventory` | `view`+ | ✅ bypass |

---

## 20. صفحات ثابت و فوتر (Static Pages & Footer)

**مسیر فایل‌ها**: `main.py` (routes) + `templates/shop/`

### شرح قابلیت

صفحات اطلاع‌رسانی ثابت (Static Pages) برای معرفی شرکت، پاسخ به سوالات متداول، راه‌های ارتباطی و قوانین استفاده از سایت. همچنین فوتر (Footer) کامل با اطلاعات شرکت، لینک‌های سریع، لینک‌های اعتماد و شبکه‌های اجتماعی.

### صفحات

| صفحه | توضیح |
|--------|--------|
| **درباره ما** (`/about`) | معرفی شرکت طلاملا، تاریخچه و ماموریت |
| **سوالات متداول** (`/faq`) | سوالات پرتکرار مشتریان با پاسخ (Accordion) |
| **تماس با ما** (`/contact`) | اطلاعات تماس (آدرس، تلفن، ایمیل، ساعت کاری) |
| **قوانین و مقررات** (`/terms`) | شرایط استفاده از خدمات فروشگاه |
| **صفحه ۴۰۴** | صفحه سفارشی برای آدرس‌های ناموجود |

### آدرس‌ها (عمومی — بدون نیاز به لاگین)

| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/about` | صفحه درباره ما |
| GET | `/faq` | صفحه سوالات متداول |
| GET | `/contact` | صفحه تماس با ما |
| GET | `/terms` | صفحه قوانین و مقررات |
| — | هر مسیر نامعتبر | صفحه سفارشی ۴۰۴ |

### فوتر (Footer)

فوتر سایت در قالب `templates/shop/base_shop.html` تعریف شده و شامل موارد زیر است:

- **اطلاعات شرکت**: نام، توضیح کوتاه، نشانی، تلفن، ایمیل
- **لینک‌های سریع**: صفحه اصلی، محصولات، احراز اصالت، سوالات متداول، درباره ما، تماس با ما، قوانین
- **نشان‌های اعتماد**: لینک به نمادهای اعتماد الکترونیکی (enamad، ساماندهی و غیره)
- **شبکه‌های اجتماعی**: لینک به حساب‌های اینستاگرام، تلگرام، واتساپ و غیره
- **لینک‌های عضویت**: عضویت در انجمن طلا و جواهر و سایر مجامع صنفی

### ناوبار (Navbar)

ناوبار سایت در `templates/shop/base_shop.html` به‌روز شده و شامل لینک‌های زیر است:

- احراز اصالت (`/verify`)
- سوالات متداول (`/faq`)
- درباره ما (`/about`)
- تماس با ما (`/contact`)

### پیاده‌سازی فنی

- تابع کمکی `_static_page_ctx(request, db)` در `main.py` برای تولید context مشترک (اطلاعات کاربر، تعداد سبد خرید، CSRF token)
- صفحات ثابت نیازی به مدل دیتابیسی ندارند — محتوا در قالب‌های Jinja2 نوشته شده
- صفحه ۴۰۴ از طریق `@app.exception_handler(404)` ثبت شده

### قالب‌ها (Templates)

| قالب | توضیح |
|-------|--------|
| `templates/shop/about.html` | صفحه درباره ما |
| `templates/shop/faq.html` | صفحه سوالات متداول |
| `templates/shop/contact.html` | صفحه تماس با ما |
| `templates/shop/terms.html` | صفحه قوانین و مقررات |
| `templates/shop/404.html` | صفحه سفارشی خطای ۴۰۴ |
| `templates/shop/base_shop.html` | فوتر + ناوبار به‌روز شده |

---

## 21. ثبت مالکیت و انتقال شمش (Bar Claim & Ownership Transfer)

**مسیر فایل‌ها**: `modules/inventory/` (مدل BarTransfer) + route‌های مربوطه

### شرح قابلیت

این ماژول امکان **ثبت مالکیت**، **خرید هدیه** و **انتقال شمش** بین مشتریان را فراهم می‌کند.

### مدل‌های جدید / تغییریافته

#### Bar — فیلد جدید `claim_code`
- `claim_code` (String(8), unique, nullable, indexed): کد ۶ کاراکتری برای ثبت مالکیت
- مجموعه کاراکترها: `ABCDEFGHJKMNPQRSTUVWXYZ23456789` (بدون کاراکترهای مبهم مثل O/0/I/1/L)
- تولید خودکار هنگام فروش حضوری (POS) و خرید هدیه (gift)

#### Order — فیلد جدید `is_gift`
- `is_gift` (Boolean, default=False): آیا سفارش به‌عنوان هدیه ثبت شده
- در سفارش هدیه: `user_id` شمش NULL می‌ماند و `claim_code` تولید می‌شود

#### BarTransfer (مدل جدید)
- `id`: شناسه یکتا
- `bar_id` (FK → bars): شمش مورد انتقال
- `from_user_id` (FK → users): مالک فعلی (فرستنده)
- `to_mobile` (String): شماره موبایل گیرنده
- `otp_hash` (String): هش رمز یک‌بارمصرف ارسال‌شده به فرستنده
- `otp_expiry` (DateTime): زمان انقضای OTP
- `status` (String): وضعیت درخواست انتقال (Pending / Completed / Expired)
- `created_at` (DateTime): زمان ایجاد

### سناریوهای اصلی

#### ۱. فروش حضوری (POS) با کد ثبت مالکیت
- نماینده شمش را از طریق POS می‌فروشد
- سیستم خودکار `claim_code` تولید و در Bar ذخیره می‌کند
- کد در پاسخ API و رسید فروش POS نمایش داده می‌شود
- خریدار با این کد می‌تواند مالکیت شمش را در سایت ثبت کند

#### ۲. خرید هدیه (Gift Purchase)
- مشتری در صفحه checkout تیک «خرید به‌عنوان هدیه» (`is_gift`) را می‌زند
- پس از پرداخت موفق، `claim_code` برای شمش تولید می‌شود
- `user_id` شمش NULL می‌ماند (مالکیت ثبت نمی‌شود)
- خریدار `claim_code` را به گیرنده هدیه می‌دهد

#### ۳. ثبت مالکیت (Claim Bar)
- مشتری از طریق **منوی کشویی کاربر → «ثبت شمش»**، **لینک فوتر**، یا **دکمه «ثبت شمش جدید» در صفحه شمش‌های من** وارد فرم ثبت مالکیت می‌شود
- سریال‌کد شمش و کد ثبت مالکیت (`claim_code`) را وارد می‌کند
- سیستم بررسی می‌کند: سریال معتبر + claim_code صحیح + شمش بدون مالک
- مالکیت شمش به مشتری منتقل و `claim_code` حذف می‌شود
- رکورد OwnershipHistory ثبت می‌شود

#### ۴. مشاهده شمش‌های من (My Bars)
- مشتری از طریق **منوی کشویی کاربر → «شمش‌های من»** لیست تمام شمش‌های متعلق به خود را می‌بیند
- اطلاعات: سریال‌کد، نام محصول، وزن، عیار، تاریخ خرید

#### ۵. انتقال مالکیت (Ownership Transfer)
جریان ۳ مرحله‌ای:

1. **مرحله ۱**: مالک شمش به `/my-bars/{bar_id}/transfer` می‌رود و شماره موبایل گیرنده را وارد می‌کند
2. **مرحله ۲**: سیستم OTP به موبایل **مالک فعلی** (فرستنده) ارسال می‌کند (تایید هویت فرستنده)
3. **مرحله ۳**: مالک OTP را وارد و تایید می‌کند → مالکیت شمش منتقل می‌شود:
   - `user_id` شمش به کاربر گیرنده تغییر می‌کند (اگر گیرنده حساب ندارد، ایجاد می‌شود)
   - رکورد OwnershipHistory ثبت می‌شود
   - رکورد BarTransfer با وضعیت Completed ثبت می‌شود

### آدرس‌ها (مشتری)

| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/my-bars` | لیست شمش‌های مشتری |
| GET | `/claim-bar` | فرم ثبت مالکیت |
| POST | `/claim-bar` | پردازش ثبت مالکیت |
| GET | `/my-bars/{bar_id}/transfer` | فرم انتقال مالکیت |
| POST | `/my-bars/{bar_id}/transfer` | ارسال OTP به مالک |
| POST | `/my-bars/{bar_id}/transfer/confirm` | تایید انتقال با OTP |

### تغییر در API نماینده (Dealer POS API)

| متد | مسیر | تغییر |
|------|------|--------|
| POST | `/api/dealer/sale` | پاسخ اکنون شامل `claim_code` در خروجی JSON است |

### فایل‌های مرتبط

| فایل | تغییرات |
|-------|---------|
| `modules/inventory/models.py` | فیلد `claim_code` در Bar + مدل جدید `BarTransfer` |
| `modules/order/models.py` | فیلد `is_gift` در Order |
| `modules/dealer/api_routes.py` | بازگشت `claim_code` در پاسخ فروش POS |
| `modules/dealer/service.py` | تولید خودکار `claim_code` هنگام فروش POS |
| route ثبت مالکیت / انتقال | صفحات claim-bar, my-bars, transfer |
| `templates/shop/` | قالب‌های claim_bar.html, my_bars.html, transfer.html |
| `templates/shop/base_shop.html` | لینک «ثبت شمش» در منوی کشویی کاربر + فوتر |
| `templates/shop/checkout.html` | چک‌باکس «خرید به‌عنوان هدیه» |
| `templates/admin/inventory/bars.html` | نمایش کد ثبت مالکیت زیر سریال‌کد (با آیکن کلید) |
| `templates/admin/inventory/edit_bar.html` | نمایش کد ثبت مالکیت در بخش اطلاعات سریع |

### دسترسی از رابط کاربری (Navigation)

مشتری از مسیرهای زیر به صفحه ثبت شمش دسترسی دارد:
- **منوی کشویی کاربر** (ناوبار): آیتم «ثبت شمش» با آیکن `bi-plus-circle`
- **فوتر سایت**: لینک «ثبت شمش» در بخش دسترسی سریع
- **صفحه شمش‌های من** (`/my-bars`): دکمه «ثبت شمش جدید» بالای صفحه + دکمه در حالت خالی

---

## 22. مدیریت کاربران (Customer Management)

**مسیر فایل‌ها**: `modules/admin/` (بخش مدیریت کاربران)

### شرح قابلیت

صفحه مدیریت کاربران در پنل مدیریت، امکان مشاهده لیست تمام مشتریان، جستجو، فیلتر وضعیت، مشاهده جزئیات هر مشتری (شامل کیف پول، سفارشات و برداشت‌ها) و **ویرایش اطلاعات مشتری** را فراهم می‌کند.

### لینک سایدبار

- آیکون: `bi-people` (مدیریت کاربران)
- مسیر: `/admin/customers`

### صفحه لیست مشتریان (`/admin/customers`)

- **کارت‌های آماری**: تعداد کل مشتریان، مشتریان فعال، ثبت‌نام امروز، مشتریان دارای سفارش
- **جستجو**: بر اساس نام، شماره موبایل، کد ملی
- **فیلتر وضعیت**: فعال / غیرفعال
- **جدول صفحه‌بندی‌شده**: نام مشتری، موبایل، کد ملی، تاریخ ثبت‌نام، وضعیت، تعداد سفارش

### صفحه جزئیات مشتری (`/admin/customers/{id}`)

چهار تب اطلاعاتی:

| تب | توضیح |
|-----|--------|
| **خلاصه (Overview)** | اطلاعات مشتری (نام، موبایل، کد ملی، تاریخ ثبت‌نام) + **فرم ویرایش inline** (نام، موبایل، کد ملی، نوع مشتری حقیقی/حقوقی، فیلدهای حقوقی، کد پستی، آدرس، تلفن، تاریخ تولد، وضعیت فعال/غیرفعال) + کارت‌های موجودی کیف پول (IRR + XAU_MG + XAG_MG) |
| **کیف پول (Wallet)** | لیست صفحه‌بندی‌شده تراکنش‌های حسابداری (LedgerEntry) — تراکنش‌های ریالی (IRR)، طلایی (XAU_MG) و نقره‌ای (XAG_MG) |
| **سفارشات (Orders)** | لیست صفحه‌بندی‌شده سفارشات مشتری با وضعیت، مبلغ، روش تحویل و تاریخ |
| **برداشت‌ها (Withdrawals)** | لیست صفحه‌بندی‌شده درخواست‌های برداشت مشتری با وضعیت (در انتظار / تایید / رد)، مبلغ و شماره شبا |

### آدرس‌ها

| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/admin/customers` | لیست مشتریان (جستجو + فیلتر وضعیت + صفحه‌بندی + کارت‌های آماری) |
| GET | `/admin/customers/{id}` | جزئیات مشتری (تب‌ها: خلاصه، کیف پول، سفارشات، برداشت‌ها) |
| POST | `/admin/customers/{id}` | ویرایش اطلاعات مشتری (نام، موبایل، کد ملی، نوع مشتری، وضعیت، فیلدهای حقوقی) — بررسی یکتایی موبایل و کد ملی + CSRF |

### دسترسی

| نقش | دسترسی |
|------|--------|
| Super Admin | ✅ |
| Operator | ✅ |
| Dealer | — |
| Customer | — |

### فایل‌های مرتبط

| فایل | توضیح |
|-------|--------|
| `modules/admin/routes.py` یا `modules/customer/admin_routes.py` | Route های مدیریت کاربران |
| `templates/admin/customers/list.html` | قالب لیست مشتریان |
| `templates/admin/customers/detail.html` | قالب جزئیات مشتری |
| `templates/admin/base_admin.html` | لینک سایدبار «مدیریت کاربران» با آیکون `bi-people` |

---

## 23. مدیریت دارایی و قیمت‌گذاری خودکار (Asset Price Management)

**مسیر فایل‌ها**: `modules/pricing/`

### شرح قابلیت

سیستم مدیریت دارایی (Asset) جایگزین ذخیره‌سازی قیمت طلا در `SystemSetting` شده و امکانات زیر را فراهم می‌کند:

- **بروزرسانی خودکار قیمت** از API گلدیس (goldis.ir) — دیفالت فعال
- **آستانه انقضای قیمت** (staleness guard): اگر قیمت بیش از حد آستانه به‌روز نشده باشد، خرید/فروش بلاک می‌شود
- **تنظیمات per-asset**: هر دارایی (طلا، نقره، ...) آستانه انقضا و بازه بروزرسانی مستقل خود را دارد
- **سوئیچ دستی/خودکار**: ادمین می‌تواند بروزرسانی خودکار را خاموش و قیمت را دستی وارد کند
- **هشدار قیمت قدیمی**: در فروشگاه و سبد خرید بنر هشدار نمایش داده می‌شود

### مدل: Asset

| فیلد | نوع | توضیح |
|-------|------|--------|
| `id` | Integer PK | شناسه |
| `asset_code` | String(30), unique | کد دارایی (`gold_18k`, `silver`) |
| `asset_label` | String(100) | نام فارسی دارایی |
| `price_per_gram` | BigInteger | قیمت فعلی (ریال بر گرم) |
| `stale_after_minutes` | Integer | آستانه انقضا (دقیقه) — پیش‌فرض: ۱۵ |
| `auto_update` | Boolean | بروزرسانی خودکار — پیش‌فرض: True |
| `update_interval_minutes` | Integer | بازه بروزرسانی (دقیقه) — پیش‌فرض: ۵ |
| `source_url` | String | آدرس API منبع قیمت |
| `updated_at` | DateTime(tz) | زمان آخرین بروزرسانی |
| `updated_by` | String | عامل بروزرسانی (`system:goldis` یا `admin:username`) |

### محل‌های بلاک شدن (Staleness Guard)

> **نکته مهم**: بررسی تازگی قیمت **per-metal** انجام می‌شود. یعنی اگر قیمت نقره منقضی شده باشد ولی طلا تازه باشد، فقط عملیات مربوط به محصولات نقره‌ای بلاک می‌شود. در سفارشات مختلط (طلا + نقره)، تازگی **هر دو** فلز بررسی می‌شود.

| ماژول | تابع | رفتار |
|--------|--------|--------|
| `order/service.py` | `checkout()` | بررسی تازگی قیمت فلز هر محصول در سبد — خطا: «قیمت به‌روز نیست» |
| `dealer/service.py` | `create_pos_sale()` | بررسی تازگی قیمت فلز محصول شمش — خطا: «قیمت به‌روز نیست» |
| `pos/service.py` | `reserve_bar()` / `confirm_sale()` | بررسی تازگی قیمت فلز محصول — خطا: «قیمت به‌روز نیست» |
| `wallet/service.py` | `convert_rial_to_gold()` / `convert_gold_to_rial()` | خطا: «قیمت به‌روز نیست» |

### محل‌های نمایش هشدار (Display-only)

| ماژول | صفحه | هشدار |
|--------|--------|--------|
| `shop/routes.py` | صفحه اصلی + جزئیات محصول | بنر زرد: «قیمت‌ها ممکن است به‌روز نباشند» |
| `cart/routes.py` | سبد خرید + چک‌اوت | بنر زرد |

### بروزرسانی خودکار (Scheduler)

- یک job هر ۶۰ ثانیه اجرا می‌شود
- برای هر Asset با `auto_update=True` بررسی می‌کند آیا از آخرین بروزرسانی به اندازه `update_interval_minutes` گذشته
- در صورت نیاز، از API مربوطه (goldis.ir برای طلا) قیمت جدید دریافت و ذخیره می‌کند

### آدرس‌های جدید

| متد | مسیر | توضیح |
|------|------|--------|
| POST | `/admin/settings/fetch-price` | بروزرسانی دستی قیمت (AJAX) — JSON body: `{"asset_code": "gold_18k"}` |

### دارایی‌های seed

| کد | نام | خودکار | بازه | آستانه انقضا |
|-----|------|---------|------|-------------|
| `gold_18k` | طلای ۱۸ عیار | ✅ (از goldis.ir) | ۵ دقیقه | ۱۵ دقیقه |
| `silver` | نقره | ❌ (دستی) | — | ۳۰ دقیقه |

### فایل‌های مرتبط

| فایل | توضیح |
|-------|--------|
| `modules/pricing/models.py` | مدل Asset + ثابت‌های GOLD_18K, SILVER |
| `modules/pricing/feed_service.py` | دریافت قیمت از goldis.ir API |
| `modules/pricing/service.py` | توابع `get_price_value`, `is_price_fresh`, `require_fresh_price`, `update_asset_price`, `get_product_pricing` |
| `main.py` | job زمان‌بند `_auto_update_prices` |
| `templates/admin/settings.html` | UI مدیریت دارایی‌ها |
| `templates/shop/base_shop.html` | بنر هشدار قیمت قدیمی |

---

## 24. چند درگاه پرداخت (Multi-Gateway Payment)

**مسیر فایل‌ها**: `modules/payment/gateways/`

### شرح قابلیت

سیستم پرداخت از معماری **چند درگاه** با لایه انتزاعی (abstraction layer) استفاده می‌کند. ادمین می‌تواند از صفحه تنظیمات، درگاه فعال را انتخاب کند و بدون تغییر کد، بین درگاه‌ها جابه‌جا شود.

### معماری

- **BaseGateway**: کلاس پایه انتزاعی با متدهای `request_payment(amount, callback_url, order_id)` و `verify_payment(request_data)`
- **GATEWAY_REGISTRY**: دیکشنری ثبت درگاه‌ها — کلید: نام درگاه (string)، مقدار: کلاس gateway
- **SystemSetting `active_gateway`**: تعیین درگاه فعال — مقادیر مجاز: `zibal`, `sepehr`, `top`, `parsian`
- **توابع عمومی**: `create_gateway_payment()` و `verify_gateway_callback()` در `payment/service.py`

### فایل‌ها

| فایل | توضیح |
|-------|--------|
| `modules/payment/gateways/__init__.py` | BaseGateway + GATEWAY_REGISTRY + get_active_gateway() |
| `modules/payment/gateways/zibal.py` | پیاده‌سازی درگاه زیبال (REST) |
| `modules/payment/gateways/sepehr.py` | پیاده‌سازی درگاه سپهر (REST) |
| `modules/payment/gateways/top.py` | پیاده‌سازی درگاه تاپ (REST) |
| `modules/payment/gateways/parsian.py` | پیاده‌سازی درگاه پارسیان (SOAP via zeep) |
| `modules/payment/service.py` | توابع عمومی create/verify gateway payment |

### تنظیم درگاه فعال

ادمین از صفحه تنظیمات (`/admin/settings`) در بخش dropdown «درگاه پرداخت فعال» درگاه مورد نظر را انتخاب می‌کند. تغییر فوری اعمال می‌شود و پرداخت‌های بعدی (هم سفارشات و هم شارژ کیف پول) از درگاه جدید استفاده می‌کنند.

### مدل تغییرات

- **WalletTopup**: فیلد `gateway` (String) اضافه شده — نام درگاهی که topup با آن انجام شده
- **SystemSetting**: کلید `active_gateway` با مقدار پیش‌فرض `zibal`

### env vars

| متغیر | توضیح |
|--------|--------|
| `ZIBAL_MERCHANT` | شناسه مرچنت زیبال (`zibal` = sandbox) |
| `SEPEHR_TERMINAL_ID` | شناسه ترمینال سپهر |
| `TOP_USERNAME` | نام کاربری درگاه تاپ |
| `TOP_PASSWORD` | رمز عبور درگاه تاپ |
| `PARSIAN_PIN` | پین درگاه پارسیان |

---

## 25. درخواست نمایندگی (Dealer Request)

**مسیر فایل‌ها**: `modules/dealer_request/`

### شرح قابلیت

مشتریان می‌توانند از طریق فرم عمومی درخواست نمایندگی ثبت کنند. ادمین/اپراتور درخواست‌ها را بررسی کرده و تایید، رد، یا **درخواست اصلاح (Revision)** می‌کند. در صورت درخواست اصلاح، مشتری می‌تواند اطلاعات را ویرایش و مجدد ارسال کند.

### مدل‌ها

#### DealerRequest (درخواست نمایندگی)
- `user_id` (FK → users): کاربر درخواست‌دهنده
- `first_name`, `last_name`: نام و نام خانوادگی
- `mobile`: شماره تماس
- `birth_date`: تاریخ تولد (فرمت شمسی)
- `email`: ایمیل (اختیاری)
- `gender`: جنسیت (male/female)
- `province_id` (FK → geo_provinces), `city_id` (FK → geo_cities): موقعیت جغرافیایی
- `status`: وضعیت درخواست (enum: Pending / Approved / Rejected / RevisionNeeded)
- `admin_note`: یادداشت ادمین (الزامی برای بازبینی)
- `created_at`, `updated_at`
- Properties: `full_name`, `status_label`, `status_color`, `gender_label`, `province_name`, `city_name`
- Relationships: `user`, `province`, `city`, `attachments`

#### DealerRequestAttachment (پیوست درخواست)
- `dealer_request_id` (FK → dealer_requests, CASCADE)
- `file_path`: مسیر فایل آپلود‌شده
- `original_filename`: نام اصلی فایل
- حداکثر ۵ فایل به هر درخواست قابل پیوست است

### وضعیت‌ها (DealerRequestStatus)

| وضعیت | مقدار | برچسب فارسی | رنگ | توضیح |
|--------|-------|-------------|------|--------|
| PENDING | `Pending` | در انتظار بررسی | warning | درخواست جدید یا اصلاح‌شده |
| APPROVED | `Approved` | تایید شده | success | ادمین تایید کرده |
| REJECTED | `Rejected` | رد شده | danger | ادمین رد کرده |
| REVISION_NEEDED | `RevisionNeeded` | نیاز به اصلاح | info | ادمین بازبینی خواسته — مشتری می‌تواند ویرایش و ارسال مجدد کند |

### جریان درخواست نمایندگی

```
مشتری ثبت درخواست
    │
    ▼
 Pending (در انتظار بررسی)
    │
    ├── ادمین تایید ──▶ Approved
    │
    ├── ادمین رد ──▶ Rejected
    │
    └── ادمین درخواست اصلاح ──▶ RevisionNeeded
                                    │
                                    ▼
                              مشتری ویرایش و ارسال مجدد
                                    │
                                    ▼
                                 Pending (مجدد)
```

### قابلیت‌های مشتری
1. **ثبت درخواست**: فرم با اطلاعات شخصی + موقعیت جغرافیایی + آپلود مدارک
2. **مشاهده وضعیت**: صفحه وضعیت با رنگ و برچسب فارسی
3. **ویرایش و ارسال مجدد**: فقط وقتی وضعیت RevisionNeeded باشد، مشتری می‌تواند فرم را ویرایش و مجدد ارسال کند (با `?edit=1`)
4. **مشاهده یادداشت ادمین**: در صفحه وضعیت، یادداشت ادمین نمایش داده می‌شود

### قابلیت‌های ادمین
1. **لیست درخواست‌ها**: با فیلتر تب‌ها (همه / در انتظار / تایید‌شده / رد‌شده / نیاز به اصلاح) + جستجو + آمار تجمیعی
2. **جزئیات درخواست**: مشاهده اطلاعات کامل + پیوست‌ها
3. **تایید**: فقط درخواست‌های Pending قابل تایید (با یادداشت اختیاری)
4. **رد**: فقط درخواست‌های Pending قابل رد (با یادداشت اختیاری)
5. **درخواست اصلاح**: فقط درخواست‌های Pending — ادمین یادداشت (دلیل اصلاح) وارد می‌کند و وضعیت به RevisionNeeded تغییر می‌کند

### آدرس‌های مشتری
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/dealer-request` | فرم ثبت درخواست یا صفحه وضعیت (بسته به وجود درخواست فعال) |
| GET | `/dealer-request?edit=1` | فرم ویرایش درخواست (فقط وقتی وضعیت RevisionNeeded باشد) |
| POST | `/dealer-request` | ثبت درخواست جدید یا ارسال مجدد درخواست اصلاح‌شده |

### آدرس‌های ادمین
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/admin/dealer-requests` | لیست درخواست‌ها (فیلتر + جستجو + آمار) |
| GET | `/admin/dealer-requests/{id}` | جزئیات درخواست + پیوست‌ها |
| POST | `/admin/dealer-requests/{id}/approve` | تایید درخواست |
| POST | `/admin/dealer-requests/{id}/revision` | درخواست اصلاح (admin_note الزامی) |
| POST | `/admin/dealer-requests/{id}/reject` | رد درخواست |

---

## 26. ماژول نظرات و پرسش‌وپاسخ (Review & Comments)

**مسیر فایل‌ها**: `modules/review/`

### شرح قابلیت

سیستم نظرات ستاره‌ای (از صفحه سفارش) و پرسش‌وپاسخ (از صفحه محصول). مشتریان می‌توانند پس از خرید، نظر خود را با امتیاز ستاره‌ای ثبت کنند و همچنین در صفحه محصول سوال یا نظر بگذارند. ادمین/اپراتور نظرات و کامنت‌ها را مدیریت و پاسخ می‌دهد.

### مدل‌ها

#### Review (نظر ستاره‌ای)
- نظرات مشتریان بر اساس سفارش‌های انجام‌شده
- شامل امتیاز ستاره‌ای (۱ تا ۵)
- قابلیت آپلود تصویر

#### ReviewImage (تصویر نظر)
- تصاویر پیوست‌شده به نظرات ستاره‌ای

#### ProductComment (نظر/پرسش محصول)
- نظرات و پرسش‌های مشتریان در صفحه محصول
- قابلیت پاسخ ادمین

#### CommentImage (تصویر کامنت)
- تصاویر پیوست‌شده به کامنت‌های محصول

#### CommentLike (لایک کامنت)
- لایک/آنلایک نظرات توسط مشتریان

### آدرس‌های مشتری

| متد | مسیر | توضیح |
|------|------|--------|
| POST | `/reviews/submit` | ثبت نظر با امتیاز ستاره‌ای (از صفحه سفارش) |
| POST | `/reviews/comment` | ثبت نظر/پرسش در صفحه محصول |
| POST | `/reviews/comment/{id}/like` | لایک/آنلایک نظر (AJAX) |

### آدرس‌های ادمین

| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/admin/reviews` | لیست نظرات و کامنت‌ها (تب‌ها: نظرات/کامنت‌ها) |
| GET | `/admin/reviews/comment/{id}` | جزئیات کامنت |
| GET | `/admin/reviews/review/{id}` | جزئیات نظر |
| POST | `/admin/reviews/comment/{id}/reply` | پاسخ ادمین به کامنت |
| POST | `/admin/reviews/review/{id}/reply` | پاسخ ادمین به نظر |
| POST | `/admin/reviews/comment/{id}/delete` | حذف کامنت |
| POST | `/admin/reviews/review/{id}/delete` | حذف نظر |

### دسترسی

| نقش | دسترسی |
|------|--------|
| مشتری (لاگین‌شده) | ثبت نظر ستاره‌ای، ثبت کامنت/پرسش، لایک/آنلایک |
| ادمین / اپراتور | مشاهده لیست، جزئیات، پاسخ، حذف |

---

## 27. API دستگاه POS مشتری‌محور (Customer-Facing POS API)

**مسیر فایل‌ها**: `modules/dealer/` (endpointهای POS مشتری‌محور)

### شرح قابلیت

API مشتری‌محور برای دستگاه‌های POS با الگوی **Reserve → Confirm / Cancel** (رزرو → تایید / لغو). برخلاف API نماینده (بخش ۱۶) که فروش تک‌مرحله‌ای است، این API فروش را به دو مرحله تقسیم می‌کند: ابتدا شمش رزرو می‌شود (۲ دقیقه hold)، سپس پس از دریافت پرداخت، فروش تایید یا لغو می‌شود.

### تفاوت با API نماینده (بخش ۱۶)

| ویژگی | API نماینده (بخش ۱۶) | API دستگاه POS مشتری‌محور |
|--------|----------------------|---------------------------|
| الگوی فروش | تک‌مرحله‌ای (ثبت مستقیم) | دو مرحله‌ای (رزرو + تایید) |
| زمان رزرو | — | ۲ دقیقه hold |
| لغو خودکار | — | پس از انقضای رزرو |
| دسته‌بندی‌ها | — | endpoint جداگانه با موجودی |

### احراز هویت

- **هدر**: `X-API-Key`
- **کلید**: همان API Key نماینده (مشترک با API بخش ۱۶)

### آدرس‌ها

| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/api/pos/categories` | دسته‌بندی‌ها با تعداد موجودی هر دسته |
| GET | `/api/pos/products?category_id=X` | محصولات با قیمت لحظه‌ای (فیلتر بر اساس دسته‌بندی) |
| POST | `/api/pos/reserve` | رزرو شمش (۲ دقیقه hold — وضعیت شمش به RESERVED تغییر می‌کند) |
| POST | `/api/pos/confirm` | تایید فروش بعد از دریافت پرداخت (نهایی‌سازی فروش) |
| POST | `/api/pos/cancel` | لغو رزرو (آزادسازی شمش) |
| GET | `/api/pos/receipt/{sale_id}` | دریافت دیتای رسید فروش |

### جریان فروش POS مشتری‌محور

```
دستگاه POS: GET /api/pos/categories
    │
    ▼
دستگاه POS: GET /api/pos/products?category_id=X
    │
    ▼
دستگاه POS: POST /api/pos/reserve (serial_code + customer info)
    │
    ├── موفق → شمش RESERVED (۲ دقیقه hold)
    │       │
    │       ├── پرداخت موفق → POST /api/pos/confirm → فروش نهایی
    │       │
    │       ├── لغو دستی → POST /api/pos/cancel → آزادسازی شمش
    │       │
    │       └── انقضای ۲ دقیقه → لغو خودکار → آزادسازی شمش
    │
    └── خطا → پیام خطا (شمش ناموجود، قیمت منقضی، و غیره)
```

### دسترسی

| نقش | دسترسی |
|------|--------|
| نماینده (با API Key معتبر) | دسترسی کامل به تمام endpointها |

---

## 28. یکپارچه‌سازی دستگاه POS راسیس (Rasis POS Integration)

**مسیر فایل‌ها**: `modules/rasis/`

### شرح قابلیت

ماژول Rasis POS امکان همگام‌سازی خودکار موجودی شمش و قیمت‌گذاری لحظه‌ای با دستگاه‌های POS راسیس مستقر در محل نمایندگان را فراهم می‌کند. هر نماینده‌ای که فیلد `rasis_sharepoint` روی مدل User تنظیم شده باشد، به یک دستگاه POS راسیس متصل است.

### مکانیزم‌ها

- **Auto-sync موجودی**: هنگام تخصیص شمش به نماینده (`inventory/service.py`)، کالا به‌صورت خودکار در دستگاه POS اضافه می‌شود
- **حذف خودکار پس از فروش**: هنگام فروش شمش (`dealer/service.py` فروش POS، `pos/service.py` تایید POS، `order/service.py` نهایی‌سازی سفارش)، کالا از دستگاه POS حذف می‌شود
- **همگام‌سازی قیمت**: Scheduler پس‌زمینه هر ۵ دقیقه قیمت‌های به‌روز را به تمام دستگاه‌های راسیس فعال ارسال می‌کند (`_rasis_price_sync`)
- **همگام‌سازی دستی**: ادمین می‌تواند از صفحه ویرایش نماینده، همگام‌سازی کامل (full sync) را به‌صورت دستی اجرا کند

### تنظیمات

| تنظیم | نوع | توضیح |
|--------|------|--------|
| `rasis_pos_enabled` | SystemSetting | فعال/غیرفعال‌سازی کل ماژول Rasis (از تنظیمات ادمین) |
| `RASIS_API_URL` | ENV | آدرس API سرویس راسیس |
| `RASIS_USERNAME` | ENV | نام کاربری احراز هویت راسیس |
| `RASIS_PASSWORD` | ENV | رمز عبور احراز هویت راسیس |
| `rasis_sharepoint` | User field (dealer) | شناسه Sharepoint راسیس مرتبط با نماینده (Integer, nullable) |

### فایل‌ها و سرویس‌ها

| فایل | توضیح |
|-------|--------|
| `modules/rasis/service.py` | RasisService — سرویس اصلی ارتباط با API راسیس |

### هوک‌ها (Integration Points)

| محل | رویداد | عملکرد |
|------|--------|--------|
| `inventory/service.py` | تخصیص شمش به نماینده (bar assign) | افزودن کالا به دستگاه POS |
| `dealer/service.py` | فروش POS نماینده (POS sale) | حذف کالا از دستگاه POS |
| `pos/service.py` | تایید فروش POS مشتری‌محور (POS confirm) | حذف کالا از دستگاه POS |
| `order/service.py` | نهایی‌سازی سفارش آنلاین (order finalize) | حذف کالا از دستگاه POS |
| Background Scheduler | هر ۵ دقیقه (`_rasis_price_sync`) | بروزرسانی قیمت در همه دستگاه‌ها |

### آدرس‌ها

| متد | مسیر | توضیح |
|------|------|--------|
| POST | `/admin/dealers/{id}/rasis-sync` | همگام‌سازی کامل دستی موجودی + قیمت نماینده با دستگاه POS |

### دسترسی

| نقش | دسترسی |
|------|--------|
| Super Admin | فعال/غیرفعال‌سازی ماژول + همگام‌سازی دستی |
| Operator | همگام‌سازی دستی (از صفحه ویرایش نماینده) |
| نماینده | — (خودکار، بدون دسترسی مستقیم) |
| مشتری | — |

---

## 29. پنل پیشرفته نماینده — زیرنمایندگان و سفارش عمده (Dealer Portal Enhancement — Phase 21)

**مسیر فایل‌ها**: `modules/dealer/`

### شرح قابلیت

فاز ۲۱ شامل سه قابلیت اصلی برای ارتقای پنل نمایندگان است:

#### ۱. زیرنمایندگان (Sub-Dealer Hierarchy)
- نماینده والد می‌تواند زیرنمایندگانی داشته باشد (single-level — فقط یک سطح)
- هر زیرنماینده حداکثر یک والد دارد
- هنگام فروش POS توسط زیرنماینده، سود فلزی (`metal_profit_mg`) تقسیم می‌شود:
  - X% (تنظیم‌شده در `commission_split_percent`) به کیف پول فلز نماینده والد
  - بقیه به کیف پول فلز زیرنماینده
- ادمین رابطه زیرنمایندگی را ایجاد و مدیریت می‌کند
- نماینده والد می‌تواند لیست زیرنمایندگان و آمار فروش آنها را مشاهده کند

#### ۲. سفارش عمده نمایندگان (B2B Orders)
- نمایندگان می‌توانند سفارش عمده شمش از انبار مرکزی ثبت کنند
- قیمت‌گذاری بر اساس سطح نماینده (DealerTier) — اجرت کمتر از مشتری نهایی
- **چرخه عمر سفارش**: Submitted → Approved → Paid → Fulfilled (یا Rejected/Cancelled)
- **پرداخت**: فقط از کیف پول ریالی (wallet-only). درگاه بانکی پشتیبانی نمی‌شود
- **تایید ادمین**: الزامی قبل از پرداخت — ادمین موجودی و قیمت را بررسی می‌کند
- **تحویل (Fulfill)**: ادمین شمش‌ها را به نماینده تخصیص می‌دهد (bar assign)

#### ۳. موجودی نماینده (Dealer Inventory View)
- نماینده می‌تواند لیست شمش‌های تخصیص‌یافته به خود (وضعیت ASSIGNED) را مشاهده کند
- نمایش جزئیات محصول، سریال‌کد، وزن، عیار و قیمت لحظه‌ای

### مدل‌ها

| مدل | جدول | توضیح |
|------|-------|--------|
| SubDealerRelation | `sub_dealer_relations` | رابطه والد-فرزند بین نمایندگان + درصد تقسیم سود |
| B2BOrder | `b2b_orders` | سفارش عمده نماینده (header) |
| B2BOrderItem | `b2b_order_items` | آیتم‌های سفارش عمده (محصول + تعداد + قیمت واحد) |

### آدرس‌ها (نماینده)

| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/dealer/inventory` | موجودی شمش نماینده |
| GET | `/dealer/sub-dealers` | لیست زیرنمایندگان + آمار فروش |
| GET | `/dealer/b2b-orders/new` | فرم ثبت سفارش عمده |
| POST | `/dealer/b2b-orders/new` | ثبت سفارش عمده جدید |
| GET | `/dealer/b2b-orders` | لیست سفارشات عمده |
| GET | `/dealer/b2b-orders/{id}` | جزئیات سفارش عمده |
| POST | `/dealer/b2b-orders/{id}/pay` | پرداخت از کیف پول |
| POST | `/dealer/b2b-orders/{id}/cancel` | لغو سفارش (فقط قبل از پرداخت) |

### آدرس‌ها (ادمین)

| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/admin/dealers/{id}/sub-dealers` | لیست زیرنمایندگان یک نماینده |
| POST | `/admin/dealers/{id}/sub-dealers/add` | افزودن زیرنماینده |
| POST | `/admin/dealers/{id}/sub-dealers/deactivate` | غیرفعال‌سازی رابطه زیرنمایندگی |
| GET | `/admin/dealers/b2b-orders` | لیست سفارشات عمده (فیلتر: نماینده، وضعیت) |
| GET | `/admin/dealers/b2b-orders/{id}` | جزئیات سفارش عمده |
| POST | `/admin/dealers/b2b-orders/{id}/approve` | تایید سفارش عمده |
| POST | `/admin/dealers/b2b-orders/{id}/reject` | رد سفارش عمده |
| POST | `/admin/dealers/b2b-orders/{id}/fulfill` | تحویل — تخصیص شمش به نماینده |

### دسترسی

| نقش | دسترسی |
|------|--------|
| Super Admin | مدیریت کامل زیرنمایندگان + سفارشات عمده (تایید/رد/تحویل) |
| Operator | مدیریت زیرنمایندگان + سفارشات عمده (با مجوز `dealers`) |
| نماینده | مشاهده موجودی + زیرنمایندگان + ثبت/پرداخت/لغو سفارش عمده |
| مشتری | — |

---

## 30. انبارگردانی پیشرفته و رهگیری فیزیکی (Advanced Inventory & Physical Tracking — Phase 22)

**مسیر فایل‌ها**: `modules/inventory/` + `modules/dealer/routes.py` + `modules/ownership/routes.py` + `static/js/scanner.js` + `templates/components/scanner_modal.html`

### شرح قابلیت

فاز ۲۲ شامل چهار قابلیت اصلی برای ارتقای مدیریت موجودی و رهگیری فیزیکی شمش است:

#### ۱. اسکنر شمش (TmScanner — Bar Scanner)
- کامپوننت اسکنر مشترک (`scanner_modal.html` + `scanner.js`) برای اسکن QR/بارکد شمش
- پشتیبانی از دوربین (html5-qrcode) و اسکنر USB (شبیه‌سازی کیبورد)
- ورودی دستی سریال‌کد به‌عنوان fallback
- استخراج خودکار سریال از URL الگوهایی مانند `?code=XXXX` یا `?serial=XXXX`
- جلوگیری از اسکن تکراری (cooldown 2 ثانیه)
- قابل استفاده در پنل ادمین (`/api/admin/bars/lookup`) و پنل نماینده (`/dealer/scan/lookup`)

#### ۲. انبارگردانی (Reconciliation — موجودی‌شماری)
- شروع جلسه انبارگردانی برای یک نماینده/انبار خاص
- اسکن شمش‌ها طی جلسه → ثبت وضعیت هر شمش:
  - **Matched**: شمش در سیستم وجود دارد و در همین لوکیشن ثبت شده
  - **Missing**: شمش در سیستم این لوکیشن ثبت شده ولی اسکن نشده
  - **Unexpected**: شمش اسکن شده ولی در سیستم این لوکیشن ثبت نیست
- نهایی‌سازی جلسه: محاسبه آمار تجمیعی (تعداد مورد انتظار، اسکن‌شده، تطابق، مفقود، اضافی)
- لغو جلسه
- دسترسی: ادمین (برای همه نمایندگان) + نماینده (فقط برای انبار خودش)

#### ۳. تحویل امانی (Custodial Delivery)
- مشتری می‌تواند برای شمش‌های امانی (SOLD + `delivered_at IS NULL`) درخواست تحویل فیزیکی ثبت کند
- انتخاب نماینده/لوکیشن تحویل توسط مشتری
- تایید تحویل با OTP: مشتری OTP دریافت می‌کند → نماینده OTP + سریال‌کد را وارد می‌کند
- پس از تایید: `delivered_at` مقداردهی + وضعیت درخواست → Completed
- لغو درخواست توسط مشتری (قبل از تحویل)
- **چرخه عمر**: Pending → (OTP ارسال) → Completed یا Cancelled/Expired

#### ۴. رهگیری نوع انتقال (Transfer Audit Trail)
- مدل `TransferType` (enum) برای ثبت دلیل هر جابجایی فیزیکی شمش:
  - `Manual`: انتقال دستی ادمین
  - `B2BFulfillment`: تحویل سفارش عمده
  - `AdminTransfer`: انتقال ادمین
  - `Reconciliation`: تعدیل ناشی از انبارگردانی
  - `CustodialDelivery`: تحویل امانی به مشتری
  - `Return`: بازگشت به انبار
- فیلدهای `transfer_type`، `reference_type` و `reference_id` به مدل `DealerTransfer` اضافه شده
- نمایش بج نوع انتقال در صفحه جزئیات شمش ادمین

### مدل‌ها

| مدل | جدول | توضیح |
|------|-------|--------|
| TransferType | — (enum) | دلیل جابجایی فیزیکی شمش (Manual, B2BFulfillment, AdminTransfer, Reconciliation, CustodialDelivery, Return) |
| ReconciliationSession | `reconciliation_sessions` | جلسه انبارگردانی (نماینده + وضعیت + آمار تجمیعی) |
| ReconciliationItem | `reconciliation_items` | آیتم‌های اسکن‌شده در جلسه (سریال + وضعیت تطابق + snapshot) |
| ReconciliationStatus | — (enum) | InProgress / Completed / Cancelled |
| ReconciliationItemStatus | — (enum) | Matched / Missing / Unexpected |
| CustodialDeliveryRequest | `custodial_delivery_requests` | درخواست تحویل امانی مشتری (OTP + وضعیت + ردیابی) |
| CustodialDeliveryStatus | — (enum) | Pending / Completed / Cancelled / Expired |

### آدرس‌ها (ادمین)

| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/api/admin/bars/lookup?serial=X` | جستجوی شمش با سریال (AJAX — اسکنر ادمین) |
| GET | `/admin/reconciliation` | لیست جلسات انبارگردانی |
| POST | `/admin/reconciliation/start` | شروع جلسه انبارگردانی جدید (انتخاب نماینده) |
| GET | `/admin/reconciliation/{session_id}` | جزئیات جلسه انبارگردانی + اسکنر |
| POST | `/admin/reconciliation/{session_id}/scan` | اسکن شمش در جلسه انبارگردانی |
| POST | `/admin/reconciliation/{session_id}/finalize` | نهایی‌سازی جلسه (محاسبه مفقودها) |
| POST | `/admin/reconciliation/{session_id}/cancel` | لغو جلسه انبارگردانی |

### آدرس‌ها (نماینده)

| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/dealer/scan/lookup?serial=X` | جستجوی شمش با سریال (AJAX — اسکنر نماینده) |
| GET | `/dealer/reconciliation` | لیست جلسات انبارگردانی نماینده |
| POST | `/dealer/reconciliation/start` | شروع جلسه انبارگردانی (فقط انبار خود نماینده) |
| GET | `/dealer/reconciliation/{session_id}` | جزئیات جلسه انبارگردانی |
| POST | `/dealer/reconciliation/{session_id}/scan` | اسکن شمش در جلسه |
| POST | `/dealer/reconciliation/{session_id}/finalize` | نهایی‌سازی جلسه |
| POST | `/dealer/reconciliation/{session_id}/cancel` | لغو جلسه |
| GET | `/dealer/deliveries` | لیست درخواست‌های تحویل امانی برای این نماینده |
| GET | `/dealer/deliveries/{req_id}` | جزئیات درخواست تحویل امانی |
| POST | `/dealer/deliveries/{req_id}/confirm` | تایید تحویل با OTP + سریال‌کد |

### آدرس‌ها (مشتری)

| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/my-bars/{bar_id}/delivery` | صفحه درخواست تحویل امانی (انتخاب نماینده) |
| POST | `/my-bars/{bar_id}/delivery` | ثبت درخواست تحویل امانی |
| POST | `/my-bars/{bar_id}/delivery/{req_id}/send-otp` | ارسال OTP تایید تحویل به مشتری |
| POST | `/my-bars/{bar_id}/delivery/{req_id}/cancel` | لغو درخواست تحویل |

### دسترسی

| نقش | دسترسی |
|------|--------|
| Super Admin | اسکنر شمش + انبارگردانی (همه نمایندگان) + مشاهده بج نوع انتقال |
| Operator | اسکنر شمش + انبارگردانی (با مجوز `inventory`) + مشاهده بج نوع انتقال |
| نماینده | اسکنر شمش (انبار خود) + انبارگردانی (انبار خود) + تایید تحویل امانی |
| مشتری | درخواست تحویل امانی + لغو درخواست + ارسال OTP |

---

## 31. سطح‌بندی فعال/غیرفعال خرید و فروش — Trade Guard

### شرح قابلیت

سیستم **Trade Guard** به ادمین امکان می‌دهد خرید و فروش هر فلز گرانبها (طلا، نقره) را به‌تفکیک کانال فروش فعال یا غیرفعال کند. این سیستم ۱۴ سوئیچ مستقل (۷ کانال × ۲ فلز) ارائه می‌دهد که از طریق صفحه تنظیمات ادمین قابل مدیریت هستند.

**ماژول**: `modules/pricing/trade_guard.py`

### کانال‌های فروش (Channels)

| کانال | کلید | توضیح |
|--------|------|--------|
| فروشگاه آنلاین | `shop` | خرید شمش از فروشگاه وب |
| کیف پول — خرید | `wallet_buy` | تبدیل ریال به فلز (خرید از کیف پول) |
| کیف پول — فروش | `wallet_sell` | تبدیل فلز به ریال (فروش از کیف پول) |
| پوز نماینده | `dealer_pos` | فروش حضوری توسط نماینده |
| پوز فروشگاهی (مشتری‌محور) | `customer_pos` | فروش از طریق API دستگاه POS مشتری‌محور |
| سفارش عمده B2B | `b2b_order` | سفارش عمده نمایندگان |
| بازخرید | `buyback` | بازخرید شمش توسط نماینده |

### الگوی کلید تنظیمات (SystemSetting)

هر سوئیچ یک رکورد در جدول `system_settings` است با الگوی نام‌گذاری:

```
{metal}_{channel}_enabled
```

**مثال‌ها:**

| کلید | فلز | کانال | پیش‌فرض |
|------|------|--------|---------|
| `gold_shop_enabled` | طلا | فروشگاه | `true` |
| `gold_wallet_buy_enabled` | طلا | کیف پول خرید | `true` |
| `gold_wallet_sell_enabled` | طلا | کیف پول فروش | `true` |
| `gold_dealer_pos_enabled` | طلا | پوز نماینده | `true` |
| `gold_customer_pos_enabled` | طلا | پوز فروشگاهی | `true` |
| `gold_b2b_order_enabled` | طلا | سفارش عمده | `true` |
| `gold_buyback_enabled` | طلا | بازخرید | `true` |
| `silver_shop_enabled` | نقره | فروشگاه | `true` |
| `silver_wallet_buy_enabled` | نقره | کیف پول خرید | `true` |
| `silver_wallet_sell_enabled` | نقره | کیف پول فروش | `true` |
| `silver_dealer_pos_enabled` | نقره | پوز نماینده | `true` |
| `silver_customer_pos_enabled` | نقره | پوز فروشگاهی | `true` |
| `silver_b2b_order_enabled` | نقره | سفارش عمده | `true` |
| `silver_buyback_enabled` | نقره | بازخرید | `true` |

> **پیش‌فرض**: در صورت نبود کلید در دیتابیس، تمام کانال‌ها **فعال** (`true`) در نظر گرفته می‌شوند.

### توابع سرویس

| تابع | ورودی | خروجی | توضیح |
|-------|--------|--------|--------|
| `is_trade_enabled(db, metal, channel)` | `db: Session`, `metal: str`, `channel: str` | `bool` | بررسی فعال بودن کانال خاص برای فلز خاص |
| `require_trade_enabled(db, metal, channel)` | `db: Session`, `metal: str`, `channel: str` | — (raises `HTTPException 403`) | بررسی + بلاک در صورت غیرفعال بودن |
| `get_all_trade_status(db)` | `db: Session` | `dict` | وضعیت تمام ۱۴ سوئیچ (برای نمایش در ماتریس ادمین) |

### اجرا در سطح سرویس (Enforcement Points)

سیستم Trade Guard در نقاط زیر اعمال می‌شود:

| کانال | محل اجرا | رفتار در صورت غیرفعال بودن |
|--------|----------|---------------------------|
| `shop` | Checkout (ثبت سفارش) | بلاک با خطای ۴۰۳ |
| `wallet_buy` | `POST /wallet/{asset_type}/buy` | بلاک با خطای ۴۰۳ |
| `wallet_sell` | `POST /wallet/{asset_type}/sell` | بلاک با خطای ۴۰۳ |
| `dealer_pos` | `POST /dealer/pos` + `POST /api/dealer/sale` | بلاک با خطای ۴۰۳ |
| `customer_pos` | `POST /api/pos/reserve` | بلاک با خطای ۴۰۳ |
| `b2b_order` | `POST /dealer/b2b-orders/new` | بلاک با خطای ۴۰۳ |
| `buyback` | `POST /dealer/buyback` | بلاک با خطای ۴۰۳ |

### رابط کاربری ادمین

در صفحه تنظیمات ادمین (`/admin/settings`) یک **ماتریس سوئیچ** نمایش داده می‌شود:

- ردیف‌ها: کانال‌های فروش (۷ کانال)
- ستون‌ها: فلزات (طلا، نقره)
- هر سلول: یک toggle switch (فعال/غیرفعال)
- ذخیره‌سازی همراه با سایر تنظیمات سیستم

### فایل‌های مرتبط

| فایل | توضیح |
|------|--------|
| `modules/pricing/trade_guard.py` | سرویس Trade Guard (توابع اصلی) |
| `modules/admin/routes.py` | صفحه تنظیمات (GET/POST — شامل ماتریس toggle) |
| `modules/wallet/routes.py` | اعمال guard در خرید/فروش فلز |
| `modules/cart/routes.py` | اعمال guard در checkout |
| `modules/dealer/routes.py` | اعمال guard در POS و بازخرید و B2B |
| `modules/pos/routes.py` | اعمال guard در POS مشتری‌محور |
| `templates/admin/settings.html` | قالب ماتریس سوئیچ |

### دسترسی

| نقش | دسترسی |
|------|--------|
| Super Admin | مشاهده و تغییر تمام سوئیچ‌ها در صفحه تنظیمات |
| Operator | بسته به سطح دسترسی `settings` |
| نماینده | بدون دسترسی — فقط در زمان عملیات (POS/بازخرید/B2B) بلاک می‌شود |
| مشتری | بدون دسترسی — فقط در زمان عملیات (فروشگاه/کیف پول) بلاک می‌شود |

---

## 32. تولید QR Code برای شمش‌ها (QR Code Generation for Bars)

### شرح قابلیت

سیستم به‌صورت خودکار برای هر شمش یک **QR Code با کیفیت بالا** تولید می‌کند که آماده چاپ لیزری روی بسته‌بندی وکیوم است. QR Code حاوی لینک صفحه احراز اصالت شمش (`/verify/check?code={serial_code}`) است و مشتری با اسکن آن می‌تواند اصالت شمش خود را بررسی کند.

### مشخصات فنی QR Code

| ویژگی | مقدار | توضیح |
|--------|-------|--------|
| ابعاد نهایی | ۹۸۰ × ۱۰۶۰ پیکسل | مناسب چاپ لیزری با کیفیت بالا |
| فرمت | PNG | با پس‌زمینه سفید خالص |
| سطح تصحیح خطا | `ERROR_CORRECT_H` | ۳۰% تحمل خطا — لازم برای جاگذاری لوگو در مرکز |
| اندازه ماژول | `box_size=20` | هر بلوک QR ۲۰ پیکسل |
| لوگوی برند | جاگذاری شده در مرکز QR | افزایش شناسایی برند |
| متن سریال‌کد | چاپ‌شده در زیر QR | برای شناسایی بصری بدون اسکن |
| رنگ | سیاه خالص روی سفید | حداکثر کنتراست برای اسکن |
| محل ذخیره | `static/uploads/qrcodes/{serial_code}.png` | یک فایل به‌ازای هر شمش |
| محتوای QR | `{BASE_URL}/verify/check?code={serial_code}` | لینک مستقیم به صفحه احراز اصالت |

### نحوه تولید

- **خودکار هنگام ساخت شمش**: وقتی شمش‌ها از طریق `inventory_service.generate_bars()` یا اسکریپت seed ساخته می‌شوند، QR Code به‌صورت خودکار تولید می‌شود
- **بازتولید دستی**: ادمین می‌تواند از صفحه ویرایش شمش، QR Code را بازتولید کند (مثلاً بعد از تغییر لوگوی برند)
- **تضمین وجود**: تابع `ensure_qr_exists()` قبل از دانلود بررسی می‌کند که فایل QR موجود باشد و در صورت نیاز آن را تولید می‌کند

### آدرس‌ها

| متد | مسیر | دسترسی | توضیح |
|------|------|--------|--------|
| GET | `/admin/bars/{bar_id}/qr` | inventory:view | دانلود فایل QR Code با کیفیت بالا (PNG) |
| POST | `/admin/bars/{bar_id}/qr/regenerate` | inventory:edit | بازتولید QR Code (مثلاً بعد از تغییر لوگو) |

### فایل‌های مرتبط

| فایل | توضیح |
|------|--------|
| `modules/verification/service.py` | `generate_qr_for_print()` — تولید QR با لوگو و متن سریال؛ `ensure_qr_exists()` — تضمین وجود فایل QR |
| `modules/inventory/service.py` | `_generate_qr_for_bar()` — فراخوانی تولید QR هنگام ساخت شمش؛ `regenerate_all_qr_codes()` — بازتولید دسته‌ای QR ها |
| `modules/inventory/admin_routes.py` | مسیرهای دانلود و بازتولید QR |
| `templates/admin/inventory/edit_bar.html` | نمایش پیش‌نمایش QR + دکمه دانلود + دکمه بازتولید |

### دسترسی

| نقش | دسترسی |
|------|--------|
| Super Admin | مشاهده، دانلود و بازتولید QR Code از صفحه ویرایش شمش |
| Operator | بسته به سطح دسترسی `inventory` (view برای دانلود، edit برای بازتولید) |
| نماینده | بدون دسترسی مستقیم |
| مشتری | اسکن QR → ریدایرکت به صفحه عمومی احراز اصالت (`/verify/check?code=X`) |

---

> این سند بر اساس کد واقعی پروژه TalaMala v4 (فازهای ۱-۱۴، ۲۱ و ۲۲ + بازگشت اجرت بازخرید + بهبود تیکتینگ + صفحات ثابت و فوتر + ثبت مالکیت و انتقال شمش + مدیریت کاربران + ویرایش مشتری توسط ادمین + اطلاعات خریدار در فاکتور + الزام تکمیل پروفایل + انتخاب بسته‌بندی مشتری + گزارش فروش نمایندگان + مدیریت دارایی و قیمت‌گذاری خودکار + چند درگاه پرداخت + درخواست نمایندگی با بازبینی + نظرات و پرسش‌وپاسخ + API دستگاه POS مشتری‌محور + یکپارچه‌سازی دستگاه POS راسیس + زیرنمایندگان و سفارش عمده B2B + انبارگردانی پیشرفته و رهگیری فیزیکی + سطح‌بندی فعال/غیرفعال خرید و فروش — Trade Guard + تولید QR Code برای شمش‌ها) تهیه شده و هیچ قابلیت فرضی شامل نشده است.
