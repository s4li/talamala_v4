# کاتالوگ قابلیت‌های سیستم طلاملا v4

> این سند تمام ماژول‌ها، قابلیت‌ها، نقش‌های کاربری و فرمول قیمت‌گذاری سیستم TalaMala v4 را شرح می‌دهد.
> آخرین به‌روزرسانی: فازهای ۱ تا ۱۴ تکمیل‌شده + قابلیت بازگشت اجرت بازخرید + بهبود سیستم تیکتینگ + صفحات ثابت و فوتر (Static Pages & Footer) + ثبت مالکیت و انتقال شمش (Bar Claim & Gifting + Ownership Transfer) + ساده‌سازی فرمول قیمت‌گذاری + مدیریت کاربران (Customer Management) + اطلاعات خریدار در فاکتور + الزام تکمیل پروفایل + انتخاب بسته‌بندی مشتری + گزارش فروش نمایندگان (Admin POS Sales Report).

---

## فهرست مطالب

1. [معرفی سیستم](#1-معرفی-سیستم)
2. [نقش‌ها و دسترسی‌ها](#2-نقشها-و-دسترسیها)
3. [ماژول احراز هویت (Auth)](#3-ماژول-احراز-هویت)
4. [ماژول کاتالوگ (Catalog)](#4-ماژول-کاتالوگ)
5. [ماژول انبارداری (Inventory)](#5-ماژول-انبارداری)
6. [ماژول فروشگاه (Shop)](#6-ماژول-فروشگاه)
7. [ماژول سبد خرید و سفارش (Cart & Order)](#7-ماژول-سبد-خرید-و-سفارش)
8. [ماژول پرداخت (Payment)](#8-ماژول-پرداخت)
9. [ماژول کیف پول (Wallet)](#9-ماژول-کیف-پول)
10. [ماژول کوپن (Coupon)](#10-ماژول-کوپن)
11. [ماژول نماینده (Dealer)](#11-ماژول-نماینده)
12. [ماژول احراز اصالت (Verification)](#12-ماژول-احراز-اصالت)
13. [ماژول مشتری (Customer)](#13-ماژول-مشتری)
14. [ماژول مدیریت (Admin)](#14-ماژول-مدیریت)
15. [ماژول تیکتینگ / پشتیبانی (Ticket)](#15-ماژول-تیکتینگ--پشتیبانی)
16. [API نماینده (Dealer POS API)](#16-api-نماینده-dealer-pos-api)
17. [بازگشت اجرت بازخرید (Buyback Wage Refund)](#17-بازگشت-اجرت-بازخرید-buyback-wage-refund)
18. [فرمول قیمت‌گذاری طلا](#18-فرمول-قیمتگذاری-طلا)
19. [جدول جامع دسترسی نقش‌ها](#19-جدول-جامع-دسترسی-نقشها)
20. [صفحات ثابت و فوتر (Static Pages & Footer)](#20-صفحات-ثابت-و-فوتر-static-pages--footer)
21. [ثبت مالکیت و انتقال شمش (Bar Claim & Ownership Transfer)](#21-ثبت-مالکیت-و-انتقال-شمش-bar-claim--ownership-transfer)
22. [مدیریت کاربران (Customer Management)](#22-مدیریت-کاربران-customer-management)

---

## 1. معرفی سیستم

**طلاملا v4** یک سیستم ERP فروش شمش طلا (Gold Bullion) است که شامل:

- **فروشگاه آنلاین**: مشتریان می‌توانند شمش طلا بخرند
- **پنل مدیریت**: ادمین و اپراتور سیستم را مدیریت می‌کنند
- **پنل نماینده**: نمایندگان فروش حضوری (POS) و بازخرید انجام می‌دهند
- **احراز اصالت**: هر شمش با سریال‌کد قابل بررسی است

### استک فنی
| بخش | فناوری |
|------|--------|
| Backend | FastAPI (Python) |
| Templates | Jinja2 |
| Database | PostgreSQL + SQLAlchemy ORM |
| Migration | Alembic |
| UI | Bootstrap 5 RTL + Vazirmatn Font |
| آیکون‌ها | Bootstrap Icons |
| درگاه پرداخت | زیبال (Zibal) |
| SMS | کاوه‌نگار (Kavenegar) |

### واحد پولی
- تمام مبالغ در دیتابیس به **ریال** ذخیره می‌شوند
- در رابط کاربری به **تومان** نمایش داده می‌شوند (تقسیم بر ۱۰)

---

## 2. نقش‌ها و دسترسی‌ها

سیستم ۴ نقش اصلی دارد:

| نقش | مدل | نحوه لاگین | کوکی JWT | دسترسی |
|------|------|------------|----------|--------|
| **Super Admin** | SystemUser (role=super_admin) | OTP موبایل | `auth_token` | دسترسی کامل به پنل مدیریت |
| **Operator** | SystemUser (role=operator) | OTP موبایل | `auth_token` | دسترسی عملیاتی (بدون تنظیمات سیستمی) |
| **Dealer** | Dealer | OTP موبایل | `dealer_token` | پنل نماینده (POS + بازخرید) |
| **Customer** | Customer | OTP موبایل | `customer_token` | فروشگاه + سبد خرید + کیف پول |

### تفاوت Super Admin و Operator
- Super Admin: تنظیمات سیستم (قیمت طلا، مالیات)، ایجاد/حذف اپراتور
- Operator: مدیریت محصولات، سفارشات، انبار، کوپن‌ها، نمایندگان

---

## 3. ماژول احراز هویت

**مسیر فایل‌ها**: `modules/auth/`

### قابلیت‌ها
- ورود با رمز یک‌بارمصرف (OTP) از طریق SMS
- شناسایی خودکار نقش کاربر (ادمین/نماینده/مشتری) بر اساس شماره موبایل
- ایجاد خودکار حساب مشتری در اولین ورود
- خروج (logout) با حذف کوکی مربوطه

### جریان لاگین
1. کاربر شماره موبایل وارد می‌کند → `POST /auth/send-otp`
2. سیستم OTP ارسال می‌کند (در محیط توسعه: کد ثابت `111111`)
3. کاربر OTP وارد می‌کند → `POST /auth/verify-otp`
4. سیستم نقش را تشخیص داده و ریدایرکت می‌کند:
   - ادمین/اپراتور → `/admin/dashboard`
   - نماینده → `/dealer/dashboard`
   - مشتری → `/` (صفحه اصلی فروشگاه)

### آدرس‌ها
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/auth/login` | صفحه ورود |
| POST | `/auth/send-otp` | ارسال OTP |
| POST | `/auth/verify-otp` | تایید OTP |
| GET | `/auth/logout` | خروج |

---

## 4. ماژول کاتالوگ

**مسیر فایل‌ها**: `modules/catalog/`

### مدل‌ها

#### ProductCategory (دسته‌بندی محصول)
- نام، slug (برای URL)، ترتیب نمایش، وضعیت فعال/غیرفعال
- Relationship `product_links`: لینک به ProductCategoryLink (رابطه M2M با Product)

#### Product (محصول = شمش طلا)
- نام، وزن (گرم)، عیار (750=18K)
- **دسته‌بندی‌ها**: رابطه Many-to-Many با ProductCategory از طریق جدول واسط `ProductCategoryLink` — هر محصول می‌تواند در **چند دسته‌بندی** قرار بگیرد
- اجرت ساخت (درصدی)
- تصاویر محصول (ProductImage)
- Property `categories`: لیست اشیاء ProductCategory مرتبط
- Property `category_ids`: لیست شناسه‌های دسته‌بندی‌ها (List[int])

#### ProductCategoryLink (رابطه محصول-دسته‌بندی)
- جدول واسط (junction table) برای رابطه Many-to-Many بین Product و ProductCategory
- `product_id` (FK → products): شناسه محصول
- `category_id` (FK → product_categories): شناسه دسته‌بندی
- UniqueConstraint روی (product_id, category_id)

#### CardDesign (طرح کارت هدیه)
- طرح‌های مختلف کارت برای بسته‌بندی شمش
- تصاویر طرح (CardDesignImage)

#### PackageType (نوع بسته‌بندی)
- انواع بسته‌بندی شمش (با قیمت‌گذاری)
- **فیلدهای جدید**: `price` (قیمت به ریال، پیش‌فرض ۰ = رایگان)، `is_active` (وضعیت فعال/غیرفعال)
- تصاویر بسته‌بندی (PackageTypeImage)
- مشتری هنگام خرید می‌تواند بسته‌بندی انتخاب کند — قیمت بسته‌بندی به فاکتور اضافه می‌شود

#### Batch (بچ تولید / ذوب)
- شناسه بچ، توضیحات
- تصاویر بچ (BatchImage)

### آدرس‌های ادمین
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/admin/products` | لیست محصولات |
| GET/POST | `/admin/products/create` | ایجاد محصول |
| GET/POST | `/admin/products/{id}/edit` | ویرایش محصول |
| GET | `/admin/categories` | لیست دسته‌بندی‌ها |
| GET/POST | `/admin/categories/create` | ایجاد دسته‌بندی |
| GET | `/admin/designs` | لیست طرح‌های کارت |
| GET | `/admin/packages` | لیست بسته‌بندی‌ها |
| GET | `/admin/batches` | لیست بچ‌ها |

---

## 5. ماژول انبارداری

**مسیر فایل‌ها**: `modules/inventory/`

### مدل‌ها

#### Bar (شمش طلا)
- سریال‌کد یکتا (۸ کاراکتری)
- **کد ثبت مالکیت** (`claim_code`): کد ۶ کاراکتری یکتا (حروف بزرگ + ارقام بدون ابهام: `ABCDEFGHJKMNPQRSTUVWXYZ23456789`) — هنگام فروش حضوری (POS) یا خرید هدیه (gift) تولید می‌شود
- وضعیت‌ها:
  - **Raw** (خام): فقط سریال دارد، هنوز به محصولی تخصیص نیافته
  - **Assigned** (تخصیص): به محصول وصل شده، آماده فروش
  - **Reserved** (رزرو): در سبد خرید مشتری قرار دارد
  - **Sold** (فروخته شده): فروش نهایی شده
- ارتباطات: محصول، مشتری، بچ، طرح کارت، بسته‌بندی، نمایندگی (dealer_id FK → dealers)
- تصاویر شمش (BarImage)

#### OwnershipHistory (تاریخچه مالکیت)
- ثبت هر تغییر مالکیت شمش

#### DealerTransfer (تاریخچه جابه‌جایی)
- ثبت هر انتقال شمش بین نمایندگان (from_dealer_id, to_dealer_id)

### آدرس‌های ادمین
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/admin/bars` | لیست شمش‌ها (فیلتر وضعیت، نمایندگی، جستجو سریال) |
| GET/POST | `/admin/bars/{id}/edit` | ویرایش شمش (نمایندگی بجای مکان) |

---

## 6. ماژول فروشگاه

**مسیر فایل‌ها**: `modules/shop/`

### قابلیت‌ها
- نمایش لیست محصولات با قیمت محاسبه‌شده لحظه‌ای
- فیلتر بر اساس دسته‌بندی (M2M — محصولات چنددسته‌بندی‌ای در نتایج همه دسته‌بندی‌های مرتبط نمایش داده می‌شوند)
- مرتب‌سازی (جدیدترین، ارزان‌ترین، گران‌ترین)
- صفحه جزئیات محصول با ریز قیمت
- انتخاب بسته‌بندی در صفحه جزئیات محصول (رادیو باتن با نام و قیمت)

### نمایش قیمت
قیمت هر محصول **لحظه‌ای** محاسبه می‌شود بر اساس:
- قیمت طلای ۱۸ عیار (از تنظیمات سیستم)
- وزن و عیار محصول
- اجرت + مالیات (مالیات فقط روی اجرت)

### آدرس‌ها
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/` | صفحه اصلی فروشگاه (لیست محصولات) |
| GET | `/product/{id}` | جزئیات محصول |

---

## 7. ماژول سبد خرید و سفارش

**مسیر فایل‌ها**: `modules/cart/` و `modules/order/`

### سبد خرید
- افزودن محصول به سبد
- تغییر تعداد / حذف آیتم
- نمایش قیمت لحظه‌ای
- انتخاب / تغییر بسته‌بندی هر آیتم (dropdown)
- قیمت بسته‌بندی در مبلغ خط سفارش لحاظ می‌شود

### فرآیند ثبت سفارش (Checkout)
1. مشتری سبد خرید را بررسی می‌کند
2. روش تحویل انتخاب می‌شود:
   - **حضوری (Pickup)**: انتخاب نمایندگی از لیست
   - **پستی (Postal)**: وارد کردن آدرس ارسال
3. **خرید هدیه** (اختیاری): تیک «خرید به‌عنوان هدیه» — شمش به نام خریدار ثبت نمی‌شود و `claim_code` تولید می‌شود تا گیرنده هدیه بتواند مالکیت را ثبت کند
4. کوپن تخفیف (اختیاری)
5. ثبت سفارش → رزرو شمش‌ها

### وضعیت‌های سفارش
| وضعیت | توضیح |
|--------|--------|
| Pending | در انتظار پرداخت |
| Paid | پرداخت شده |
| Shipped | ارسال شده |
| Delivered | تحویل داده شده |
| Cancelled | لغو شده |

### دلیل لغو سفارش
هر سفارش لغو‌شده دارای فیلد `cancellation_reason` و `cancelled_at` است:
| سناریو | دلیل ثبت‌شده |
|---------|-------------|
| لغو توسط مشتری | لغو توسط مشتری |
| لغو توسط مدیر | لغو توسط مدیر سیستم |
| انقضای زمان رزرو | عدم پرداخت در مهلت مقرر (X دقیقه) |
| استرداد (Refund) | استرداد وجه توسط مدیر — [یادداشت] |

دلیل لغو در صفحه جزئیات سفارش به مشتری نمایش داده می‌شود.

### مدل‌های سفارش

#### Order (سفارش)
- شناسه یکتا
- شناسه مشتری (FK → customers)
- وضعیت سفارش (Pending/Paid/Shipped/Delivered/Cancelled)
- دلیل و زمان لغو (اگر لغو شده باشد)
- روش تحویل (Pickup/Postal)
- نمایندگی (برای تحویل حضوری)
- آدرس ارسال (برای تحویل پستی)
- خرید هدیه (is_gift: boolean)
- کوپن و تخفیف‌های اعمال‌شده
- کل سفارش، هزینه ارسال، بیمه
- اطلاعات پرداخت (روش، مرجع، تاریخ)
- وضعیت تحویل (delivery_status)
- تاریخ ایجاد / تاریخ پرداخت / تاریخ تحویل

#### OrderItem (ردیف سفارش)
- شناسه یکتا
- شناسه سفارش (FK → orders)
- شناسه محصول
- شناسه شمش (FK → bars)
- مقادیر لحظه‌ای بر اساس قیمت در زمان ثبت سفارش:
  - قیمت طلا (ریال)
  - وزن شمش
  - عیار
  - درصد اجرت
  - درصد مالیات
  - مبلغ طلای خالص
  - مبلغ اجرت
  - مبلغ مالیات
- بسته‌بندی انتخاب‌شده (FK → package_types)
- قیمت بسته‌بندی
- مبلغ خط (= طلا + اجرت + مالیات + بسته‌بندی)

#### OrderStatusLog (تاریخچه تغییر وضعیت) — مدل جدید
- شناسه یکتا (id)
- شناسه سفارش (order_id، FK → orders)
- نام فیلد تغییریافته (field): مثلاً "status"، "delivery_status"، "cancellation_reason"
- مقدار قدیمی (old_value): مقدار قبلی فیلد
- مقدار جدید (new_value): مقدار جدید فیلد
- شناسه کاربر تغییر‌دهنده (changed_by): نام یا شناسه کاربری که تغییر را انجام داده (مثلاً نام ادمین یا سیستم)
- توضیح (description): علت یا توضیح تغییر (اختیاری)
- زمان تغییر (created_at): timestamp زمان ثبت تغییر
- این مدل یک **audit trail** (سند حسابی) برای تمام تغییرات وضعیت و تحویل سفارش است

### نمایش تاریخچه وضعیت در صفحه سفارش
در صفحه جزئیات سفارش (مشتری و ادمین)، یک **timeline** نمایش داده می‌شود که تمام تغییرات وضعیت را از کوچک‌ترین به بزرگ‌ترین تاریخ نشان می‌دهد:
- هر ردیف: `[تاریخ و ساعت] [فیلد تغییریافته]: [مقدار قدیمی] → [مقدار جدید]` `(توسط: [نام کاربر])`

### آدرس‌ها (مشتری)
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/cart` | مشاهده سبد خرید |
| POST | `/cart/add` | افزودن به سبد |
| POST | `/cart/update/{pid}` | تغییر تعداد |
| POST | `/cart/remove/{pid}` | حذف از سبد |
| GET | `/checkout` | صفحه ثبت سفارش |
| POST | `/cart/set-package` | تغییر بسته‌بندی آیتم سبد خرید |
| POST | `/cart/checkout` | ثبت نهایی سفارش |
| GET | `/orders` | لیست سفارشات من |
| GET | `/orders/{id}` | جزئیات سفارش |

### آدرس‌های ادمین
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/admin/orders` | لیست سفارشات (فیلتر وضعیت) |

---

## 8. ماژول پرداخت

**مسیر فایل‌ها**: `modules/payment/`

### روش‌های پرداخت
1. **کیف پول**: از موجودی کیف پول کسر می‌شود
2. **درگاه زیبال**: پرداخت آنلاین بانکی

### جریان پرداخت کیف پول
1. مشتری «پرداخت با کیف پول» را انتخاب می‌کند
2. سیستم بررسی می‌کند موجودی کافی باشد
3. مبلغ از کیف پول کسر + سفارش تایید می‌شود (تراکنش اتمیک)
4. شمش‌ها به مالکیت مشتری در می‌آید

### جریان پرداخت زیبال
1. مشتری «پرداخت آنلاین» را انتخاب می‌کند
2. سیستم درخواست پرداخت به زیبال ارسال می‌کند
3. مشتری به درگاه بانک هدایت می‌شود
4. پس از پرداخت، callback دریافت و سفارش تایید می‌شود

### محیط تست (Sandbox)
- وقتی `ZIBAL_MERCHANT=zibal` باشد، درگاه در حالت sandbox کار می‌کند و پرداخت‌ها خودکار موفق هستند.

### آدرس‌ها
| متد | مسیر | توضیح |
|------|------|--------|
| POST | `/payment/{id}/wallet` | پرداخت با کیف پول |
| POST | `/payment/{id}/zibal` | پرداخت با درگاه |
| GET | `/payment/zibal/callback` | بازگشت از درگاه |
| POST | `/payment/{id}/refund` | استرداد (فقط ادمین) |

---

## 9. ماژول کیف پول

**مسیر فایل‌ها**: `modules/wallet/`

### سیستم حسابداری دوطرفه
هر تغییر موجودی یک **LedgerEntry** ایجاد می‌کند (تاریخچه تغییرناپذیر).

### انواع تراکنش
| نوع | فارسی | توضیح |
|------|--------|--------|
| Deposit | واریز | شارژ کیف پول |
| Withdraw | برداشت | برداشت نقدی |
| Payment | پرداخت سفارش | خرید محصول |
| Refund | بازگشت وجه | استرداد |
| Hold | بلوکه | قفل موقت مبلغ |
| Release | آزادسازی | رفع بلوکه |
| Commit | تسویه | نهایی‌سازی |
| Credit | اعتبار | واریز اعتبار غیرقابل‌برداشت (بازگشت اجرت بازخرید — [بخش ۱۷](#17-بازگشت-اجرت-بازخرید-buyback-wage-refund)) |

### قابلیت‌ها
- **شارژ**: مشتری از طریق درگاه بانکی کیف پول را شارژ می‌کند
- **برداشت**: مشتری درخواست برداشت به حساب بانکی می‌دهد (نیاز به تایید ادمین)
- **اعتبار غیرقابل‌برداشت**: موجودی ویژه که فقط برای خرید قابل‌استفاده است (مثلاً بازگشت اجرت بازخرید — [بخش ۱۷](#17-بازگشت-اجرت-بازخرید-buyback-wage-refund))
- **مشاهده تاریخچه**: لیست تمام تراکنش‌ها

### آدرس‌ها (مشتری)
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/wallet` | داشبورد کیف پول |
| GET | `/wallet/transactions` | تاریخچه تراکنش‌ها |
| POST | `/wallet/topup` | شارژ کیف پول |
| GET/POST | `/wallet/withdraw` | درخواست برداشت |

### آدرس‌های ادمین
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/admin/wallets` | لیست حساب‌ها |
| GET | `/admin/wallets/customer/{id}` | جزئیات حساب مشتری |
| GET | `/admin/wallets/dealer/{id}` | جزئیات حساب نماینده |
| GET | `/admin/wallets/withdrawals/list` | درخواست‌های برداشت |
| POST | `/admin/wallets/withdrawals/{id}/approve` | تایید برداشت |
| POST | `/admin/wallets/withdrawals/{id}/reject` | رد برداشت |

---

## 10. ماژول کوپن

**مسیر فایل‌ها**: `modules/coupon/`

### انواع کوپن
1. **DISCOUNT (تخفیف)**: مبلغ مستقیماً از سفارش کم می‌شود
2. **CASHBACK (کشبک)**: مبلغ پس از تحویل به کیف پول واریز می‌شود

### حالت تخفیف
1. **PERCENT (درصدی)**: مثلاً ۱۰٪ تخفیف (با سقف اختیاری)
2. **FIXED (مبلغ ثابت)**: مثلاً ۵۰۰,۰۰۰ تومان

### دامنه اعمال (Scope)
| دامنه | توضیح |
|--------|--------|
| GLOBAL | کل سفارش |
| PRODUCT | فقط محصول خاص |
| CATEGORY | فقط دسته‌بندی خاص (Many-to-Many) |

**ویژگی CATEGORY Scope**:
- جدول `CouponCategory` (junction M2M): هر کوپن می‌تواند به چند دسته‌بندی محدود شود
- در فرم ادمین: انتخاب چندگانه دسته‌بندی‌ها با چک‌باکس
- اعتبارسنجی: کوپن فقط روی آیتم‌هایی اعمال می‌شود که دسته‌بندی‌شان در لیست مجاز باشد
- کوپن seed نمونه: `GOLD10` (10% تخفیف فقط روی دسته شمش گرمی)

### محدودیت‌ها
- حداقل مبلغ سفارش
- حداکثر مبلغ سفارش
- حداقل تعداد اقلام
- سقف تخفیف (برای حالت درصدی)
- محدودیت تعداد استفاده (کل + هر مشتری)
- محدودیت زمانی (تاریخ شروع / انقضا)
- فقط اولین خرید
- لیست سفید موبایل (is_private)

### وضعیت‌های کوپن
| وضعیت | توضیح |
|--------|--------|
| ACTIVE | فعال و قابل استفاده |
| INACTIVE | غیرفعال (موقتاً) |
| EXPIRED | منقضی |

### آدرس‌های ادمین
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/admin/coupons` | لیست کوپن‌ها |
| GET/POST | `/admin/coupons/create` | ایجاد کوپن |
| GET | `/admin/coupons/{id}` | جزئیات کوپن |
| GET/POST | `/admin/coupons/{id}/edit` | ویرایش کوپن |

### API مشتری
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/api/coupon/check?code=X` | بررسی اعتبار کوپن (AJAX) |

---

## 11. ماژول نماینده

**مسیر فایل‌ها**: `modules/dealer/`

### مدل‌ها

#### Dealer (نماینده)
- شماره موبایل (یکتا)، نام کامل، کد ملی
- سطح نمایندگی (FK → DealerTier): پخش / بنکدار / فروشگاه
- آدرس: استان (FK → GeoProvince)، شهر (FK → GeoCity)، محله (FK → GeoDistrict)، آدرس متنی، کد پستی، تلفن ثابت
- پرچم‌ها: `is_warehouse` (انبار مرکزی)، `is_postal_hub` (هاب ارسال پستی)
- Properties: `type_label`, `type_icon`, `type_color`, `display_name`
- کلید API یکتا (برای POS)
- وضعیت فعال/غیرفعال
- **فرم ایجاد/ویرایش**: cascade dropdown استان → شهر → محله (مثل آدرس مشتری)
- **دیتای اولیه**: ۹ نماینده (۵ شعبه تهران از صفحه تماس‌باما + تبریز + اصفهان + شیراز + مشهد)

#### DealerSale (فروش حضوری POS)
- شناسه نماینده، شمش فروخته‌شده
- نام/موبایل/کد ملی خریدار
- مبلغ فروش (ریال)، کمیسیون (ریال)
- `gold_profit_mg`: سود طلایی نماینده (میلی‌گرم)
- `discount_wage_percent` (Numeric 5,2): تخفیف اجرت از سهم نماینده (درصد) — نماینده اختیاری بخشی از سهم اجرت خود را تخفیف می‌دهد

#### BuybackRequest (درخواست بازخرید)
- نماینده درخواست‌دهنده، شمش مورد نظر
- نام/موبایل فروشنده (مشتری)
- مبلغ پیشنهادی بازخرید
- وضعیت: Pending → Approved/Rejected → Completed
- `wage_refund_amount`: مبلغ اجرت بازگشتی به کیف پول مشتری (ریال)
- `wage_refund_customer_id`: شناسه مشتری دریافت‌کننده اعتبار
- در صورت تایید ادمین و وجود OrderItem اصلی، اجرت به‌صورت اعتبار غیرقابل‌برداشت واریز می‌شود ([بخش ۱۷](#17-بازگشت-اجرت-بازخرید-buyback-wage-refund))

### قابلیت‌های پنل نماینده
1. **داشبورد**: آمار فروش، کمیسیون، بازخرید
2. **POS (فروش حضوری)**: انتخاب شمش + ثبت اطلاعات خریدار + مبلغ فروش + تخفیف اختیاری از سهم اجرت نماینده
3. **بازخرید**: ثبت سریال شمش + اطلاعات فروشنده + مبلغ پیشنهادی
4. **تاریخچه فروش**: لیست فروش‌های انجام‌شده (شامل ستون تخفیف اجرت)
5. **تاریخچه بازخرید**: لیست درخواست‌ها با وضعیت

### تخفیف اجرت POS (Dealer Wage Discount)
- نماینده هنگام فروش حضوری می‌تواند اختیاری بخشی از سهم اجرت خود را تخفیف دهد
- **محدوده تخفیف**: ۰ تا کل سهم اجرت نماینده (`ec_wage% - dealer_wage%`)
- **مثال**: محصول با ec_wage=42%, dealer_wage=14%, سهم نماینده=28%. نماینده می‌تواند ۰ تا ۲۸% تخفیف بدهد
- **نمایش UI**: باکس سبز (اطلاعات سهم) + اسلایدر/عدد (تنظیم تخفیف) + خلاصه قیمت نهایی
- **اعتبارسنجی سمت سرور**: قیمت فروش با قیمت محاسباتی (اجرت مؤثر) تطبیق داده می‌شود (تلرانس ±10 ریال)
- **سود طلایی**: با تخفیف کاهش می‌یابد: `weight × (margin - discount) / 100 × 1000` میلی‌گرم
- **REST API**: فیلد `discount_wage_percent` در `POST /api/dealer/sale` (پیش‌فرض: ۰)
- **API محصولات**: فیلدهای `ec_wage_pct`, `dealer_wage_pct`, `margin_pct` در `GET /api/dealer/products`

### آدرس‌ها (نماینده)
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/dealer/dashboard` | داشبورد نماینده |
| GET | `/dealer/pos` | فرم فروش حضوری |
| POST | `/dealer/pos` | ثبت فروش |
| GET | `/dealer/buyback` | فرم بازخرید |
| POST | `/dealer/buyback` | ثبت درخواست بازخرید |
| GET | `/dealer/sales` | تاریخچه فروش |
| GET | `/dealer/buybacks` | تاریخچه بازخرید |

### گزارش فروش نمایندگان (Admin POS Sales Report)

صفحه مدیریتی برای مشاهده و تحلیل **تمام فروش‌های حضوری (POS) نمایندگان** با فیلتر و آمار تجمیعی.

- **سرویس**: `dealer_service.list_all_sales_admin()`
- **قالب**: `templates/admin/dealers/sales.html`
- **لینک سایدبار**: «فروش نمایندگان» با آیکون `bi-receipt-cutoff`
- **دسترسی**: نیاز به مجوز `dealers`

#### فیلترها
| فیلتر | توضیح |
|--------|--------|
| نماینده | انتخاب نماینده خاص از لیست |
| بازه تاریخی | تاریخ شروع و پایان |
| جستجو | بر اساس نام خریدار، شماره موبایل، سریال‌کد شمش |
| تخفیف | فیلتر فروش‌های دارای تخفیف اجرت |

#### آمار تجمیعی
| آمار | توضیح |
|-------|--------|
| تعداد کل فروش | مجموع تعداد فروش‌های ثبت‌شده |
| درآمد کل | مجموع مبالغ فروش (ریال) |
| سود طلایی | مجموع سود طلایی نمایندگان (میلی‌گرم) |
| تعداد تخفیف‌دار | تعداد فروش‌هایی که تخفیف اجرت داشته‌اند |

#### صفحه‌بندی
- نتایج با pagination نمایش داده می‌شوند

### آدرس‌های ادمین
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/admin/dealers` | لیست نمایندگان |
| GET/POST | `/admin/dealers/create` | ایجاد نماینده |
| GET/POST | `/admin/dealers/{id}/edit` | ویرایش نماینده |
| GET | `/admin/dealers/sales` | گزارش فروش نمایندگان (فیلتر + آمار تجمیعی + صفحه‌بندی) |
| GET | `/admin/dealers/buybacks` | لیست درخواست‌های بازخرید |
| POST | `/admin/dealers/buybacks/{id}/approve` | تایید بازخرید |
| POST | `/admin/dealers/buybacks/{id}/reject` | رد بازخرید |
| GET | `/admin/dealers/stats` | آمار نمایندگان (JSON API) |

---

## 12. ماژول احراز اصالت

**مسیر فایل‌ها**: `modules/verification/`

### قابلیت‌ها
- بررسی اصالت شمش با وارد کردن سریال‌کد
- نمایش اطلاعات شمش (محصول، وزن، عیار، وضعیت)
- صفحه عمومی (بدون نیاز به لاگین)

### آدرس‌ها
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/verify` | صفحه احراز اصالت |
| GET | `/verify/check?code=X` | بررسی سریال‌کد |

---

## 13. ماژول مشتری

**مسیر فایل‌ها**: `modules/customer/`

### مدل‌ها

#### Customer (مشتری)
- شماره موبایل (یکتا)، نام کامل، کد ملی، تاریخ تولد
- **نوع مشتری** (`customer_type`): حقیقی (`real`) یا حقوقی (`legal`) — پیش‌فرض: حقیقی
- **فیلدهای حقوقی**: نام شرکت (`company_name`)، کد اقتصادی (`economic_code`) — فقط برای مشتریان حقوقی
- **فیلدهای تماس/آدرس**: تلفن ثابت (`phone`)، کد پستی (`postal_code`)، آدرس (`address`)
- **Property** `display_name`: برای حقیقی → `full_name`، برای حقوقی → `company_name`
- **Property** `is_profile_complete`: بررسی تکمیل بودن اطلاعات ضروری (نام، کد ملی، کد پستی، آدرس + برای حقوقی: نام شرکت و کد اقتصادی)

#### آدرس‌ها (Geo + Address)
- **GeoProvince**: لیست استان‌ها
- **GeoCity**: شهرهای هر استان
- **GeoDistrict**: مناطق هر شهر
- **CustomerAddress**: دفتر آدرس مشتری (عنوان، آدرس کامل، کدپستی، گیرنده)

### قابلیت‌ها
- ویرایش پروفایل (نام، کد ملی، تاریخ تولد، نوع مشتری، فیلدهای حقوقی، تلفن، کد پستی، آدرس)
- **انتخاب نوع مشتری**: حقیقی/حقوقی — در صورت انتخاب حقوقی، فیلدهای نام شرکت و کد اقتصادی نمایش داده می‌شوند
- مدیریت دفتر آدرس (افزودن، ویرایش، حذف، تعیین پیش‌فرض)
- انتخاب آدرس هنگام ثبت سفارش پستی
- **الزام تکمیل پروفایل (Profile Completion Guard)**: هنگام ورود به صفحه checkout (`GET /checkout`) یا ثبت سفارش (`POST /cart/checkout`)، اگر پروفایل مشتری ناقص باشد (`is_profile_complete == False`)، کاربر به صفحه پروفایل (`/profile`) ریدایرکت و پیام هشدار نمایش داده می‌شود
- **اطلاعات خریدار در فاکتور سفارش**: صفحه جزئیات سفارش (`/orders/{id}`) اطلاعات صورتحسابی خریدار را برای **همه کاربران** (نه فقط ادمین) نمایش می‌دهد: نوع مشتری (حقیقی/حقوقی)، نام/نام شرکت، کد ملی، موبایل، تلفن ثابت، کد پستی، آدرس

### آدرس‌ها
| متد | مسیر | توضیح |
|------|------|--------|
| GET/POST | `/profile` | پروفایل مشتری |
| GET/POST | `/addresses` | دفتر آدرس |
| POST | `/addresses/{id}/delete` | حذف آدرس |
| POST | `/addresses/{id}/default` | تعیین آدرس پیش‌فرض |
| GET | `/api/geo/cities?province_id=X` | لیست شهرها (AJAX) |
| GET | `/api/geo/districts?city_id=X` | لیست مناطق (AJAX) |
| GET | `/api/geo/dealers?province_id&city_id&district_id` | فیلتر نمایندگان بر اساس موقعیت (AJAX) |

---

## 14. ماژول مدیریت

**مسیر فایل‌ها**: `modules/admin/`

### داشبورد (فاز ۱۲)
- ۴ کارت آماری اصلی: درآمد کل، سفارشات، مشتریان، شمش‌ها
- ۶ کارت آماری فرعی: سفارش امروز، درآمد امروز، در انتظار پرداخت، شمش موجود، نماینده فعال، درخواست برداشت
- نمودار خطی: درآمد ۳۰ روز اخیر (Chart.js)
- نمودار دایره‌ای: وضعیت موجودی شمش‌ها
- جدول آخرین سفارشات
- لینک‌های دسترسی سریع
- نمایش قیمت طلا
- هشدار برای موارد در انتظار (سفارش، برداشت، بازخرید)

### تنظیمات سیستم
- قیمت طلای ۱۸ عیار (ریال بر گرم)
- درصد مالیات
- هزینه ارسال پستی
- بیمه ارسال

### آدرس‌ها
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/admin/dashboard` | داشبورد |
| GET | `/admin/dashboard/api/stats` | آمار JSON |
| GET/POST | `/admin/settings` | تنظیمات سیستم |

---

## 15. ماژول تیکتینگ / پشتیبانی

**مسیر فایل‌ها**: `modules/ticket/`

### مدل‌ها

#### Ticket (تیکت پشتیبانی)
- موضوع، متن اولیه، وضعیت، اولویت
- **دسته‌بندی** (`category`): TicketCategory enum — مالی / فنی / فروش / شکایات / سایر
- نوع فرستنده (مشتری/نماینده)
- ارتباط: customer_id یا dealer_id (بسته به فرستنده)
- تخصیص: assigned_to (FK → SystemUser)
- زمان‌ها: ایجاد، بروزرسانی، بسته شدن

#### TicketMessage (پیام تیکت)
- متن پیام، نوع فرستنده (CUSTOMER/DEALER/STAFF)
- نام فرستنده (denormalized)
- **is_internal** (Boolean): یادداشت داخلی فقط قابل‌مشاهده توسط کارکنان (staff-only note)
- **is_initial** (Boolean): پیام اولیه تیکت (برای پشتیبانی پیوست در ایجاد تیکت)
- **attachments**: رابطه با TicketAttachment (پیوست‌های پیام)
- زمان ایجاد

#### TicketAttachment (پیوست تیکت) — مدل جدید
- **id**: شناسه یکتا
- **message_id** (FK → ticket_messages): پیام مرتبط
- **file_path**: مسیر فایل آپلود‌شده
- **created_at**: زمان ایجاد

### Enum جدید: TicketCategory (دسته‌بندی تیکت)
| مقدار | فارسی |
|--------|--------|
| Financial | مالی |
| Technical | فنی |
| Sales | فروش |
| Complaints | شکایات |
| Other | سایر |

### وضعیت‌های تیکت
| وضعیت | فارسی | توضیح |
|--------|--------|--------|
| Open | باز | تازه ایجاد شده یا بازشده |
| InProgress | در حال بررسی | به اپراتور تخصیص داده شده |
| Answered | پاسخ داده شده | اپراتور پاسخ داده |
| Closed | بسته | بسته شده توسط کاربر یا اپراتور |

### اولویت‌ها
| اولویت | فارسی |
|---------|--------|
| Low | کم |
| Medium | متوسط |
| High | بالا |

### رفتار خودکار وضعیت
- پاسخ اپراتور → وضعیت به **Answered** تغییر می‌کند
- پاسخ کاربر به تیکت Answered → وضعیت به **Open** بازمی‌گردد
- تخصیص به اپراتور → اگر Open باشد، به **InProgress** تغییر می‌کند
- اولین پاسخ ادمین → اگر تخصیص نشده، خودکار assign می‌شود

### اعلان‌ها (Notifications)
- **فایل**: `common/notifications.py`
- تابع `notify_ticket_update()` برای ارسال SMS هنگام رویدادهای تیکت (ایجاد، پاسخ، تغییر وضعیت)
- اعلان به مشتری/نماینده هنگام پاسخ کارکنان
- اعلان به کارکنان هنگام ایجاد تیکت جدید یا پاسخ کاربر

### تمایز مشتری/نماینده در پنل ادمین
- لیست تیکت‌ها با **تب‌ها**: همه | مشتریان (badge آبی) | نمایندگان (badge بنفش)
- Badge تعداد تیکت باز هر نوع روی تب
- فیلتر وضعیت: دکمه‌های وضعیت (باز / در حال بررسی / پاسخ‌داده / بسته)
- **فیلتر دسته‌بندی**: انتخاب دسته‌بندی تیکت (مالی / فنی / فروش / شکایات / سایر)
- **جستجو**: بر اساس شناسه تیکت، موضوع، نام فرستنده، شماره موبایل
- جزئیات تیکت: نوع فرستنده + نام + شماره + تاریخ + دسته‌بندی در پنل کناری

### قابلیت پیوست فایل (File Upload)
- مشتری و نماینده می‌توانند هنگام **ایجاد تیکت** و **ارسال پاسخ** فایل پیوست کنند
- کارکنان می‌توانند هنگام **پاسخ به تیکت** فایل پیوست کنند
- فایل‌های پیوست در مکالمه تیکت نمایش داده می‌شوند
- هر پیام می‌تواند چندین پیوست داشته باشد

### یادداشت داخلی (Internal Notes)
- کارکنان می‌توانند **یادداشت داخلی** ثبت کنند (فقط قابل‌مشاهده توسط ادمین و اپراتور)
- یادداشت‌های داخلی در مکالمه با رنگ متمایز (مثلاً زمینه زرد) نمایش داده می‌شوند
- مشتری و نماینده یادداشت‌های داخلی را **نمی‌بینند**

### قالب‌های بروزرسانی‌شده (Templates)
۶ قالب بهبود یافته:
1. `templates/shop/ticket_new.html` — افزودن dropdown دسته‌بندی + آپلود فایل
2. `templates/shop/ticket_detail.html` — نمایش پیوست‌ها + آپلود فایل در پاسخ
3. `templates/dealer/ticket_new.html` — افزودن dropdown دسته‌بندی + آپلود فایل
4. `templates/dealer/ticket_detail.html` — نمایش پیوست‌ها + آپلود فایل در پاسخ
5. `templates/admin/tickets/list.html` — جستجو + فیلتر دسته‌بندی
6. `templates/admin/tickets/detail.html` — نمایش پیوست‌ها + فرم یادداشت داخلی + آپلود فایل در پاسخ

### آدرس‌ها (مشتری + نماینده)
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/tickets` | لیست تیکت‌های من |
| GET | `/tickets/new` | فرم ایجاد تیکت |
| POST | `/tickets/new` | ثبت تیکت (+ آپلود فایل) |
| GET | `/tickets/{id}` | جزئیات + مکالمه + پیوست‌ها |
| POST | `/tickets/{id}/message` | ارسال پاسخ (+ آپلود فایل) |
| POST | `/tickets/{id}/close` | بستن تیکت |

### آدرس‌های ادمین
| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/admin/tickets` | لیست تیکت‌ها (تب + فیلتر وضعیت + فیلتر دسته‌بندی + جستجو) |
| GET | `/admin/tickets/{id}` | جزئیات + پاسخ + تخصیص + پیوست‌ها |
| POST | `/admin/tickets/{id}/reply` | پاسخ ادمین (+ آپلود فایل) |
| POST | `/admin/tickets/{id}/internal-note` | ثبت یادداشت داخلی (فقط کارکنان) |
| POST | `/admin/tickets/{id}/status` | تغییر وضعیت |
| POST | `/admin/tickets/{id}/close` | بستن تیکت |
| POST | `/admin/tickets/{id}/assign` | تخصیص به اپراتور |

### فایل‌های مرتبط با بهبودهای تیکتینگ

| فایل | تغییرات |
|-------|---------|
| `modules/ticket/models.py` | مدل جدید `TicketAttachment`، enum `TicketCategory`، فیلدهای جدید `is_internal`/`is_initial`/`attachments` در TicketMessage، فیلد `category` در Ticket |
| `common/notifications.py` | فایل جدید — تابع `notify_ticket_update()` برای اعلان SMS رویدادهای تیکت |
| `modules/ticket/service.py` | پشتیبانی از پیوست، دسته‌بندی، یادداشت داخلی، جستجو |
| `modules/ticket/routes.py` | آپلود فایل در ایجاد تیکت و ارسال پاسخ |
| `modules/ticket/admin_routes.py` | endpoint جدید `internal-note`، آپلود فایل، جستجو و فیلتر دسته‌بندی |

---

## 15.5 لاگ درخواست‌ها (Request Audit Log)

**مسیر فایل‌ها**: `modules/admin/models.py` (RequestLog), `modules/admin/routes.py`, `main.py` (middleware)

### مدل

| مدل | جدول | ستون‌های کلیدی |
|------|-------|---------------|
| RequestLog | request_logs | method, path, query_string, status_code, ip_address, user_agent, user_type, user_display, body_preview, response_time_ms, created_at |

### Middleware

- `request_logger` در `main.py` — هر درخواست HTTP را لاگ میکنه
- Exclude: `/static/`, `/health`, `favicon.ico`
- POST body: mask حساس (`password`, `otp_code`, `csrf_token`, `api_key`)
- شناسایی کاربر از JWT cookies
- Auto-cleanup: لاگ‌های قدیمی‌تر از ۳۰ روز (APScheduler هر ۶ ساعت)

### مسیرها

| متد | مسیر | توضیح |
|------|------|-------|
| GET | `/admin/logs` | لیست لاگ‌ها + فیلتر (متد، وضعیت، مسیر، نوع کاربر، IP) + pagination |

### Middleware: جلوگیری از کش مرورگر (No-Cache)

- در `main.py` — هدرهای `Cache-Control: no-cache, no-store, must-revalidate`، `Pragma: no-cache` و `Expires: 0` برای تمام مسیرهای `/admin/*` و `/dealer/*` ست می‌شود
- هدف: جلوگیری از نمایش صفحات قدیمی کش‌شده هنگام ناوبری (back/forward) — آمار و داده‌ها همیشه تازه از دیتابیس بارگذاری می‌شوند

---

## 16. API نماینده (Dealer POS API)

**مسیر فایل‌ها**: `modules/dealer/api_routes.py`

### احراز هویت
- هدر `X-API-Key` با کلید ۶۴ کاراکتری یکتا
- کلید توسط ادمین از پنل مدیریت تولید/لغو می‌شود
- بدون نیاز به Cookie یا CSRF (stateless)

### اندپوینت‌ها

| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/api/dealer/info` | اطلاعات نماینده (health check) |
| GET | `/api/dealer/products` | لیست محصولات + قیمت لحظه‌ای + سریال‌کد شمش‌ها + اطلاعات سهم اجرت (`ec_wage_pct`, `dealer_wage_pct`, `margin_pct`) |
| POST | `/api/dealer/sale` | ثبت فروش POS (serial_code, sale_price, discount_wage_percent, اطلاعات مشتری) |
| GET | `/api/dealer/sales` | تاریخچه فروش (صفحه‌بندی) |

### فرمت پاسخ
- موفق: `{"success": true, ...data}`
- خطا: `{"success": false, "error": "message", "code": 400}`
- بدون API Key: `422` (هدر الزامی)
- API Key نامعتبر: `401`

### مدیریت کلید API (ادمین)

| متد | مسیر | توضیح |
|------|------|--------|
| POST | `/admin/dealers/{id}/generate-api-key` | تولید کلید جدید |
| POST | `/admin/dealers/{id}/revoke-api-key` | لغو کلید |

---

## 17. بازگشت اجرت بازخرید (Buyback Wage Refund)

### شرح قابلیت

وقتی مشتری شمش طلایی را که قبلاً از فروشگاه آنلاین خریده بازفروش (بازخرید) می‌کند، سیستم به‌صورت خودکار مبلغ اجرت ساخت (wage) اصلی آن شمش را به کیف پول مشتری به‌عنوان **اعتبار غیرقابل‌برداشت** واریز می‌کند. این اعتبار فقط برای خرید محصولات جدید قابل‌استفاده است و امکان برداشت نقدی به حساب بانکی را ندارد.

### نحوه عملکرد

1. نماینده درخواست بازخرید برای شمشی با وضعیت **SOLD** ثبت می‌کند
2. ادمین/اپراتور درخواست بازخرید را **تایید** می‌کند
3. سیستم در آیتم‌های سفارش اصلی (`OrderItem`) آن شمش را جستجو کرده و مقدار `final_wage_amount` را استخراج می‌کند
4. اگر شمش از طریق **فروشگاه آنلاین** فروخته شده باشد (OrderItem موجود باشد):
   - مبلغ اجرت به‌عنوان اعتبار غیرقابل‌برداشت به کیف پول مشتری واریز می‌شود
   - مقادیر `wage_refund_amount` و `wage_refund_customer_id` در BuybackRequest ثبت می‌شود
5. اگر شمش از طریق **POS (فروش حضوری)** فروخته شده باشد (بدون OrderItem):
   - بازگشت اجرت صورت نمی‌گیرد

### تغییرات مدل‌ها

#### Account (حساب کیف پول) — ستون جدید `credit_balance`
- `credit_balance`: موجودی اعتبار غیرقابل‌برداشت (پیش‌فرض ۰)
- **موجودی قابل‌استفاده برای خرید** (`available_balance`): `balance - locked_balance`
- **موجودی قابل‌برداشت** (`withdrawable_balance`): `balance - locked_balance - credit_balance`

#### LedgerEntry (سند حسابداری) — ستون‌های جدید
- `delta_credit`: تغییر اعتبار در این تراکنش
- `credit_after`: موجودی اعتبار پس از تراکنش

#### TransactionType (انواع تراکنش) — نوع جدید
- `CREDIT`: واریز اعتبار غیرقابل‌برداشت (بازگشت اجرت)

#### BuybackRequest (درخواست بازخرید) — ستون‌های جدید
- `wage_refund_amount`: مبلغ اجرت بازگشتی (ریال)
- `wage_refund_customer_id`: شناسه مشتری دریافت‌کننده اعتبار

### رفتار کیف پول

| عملیات | balance | credit_balance | توضیح |
|--------|---------|----------------|--------|
| واریز اعتبار (`deposit_credit`) | افزایش | افزایش | هم‌زمان هر دو افزایش می‌یابد |
| خرید با کیف پول | کاهش | بدون تغییر یا کاهش | ابتدا پول عادی مصرف می‌شود؛ اعتبار فقط وقتی موجودی عادی کافی نباشد |
| درخواست برداشت | — | — | فقط `withdrawable_balance` قابل‌برداشت (بدون اعتبار) |

**ترتیب مصرف هنگام خرید:**
1. ابتدا موجودی عادی (`balance - credit_balance`) مصرف می‌شود
2. اگر موجودی عادی کافی نباشد، مابقی از اعتبار (`credit_balance`) کسر می‌شود
3. پارامتر `consume_credit=True` در `wallet_service.withdraw()` این رفتار را فعال می‌کند

**محدودیت برداشت:**
- درخواست‌های برداشت بانکی بر اساس `withdrawable_balance` اعتبارسنجی می‌شوند (نه `available_balance`)
- یعنی اعتبار غیرقابل‌برداشت هرگز قابل انتقال به حساب بانکی نیست

### رابط کاربری (UI)

| صفحه | تغییر |
|-------|--------|
| کیف پول مشتری (`/wallet`) | نمایش موجودی اعتبار + مبلغ قابل‌برداشت |
| جزئیات حساب ادمین (`/admin/wallets/customer/{id}` یا `/admin/wallets/dealer/{id}`) | نمایش تفکیک: موجودی کل، اعتبار، قابل‌برداشت |
| لیست بازخریدها ادمین (`/admin/dealers/buybacks`) | نمایش مبلغ بازگشت اجرت در هر درخواست |

### فایل‌های مرتبط

| فایل | تغییرات |
|-------|---------|
| `modules/wallet/models.py` | `credit_balance` در Account، `delta_credit`/`credit_after` در LedgerEntry، نوع `CREDIT` در TransactionType |
| `modules/wallet/service.py` | متد `deposit_credit()`، پارامتر `consume_credit` در `withdraw()`، بررسی `withdrawable_balance` |
| `modules/dealer/models.py` | `wage_refund_amount`/`wage_refund_customer_id` در BuybackRequest |
| `modules/dealer/service.py` | منطق بازگشت اجرت در `approve_buyback()` |
| `modules/payment/service.py` | ارسال `consume_credit=True` هنگام پرداخت با کیف پول |

---

## 18. فرمول قیمت‌گذاری طلا

**فایل**: `modules/pricing/calculator.py`

### ورودی‌ها
| پارامتر | توضیح | مثال |
|----------|--------|------|
| weight | وزن شمش (گرم) | 1.000 |
| purity | عیار (در هزار) | 750 (= 18 عیار) |
| wage_percent | اجرت ساخت (درصد) | 7 |
| base_gold_price_18k | قیمت طلای ۱۸ عیار (ریال/گرم) | 52,000,000 |
| tax_percent | درصد مالیات | 10 |

### مراحل محاسبه

```
۱. قیمت واحد بر اساس عیار:
   price_per_gram = (gold_price_18k / 750) × purity

۲. ارزش طلای خام:
   raw_gold = weight × price_per_gram

۳. اجرت ساخت (درصدی از ارزش طلا):
   wage = raw_gold × (wage_percent / 100)

۴. مالیات (فقط روی اجرت):
   tax = wage × (tax_percent / 100)

۵. قیمت نهایی:
   total = raw_gold + wage + tax
```

### نکته مهم
- تمام گِردکردن‌ها به **پایین** (FLOOR) انجام می‌شود
- مالیات فقط روی اجرت (خدمات) اعمال می‌شود — طلای خام معاف از مالیات است
- فیلدهای سود، کمیسیون، سنگ و لوازم جانبی از فرمول حذف شده‌اند (سیستم فقط شمش طلا می‌فروشد)

---

## 19. جدول جامع دسترسی نقش‌ها

| عملیات | مشتری | نماینده | اپراتور | مدیرکل |
|--------|--------|---------|---------|--------|
| مشاهده فروشگاه | ✅ | — | — | — |
| خرید آنلاین | ✅ | — | — | — |
| کیف پول (شارژ/برداشت) | ✅ | — | — | — |
| مشاهده سفارشات خود | ✅ | — | — | — |
| مشاهده شمش‌های من (`/my-bars`) | ✅ | — | — | — |
| ثبت مالکیت شمش (`/claim-bar`) | ✅ | — | — | — |
| انتقال شمش به دیگران (`/my-bars/{id}/transfer`) | ✅ | — | — | — |
| خرید هدیه (gift checkout) | ✅ | — | — | — |
| ویرایش پروفایل | ✅ | — | — | — |
| دفتر آدرس | ✅ | — | — | — |
| مشاهده صفحات ثابت (درباره ما، سوالات، تماس، قوانین) | ✅ | ✅ | ✅ | ✅ |
| احراز اصالت شمش | ✅ | ✅ | ✅ | ✅ |
| فروش حضوری (POS) | — | ✅ | — | — |
| بازخرید شمش | — | ✅ | — | — |
| تاریخچه فروش خود | — | ✅ | — | — |
| دسترسی API (POS) | — | ✅ | — | — |
| داشبورد مدیریت | — | — | ✅ | ✅ |
| مدیریت محصولات | — | — | ✅ | ✅ |
| مدیریت دسته‌بندی‌ها | — | — | ✅ | ✅ |
| مدیریت شمش‌ها | — | — | ✅ | ✅ |
| مدیریت سفارشات | — | — | ✅ | ✅ |
| مدیریت کوپن‌ها | — | — | ✅ | ✅ |
| مدیریت نمایندگان | — | — | ✅ | ✅ |
| گزارش فروش نمایندگان (POS Sales Report) | — | — | ✅ | ✅ |
| تایید/رد بازخرید (+ بازگشت اجرت) | — | — | ✅ | ✅ |
| مشاهده اعتبار غیرقابل‌برداشت | ✅ | — | — | — |
| تایید/رد برداشت | — | — | ✅ | ✅ |
| مدیریت کاربران (لیست + جزئیات + ویرایش) | — | — | ✅ | ✅ |
| ارسال تیکت پشتیبانی (+ پیوست) | ✅ | ✅ | — | — |
| مشاهده تیکت‌های خود (+ پیوست‌ها) | ✅ | ✅ | — | — |
| مدیریت تیکت‌ها (جستجو + فیلتر دسته‌بندی) | — | — | ✅ | ✅ |
| پاسخ به تیکت‌ها (+ آپلود فایل) | — | — | ✅ | ✅ |
| ثبت یادداشت داخلی (internal note) | — | — | ✅ | ✅ |
| تخصیص تیکت به اپراتور | — | — | ✅ | ✅ |
| تنظیمات سیستم | — | — | — | ✅ |
| قیمت طلا / مالیات | — | — | — | ✅ |

---

## 20. صفحات ثابت و فوتر (Static Pages & Footer)

**مسیر فایل‌ها**: `main.py` (routes) + `templates/shop/`

### شرح قابلیت

صفحات اطلاع‌رسانی ثابت (Static Pages) برای معرفی شرکت، پاسخ به سوالات متداول، راه‌های ارتباطی و قوانین استفاده از سایت. همچنین فوتر (Footer) کامل با اطلاعات شرکت، لینک‌های سریع، لینک‌های اعتماد و شبکه‌های اجتماعی.

### صفحات

| صفحه | توضیح |
|--------|--------|
| **درباره ما** (`/about`) | معرفی شرکت طلاملا، تاریخچه و ماموریت |
| **سوالات متداول** (`/faq`) | سوالات پرتکرار مشتریان با پاسخ (Accordion) |
| **تماس با ما** (`/contact`) | اطلاعات تماس (آدرس، تلفن، ایمیل، ساعت کاری) |
| **قوانین و مقررات** (`/terms`) | شرایط استفاده از خدمات فروشگاه |
| **صفحه ۴۰۴** | صفحه سفارشی برای آدرس‌های ناموجود |

### آدرس‌ها (عمومی — بدون نیاز به لاگین)

| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/about` | صفحه درباره ما |
| GET | `/faq` | صفحه سوالات متداول |
| GET | `/contact` | صفحه تماس با ما |
| GET | `/terms` | صفحه قوانین و مقررات |
| — | هر مسیر نامعتبر | صفحه سفارشی ۴۰۴ |

### فوتر (Footer)

فوتر سایت در قالب `templates/shop/base_shop.html` تعریف شده و شامل موارد زیر است:

- **اطلاعات شرکت**: نام، توضیح کوتاه، نشانی، تلفن، ایمیل
- **لینک‌های سریع**: صفحه اصلی، محصولات، احراز اصالت، سوالات متداول، درباره ما، تماس با ما، قوانین
- **نشان‌های اعتماد**: لینک به نمادهای اعتماد الکترونیکی (enamad، ساماندهی و غیره)
- **شبکه‌های اجتماعی**: لینک به حساب‌های اینستاگرام، تلگرام، واتساپ و غیره
- **لینک‌های عضویت**: عضویت در انجمن طلا و جواهر و سایر مجامع صنفی

### ناوبار (Navbar)

ناوبار سایت در `templates/shop/base_shop.html` به‌روز شده و شامل لینک‌های زیر است:

- احراز اصالت (`/verify`)
- سوالات متداول (`/faq`)
- درباره ما (`/about`)
- تماس با ما (`/contact`)

### پیاده‌سازی فنی

- تابع کمکی `_static_page_ctx(request, db)` در `main.py` برای تولید context مشترک (اطلاعات کاربر، تعداد سبد خرید، CSRF token)
- صفحات ثابت نیازی به مدل دیتابیسی ندارند — محتوا در قالب‌های Jinja2 نوشته شده
- صفحه ۴۰۴ از طریق `@app.exception_handler(404)` ثبت شده

### قالب‌ها (Templates)

| قالب | توضیح |
|-------|--------|
| `templates/shop/about.html` | صفحه درباره ما |
| `templates/shop/faq.html` | صفحه سوالات متداول |
| `templates/shop/contact.html` | صفحه تماس با ما |
| `templates/shop/terms.html` | صفحه قوانین و مقررات |
| `templates/shop/404.html` | صفحه سفارشی خطای ۴۰۴ |
| `templates/shop/base_shop.html` | فوتر + ناوبار به‌روز شده |

---

## 21. ثبت مالکیت و انتقال شمش (Bar Claim & Ownership Transfer)

**مسیر فایل‌ها**: `modules/inventory/` (مدل BarTransfer) + route‌های مربوطه

### شرح قابلیت

این ماژول امکان **ثبت مالکیت**، **خرید هدیه** و **انتقال شمش** بین مشتریان را فراهم می‌کند.

### مدل‌های جدید / تغییریافته

#### Bar — فیلد جدید `claim_code`
- `claim_code` (String(8), unique, nullable, indexed): کد ۶ کاراکتری برای ثبت مالکیت
- مجموعه کاراکترها: `ABCDEFGHJKMNPQRSTUVWXYZ23456789` (بدون کاراکترهای مبهم مثل O/0/I/1/L)
- تولید خودکار هنگام فروش حضوری (POS) و خرید هدیه (gift)

#### Order — فیلد جدید `is_gift`
- `is_gift` (Boolean, default=False): آیا سفارش به‌عنوان هدیه ثبت شده
- در سفارش هدیه: `customer_id` شمش NULL می‌ماند و `claim_code` تولید می‌شود

#### BarTransfer (مدل جدید)
- `id`: شناسه یکتا
- `bar_id` (FK → bars): شمش مورد انتقال
- `from_customer_id` (FK → customers): مالک فعلی (فرستنده)
- `to_mobile` (String): شماره موبایل گیرنده
- `otp_hash` (String): هش رمز یک‌بارمصرف ارسال‌شده به فرستنده
- `otp_expiry` (DateTime): زمان انقضای OTP
- `status` (String): وضعیت درخواست انتقال (Pending / Completed / Expired)
- `created_at` (DateTime): زمان ایجاد

### سناریوهای اصلی

#### ۱. فروش حضوری (POS) با کد ثبت مالکیت
- نماینده شمش را از طریق POS می‌فروشد
- سیستم خودکار `claim_code` تولید و در Bar ذخیره می‌کند
- کد در پاسخ API و رسید فروش POS نمایش داده می‌شود
- خریدار با این کد می‌تواند مالکیت شمش را در سایت ثبت کند

#### ۲. خرید هدیه (Gift Purchase)
- مشتری در صفحه checkout تیک «خرید به‌عنوان هدیه» (`is_gift`) را می‌زند
- پس از پرداخت موفق، `claim_code` برای شمش تولید می‌شود
- `customer_id` شمش NULL می‌ماند (مالکیت ثبت نمی‌شود)
- خریدار `claim_code` را به گیرنده هدیه می‌دهد

#### ۳. ثبت مالکیت (Claim Bar)
- مشتری از طریق **منوی کشویی کاربر → «ثبت شمش»**، **لینک فوتر**، یا **دکمه «ثبت شمش جدید» در صفحه شمش‌های من** وارد فرم ثبت مالکیت می‌شود
- سریال‌کد شمش و کد ثبت مالکیت (`claim_code`) را وارد می‌کند
- سیستم بررسی می‌کند: سریال معتبر + claim_code صحیح + شمش بدون مالک
- مالکیت شمش به مشتری منتقل و `claim_code` حذف می‌شود
- رکورد OwnershipHistory ثبت می‌شود

#### ۴. مشاهده شمش‌های من (My Bars)
- مشتری از طریق **منوی کشویی کاربر → «شمش‌های من»** لیست تمام شمش‌های متعلق به خود را می‌بیند
- اطلاعات: سریال‌کد، نام محصول، وزن، عیار، تاریخ خرید

#### ۵. انتقال مالکیت (Ownership Transfer)
جریان ۳ مرحله‌ای:

1. **مرحله ۱**: مالک شمش به `/my-bars/{bar_id}/transfer` می‌رود و شماره موبایل گیرنده را وارد می‌کند
2. **مرحله ۲**: سیستم OTP به موبایل **مالک فعلی** (فرستنده) ارسال می‌کند (تایید هویت فرستنده)
3. **مرحله ۳**: مالک OTP را وارد و تایید می‌کند → مالکیت شمش منتقل می‌شود:
   - `customer_id` شمش به مشتری گیرنده تغییر می‌کند (اگر گیرنده حساب ندارد، ایجاد می‌شود)
   - رکورد OwnershipHistory ثبت می‌شود
   - رکورد BarTransfer با وضعیت Completed ثبت می‌شود

### آدرس‌ها (مشتری)

| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/my-bars` | لیست شمش‌های مشتری |
| GET | `/claim-bar` | فرم ثبت مالکیت |
| POST | `/claim-bar` | پردازش ثبت مالکیت |
| GET | `/my-bars/{bar_id}/transfer` | فرم انتقال مالکیت |
| POST | `/my-bars/{bar_id}/transfer` | ارسال OTP به مالک |
| POST | `/my-bars/{bar_id}/transfer/confirm` | تایید انتقال با OTP |

### تغییر در API نماینده (Dealer POS API)

| متد | مسیر | تغییر |
|------|------|--------|
| POST | `/api/dealer/sale` | پاسخ اکنون شامل `claim_code` در خروجی JSON است |

### فایل‌های مرتبط

| فایل | تغییرات |
|-------|---------|
| `modules/inventory/models.py` | فیلد `claim_code` در Bar + مدل جدید `BarTransfer` |
| `modules/order/models.py` | فیلد `is_gift` در Order |
| `modules/dealer/api_routes.py` | بازگشت `claim_code` در پاسخ فروش POS |
| `modules/dealer/service.py` | تولید خودکار `claim_code` هنگام فروش POS |
| route ثبت مالکیت / انتقال | صفحات claim-bar, my-bars, transfer |
| `templates/shop/` | قالب‌های claim_bar.html, my_bars.html, transfer.html |
| `templates/shop/base_shop.html` | لینک «ثبت شمش» در منوی کشویی کاربر + فوتر |
| `templates/shop/checkout.html` | چک‌باکس «خرید به‌عنوان هدیه» |
| `templates/admin/inventory/bars.html` | نمایش کد ثبت مالکیت زیر سریال‌کد (با آیکن کلید) |
| `templates/admin/inventory/edit_bar.html` | نمایش کد ثبت مالکیت در بخش اطلاعات سریع |

### دسترسی از رابط کاربری (Navigation)

مشتری از مسیرهای زیر به صفحه ثبت شمش دسترسی دارد:
- **منوی کشویی کاربر** (ناوبار): آیتم «ثبت شمش» با آیکن `bi-plus-circle`
- **فوتر سایت**: لینک «ثبت شمش» در بخش دسترسی سریع
- **صفحه شمش‌های من** (`/my-bars`): دکمه «ثبت شمش جدید» بالای صفحه + دکمه در حالت خالی

---

## 22. مدیریت کاربران (Customer Management)

**مسیر فایل‌ها**: `modules/admin/` (بخش مدیریت کاربران)

### شرح قابلیت

صفحه مدیریت کاربران در پنل مدیریت، امکان مشاهده لیست تمام مشتریان، جستجو، فیلتر وضعیت، مشاهده جزئیات هر مشتری (شامل کیف پول، سفارشات و برداشت‌ها) و **ویرایش اطلاعات مشتری** را فراهم می‌کند.

### لینک سایدبار

- آیکون: `bi-people` (مدیریت کاربران)
- مسیر: `/admin/customers`

### صفحه لیست مشتریان (`/admin/customers`)

- **کارت‌های آماری**: تعداد کل مشتریان، مشتریان فعال، ثبت‌نام امروز، مشتریان دارای سفارش
- **جستجو**: بر اساس نام، شماره موبایل، کد ملی
- **فیلتر وضعیت**: فعال / غیرفعال
- **جدول صفحه‌بندی‌شده**: نام مشتری، موبایل، کد ملی، تاریخ ثبت‌نام، وضعیت، تعداد سفارش

### صفحه جزئیات مشتری (`/admin/customers/{id}`)

چهار تب اطلاعاتی:

| تب | توضیح |
|-----|--------|
| **خلاصه (Overview)** | اطلاعات مشتری (نام، موبایل، کد ملی، تاریخ ثبت‌نام) + **فرم ویرایش inline** (نام، موبایل، کد ملی، نوع مشتری حقیقی/حقوقی، فیلدهای حقوقی، کد پستی، آدرس، تلفن، تاریخ تولد، وضعیت فعال/غیرفعال) + کارت‌های موجودی کیف پول (IRR + XAU_MG) |
| **کیف پول (Wallet)** | لیست صفحه‌بندی‌شده تراکنش‌های حسابداری (LedgerEntry) — تراکنش‌های ریالی (IRR) و طلایی (XAU_MG) |
| **سفارشات (Orders)** | لیست صفحه‌بندی‌شده سفارشات مشتری با وضعیت، مبلغ، روش تحویل و تاریخ |
| **برداشت‌ها (Withdrawals)** | لیست صفحه‌بندی‌شده درخواست‌های برداشت مشتری با وضعیت (در انتظار / تایید / رد)، مبلغ و شماره شبا |

### آدرس‌ها

| متد | مسیر | توضیح |
|------|------|--------|
| GET | `/admin/customers` | لیست مشتریان (جستجو + فیلتر وضعیت + صفحه‌بندی + کارت‌های آماری) |
| GET | `/admin/customers/{id}` | جزئیات مشتری (تب‌ها: خلاصه، کیف پول، سفارشات، برداشت‌ها) |
| POST | `/admin/customers/{id}` | ویرایش اطلاعات مشتری (نام، موبایل، کد ملی، نوع مشتری، وضعیت، فیلدهای حقوقی) — بررسی یکتایی موبایل و کد ملی + CSRF |

### دسترسی

| نقش | دسترسی |
|------|--------|
| Super Admin | ✅ |
| Operator | ✅ |
| Dealer | — |
| Customer | — |

### فایل‌های مرتبط

| فایل | توضیح |
|-------|--------|
| `modules/admin/routes.py` یا `modules/customer/admin_routes.py` | Route های مدیریت کاربران |
| `templates/admin/customers/list.html` | قالب لیست مشتریان |
| `templates/admin/customers/detail.html` | قالب جزئیات مشتری |
| `templates/admin/base_admin.html` | لینک سایدبار «مدیریت کاربران» با آیکون `bi-people` |

---

> این سند بر اساس کد واقعی پروژه TalaMala v4 (فازهای ۱-۱۴ + بازگشت اجرت بازخرید + بهبود تیکتینگ + صفحات ثابت و فوتر + ثبت مالکیت و انتقال شمش + مدیریت کاربران + ویرایش مشتری توسط ادمین + اطلاعات خریدار در فاکتور + الزام تکمیل پروفایل + انتخاب بسته‌بندی مشتری + گزارش فروش نمایندگان) تهیه شده و هیچ قابلیت فرضی شامل نشده است.
