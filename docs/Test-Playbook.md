# دفترچه تست سیستم طلامالا v4 — Test Playbook

> این سند شامل سناریوهای تست دقیق برای QA سیستم TalaMala v4 است.
> هر تست دارای شناسه یکتا، اقدام، ورودی، نتیجه مورد انتظار و ستون وضعیت است.

---

## فهرست مطالب

1. [پیش‌نیازها و داده‌های تست](#1-پیشنیازها-و-دادههای-تست)
2. [TS-01: احراز هویت (Auth)](#2-ts-01-احراز-هویت)
3. [TS-02: فروشگاه (Shop)](#3-ts-02-فروشگاه)
4. [TS-03: سبد خرید (Cart)](#4-ts-03-سبد-خرید)
5. [TS-04: ثبت سفارش (Checkout & Order)](#5-ts-04-ثبت-سفارش)
6. [TS-05: پرداخت (Payment)](#6-ts-05-پرداخت)
7. [TS-06: کیف پول (Wallet)](#7-ts-06-کیف-پول)
8. [TS-07: کوپن (Coupon)](#8-ts-07-کوپن)
9. [TS-08: پنل مدیریت (Admin)](#9-ts-08-پنل-مدیریت)
10. [TS-09: نمایندگان (Dealer)](#10-ts-09-نمایندگان)
11. [TS-10: احراز اصالت (Verification)](#11-ts-10-احراز-اصالت)
12. [TS-11: پروفایل و آدرس (Profile & Address)](#12-ts-11-پروفایل-و-آدرس)
13. [TS-12: تیکتینگ / پشتیبانی (Ticket)](#13-ts-12-تیکتینگ--پشتیبانی)
14. [TS-13: POS REST API نماینده](#14-ts-13-pos-rest-api-نماینده)
15. [TS-14: بازپرداخت اجرت بازخرید (Buyback Wage Refund)](#15-ts-14-بازپرداخت-اجرت-بازخرید)
16. [TS-15: صفحات ثابت و فوتر (Static Pages & Footer)](#16-ts-15-صفحات-ثابت-و-فوتر)
17. [TS-16: ثبت مالکیت، خرید هدیه و انتقال شمش (Bar Claim & Transfer)](#17-ts-16-ثبت-مالکیت-خرید-هدیه-و-انتقال-شمش)
18. [TS-NEG: تست‌های منفی (Negative Tests)](#18-ts-neg-تستهای-منفی)

---

## 1. پیش‌نیازها و داده‌های تست

### محیط تست
```
python scripts/seed.py --reset
uvicorn main:app --reload
مرورگر: http://127.0.0.1:8000
```

### حساب‌های تست

| شناسه | نقش | موبایل | توضیح |
|--------|------|---------|--------|
| U1 | Super Admin | 09123456789 | دسترسی کامل |
| U2 | Operator | 09121111111 | عملیاتی |
| U3 | Customer | 09351234567 | کیف پول: ۱۰ میلیون تومان |
| U4 | Customer | 09359876543 | بدون موجودی |
| U5 | Customer | 09131112233 | — |
| D1 | Dealer | نماینده اصفهان | کمیسیون ۲٪ |
| D2 | Dealer | نماینده شیراز | کمیسیون ۲.۵٪ |
| D3 | Dealer | نماینده مشهد | کمیسیون ۳٪ |

### کوپن‌های تست

| شناسه | کد | نوع | توضیح |
|--------|------|------|--------|
| C1 | WELCOME10 | ۱۰٪ تخفیف | اولین خرید |
| C2 | CASHBACK5 | ۵٪ کشبک | واریز به کیف پول |
| C3 | FIXED500 | ۵۰۰ هزار تومان | حداقل سفارش ۵ میلیون |
| C4 | VIP2026 | ۱۵٪ تخفیف | فقط موبایل‌های خاص |

### کد OTP در محیط تست
در حالت توسعه، کد OTP ثابت `111111` است.

---

## 2. TS-01: احراز هویت

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TS-01-01 | باز کردن صفحه لاگین | مرورگر → `/auth/login` | فرم ورود با فیلد موبایل نمایش داده شود | ☐ |
| TS-01-02 | درخواست OTP برای ادمین | موبایل: `09123456789` | پیام «کد ارسال شد» + ریدایرکت به فرم OTP | ☐ |
| TS-01-03 | تایید OTP ادمین | کد: `111111` | ریدایرکت به `/admin/dashboard` | ☐ |
| TS-01-04 | درخواست OTP برای مشتری | موبایل: `09351234567` | پیام «کد ارسال شد» | ☐ |
| TS-01-05 | تایید OTP مشتری | کد: `111111` | ریدایرکت به `/` (صفحه اصلی فروشگاه) | ☐ |
| TS-01-06 | لاگین نماینده | موبایل نماینده + OTP `111111` | ریدایرکت به `/dealer/dashboard` | ☐ |
| TS-01-07 | خروج (Logout) | کلیک روی «خروج» | ریدایرکت به `/auth/login` + حذف کوکی | ☐ |
| TS-01-08 | لاگین مشتری جدید | موبایل: `09199999999` + OTP | حساب مشتری جدید ایجاد شود + ریدایرکت به `/` | ☐ |
| TS-01-09 | OTP اشتباه | کد: `000000` | پیام خطا «کد نادرست» | ☐ |
| TS-01-10 | موبایل نامعتبر | موبایل: `1234` | ارسال نشود / خطای اعتبارسنجی | ☐ |

---

## 3. TS-02: فروشگاه

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TS-02-01 | صفحه اصلی فروشگاه | مرورگر → `/` | لیست محصولات با قیمت نمایش شود | ☐ |
| TS-02-02 | فیلتر دسته‌بندی | کلیک روی یک دسته‌بندی | فقط محصولاتی که آن دسته‌بندی را دارند نمایش شوند (M2M — محصولات چنددسته‌بندی‌ای در نتایج ظاهر می‌شوند) | ☐ |
| TS-02-02a | فیلتر دسته‌بندی — محصول چنددسته‌بندی | محصولی با ۲ دسته‌بندی (A و B) → فیلتر روی A | محصول در نتایج نمایش شود + فیلتر روی B هم آن محصول را نشان دهد | ☐ |
| TS-02-03 | مرتب‌سازی ارزان‌ترین | انتخاب «ارزان‌ترین» | محصولات به ترتیب قیمت صعودی | ☐ |
| TS-02-04 | مرتب‌سازی گران‌ترین | انتخاب «گران‌ترین» | محصولات به ترتیب قیمت نزولی | ☐ |
| TS-02-05 | صفحه جزئیات محصول | کلیک روی یک محصول | نمایش: نام، وزن، عیار، ریز قیمت، تصویر، دکمه افزودن | ☐ |
| TS-02-06 | قیمت لحظه‌ای | تغییر قیمت طلا در تنظیمات → رفرش فروشگاه | قیمت‌ها بر اساس قیمت جدید محاسبه شوند | ☐ |
| TS-02-07 | محصول بدون موجودی | محصولی که شمش Assigned ندارد | نمایش «ناموجود» یا عدم نمایش دکمه خرید | ☐ |

---

## 4. TS-03: سبد خرید

**پیش‌نیاز**: لاگین به‌عنوان مشتری (U3: `09351234567`)

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TS-03-01 | افزودن به سبد | کلیک «افزودن به سبد» در صفحه محصول | محصول به سبد اضافه شود + تعداد سبد +۱ | ☐ |
| TS-03-02 | مشاهده سبد | مرورگر → `/cart` | لیست آیتم‌ها با قیمت و جمع کل | ☐ |
| TS-03-03 | تغییر تعداد | تغییر تعداد آیتم به ۲ | قیمت و جمع کل به‌روز شود | ☐ |
| TS-03-04 | حذف از سبد | کلیک «حذف» روی آیتم | آیتم حذف شود + جمع کل به‌روز شود | ☐ |
| TS-03-05 | سبد خالی | حذف همه آیتم‌ها | پیام «سبد خرید خالی است» | ☐ |
| TS-03-06 | افزودن بدون لاگین | بدون لاگین، کلیک «افزودن به سبد» | ریدایرکت به صفحه ورود | ☐ |

---

## 5. TS-04: ثبت سفارش

**پیش‌نیاز**: لاگین U3 + حداقل ۱ آیتم در سبد

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TS-04-01 | باز کردن چک‌اوت | مرورگر → `/checkout` | فرم تحویل + خلاصه سفارش | ☐ |
| TS-04-02 | انتخاب تحویل حضوری | انتخاب «حضوری» + انتخاب نمایندگی | نمایندگی‌ها در dropdown نمایش شوند | ☐ |
| TS-04-03 | انتخاب ارسال پستی | انتخاب «پستی» + وارد کردن آدرس | فیلدهای آدرس نمایش شوند + هزینه ارسال اضافه شود | ☐ |
| TS-04-04 | اعمال کوپن تخفیف | وارد کردن `WELCOME10` | تخفیف ۱۰٪ نمایش شود + مبلغ نهایی کاهش یابد | ☐ |
| TS-04-05 | اعمال کوپن کشبک | وارد کردن `CASHBACK5` | نوع کشبک نمایش شود (واریز پس از تحویل) | ☐ |
| TS-04-06 | ثبت سفارش حضوری | فرم کامل + کلیک «ثبت سفارش» | سفارش ایجاد شود با وضعیت Pending + ریدایرکت به جزئیات | ☐ |
| TS-04-07 | ثبت سفارش پستی | فرم کامل + آدرس + کلیک «ثبت سفارش» | سفارش با هزینه ارسال ایجاد شود | ☐ |
| TS-04-08 | رزرو شمش | ثبت سفارش | شمش مربوطه وضعیت Reserved بگیرد | ☐ |
| TS-04-09 | لغو سفارش توسط مشتری | سفارش Pending → «لغو سفارش» | وضعیت Cancelled + دلیل «لغو توسط مشتری» + تاریخ لغو نمایش شود | ☐ |
| TS-04-10 | لغو سفارش توسط مدیر | ادمین → سفارش Pending → «لغو» | وضعیت Cancelled + دلیل «لغو توسط مدیر سیستم» | ☐ |
| TS-04-11 | لغو خودکار (انقضای رزرو) | سفارش Pending بیش از ۱۵ دقیقه | وضعیت Cancelled + دلیل «عدم پرداخت در مهلت مقرر» | ☐ |
| TS-04-12 | نمایش دلیل لغو | جزئیات سفارش لغو‌شده | دلیل لغو + تاریخ لغو در صفحه نمایش داده شود | ☐ |

---

## 6. TS-05: پرداخت

**پیش‌نیاز**: سفارش ثبت‌شده با وضعیت Pending

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TS-05-01 | پرداخت با کیف پول (موجودی کافی) | U3 (۱۰M تومان) → «پرداخت با کیف پول» | سفارش Paid شود + موجودی کم شود + شمش Sold شود | ☐ |
| TS-05-02 | پرداخت با کیف پول (موجودی ناکافی) | U4 (بدون موجودی) → «پرداخت با کیف پول» | خطا: «موجودی کافی نیست» | ☐ |
| TS-05-03 | پرداخت با درگاه زیبال | کلیک «پرداخت آنلاین» | ریدایرکت به درگاه زیبال (sandbox) | ☐ |
| TS-05-04 | بازگشت موفق از درگاه | پرداخت موفق در sandbox | سفارش Paid + شمش Sold + ریدایرکت به جزئیات سفارش | ☐ |
| TS-05-05 | بازگشت ناموفق از درگاه | لغو پرداخت در sandbox | سفارش Pending بماند + پیام خطا | ☐ |
| TS-05-06 | استرداد (ادمین) | ادمین → سفارش Paid → «استرداد» | مبلغ به کیف پول برگردد + شمش آزاد شود | ☐ |

---

## 7. TS-06: کیف پول

**پیش‌نیاز**: لاگین U3

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TS-06-01 | مشاهده داشبورد کیف پول | مرورگر → `/wallet` | موجودی، مبلغ بلوکه، موجودی قابل برداشت | ☐ |
| TS-06-02 | مشاهده تاریخچه | مرورگر → `/wallet/transactions` | لیست تراکنش‌ها با نوع، مبلغ، تاریخ | ☐ |
| TS-06-03 | شارژ کیف پول | وارد کردن مبلغ + «شارژ» | ریدایرکت به درگاه / تایید واریز | ☐ |
| TS-06-04 | درخواست برداشت | مبلغ: ۱,۰۰۰,۰۰۰ تومان + شبا | درخواست ایجاد شود با وضعیت PENDING | ☐ |
| TS-06-05 | تایید برداشت (ادمین) | ادمین → برداشت‌ها → «تایید» | وضعیت Paid + موجودی مشتری کم شود | ☐ |
| TS-06-06 | رد برداشت (ادمین) | ادمین → برداشت‌ها → «رد» | وضعیت Rejected + موجودی برنگردد (قبلاً بلوکه بوده) | ☐ |
| TS-06-07 | برداشت بیش از موجودی | مبلغ بیش از موجودی قابل برداشت | خطا: «موجودی کافی نیست» | ☐ |

---

## 8. TS-07: کوپن

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TS-07-01 | بررسی کوپن معتبر (AJAX) | `/api/coupon/check?code=WELCOME10` | JSON: valid=true + اطلاعات تخفیف | ☐ |
| TS-07-02 | بررسی کوپن نامعتبر | `/api/coupon/check?code=INVALID` | JSON: valid=false | ☐ |
| TS-07-03 | کوپن اولین خرید — مشتری جدید | U5 (بدون خرید) + WELCOME10 | تخفیف اعمال شود | ☐ |
| TS-07-04 | کوپن اولین خرید — مشتری قدیمی | U3 (با خرید قبلی) + WELCOME10 | خطا: «فقط برای اولین خرید» | ☐ |
| TS-07-05 | کوپن مبلغ ثابت — زیر حداقل | سفارش ۳M + FIXED500 (حداقل ۵M) | خطا: «حداقل مبلغ سفارش ...» | ☐ |
| TS-07-06 | کوپن مبلغ ثابت — بالای حداقل | سفارش ۶M + FIXED500 | تخفیف ۵۰۰,۰۰۰ تومان اعمال شود | ☐ |
| TS-07-07 | کوپن VIP — موبایل مجاز | موبایل در لیست سفید + VIP2026 | تخفیف ۱۵٪ اعمال شود | ☐ |
| TS-07-08 | کوپن VIP — موبایل غیرمجاز | موبایل نه در لیست سفید + VIP2026 | خطا: «مجاز نیست» | ☐ |
| TS-07-09 | کوپن منقضی | کوپن با تاریخ انقضا گذشته | خطا: «منقضی شده» | ☐ |
| TS-07-10 | کوپن با سقف استفاده پر | کوپن با max_total_uses رسیده | خطا: «ظرفیت تمام» | ☐ |

### تست‌های محدودیت دسته‌بندی (CATEGORY scope)

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TS-07-11 | ایجاد کوپن دسته‌بندی | `/admin/coupons/create` → scope: CATEGORY + انتخاب «شمش گرمی» | کوپن ایجاد شود + M2M ذخیره شود | ☐ |
| TS-07-12 | ویرایش دسته‌بندی‌های کوپن | ویرایش کوپن CATEGORY + تغییر دسته‌بندی‌های انتخابی | دسته‌بندی‌ها به‌روز شوند | ☐ |
| TS-07-13 | AJAX چک — دسته‌بندی معتبر | سبد با محصول «شمش گرمی» + کد GOLD10 (CATEGORY) | JSON: valid=true + تخفیف | ☐ |
| TS-07-14 | AJAX چک — دسته‌بندی نامعتبر | سبد با محصول از دسته‌بندی دیگر + کد GOLD10 | JSON: valid=false + خطا «فقط برای دسته‌بندی خاصی معتبر است» | ☐ |
| TS-07-15 | AJAX چک — سبد مختلط | سبد با محصول از «شمش گرمی» و دسته دیگر + GOLD10 | JSON: valid=true (اشتراک ناخالی) | ☐ |
| TS-07-16 | Checkout با کوپن CATEGORY | سبد با «شمش گرمی» + GOLD10 → ثبت سفارش | تخفیف اعمال شود + سفارش ایجاد شود | ☐ |
| TS-07-17 | کوپن GLOBAL — بدون محدودیت | سبد با هر دسته‌بندی + WELCOME10 (GLOBAL) | تخفیف اعمال شود (بدون محدودیت) | ☐ |

---

## 9. TS-08: پنل مدیریت

**پیش‌نیاز**: لاگین U1 (Super Admin)

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TS-08-01 | داشبورد | مرورگر → `/admin/dashboard` | آمار + نمودارها + سفارشات اخیر | ☐ |
| TS-08-02 | API آمار JSON | مرورگر → `/admin/dashboard/api/stats` | JSON با تمام فیلدهای stats | ☐ |
| TS-08-03 | لیست محصولات | `/admin/products` | جدول محصولات با نام، وزن، عیار، وضعیت | ☐ |
| TS-08-04 | ایجاد محصول با چند دسته‌بندی | `/admin/products/create` + فرم + انتخاب ۲ دسته‌بندی با چک‌باکس | محصول جدید ایجاد شود + هر دو دسته‌بندی ذخیره شوند (M2M) | ☐ |
| TS-08-04a | ایجاد محصول با یک دسته‌بندی | `/admin/products/create` + فرم + انتخاب ۱ دسته‌بندی | محصول ایجاد شود + فقط دسته‌بندی انتخابی ذخیره شود | ☐ |
| TS-08-05 | ویرایش محصول — تغییر دسته‌بندی‌ها | `/admin/products/{id}/edit` + تغییر چک‌باکس‌های دسته‌بندی | دسته‌بندی‌ها به‌روز شوند (قبلی‌ها حذف + جدیدها اضافه) | ☐ |
| TS-08-05a | ویرایش محصول — بررسی چک‌باکس‌های پیش‌فرض | `/admin/products/{id}/edit` | چک‌باکس‌های دسته‌بندی‌های فعلی محصول از قبل تیک خورده باشند | ☐ |
| TS-08-06 | لیست دسته‌بندی‌ها | `/admin/categories` | جدول دسته‌بندی‌ها | ☐ |
| TS-08-07 | ایجاد دسته‌بندی | `/admin/categories/create` + فرم | دسته‌بندی جدید ایجاد شود | ☐ |
| TS-08-08 | لیست شمش‌ها | `/admin/bars` | جدول شمش‌ها با فیلتر وضعیت | ☐ |
| TS-08-09 | ویرایش شمش | `/admin/bars/{id}/edit` + فرم | تخصیص محصول/مکان ذخیره شود | ☐ |
| TS-08-10 | لیست مکان‌ها | `/admin/locations` | جدول مکان‌ها با نوع و وضعیت | ☐ |
| TS-08-11 | لیست سفارشات | `/admin/orders` | جدول سفارشات با فیلتر وضعیت | ☐ |
| TS-08-12 | تنظیمات سیستم | `/admin/settings` | فرم قیمت طلا، مالیات، ارسال | ☐ |
| TS-08-13 | تغییر قیمت طلا | تنظیمات → قیمت جدید → ذخیره | قیمت محصولات در فروشگاه تغییر کند | ☐ |
| TS-08-14 | لیست حساب‌ها | `/admin/wallet/accounts` | جدول حساب‌ها با موجودی | ☐ |
| TS-08-15 | جزئیات حساب | `/admin/wallet/accounts/{id}` | تاریخچه تراکنش‌های حساب | ☐ |
| TS-08-16 | لیست برداشت‌ها | `/admin/wallet/withdrawals` | جدول درخواست‌ها با وضعیت | ☐ |
| TS-08-17 | لیست کوپن‌ها | `/admin/coupons` | جدول کوپن‌ها با وضعیت و نوع | ☐ |
| TS-08-18 | ایجاد کوپن | `/admin/coupons/create` + فرم | کوپن جدید ایجاد شود | ☐ |

---

## 10. TS-09: نمایندگان

### تست‌های پنل ادمین

**پیش‌نیاز**: لاگین U1 یا U2

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TS-09-01 | لیست نمایندگان | `/admin/dealers` | جدول نمایندگان + ۶ کارت آماری | ☐ |
| TS-09-02 | ایجاد نماینده | `/admin/dealers/create` + فرم | نماینده جدید ایجاد شود | ☐ |
| TS-09-03 | ویرایش نماینده | `/admin/dealers/{id}/edit` + فرم | تغییرات ذخیره شود | ☐ |
| TS-09-04 | غیرفعال کردن نماینده | ویرایش → فعال=خاموش → ذخیره | نماینده نتواند لاگین کند | ☐ |
| TS-09-05 | لیست بازخرید | `/admin/dealers/buybacks` | جدول درخواست‌ها با فیلتر | ☐ |
| TS-09-06 | فیلتر بازخرید | فیلتر «در انتظار» | فقط درخواست‌های Pending | ☐ |
| TS-09-07 | تایید بازخرید | درخواست Pending → «تایید» + یادداشت | وضعیت به Approved تغییر کند | ☐ |
| TS-09-08 | رد بازخرید | درخواست Pending → «رد» + دلیل | وضعیت به Rejected + دلیل رد نمایش شود | ☐ |
| TS-09-09 | API آمار نمایندگان | `/admin/dealers/stats` | JSON با total_dealers, total_sales, ... | ☐ |

### تست‌های پنل نماینده

**پیش‌نیاز**: لاگین نماینده D1

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TS-09-10 | داشبورد نماینده | `/dealer/dashboard` | آمار فروش + کمیسیون + اقدامات سریع | ☐ |
| TS-09-11 | فروش حضوری (POS) — فرم | `/dealer/pos` | فرم با فیلد شمش، قیمت، اطلاعات خریدار | ☐ |
| TS-09-12 | فروش حضوری — ثبت | انتخاب شمش + مبلغ ۵M تومان + نام خریدار | فروش ثبت شود + کمیسیون محاسبه شود | ☐ |
| TS-09-13 | فروش — شمش نامعتبر | سریال‌کد اشتباه | خطا: «شمش یافت نشد» | ☐ |
| TS-09-14 | بازخرید — فرم | `/dealer/buyback` | فرم با فیلد سریال، مبلغ، اطلاعات فروشنده | ☐ |
| TS-09-15 | بازخرید — ثبت | سریال شمش فروخته‌شده + مبلغ ۴.۵M تومان | درخواست بازخرید ثبت شود با وضعیت Pending | ☐ |
| TS-09-16 | تاریخچه فروش | `/dealer/sales` | لیست فروش‌ها با مبلغ، کمیسیون، تاریخ | ☐ |
| TS-09-17 | تاریخچه بازخرید | `/dealer/buybacks` | لیست درخواست‌ها با وضعیت و رنگ badge | ☐ |

---

## 11. TS-10: احراز اصالت

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TS-10-01 | صفحه احراز اصالت | مرورگر → `/verify` | فرم ورود سریال‌کد | ☐ |
| TS-10-02 | سریال‌کد معتبر | سریال‌کد یکی از شمش‌های seed | نمایش: محصول، وزن، عیار، وضعیت | ☐ |
| TS-10-03 | سریال‌کد نامعتبر | سریال‌کد: `XXXXXXXX` | پیام «سریال‌کد یافت نشد» | ☐ |
| TS-10-04 | بدون لاگین | بدون هیچ کوکی auth → `/verify` | صفحه باید بدون مشکل باز شود (عمومی) | ☐ |

---

## 12. TS-11: پروفایل و آدرس

**پیش‌نیاز**: لاگین U3

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TS-11-01 | مشاهده پروفایل | مرورگر → `/profile` | نمایش نام، موبایل، کد ملی | ☐ |
| TS-11-02 | ویرایش پروفایل | نام جدید → «ذخیره» | نام به‌روز شود | ☐ |
| TS-11-03 | مشاهده دفتر آدرس | مرورگر → `/addresses` | لیست آدرس‌ها | ☐ |
| TS-11-04 | افزودن آدرس | فرم: عنوان + استان + شهر + آدرس + کدپستی | آدرس جدید اضافه شود | ☐ |
| TS-11-05 | حذف آدرس | کلیک «حذف» روی آدرس | آدرس حذف شود | ☐ |
| TS-11-06 | تعیین آدرس پیش‌فرض | کلیک «پیش‌فرض» | آدرس انتخابی پیش‌فرض شود | ☐ |
| TS-11-07 | AJAX شهرها | انتخاب استان در فرم آدرس | شهرهای آن استان بارگذاری شوند | ☐ |
| TS-11-08 | AJAX مناطق | انتخاب شهر | مناطق آن شهر بارگذاری شوند | ☐ |

---

## 13. TS-12: تیکتینگ / پشتیبانی

### تیکت مشتری

| شناسه | اقدام | ورودی / مراحل | نتیجه مورد انتظار | وضعیت |
|--------|--------|---------------|---------------------|--------|
| TS-12-01 | مشاهده لیست تیکت‌ها (مشتری) | لاگین U3 → `/tickets` | صفحه لیست تیکت‌ها نمایش داده شود (با تیکت‌های seed) | ☐ |
| TS-12-02 | ایجاد تیکت جدید (مشتری) | `/tickets/new` → موضوع: «مشکل ارسال» + اولویت: متوسط + متن | ثبت موفق + ریدایرکت به جزئیات تیکت | ☐ |
| TS-12-03 | مشاهده جزئیات تیکت | `/tickets/{id}` | پیام اولیه + اطلاعات تیکت نمایش داده شود | ☐ |
| TS-12-04 | ارسال پاسخ (مشتری) | در جزئیات تیکت → فرم پاسخ → «ارسال» | پیام جدید اضافه شود | ☐ |
| TS-12-05 | بستن تیکت (مشتری) | در جزئیات → «بستن تیکت» | وضعیت → Closed + فرم پاسخ مخفی | ☐ |
| TS-12-06 | عدم دسترسی به تیکت دیگران | لاگین U4 → `/tickets/1` (تیکت U3) | خطای 403 | ☐ |

### تیکت نماینده

| شناسه | اقدام | ورودی / مراحل | نتیجه مورد انتظار | وضعیت |
|--------|--------|---------------|---------------------|--------|
| TS-12-07 | مشاهده لیست تیکت‌ها (نماینده) | لاگین D1 → `/tickets` | صفحه لیست تیکت‌های نماینده | ☐ |
| TS-12-08 | ایجاد تیکت (نماینده) | `/tickets/new` → موضوع + متن | ثبت موفق + ریدایرکت به جزئیات | ☐ |
| TS-12-09 | ارسال پاسخ (نماینده) | جزئیات تیکت → ارسال پاسخ | پیام اضافه شود | ☐ |
| TS-12-10 | عدم دسترسی به تیکت نماینده دیگر | لاگین D2 → `/tickets/3` (تیکت D1) | خطای 403 | ☐ |

### مدیریت تیکت (ادمین)

| شناسه | اقدام | ورودی / مراحل | نتیجه مورد انتظار | وضعیت |
|--------|--------|---------------|---------------------|--------|
| TS-12-11 | لیست تیکت‌ها — تب همه | لاگین U1 → `/admin/tickets` | تمام تیکت‌ها + badge تعداد | ☐ |
| TS-12-12 | لیست تیکت‌ها — تب مشتریان | `/admin/tickets?sender_type=CUSTOMER` | فقط تیکت‌های مشتریان + badge آبی | ☐ |
| TS-12-13 | لیست تیکت‌ها — تب نمایندگان | `/admin/tickets?sender_type=DEALER` | فقط تیکت‌های نمایندگان + badge بنفش | ☐ |
| TS-12-14 | فیلتر وضعیت | `/admin/tickets?status=Open` | فقط تیکت‌های باز | ☐ |
| TS-12-15 | جزئیات تیکت (ادمین) | `/admin/tickets/1` | مکالمه + پنل کناری (فرستنده، وضعیت، تخصیص) | ☐ |
| TS-12-16 | پاسخ ادمین | جزئیات → فرم پاسخ → «ارسال» | پیام اضافه + وضعیت → Answered + تخصیص خودکار | ☐ |
| TS-12-17 | تخصیص به اپراتور | پنل کناری → انتخاب اپراتور → «تخصیص» | تخصیص موفق + وضعیت Open → InProgress | ☐ |
| TS-12-18 | تغییر وضعیت | پنل کناری → وضعیت جدید → «اعمال» | وضعیت تغییر کند | ☐ |
| TS-12-19 | بستن تیکت (ادمین) | پنل کناری → «بستن تیکت» | وضعیت → Closed | ☐ |
| TS-12-20 | بازگشایی خودکار | ادمین پاسخ داده (Answered) → مشتری پاسخ می‌دهد | وضعیت → Open (بازشده) | ☐ |

### پیوست فایل (File Attachment)

| شناسه | اقدام | ورودی / مراحل | نتیجه مورد انتظار | وضعیت |
|--------|--------|---------------|---------------------|--------|
| TC-TKT-ATT-01 | ایجاد تیکت با پیوست فایل | لاگین U3 → `/tickets/new` → موضوع + متن + انتخاب فایل تصویری → «ارسال» | فایل آپلود شود + در جزئیات تیکت به‌صورت تصویر بندانگشتی (thumbnail) نمایش داده شود | ☐ |
| TC-TKT-ATT-02 | پاسخ به تیکت با پیوست فایل | جزئیات تیکت → فرم پاسخ → متن + انتخاب فایل → «ارسال» | پیوست در نخ مکالمه (conversation thread) نمایش داده شود | ☐ |
| TC-TKT-ATT-03 | پاسخ ادمین با پیوست فایل | لاگین U1 → `/admin/tickets/{id}` → فرم پاسخ → متن + فایل → «ارسال» | مشتری/نماینده در جزئیات تیکت خود پیوست ادمین را ببیند | ☐ |

### دسته‌بندی تیکت (Ticket Category)

| شناسه | اقدام | ورودی / مراحل | نتیجه مورد انتظار | وضعیت |
|--------|--------|---------------|---------------------|--------|
| TC-TKT-CAT-01 | ایجاد تیکت با انتخاب دسته‌بندی | لاگین U3 → `/tickets/new` → انتخاب دسته‌بندی از dropdown + موضوع + متن → «ارسال» | badge دسته‌بندی در جزئیات تیکت و لیست تیکت‌های ادمین نمایش داده شود | ☐ |
| TC-TKT-CAT-02 | فیلتر تیکت‌ها بر اساس دسته‌بندی (ادمین) | لاگین U1 → `/admin/tickets` → انتخاب دسته‌بندی از فیلتر | فقط تیکت‌های دسته‌بندی انتخاب‌شده نمایش داده شوند | ☐ |

### یادداشت داخلی (Internal Note)

| شناسه | اقدام | ورودی / مراحل | نتیجه مورد انتظار | وضعیت |
|--------|--------|---------------|---------------------|--------|
| TC-TKT-INT-01 | ثبت یادداشت داخلی توسط ادمین | لاگین U1 → `/admin/tickets/{id}` → فرم یادداشت داخلی → متن → «ارسال» | یادداشت در جزئیات ادمین با آیکون قفل و استایل هشدار (warning) نمایش داده شود | ☐ |
| TC-TKT-INT-02 | عدم نمایش یادداشت داخلی به مشتری | لاگین U3 → `/tickets/{id}` (تیکتی که ادمین یادداشت داخلی ثبت کرده) | یادداشت داخلی به مشتری نمایش داده نشود | ☐ |
| TC-TKT-INT-03 | عدم نمایش یادداشت داخلی به نماینده | لاگین D1 → `/tickets/{id}` (تیکتی که ادمین یادداشت داخلی ثبت کرده) | یادداشت داخلی به نماینده نمایش داده نشود | ☐ |

### جستجوی تیکت (Ticket Search)

| شناسه | اقدام | ورودی / مراحل | نتیجه مورد انتظار | وضعیت |
|--------|--------|---------------|---------------------|--------|
| TC-TKT-SRCH-01 | جستجو بر اساس شناسه تیکت | لاگین U1 → `/admin/tickets` → فیلد جستجو → وارد کردن شماره تیکت | تیکت مورد نظر پیدا و نمایش داده شود | ☐ |
| TC-TKT-SRCH-02 | جستجو بر اساس موبایل مشتری | لاگین U1 → `/admin/tickets` → فیلد جستجو → وارد کردن شماره موبایل مشتری | تیکت‌های مطابق نمایش داده شوند | ☐ |
| TC-TKT-SRCH-03 | جستجو بر اساس کلمه کلیدی موضوع | لاگین U1 → `/admin/tickets` → فیلد جستجو → وارد کردن کلمه‌ای از موضوع تیکت | تیکت‌های مطابق نمایش داده شوند | ☐ |

### اعلان‌ها (Notifications — حالت توسعه)

| شناسه | اقدام | ورودی / مراحل | نتیجه مورد انتظار | وضعیت |
|--------|--------|---------------|---------------------|--------|
| TC-TKT-NOTIF-01 | اعلان پاسخ ادمین | لاگین U1 → `/admin/tickets/{id}` → ارسال پاسخ | خروجی debug اعلان در کنسول سرور نمایش داده شود (حالت dev) | ☐ |
| TC-TKT-NOTIF-02 | اعلان تغییر وضعیت تیکت | لاگین U1 → `/admin/tickets/{id}` → تغییر وضعیت | خروجی debug اعلان تغییر وضعیت در کنسول سرور نمایش داده شود | ☐ |

---

## 14. TS-13: POS REST API نماینده

### احراز هویت API Key

| # | شرح تست | پیش‌شرط | اقدام | نتیجه مورد انتظار |
|---|---------|---------|-------|-------------------|
| TS-13-01 | درخواست بدون هدر X-API-Key | — | GET /api/dealer/info | خطا 422 |
| TS-13-02 | درخواست با کلید نامعتبر | — | GET /api/dealer/info با کلید اشتباه | خطا 401 |
| TS-13-03 | درخواست با کلید معتبر | نماینده فعال با API Key | GET /api/dealer/info | 200 + اطلاعات نماینده |
| TS-13-04 | نماینده غیرفعال با کلید معتبر | نماینده غیرفعال | GET /api/dealer/info | خطا 401 |

### لیست محصولات

| # | شرح تست | پیش‌شرط | اقدام | نتیجه مورد انتظار |
|---|---------|---------|-------|-------------------|
| TS-13-05 | دریافت لیست محصولات | نماینده با شمش‌های فعال | GET /api/dealer/products | 200 + لیست محصولات با قیمت و سریال + فیلد `categories` آرایه‌ای از نام دسته‌بندی‌ها (نه رشته تکی) |
| TS-13-06 | قیمت‌گذاری لحظه‌ای | تغییر قیمت طلا در تنظیمات | GET /api/dealer/products | قیمت‌ها بروزرسانی شده |
| TS-13-07 | شعبه بدون شمش | نماینده بدون شمش ASSIGNED | GET /api/dealer/products | 200 + لیست خالی |

### ثبت فروش POS

| # | شرح تست | پیش‌شرط | اقدام | نتیجه مورد انتظار |
|---|---------|---------|-------|-------------------|
| TS-13-08 | فروش موفق | سریال شمش موجود و ASSIGNED | POST /api/dealer/sale | 200 + sale_id + commission |
| TS-13-09 | فروش شمش فروخته‌شده | شمش با وضعیت SOLD | POST /api/dealer/sale | خطا 400 |
| TS-13-10 | سریال نامعتبر | سریال وجود ندارد | POST /api/dealer/sale | خطا 400 |
| TS-13-11 | شمش شعبه دیگر | شمش در شعبه دیگر | POST /api/dealer/sale | خطا 400 |
| TS-13-12 | بروزرسانی موجودی بعد از فروش | فروش موفق | GET /api/dealer/products | stock_count کاهش یافته |
| TS-13-13 | ارتباط با مشتری موجود | موبایل مشتری ثبت‌شده | POST /api/dealer/sale | شمش به مشتری لینک شده |

### تاریخچه فروش

| # | شرح تست | پیش‌شرط | اقدام | نتیجه مورد انتظار |
|---|---------|---------|-------|-------------------|
| TS-13-14 | لیست فروش‌ها | فروش‌های ثبت‌شده | GET /api/dealer/sales | 200 + لیست فروش‌ها |
| TS-13-15 | صفحه‌بندی | بیش از ۲۰ فروش | GET /api/dealer/sales?page=2 | صفحه دوم |

### مدیریت کلید API (ادمین)

| # | شرح تست | پیش‌شرط | اقدام | نتیجه مورد انتظار |
|---|---------|---------|-------|-------------------|
| TS-13-16 | تولید کلید API | نماینده بدون کلید | POST generate-api-key | کلید ۶۴ کاراکتری در فرم |
| TS-13-17 | تولید مجدد کلید | نماینده با کلید قبلی | POST generate-api-key | کلید قبلی باطل + کلید جدید |
| TS-13-18 | لغو کلید API | نماینده با کلید فعال | POST revoke-api-key | کلید حذف شده + دستگاه 401 |

---

## 15. TS-14: بازپرداخت اجرت بازخرید

**پیش‌نیاز**: لاگین U1 (Super Admin) + حداقل یک BuybackRequest با وضعیت Pending + مشتری با کیف پول (U3)

### تایید بازخرید و اعتبار اجرت

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TC-BBWR-01 | تایید بازخرید شمش فروش آنلاین → واریز اعتبار اجرت | `/admin/dealers/buybacks` → کلیک «تایید» روی بازخرید Pending (شمش فروخته‌شده از فروشگاه آنلاین) | وضعیت شمش → ASSIGNED + اعتبار اجرت (wage_amount از OrderItem.final_wage_amount) به credit_balance مشتری واریز شود + پیام موفقیت شامل مبلغ اعتبار اجرت + BuybackRequest.wage_refund_amount مقداردهی شود + ستون «اعتبار اجرت» در جدول بازخرید مبلغ را نمایش دهد | ☐ |
| TC-BBWR-02 | تایید بازخرید شمش فروش حضوری (POS) → بدون واریز اعتبار | `/admin/dealers/buybacks` → کلیک «تایید» روی بازخرید Pending (شمش فروخته‌شده از POS، بدون OrderItem) | وضعیت شمش → ASSIGNED + هیچ واریزی به کیف پول انجام نشود + پیام موفقیت: «بازخرید #X تایید شد» بدون اشاره به اعتبار اجرت + BuybackRequest.wage_refund_amount برابر ۰ بماند | ☐ |

### اعتبار فروشگاهی در کیف پول مشتری

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TC-BBWR-03 | نمایش اعتبار فروشگاهی در کیف پول | لاگین مشتری (U3) → `/wallet` (پس از تایید بازخرید با واریز اجرت) | بخش «اعتبار فروشگاهی» نمایش داده شود با مبلغ واریزشده + «قابل برداشت» فقط موجودی قابل برداشت (بدون اعتبار) را نشان دهد + پیام راهنما درباره غیرقابل‌برداشت بودن اعتبار نمایش شود | ☐ |
| TC-BBWR-04 | عدم امکان برداشت اعتبار فروشگاهی | `/wallet/withdraw` → وارد کردن مبلغی بیش از موجودی قابل برداشت (شامل اعتبار) | خطا: «موجودی قابل برداشت کافی نیست» + فرم حداکثر مبلغ برداشت را بر اساس موجودی قابل برداشت (نه موجودی کل) نمایش دهد | ☐ |

### مصرف اعتبار در خرید

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TC-BBWR-05 | پرداخت سفارش با استفاده از اعتبار فروشگاهی | مشتری با اعتبار فروشگاهی → افزودن محصول به سبد → checkout → «پرداخت با کیف پول» | پرداخت موفق با استفاده از موجودی کل (شامل اعتبار) + اگر موجودی عادی کمتر از مبلغ سفارش باشد، اعتبار برای مابقی مصرف شود + پس از پرداخت، credit_balance به‌میزان مصرف‌شده کاهش یابد | ☐ |

### نمایش اعتبار در پنل ادمین

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TC-BBWR-06 | مشاهده اعتبار فروشگاهی در جزئیات کیف پول (ادمین) | لاگین U1 → `/admin/wallets/{customer_id}` | خلاصه موجودی شامل «اعتبار فروشگاهی» با مبلغ + «قابل برداشت» با موجودی قابل برداشت + تراکنش CREDIT در لیست با توضیحات شامل سریال شمش | ☐ |

---

## 16. TS-15: صفحات ثابت و فوتر

### صفحات ثابت (Static Pages)

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TS-15-01 | باز کردن صفحه درباره ما | مرورگر → `/about` (بدون لاگین) | صفحه درباره ما با اطلاعات شرکت نمایش داده شود + ناوبار و فوتر کامل | ☐ |
| TS-15-02 | باز کردن صفحه سوالات متداول | مرورگر → `/faq` (بدون لاگین) | صفحه FAQ با سوالات و پاسخ‌ها (Accordion) نمایش داده شود | ☐ |
| TS-15-03 | باز کردن صفحه تماس با ما | مرورگر → `/contact` (بدون لاگین) | صفحه تماس با آدرس، تلفن، ایمیل و ساعت کاری نمایش داده شود | ☐ |
| TS-15-04 | باز کردن صفحه قوانین و مقررات | مرورگر → `/terms` (بدون لاگین) | صفحه قوانین و مقررات نمایش داده شود | ☐ |
| TS-15-05 | دسترسی با لاگین مشتری | لاگین U3 → `/about` | صفحه درباره ما نمایش شود + ناوبار شامل نام کاربر و سبد خرید باشد | ☐ |
| TS-15-06 | دسترسی با لاگین ادمین | لاگین U1 → `/faq` | صفحه سوالات متداول نمایش شود | ☐ |

### صفحه ۴۰۴ سفارشی

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TS-15-07 | آدرس ناموجود (بدون لاگین) | مرورگر → `/nonexistent-page` | صفحه ۴۰۴ سفارشی با پیام فارسی «صفحه یافت نشد» + دکمه بازگشت + طراحی مطابق سایت | ☐ |
| TS-15-08 | آدرس ناموجود (با لاگین) | لاگین U3 → `/some-invalid-url` | صفحه ۴۰۴ سفارشی نمایش شود + ناوبار شامل اطلاعات کاربر | ☐ |

### فوتر (Footer)

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TS-15-09 | نمایش فوتر در صفحه اصلی | مرورگر → `/` | فوتر با اطلاعات شرکت، لینک‌های سریع، نشان‌های اعتماد و شبکه‌های اجتماعی نمایش شود | ☐ |
| TS-15-10 | لینک‌های فوتر | کلیک روی لینک‌های فوتر (درباره ما، سوالات متداول، تماس، قوانین) | هر لینک به صفحه صحیح هدایت شود | ☐ |
| TS-15-11 | فوتر در صفحات ثابت | مرورگر → `/about` → اسکرول به پایین | فوتر کامل نمایش داده شود | ☐ |

### ناوبار (Navbar)

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TS-15-12 | لینک‌های ناوبار — احراز اصالت | کلیک روی لینک «احراز اصالت» در ناوبار | ریدایرکت به `/verify` | ☐ |
| TS-15-13 | لینک‌های ناوبار — سوالات متداول | کلیک روی لینک «سوالات متداول» در ناوبار | ریدایرکت به `/faq` | ☐ |
| TS-15-14 | لینک‌های ناوبار — درباره ما | کلیک روی لینک «درباره ما» در ناوبار | ریدایرکت به `/about` | ☐ |
| TS-15-15 | لینک‌های ناوبار — تماس با ما | کلیک روی لینک «تماس با ما» در ناوبار | ریدایرکت به `/contact` | ☐ |

---

## 17. TS-16: ثبت مالکیت، خرید هدیه و انتقال شمش

### فروش POS با کد ثبت مالکیت (Claim Code)

**پیش‌نیاز**: لاگین نماینده D1 + شمش‌های ASSIGNED در شعبه نماینده

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TS-16-01 | فروش POS — تولید claim_code (وب) | `/dealer/pos` → انتخاب شمش + مبلغ + اطلاعات خریدار → «ثبت فروش» | فروش ثبت شود + claim_code ۶ کاراکتری در رسید نمایش داده شود | ☐ |
| TS-16-02 | فروش POS — تولید claim_code (API) | `POST /api/dealer/sale` با اطلاعات معتبر | پاسخ JSON شامل `claim_code` باشد (۶ کاراکتر از مجموعه ABCDEFGHJKMNPQRSTUVWXYZ23456789) | ☐ |
| TS-16-03 | فروش POS — شمش بعد از فروش | بررسی شمش فروخته‌شده در `/admin/bars` | وضعیت SOLD + customer_id خالی (NULL) + claim_code مقداردهی شده | ☐ |

### خرید هدیه (Gift Purchase)

**پیش‌نیاز**: لاگین U3 + حداقل ۱ آیتم در سبد

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TS-16-04 | چک‌اوت با گزینه هدیه | `/checkout` → تیک «خرید به‌عنوان هدیه» + انتخاب روش تحویل → «ثبت سفارش» | سفارش ایجاد شود با is_gift=True | ☐ |
| TS-16-05 | پرداخت سفارش هدیه | سفارش هدیه → «پرداخت با کیف پول» | پرداخت موفق + شمش وضعیت SOLD + customer_id خالی (NULL) + claim_code تولید شود | ☐ |
| TS-16-06 | نمایش claim_code پس از پرداخت هدیه | جزئیات سفارش هدیه پس از پرداخت | claim_code در صفحه جزئیات سفارش نمایش داده شود | ☐ |
| TS-16-07 | سفارش عادی (بدون هدیه) | `/checkout` → بدون تیک هدیه → ثبت و پرداخت | سفارش عادی + شمش با customer_id مشتری + بدون claim_code | ☐ |

### ثبت مالکیت (Claim Bar)

**داده تستی آماده (از seed):**
- شمش `TSCLM001` → کد ثبت مالکیت: `ABC123` (بدون مالک، آماده ادعا)
- شمش `TSCLM002` → کد ثبت مالکیت: `XYZ789` (بدون مالک، برای تست کد اشتباه)
- شمش `TSTRF001` → متعلق به U3 (09351234567) (بدون claim_code، برای تست انتقال)

**برای مشاهده اطلاعات شمش از پنل ادمین:**
لاگین ادمین (09123456789) → پنل مدیریت → شمش‌ها → جستجوی سریال `TSCLM001` → زیر سریال‌کد، «کد ثبت مالکیت» نمایش داده می‌شود.
همچنین با کلیک روی دکمه ویرایش شمش، در بخش «اطلاعات سریع» کد ثبت مالکیت قابل مشاهده است.

| ID | اقدام | گام‌به‌گام | نتیجه مورد انتظار | وضعیت |
|----|--------|-----------|-------------------|--------|
| TS-16-08 | باز کردن صفحه ثبت مالکیت از منو | ۱. با موبایل `09359876543` (U4) لاگین کنید ۲. روی نام کاربر (بالا-چپ) کلیک کنید تا منوی کشویی باز شود ۳. گزینه **«ثبت شمش»** را بزنید | فرم ثبت مالکیت با دو فیلد «سریال‌کد» و «کد ثبت مالکیت» نمایش شود | ☐ |
| TS-16-09 | ثبت مالکیت موفق | ۱. در فرم ثبت مالکیت (مرحله قبل): ۲. فیلد سریال‌کد: `TSCLM001` ۳. فیلد کد ثبت مالکیت: `ABC123` ۴. دکمه «ثبت مالکیت» را بزنید | پیام موفقیت نمایش شود + شمش به نام U4 ثبت شود | ☐ |
| TS-16-10 | بررسی ثبت از پنل ادمین | ۱. لاگین ادمین (09123456789) → پنل مدیریت → شمش‌ها ۲. شمش `TSCLM001` را پیدا کنید | ستون مالک: نام U4 نمایش شود + کد ثبت مالکیت دیگر نمایش داده نشود (حذف شده) | ☐ |
| TS-16-11 | ثبت مالکیت — کد اشتباه | ۱. لاگین U4 → منوی کشویی → «ثبت شمش» ۲. سریال‌کد: `TSCLM002` ۳. کد ثبت مالکیت: `WRONG1` (اشتباه — کد درست: XYZ789) ۴. دکمه «ثبت مالکیت» | پیام خطا: کد ثبت مالکیت نامعتبر است | ☐ |
| TS-16-12 | ثبت مالکیت — سریال‌کد ناموجود | ۱. لاگین U4 → منوی کشویی → «ثبت شمش» ۲. سریال‌کد: `XXXXXXXX` (ناموجود) ۳. کد ثبت مالکیت: `ABC123` ۴. دکمه «ثبت مالکیت» | پیام خطا: شمش یافت نشد | ☐ |
| TS-16-13 | ثبت مالکیت — شمش با مالک قبلی | ۱. لاگین U4 → منوی کشویی → «ثبت شمش» ۲. سریال‌کد: `TSCLM001` (شمشی که قبلاً ثبت شد) ۳. هر کد ثبت مالکیت ۴. دکمه «ثبت مالکیت» | پیام خطا: این شمش قبلاً ثبت مالکیت شده است | ☐ |

### مشاهده شمش‌های من (My Bars)

**پیش‌نیاز**: تست TS-16-09 با موفقیت انجام شده باشد (شمش TSCLM001 به نام U4 ثبت شده)

| ID | اقدام | گام‌به‌گام | نتیجه مورد انتظار | وضعیت |
|----|--------|-----------|-------------------|--------|
| TS-16-14 | مشاهده شمش ثبت‌شده | ۱. لاگین U4 (09359876543) ۲. منوی کشویی → «شمش‌های من» | شمش `TSCLM001` در لیست با سریال‌کد، نام محصول، وزن و عیار نمایش شود | ☐ |
| TS-16-15 | شمش‌های مشتری U3 | ۱. لاگین U3 (09351234567) ۲. منوی کشویی → «شمش‌های من» | شمش `TSTRF001` در لیست نمایش شود (از seed data) | ☐ |
| TS-16-16 | مشتری بدون شمش | ۱. لاگین U5 (09131112233) ۲. منوی کشویی → «شمش‌های من» | پیام «هنوز شمشی به نام شما ثبت نشده» + دکمه «ثبت شمش با کد» | ☐ |
| TS-16-17 | دکمه‌های عملیات | ۱. لاگین U3 → منوی کشویی → «شمش‌های من» ۲. کنار شمش `TSTRF001` نگاه کنید | دو دکمه «اصالت‌سنجی» و «انتقال» نمایش شود | ☐ |

### انتقال مالکیت (Ownership Transfer)

**پیش‌نیاز**: لاگین U3 (09351234567) — شمش `TSTRF001` به نام اوست

| ID | اقدام | گام‌به‌گام | نتیجه مورد انتظار | وضعیت |
|----|--------|-----------|-------------------|--------|
| TS-16-18 | باز کردن فرم انتقال | ۱. لاگین U3 (09351234567) ۲. منوی کشویی → «شمش‌های من» ۳. کنار شمش `TSTRF001` دکمه **«انتقال»** را بزنید | فرم انتقال با فیلد «شماره موبایل گیرنده» نمایش شود | ☐ |
| TS-16-19 | ارسال OTP انتقال | ۱. در فرم انتقال: شماره موبایل گیرنده: `09359876543` (U4) ۲. دکمه «ارسال کد تایید» را بزنید | پیام: کد تایید به موبایل شما (مالک فعلی) ارسال شد + فرم وارد کردن OTP نمایش شود. **نکته:** OTP در کنسول سرور چاپ می‌شود (حالت dev)، مقدار `111111` | ☐ |
| TS-16-20 | OTP اشتباه | ۱. در فرم OTP: کد تایید: `999999` (اشتباه) ۲. دکمه «تایید انتقال» | پیام خطا: کد تایید نادرست | ☐ |
| TS-16-21 | تایید انتقال موفق | ۱. در فرم OTP: کد تایید: `111111` ۲. دکمه «تایید انتقال» | پیام موفقیت: شمش با موفقیت منتقل شد | ☐ |
| TS-16-22 | بررسی انتقال — شمش در لیست گیرنده | ۱. لاگین U4 (09359876543) ۲. منوی کشویی → «شمش‌های من» | شمش `TSTRF001` در لیست U4 نمایش شود | ☐ |
| TS-16-23 | بررسی انتقال — شمش از لیست فرستنده حذف شده | ۱. لاگین U3 (09351234567) ۲. منوی کشویی → «شمش‌های من» | شمش `TSTRF001` دیگر در لیست U3 نباشد | ☐ |
| TS-16-24 | بررسی از پنل ادمین | ۱. لاگین ادمین → پنل مدیریت → شمش‌ها ۲. شمش `TSTRF001` را پیدا و ویرایش کنید | مالک: نام U4 + تاریخچه مالکیت شامل انتقال از U3 به U4 | ☐ |

---

## 18. TS-NEG: تست‌های منفی

### امنیت و دسترسی

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TS-NEG-01 | دسترسی ادمین بدون لاگین | مرورگر → `/admin/dashboard` بدون کوکی | ریدایرکت به `/auth/login` یا خطای 401 | ☐ |
| TS-NEG-02 | دسترسی نماینده بدون لاگین | مرورگر → `/dealer/dashboard` بدون کوکی | ریدایرکت به `/auth/login` یا خطای 401 | ☐ |
| TS-NEG-03 | مشتری به پنل ادمین | لاگین مشتری → `/admin/dashboard` | خطای 401/403 | ☐ |
| TS-NEG-04 | نماینده به پنل ادمین | لاگین نماینده → `/admin/dashboard` | خطای 401/403 | ☐ |
| TS-NEG-05 | مشتری به پنل نماینده | لاگین مشتری → `/dealer/dashboard` | خطای 401/403 | ☐ |
| TS-NEG-06 | اپراتور به تنظیمات سیستم | لاگین U2 (operator) → `/admin/settings` | خطای 403 (فقط super_admin) | ☐ |
| TS-NEG-07 | CSRF token نامعتبر | ارسال فرم POST بدون/با CSRF نامعتبر | خطای CSRF | ☐ |

### ورودی‌های نامعتبر

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TS-NEG-08 | ایجاد محصول — وزن منفی | وزن: `-1` | خطای اعتبارسنجی | ☐ |
| TS-NEG-09 | ایجاد محصول — عیار نامعتبر | عیار: `0` | خطای اعتبارسنجی یا قیمت صفر | ☐ |
| TS-NEG-10 | ایجاد نماینده — موبایل تکراری | موبایل نماینده‌ای که وجود دارد | خطا: «این شماره قبلاً ثبت شده» | ☐ |
| TS-NEG-11 | کوپن — کد تکراری | ایجاد کوپن با کد موجود | خطا: «کد تکراری» | ☐ |
| TS-NEG-12 | برداشت — شبا نامعتبر | شبا: `12345` | خطای اعتبارسنجی | ☐ |
| TS-NEG-13 | تغییر قیمت طلا — عدد منفی | قیمت: `-1000` | خطای اعتبارسنجی | ☐ |
| TS-NEG-14 | ثبت سفارش — سبد خالی | رفتن به checkout با سبد خالی | ریدایرکت به سبد یا خطا | ☐ |
| TS-NEG-15 | پرداخت سفارش دیگری | مشتری A → پرداخت سفارش مشتری B | خطای 403 / عدم دسترسی | ☐ |

### تحمل خطا

| ID | اقدام | ورودی | نتیجه مورد انتظار | وضعیت |
|----|--------|-------|-------------------|--------|
| TS-NEG-16 | سفارش محصول بدون شمش | خرید محصولی که شمش Assigned ندارد | خطا: «موجودی کافی نیست» | ☐ |
| TS-NEG-17 | دابل‌کلیک پرداخت | دو بار سریع کلیک روی «پرداخت با کیف پول» | فقط یک بار پرداخت شود (idempotency) | ☐ |
| TS-NEG-18 | بازخرید شمش فروخته‌نشده | نماینده → بازخرید → سریال شمش Assigned | خطا: «شمش قابل بازخرید نیست» | ☐ |
| TS-NEG-19 | صفحه ناموجود | مرورگر → `/admin/nonexistent` | صفحه سفارشی ۴۰۴ با پیام فارسی | ☐ |
| TS-NEG-20 | Health check | مرورگر → `/health` | پاسخ 200 با وضعیت سلامت | ☐ |
| TS-NEG-21 | ثبت مالکیت شمش بدون claim_code | سریال‌کد شمش عادی (فروش آنلاین، بدون claim_code) + هر کدی | خطا: شمش کد ثبت مالکیت ندارد | ☐ |
| TS-NEG-22 | انتقال شمشی که مالک نیستی | لاگین U4 → `/my-bars/{bar_id}/transfer` (شمش U3) | خطای 403 | ☐ |
| TS-NEG-23 | انتقال شمش به خودت | لاگین U3 → انتقال شمش به موبایل خود U3 | خطا: نمی‌توانید شمش را به خودتان منتقل کنید | ☐ |
| TS-NEG-24 | مشاهده my-bars بدون لاگین | بدون لاگین → `/my-bars` | ریدایرکت به صفحه ورود | ☐ |
| TS-NEG-25 | OTP انتقال منقضی‌شده | OTP ارسال شده + صبر تا انقضا → وارد کردن OTP | خطا: کد تایید منقضی شده | ☐ |

---

## خلاصه تعداد تست‌ها

| بخش | تعداد |
|------|--------|
| TS-01: احراز هویت | ۱۰ |
| TS-02: فروشگاه | ۸ |
| TS-03: سبد خرید | ۶ |
| TS-04: ثبت سفارش | ۸ |
| TS-05: پرداخت | ۶ |
| TS-06: کیف پول | ۷ |
| TS-07: کوپن | ۱۷ |
| TS-08: پنل مدیریت | ۲۰ |
| TS-09: نمایندگان | ۱۷ |
| TS-10: احراز اصالت | ۴ |
| TS-11: پروفایل و آدرس | ۸ |
| TS-12: تیکتینگ / پشتیبانی | ۳۳ |
| TS-13: POS REST API نماینده | ۱۸ |
| TS-14: بازپرداخت اجرت بازخرید | ۶ |
| TS-15: صفحات ثابت و فوتر | ۱۵ |
| TS-16: ثبت مالکیت، خرید هدیه و انتقال شمش | ۲۴ |
| TS-NEG: تست‌های منفی | ۲۵ |
| **مجموع** | **۲۳۲** |

---

> این سند بر اساس قابلیت‌های فعلی سیستم TalaMala v4 (فازهای ۱-۱۴ + بازپرداخت اجرت بازخرید + بهبودهای تیکتینگ + صفحات ثابت و فوتر + ثبت مالکیت و انتقال شمش) تهیه شده است.
> ستون «وضعیت» را پس از اجرای هر تست با علامت ✅ (موفق)، ❌ (ناموفق) یا ⚠️ (نیاز به بررسی) پر کنید.
